!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=22)}([function(t,e){const s=window.classes.UI;class i extends s{constructor(t){super(t),this._data.icon=t.icon||"up"}d(t){return i.json[t]}static async load(t){if(i.json)return!0;let e=new i({user:t});i.json=await e.loadJSON("assets/data/icons.json")}}i.template='\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" {{if(options.flip)}}class="flip"{{/if}}>\n\t\t\t\t<g fill="none" fill-rule="evenodd">\n\t\t\t\t\t{{if (options.icon==\'2checks\')}}\n\t\t\t\t    <polygon points="0 0 19 0 19 14 0 14"/>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t<polygon points="0 0 24 0 24 24 0 24"/>\n\t\t\t\t\t{{/if}}\n\t\t\t\t\t<path fill="#000" fill-rule="nonzero" d="{{self.d(options.icon)}}"/>\n    \t\t\t</g>\n\t\t\t</svg>\n\t\t',t.exports=i},function(t,e,s){const i=window.classes.UI,a=window.classes.Icon,o=s(0);class n extends i{static getIconHTML(t){if(n.__iconsCache||(n.__iconsCache={}),n.__iconsCache[t])return n.__iconsCache[t];let e=o;"check"!=t&&"eye"!=t||(e=a);let s=new e({icon:t}).render({noDOM:!0});return n.__iconsCache[t]=s,s}mouseupUpG(t){let e=["mousedown","touchstart"];this.__globalMouseupCatchD=new Date,this.__globalMouseupCatch=s=>{(new Date).getTime()-this.__globalMouseupCatchD.getTime()<200||this.$()&&this.$().contains(s.target)||(this.nextTick(()=>{e.forEach(t=>{document.removeEventListener(t,this.__globalMouseupCatch)})}),t())},e.forEach(t=>{document.addEventListener(t,this.__globalMouseupCatch)})}}t.exports=n},function(t,e,s){const i=s(1),a=s(3);class o extends i{constructor(t){super(t),this.AppUI=i,this._data.message=t.message,this._data.avatarUserId=this._data.message.getAuthorId(),this._data.avatarInitials=this._data.message.getAvatarInitials(),this._data.authorName=this._data.message.getAuthorFirstName(),this._data.viewType=t.message._peer.getDisplayType(),this._data.sameAsNext=!1,t.nextMessage&&t.nextMessage.getAuthorId()==t.message.getAuthorId()&&(this._data.sameAsNext=!0),this._data.fromMe=!1,"channel"!==this._data.viewType&&t.message.isFromMe()&&(this._data.fromMe=!0),t.prevMessage&&new Date(t.message._date).getDay()!=new Date(t.prevMessage._date).getDay()&&(this._data.showDate=!0),this._data.showDate=!0;let e=t.message.getReplyMessage();e&&(this._data.reply={message:e.getDisplayMessage(),author:e.getAuthorFirstName(),id:e._id}),this._data.forwardedInfo=t.message.getForwardedInfo()}markAsRead(){if(this._ricon)return;const t=this.$(".readicon");t&&(t.innerHTML=i.getIconHTML("2checks")),this._ricon=!0}highText(t,e){console.error(this._data.message._id);document.querySelectorAll(".highlight").forEach(t=>{let e=t.parentNode;for(;t.firstChild;)e.insertBefore(t.firstChild,t);e.removeChild(t)});const s=this.$$(".messageBody, .high");if(!t||!s.length)return;let i=!1,o="";for(let e of s){let s=e.innerHTML,a=s.toLowerCase().indexOf(t.toLowerCase());a>=0?(s=s.substring(0,a)+"<span class='highlight'>"+s.substring(a,a+t.length)+"</span>"+s.substring(a+t.length),e.innerHTML=s,i=!0):o+=e.innerText}if(!i&&!e){let e=a.guessWord(o,t);if(e)return this.highText(e,!0)}}setSameAsNext(t){this._data.sameAsNext=t;const e=this.$("#message_"+this._data.message._id).classList;t?e.add("sameAsNext"):e.remove("sameAsNext")}getMetaHTML(){let t=this._data.message.getDisplayTime();return"channel"==this._data.viewType?t=a.numberToDecims(this._data.message._apiObject.views||0)+" "+i.getIconHTML("eye")+"&nbsp;&nbsp;&nbsp;"+t:this._data.message.isFromMe()&&(this._data.message.seenByPeer()?t+=' <span class="readicon">'+i.getIconHTML("2checks")+"</span>":t+=' <span class="readicon">'+i.getIconHTML("check")+"</span>"),t}getSizeForTheMedia(){let t=360,e=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;e<t&&(t=e);let s=!1,i=1.5,a=this._data.message._apiObject.media;if(a){if(a.document&&a.document.attributes)for(let t of a.document.attributes)"documentAttributeVideo"==t._&&(i=t.w/t.h,s=!0);if(a.photo&&a.photo.sizes)for(let t of a.photo.sizes)"m"!=t.type&&"y"!=t.type||(i=t.w/t.h,s=!0)}let o=240*i;return o>t&&(o=t),1.5*o>e&&(o=120*i),{width:o,height:240}}cleanUp(){this._tgs&&this._tgs.destroy()}destroy(){this.cleanUp();const t=this.$().offsetHeight;return this.$().remove(),t}messageIdChanged(t){const e=this.$("#message_"+t);e&&(e.id="message_"+this._data.message._id,e.setAttribute("data-id",this._data.message._id))}updateContent(){this.$(".messageBody")&&(this.$(".messageBody").innerHTML=this._data.message.formatMessageBody())}}o.AppUI=i,t.exports=o},function(t,e){class s{static dateToHuman(t,e){let i=new Date(1e3*t);return s.monthsNames[i.getMonth()]+(e?" ":"&nbsp;")+i.getDate()+(e?"":",&nbsp;"+i.getFullYear()+" at "+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2))}static numberToString(t){return(""+t).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")}static numberToDecims(t){if(t<2e3)return s.numberToString(t);const e=Math.floor(Math.log(t)/Math.log(1e3));return(t/Math.pow(1e3,e)).toFixed(1)+["","K","M","B"][e]}static guessWord(t,e){const s=e.trim().toLowerCase(),i=(""+t).trim().toLowerCase().split(" "),a={},o=t=>{let e=s.substring(t<0?0:t,s.length-(t<0?Math.abs(t):0));for(let s of i)-1!=s.indexOf(e)&&(a[s]||(a[s]=4-Math.abs(t)-.5*Math.abs(e.length-s.length)))},n=[-1,-2,-3,-4,-5,1,2,3];for(let t of n)o(t);const r=Object.keys(a).sort((function(t,e){return a[e]-a[t]}));if(r.length)return r[0]}}s.monthsNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t.exports=s},function(t,e,s){const i=s(1),a=window.classes.TGS;t.exports=class extends i{constructor(t){super(t),this._peerManager=this._app._peerManager,this.AppUI=i,this._data={active:t.active||!1}}async loadTGS(t,e){if(await this.sureSingle("TGS"))return;this._tgsjson||(this._tgsjson=await this.loadJSON("assets/data/"+t+".json",!0));new a(this.$(".tgs")).setJSON(this._tgsjson,!0,!0,null,!0),this.fulfilSingle("TGS",!0,e)}afterRender(){this.nextTick(()=>{this.reinitScrollBar(!0)})}reinitScrollBar(t){let e=this.$(".sidebarScroll");this.initScrollBarOn(e,t)}setActive(t=!0,e){this._data.active&&!t&&this.afterUnActive&&this.afterUnActive(),this._data.active=t,t?(this.$(".sidebarBlock").classList.add("active"),this.afterActive&&this.afterActive(e)):this.$(".sidebarBlock").classList.remove("active")}template(){}}},function(t,e,s){const i=s(0),a=s(1);t.exports=class extends a{constructor(t){super(t),this._data.items=t.items,this._events=[["click",this.domId+"_top","onClick"]],this._components=[];for(let t of this._data.items)this._components["icon_"+t[1]]||(this._components["icon_"+t[1]]=this.newC(i,{icon:t[1]}));this._data.offsetX=-37,this._data.offsetY=15}onClick(t){const e=this.$("#"+this.domId+"_top"),s=t.target.closest(".menuItem");s&&e.contains(s)&&s.dataset.action&&(this.emit(s.dataset.action),this.emit("action",s.dataset.action),this.hide())}show(t,e,s){if(e){this._data.items=e,console.error(this._data.items);for(let t of this._data.items)this._components["icon_"+t[1]]||(this._components["icon_"+t[1]]=this.newC(i,{icon:t[1]}));this.render()}if(this.$(".menuTop").className="menuTop"+(s?" "+s:""),t&&t.clientX){let e=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,s=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,i=t.clientX,a=t.clientY,o=i-10,n=a-10,r="tl";r=i>e/2?a>s/2?"br":"tr":a>s/2?"bl":"tl",this.$(".menuTop").classList.remove("tl"),this.$(".menuTop").classList.remove("tr"),this.$(".menuTop").classList.remove("br"),this.$(".menuTop").classList.remove("bl"),this.$(".menuTop").classList.add(r),this.$(".menu").style.bottom="auto",this.$(".menu").style.right="auto",this.$(".menuContainer").style.position="fixed",this.$(".menu").style.position="fixed",this.$(".menu").style.left=o+"px",this.$(".menu").style.top=n+"px",this.$(".menu").style.marginTop="br"==r||"bl"==r?"-"+46*this._data.items.length+"px":"0px"}this.$(".menuTop").style.display="block",this.$(".menu").classList.add("active"),this.mouseupUpG(()=>{this.hide()})}hide(){this.$(".menu")&&this.$(".menu").classList.remove("active")}template(){return'\n\t\t\t<div class="menuTop" id="{{domId}}_top">\n\t\t\t\t<div class="menuContainer">\n\t\t\t\t\t<div class="menu" style="bottom: {{offsetY}}px; right: {{offsetX}}px;">\n\t\t\t\t\t\t{{each(options.items)}}\n\t\t\t\t\t\t<div class="menuItem" data-action="{{@this[0]}}">\n\t\t\t\t\t\t\t<div class="miIcon">{{component(options.components[\'icon_\'+@this[1]])}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="mtTitle">{{if (@this[3])}}<div class="scBlockBadge scBlockBadgeVisible scBlockMuted">{{@this[3]}}</div>{{/if}}{{@this[2]}}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(3),a=s(12);t.exports=class extends a{constructor(t={}){super(t),this._previewBase64=null,this.blobURL=null}async getPlayableBlobURL(){return this._playableBlobURL||(this._playableBlobURL=await this.save(!0)),this._playableBlobURL}isPhoto(){return!(!this._apiObject._||"photo"!=this._apiObject._)}isVideo(){return!this.isPhoto()}isGIF(){return this.isVideo()&&this.getInfo("isGIF")}isRoundVideo(){return this.isVideo()&&this.getInfo("isRound")}getInfo(t){return this.prepareInfo(),this._preparedInfo[t]}prepareInfo(){if(this._infoPrepared)return!0;if(this._preparedInfo={width:0,height:0,aspectRatio:1,videoDuration:0,videoDurationHuman:"0:00",isRound:!1,isGIF:!1,supportsStreaming:!1,mime:"",filename:"",sentByPeerUser:null,sentByPeerUserName:"",sentByPeerUserAtDateHuman:"",caption:"",sizeHuman:""},this._messageApiObject&&(this._messageApiObject.message&&(this._preparedInfo.caption=this._messageApiObject.message),this._preparedInfo.sentByPeerUserAtDateHuman=i.dateToHuman(this._messageApiObject.date),this._preparedInfo.sentByPeerUser=this._peerManager.peerUser(this._messageApiObject.from_id),this._preparedInfo.sentByPeerUser&&(this._preparedInfo.sentByPeerUserName=this._preparedInfo.sentByPeerUser.getFirstName())),this._apiObject.mime_type&&(this._preparedInfo.mime=this._apiObject.mime_type),this._apiObject.attributes)for(let t of this._apiObject.attributes){if("documentAttributeAnimated"==t._&&(this._preparedInfo.isGIF=!0),"documentAttributeVideo"==t._){t.pFlags&&t.pFlags.round_message&&(this._preparedInfo.isRound=!0);let e=t.duration||0;this._preparedInfo.videoDuration=e,this._preparedInfo.videoDurationHuman=Math.floor(e/60)+":"+("0"+e%60).slice(-2),this._preparedInfo.width=t.w||0,this._preparedInfo.height=t.h||0,t.h&&(this._preparedInfo.aspectRatio=t.w/t.h),t.pFlags&&t.pFlags.supports_streaming&&(this._preparedInfo.supportsStreaming=!0)}"documentAttributeFilename"==t._&&(this._preparedInfo.filename=""+t.file_name)}if(this._apiObject.size&&(this._preparedInfo.sizeHuman=this.sizeToHuman(this._apiObject.size)),this._apiObject.sizes)for(let t of this._apiObject.sizes)t.w>this._preparedInfo.width&&(this._preparedInfo.width=t.w,this._preparedInfo.height=t.h),this._preparedInfo.height&&1==this._preparedInfo.aspectRatio&&(this._preparedInfo.aspectRatio=this._preparedInfo.width/this._preparedInfo.height);this._infoPrepared=!0}getVideoLengthString(){return this.getInfo("videoDurationHuman")}get id(){return this._id}get url(){return this.getPreviewMediaCacheURL()}static async loadPreviewsFromCache(t){await app._user._protocol.getCachedResources(t)}async loadPreview(t){if(this.blobURL)return this.blobURL;let e=await this._peerManager._media.loadPreviewAndReturnBlobURL(this._apiObject,"m",this._peerMessage,t);return e&&(this.blobURL=e,this.cached=!0),this.blobURL}async loadFull(){if(this._promiseLoadFull?await this._promiseLoadFull:this._promiseLoadFull=new Promise(t=>{this._promiseLoadFullResolver=t}),this._originalBlobURL||this._originalBlobURLLoaded)return this._originalBlobURL;let t=await this._peerManager._media.loadPreviewAndReturnBlobURL(this._apiObject,"o",this._peerMessage);return this._originalBlobURL=t||await this.loadPreview(),this._originalBlobURLLoaded=!0,this._promiseLoadFullResolver(),this._originalBlobURL}getStreamURL(){return"./tg/svideo/doc_"+this.id+"_stream_"+this._apiObject.size+".mp4"}getPreviewMediaCacheURL(t){return"./tg/message_photo_"+this._apiObject.id+"_m.jpg"}getPreviewBase64(){if(null!==this._previewBase64)return this._previewBase64;let t=null;if(this._apiObject.sizes&&this._apiObject.sizes[0]&&this._apiObject.sizes[0].bytes?t=this._apiObject.sizes[0].bytes:this._apiObject.thumbs&&this._apiObject.thumbs[0]&&this._apiObject.thumbs[0].bytes?t=this._apiObject.thumbs[0].bytes:this._apiObject.photo&&this._apiObject.photo.sizes[0]&&this._apiObject.photo.sizes[0].bytes&&(t=this._apiObject.photo.sizes[0].bytes),null==t)return!1;t=this._peerManager._media.decodeStrippedPhoto(t);let e="";for(var s=0;s<t.byteLength;s++)e+=String.fromCharCode(t[s]);return this._previewBase64="data:image/jpeg;base64,"+btoa(e),this._previewBase64}}},function(t,e,s){const i=window.classes.UI,a=s(0);t.exports=class extends i{constructor(t){super(t),this._components={Icon:this.newC(a,{icon:"search"})},this._events=[["keydown",this._domId+"_search_input","onSearch"],["blur",this._domId+"_search_input","onSearch"]],this._searchQ="",this._data.placeholder="Search"}focus(){this.$("#"+this._domId+"_search_input").focus()}setPlaceholder(t){this._data.placeholder=t,this.$("#"+this._domId+"_search_input").placeholder=t}onSearch(){this.nextTick(()=>{let t=this.$("#"+this._domId+"_search_input").value;t!=this._searchQ&&(this._searchQ=t,this.emit("search",t))})}setActive(t){t?this.$(".searchBox").classList.add("active"):(this.$(".searchBox").classList.remove("active"),this.$("#"+this._domId+"_search_input").value="")}template(){return'\n\t\t\t<div class="searchBox">\n\t\t\t\t<div class="searchIcon">{{component(options.components.Icon)}}{{/component}}</div>\n\t\t\t\t<div class="searchInput">\n\t\t\t\t\t<input type="text" id="{{domId}}_search_input" placeholder="{{placeholder}}">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=window.classes.UI,a=window.classes.Checkbox,o=(s(0),s(1));class n extends i{constructor(t){super(t),this._components={Checkbox:this.newC(a)},this._data.peer=t.peer,this._data.type=t.type,t.info?this._data.info=t.info:this._data.info=t.peer?t.peer.getInfoString():"",t.type&&(this._data.title=t.type.charAt(0).toUpperCase()+t.type.slice(1).split("_").join(" ")),this._noDiv=!0,this.AppUI=o}off(){this._components.Checkbox.off(),this.$().classList.remove("active")}on(){this._components.Checkbox.on(),this.$().classList.add("active")}toggle(){return this._components.Checkbox.toggle(),this._components.Checkbox._data.selected?this.$().classList.add("active"):this.$().classList.remove("active"),this._components.Checkbox._data.selected}}n.template='{{if (options.type)}}\n\t\t\t<div class="scBlock scBlockType" id="{{domId}}" title="{{type}}" data-id="{{type}}">\n\n\t\t\t\t<div class="scBlockIcon">\n\t\t\t\t\t{{self.AppUI.getIconHTML(options.type)|safe}}\n\t\t\t\t</div>\n\t\t\t\t<div class="scBlockCheckbox">\n\t\t\t\t\t{{component(options.components.Checkbox)}}{{/component}}\n\t\t\t\t</div>\n\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t<div class="scBlockTitle">{{title}}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t{{#else}}\n\t\t\t<div class="scBlock" id="{{domId}}" title="{{peer._id}}" data-id="{{peer._id}}" {{js(options.dnl = (\'\'+options.peer.getDisplayName()).toLowerCase())/}} data-search="{{dnl}}">\n\n\t\t\t\t<div class="scBlockCheckbox">\n\t\t\t\t\t{{component(options.components.Checkbox)}}{{/component}}\n\t\t\t\t</div>\n\n\t\t\t\t{{self.avHTML(options.peer, \'avatarMedium\')|safe}}\n\n\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t<div class="scBlockTitle">{{peer.getDisplayName()}}</div>\n\t\t\t\t\t<div class="scBlockBody">{{info| safe}}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t{{/if}}\n\t\t',t.exports=n},function(t,e,s){const i=s(1);t.exports=class extends i{constructor(t){super(t),this._peerManager=this._app._peerManager,this._data={active:t.active||!1}}setPeer(t){this._data.peer=t}setActive(t=!0){this._data.active=t,this.$(".rightSidebarBlock").classList[t?"add":"remove"]("active")}template(){}}},function(t,e,s){const i=s(1);class a extends i{constructor(t){super(t),this._peerManager=this._app._peerManager,this._itemsName="Webpages",this._events=[["scroll","rs"+this._itemsName+"Items","onScroll"]],this._data={active:t.active||!1,isLoading:!0,items:[]},this._inDomIds={},this._hasMoreItems=!0}async loadMoreItems(t){if(this._loadingMoreItems&&!this._data.isLoading)return!0;this._loadingMoreItems=!0;let e=this._data.items.length,s=await this._data.peer["load"+this._itemsName](t);s.length>0&&(this._data.items=s),this._data.isLoading&&(this._data.isLoading=!1,this._inDomIds={},this.render()),this._loadingMoreItems=!1,this._lastCount=this._data.items.length-e,await new Promise(t=>{this.nextTick(()=>{this.appendMissingDOM(),t()})})}onScroll(t){t.target.scrollTop>t.target.scrollHeight-t.target.clientHeight-50&&this.loadMoreItems()}reinitScrollBar(t){if(this._data.isLoading)return!1;let e=this.$("#rs"+this._itemsName+"Items");if(e){let s=parseInt(e.closest("#rsInfoBlocks").style.height,10);s<100&&(s=100),e.style.height=s+"px",this.initScrollBarOn(e,t)}}afterRender(){this.nextTick(()=>{this.appendMissingDOM(),this.reinitScrollBar(!0)})}async appendMissingDOM(){if(this._data.isLoading)return!1;let t=this.$(".rsDocsMore");if(!t)return;let e="";const s=[];for(let t of this._data.items)this._inDomIds[t._id]||(e+=this.getItemHTML(t),this._inDomIds[t._id]=!0,s.push(t));e?(t.insertAdjacentHTML("beforebegin",e),t.classList.remove("hidden")):(this._hasMoreItems=!1,t.classList.add("hidden")),this.itemsAddedCallback&&s.length&&this.itemsAddedCallback(s),this.nextTick(()=>{this.reinitScrollBar()})}isHeightFilled(){try{if(this.$(".rsDocsMore").offsetTop>this.$("#rs"+this._itemsName+"Items").offsetHeight)return!0}catch(t){console.error(t)}return!1}async setVisible(){if(this._setVisible)return;this._setVisible=!0,await this.loadMoreItems(!0),this.$(".rsDocsMore").classList.remove("hidden");let t=0;for(;this._lastCount&&!this.isHeightFilled()&&t<5;)await this.loadMoreItems(),t++;this.isHeightFilled()||this.$(".rsDocsMore").classList.add("hidden")}async setPeer(t){this._data.peer=t,this._data.items=[],this._data.isLoading=!0,this._processedPreviews={},this._setVisible=!1}}a.AppUI=i,t.exports=a},function(t,e){class s{constructor(t,e,s,i,a,o){this._ratios=this.cropRatios(t,e),this._averageRatio=e,this._maxWidth=s,this._maxHeight=i,this._minWidth=a,this._spacing=o,this._count=this._ratios.length}snap(t,e,s){return t<e?e:t>s?s:t}cropRatios(t,e){let s=[];for(let i of t)s.push(e>1.1?this.snap(i,1,2.75):this.snap(i,.6667,1));return s}layout(){const t=[],e=(t,e)=>{const s=this._ratios.slice(t,t+e).reduce((t,e)=>t+e,0);return(this._maxWidth-(e-1)*this._spacing)/s},s=s=>{let i=[],a=0;for(let t of s)i.push(e(a,t)),a+=t;t.push([s,i])};for(let t=1;t!=this._count;++t){const e=this._count-t;t>3||e>3||s([t,e])}for(let t=1;t!=this._count-1;++t)for(let e=1;e!=this._count-t;++e){const i=this._count-t-e;t>3||e>(this._averageRatio<.85?4:3)||i>3||s([t,e,i])}for(let t=1;t!=this._count-1;++t)for(let e=1;e!=this._count-t;++e)for(let i=1;i!=this._count-t-e;++i){const a=this._count-t-e-i;t>3||e>3||i>3||a>3||s([t,e,i,a])}let i=null,a=0;const o=(t,e)=>{for(let s=1;s!=e;++s)if(t[s-1]>t[s])return 1.5;return 1};for(let e of t){const t=e[1],s=e[0],n=s.length,r=t.reduce((t,e)=>t+e,0)+this._spacing*(n-1),d=Math.min(t),l=(Math.max(t),d<this._minWidth?1.5:1),h=o(s,n),c=Math.abs(r-this._maxHeight)*l*h;(!i||c<a)&&(i=e,a=c)}const n=i[0],r=i[1],d=n.length;let l=0,h=0,c=[];for(let t=0;t!=d;++t){const e=n[t],s=r[t],i=Math.round(s);let a=0;for(let t=0;t!=e;++t){const o=this._ratios[l],n=t==e-1?this._maxWidth-a:Math.round(o*s);c.push([a,h,n,i]),a+=n+this._spacing,++l}h+=i+this._spacing}return c}}t.exports=class{constructor(t,e={}){this._minWidth=50,e.hasText&&(this._minWidth=100),this._proportions="",this._averageRatio=1,this._hasHugeRatio=!1,this._count=0,this._maxWidth=e.maxWidth||308,this._maxHeight=4*this._maxWidth/3,this._maxSizeRatio=this._maxWidth/this._maxHeight,this._spacing=2,this._items=t,this._ratios=[],this._bottomRightItem=null,this._bottomLeftItem=null,this._width=0,this._height=0,this.countRatios()}countRatios(){this._proportions="",this._hasHugeRatio=!1,this._ratios=[];let t=0;for(let e of this._items)e.ratio=e.width/e.height,e.proportion=e.ratio>1.2?"w":e.ratio<.8?"n":"q",this._proportions+=e.proportion,t+=e.ratio,e.ratio>2&&(this._hasHugeRatio=!0),this._ratios.push(e.ratio);this._count=this._items.length,this._averageRatio=t/this._count}layout(){let t=[];if(1==this._count){let e=this._maxWidth,s=this._maxHeight;this._items[0].ratio>1?s=this._maxWidth/this._items[0].ratio:e=this._maxHeight*this._items[0].ratio,e=e<this._minWidth?this._minWidth:e>this._maxWidth?this._maxWidth:e,s=s<this._minWidth?this._minWidth:s>this._maxHeight?this._maxHeight:s,t=[[0,0,e,s]]}else if(this._count>=5||this._hasHugeRatio){t=new s(this._ratios,this._averageRatio,this._maxWidth,this._maxHeight,this._minWidth,this._spacing).layout()}else 2==this._count?t=this.layoutTwo():3==this._count?t=this.layoutThree():4==this._count&&(t=this.layoutFour());if(t.length==this._items.length)for(let e=0;e<this._items.length;e++)this._items[e].pos={left:t[e][0],top:t[e][1],width:t[e][2],height:t[e][3]},this._items[e].style="left: "+t[e][0]+"px; top: "+t[e][1]+"px; width: "+t[e][2]+"px; height: "+t[e][3]+"px",this._width<t[e][0]+t[e][2]&&(this._width=Math.floor(t[e][0]+t[e][2])),this._height<t[e][1]+t[e][3]&&(this._height=Math.floor(t[e][1]+t[e][3])),(!this._bottomLeftItem||this._bottomLeftItem.pos.left>t[e][0]||this._bottomLeftItem.pos.top<t[e][1])&&(this._bottomLeftItem=this._items[e]),(!this._bottomRightItem||this._bottomRightItem.pos.left<t[e][0]||this._bottomRightItem.pos.top<t[e][1])&&(this._bottomRightItem=this._items[e]);else alert("wrong");return this._items}layoutTwo(){return"ww"==this._proportions&&this._averageRatio>1.4*this._maxSizeRatio&&this._items[1].ratio-this._items[0].ratio<.2?this.layoutTwoTopBottom():"ww"==this._proportions||"qq"==this._proportions?this.layoutTwoLeftRightEqual():this.layoutTwoLeftRight()}layoutThree(){return"n"==this._items[0].proportion?this.layoutThreeLeftAndOther():this.layoutThreeTopAndOther()}layoutFour(){return"w"==this._items[0].proportion?this.layoutFourTopAndOther():this.layoutFourLeftAndOther()}layoutFourTopAndOther(){const t=this._maxWidth,e=Math.round(Math.min(t/this._items[0].ratio,.66*(this._maxHeight-this._spacing))),s=Math.round((this._maxWidth-2*this._spacing)/(this._items[1].ratio+this._items[2].ratio+this._items[3].ratio)),i=Math.max(this._minWidth,Math.round(Math.min(.4*(this._maxWidth-2*this._spacing),s*this._items[1].ratio))),a=Math.round(Math.max(Math.max(1*this._minWidth,.33*(this._maxWidth-2*this._spacing)),s*this._items[3].ratio)),o=t-i-a-2*this._spacing,n=Math.min(this._maxHeight-e-this._spacing,s);return[[0,0,t,e],[0,e+this._spacing,i,n],[i+this._spacing,e+this._spacing,o,n],[i+this._spacing+o+this._spacing,e+this._spacing,a,n]]}layoutFourLeftAndOther(){const t=this._maxHeight,e=Math.round(Math.min(t*this._items[0].ratio,.6*(this._maxWidth-this._spacing))),s=Math.round((this._maxHeight-2*this._spacing)/(1/this._items[1].ratio+1/this._items[2].ratio+1/this._items[3].ratio)),i=Math.round(s/this._items[1].ratio),a=Math.round(s/this._items[2].ratio),o=t-i-a-2*this._spacing,n=Math.max(this._minWidth,Math.min(this._maxWidth-e-this._spacing,s));return[[0,0,e,t],[e+this._spacing,0,n,i],[e+this._spacing,i+this._spacing,n,a],[e+this._spacing,i+a+2*this._spacing,n,o]]}layoutThreeLeftAndOther(){const t=this._maxHeight,e=Math.round(Math.min((this._maxHeight-this._spacing)/2,this._items[1].ratio*(this._maxWidth-this._spacing)/(this._items[2].ratio+this._items[1].ratio))),s=t-e-this._spacing,i=Math.max(this._minWidth,Math.round(Math.min((this._maxWidth-this._spacing)/2,Math.min(e*this._items[2].ratio,s*this._items[1].ratio)))),a=Math.min(Math.round(t*this._items[0].ratio),this._maxWidth-this._spacing-i);return[[0,0,a,t],[a+this._spacing,0,i,s],[a+this._spacing,s+this._spacing,i,e]]}layoutThreeTopAndOther(){const t=this._maxWidth,e=Math.round(Math.min(t/this._items[0].ratio,.66*(this._maxHeight-this._spacing))),s=(this._maxWidth-this._spacing)/2,i=Math.min(this._maxHeight-e-this._spacing,Math.round(Math.min(s/this._items[1].ratio,s/this._items[2].ratio))),a=t-s-this._spacing;return[[0,0,t,e],[0,e+this._spacing,s,i],[s+this._spacing,e+this._spacing,a,i]]}layoutTwoTopBottom(){const t=this._maxWidth,e=Math.round(Math.min(t/this._items[0].ratio,Math.min(t/this._items[1].ratio,(this._maxHeight-this._spacing)/2)));return[[0,0,t,e],[0,e+this._spacing,t,e]]}layoutTwoLeftRightEqual(){const t=(this._maxWidth-this._spacing)/2,e=Math.round(Math.min(t/this._items[0].ratio,Math.min(t/this._items[1].ratio,1*this._maxHeight)));return[[0,0,t,e],[t+this._spacing,0,t,e]]}layoutTwoLeftRight(){const t=Math.round(1.5*this._minWidth),e=Math.min(Math.round(Math.max(.4*(this._maxWidth-this._spacing),(this._maxWidth-this._spacing)/this._items[0].ratio/(1/this._items[0].ratio+1/this._items[1].ratio))),this._maxWidth-this._spacing-t),s=this._maxWidth-e-this._spacing,i=Math.min(this._maxHeight,Math.round(Math.min(s/this._items[0].ratio,e/this._items[1].ratio)));return[[0,0,s,i],[s+this._spacing,0,e,i]]}}},function(t,e){t.exports=class{constructor(t={}){this._apiObject=t.apiObject,this._id=this._apiObject.id,this._peerManager=t.peerManager,this._peer=t.peer,this._peerMessage=t.peerMessage,this._messageApiObject=t.messageApiObject||{},this._isDownloading=!1,this._downloadingPercentage=0,this._downloadingSize=0,this._downloadingSizeHuman="0",this._downloadingPartN=0,this._partBlobs=[],this._downloadedParts={},this._isDownloaded=!1,this._skippedPartN=null,this._parallelC=this._peerManager._app._config.get("maxParallelConnections"),this._totalParts=Math.ceil(this._apiObject.size/524288)}async checkCache(){if(this._isDownloaded)return!0;let t=[],e=[],s=0;for(let e=0;e<this._totalParts;e++)t.push({url:"./tg/doc_"+this._id+"_part_"+e+".dat",i:e});await this._peerManager._user._protocol.getCachedResources(t);for(let i of t)i.blob&&(s++,this._downloadedParts[i.i]=!0,this._partBlobs.push({n:i.i,blob:i.blob}),e.push(i.i),this._peerManager._user._protocol.fulfillSWStream(this.id,i.i));s==t.length&&(this._isDownloaded=!0)}async save(t){let e=null,s=!0;if(this.isPhoto&&this.isPhoto())e=await this.loadFull(),s=!1;else{if(!this._isDownloaded){await this.checkCache();do{await this.downloadNextPart()}while(!this._isDownloaded)}let t=[];this._partBlobs.sort((t,e)=>t.n>e.n?1:-1);for(let e of this._partBlobs)t.push(e.blob);let s=new Blob(t);const i=new Response(s,{"Content-Type":this.getInfo("mime"),"Content-Disposition":"attachment"});let a=await i.blob();e=URL.createObjectURL(a)}if(e){if(t)return e;{let t=document.createElement("a");t.href=e,t.download=this.getInfo("filename"),document.body.appendChild(t),t.innerHTML="download",t.classList.add("hidden"),t.click(),t.remove(),s&&window.URL.revokeObjectURL(e)}}}getStreamURL(){let t="mp4";return"audio/ogg"==this._apiObject.mime_type?t="ogg":"audio/mpeg"==this._apiObject.mime_type&&(t="mp3"),"./tg/svideo/doc_"+this.id+"_stream_"+this._apiObject.size+"."+t}scheduleDownload(){if(this._isDownloading||this._isDownloaded)return!0;this._isDownloading=!0}sizeToHuman(t){const e=Math.floor(Math.log(t)/Math.log(1024));return 1*(t/Math.pow(1024,e)).toFixed(2)+" "+["B","kB","MB","GB","TB"][e]}heatServersUp(){this._peerManager._media.heatServersUp(this._apiObject)}async downloadPart(t){if(console.error(t),this._downloadedParts[t])await this._peerManager._user._protocol.fulfillSWStream(this.id,t);else{this._downloadedParts[t]=!0;try{let e=await this._peerManager._media.loadFilePartAndReturnAB(this._apiObject,t,this._peerMessage);await this._peerManager._user._protocol.fulfillSWStream(this.id,t,e);let s="./tg/doc_"+this._apiObject.id+"_part_"+t+".dat",i=await this._peerManager._user._protocol.putToCacheAndForget({binary:e,url:s});this._partBlobs.push({n:t,blob:i}),this._downloadingSize=524288*(1+this._downloadingPartN)}catch(t){console.error(t)}}return!0}async downloadNextPart(t){if(this._isDownloaded)return!0;let e=this._downloadingPartN,s=!1;if(this._peerManager._user._protocol._docMessages[this._id]&&(e=this._peerManager._user._protocol._docMessages[this._id].partN,delete this._peerManager._user._protocol._docMessages[this._id],this._downloadingPartN=e,this._isDownloaded=!1,s=!0),this._isDownloaded)return!0;if(s||t){let t=[],s=this._parallelC,i=0;do{if(t.push(this.downloadPart(e)),e++,e>=this._totalParts)break;i++}while(i<s);await Promise.all(t),this._downloadingPartN=e}else await this.downloadPart(e),this._downloadingPartN++;if(this._downloadingPercentage=Math.ceil(this._downloadingPartN/this._totalParts*100),this._downloadingSizeHuman=this.sizeToHuman(this._downloadingSize),this._downloadingPartN>=this._totalParts){let t=!1;for(let e=0;e<this._totalParts;e++)if(!this._downloadedParts[e]&&!t){t=!0,this._downloadingPartN=e;break}t||(this._isDownloaded=!0)}}}},function(t,e,s){const i=s(1);t.exports=class extends i{constructor(t){super(t)}initScrollbar(){this._ps=new window.classes.PerfectScrollbar(this.$(".emojiScroll"),{wheelSpeed:1,wheelPropagation:!1,minScrollbarLength:40,suppressScrollX:!0})}hidden(){}}},function(t,e){t.exports=class{constructor(t={}){this._peerManager=t.peerManager,this._apiObject=t.apiObject,this._previewBase64=null,this._id=this._apiObject.id,this.blobURL=null,this.json=null,this._isAnimated=!1,"application/x-tgsticker"==this._apiObject.mime_type&&(this._isAnimated=!0)}alt(){if(this._apiObject.attributes)for(let t of this._apiObject.attributes)if(t.alt)return t.alt;return""}isAnimated(){return this._isAnimated}get tgs(){return this.isAnimated()}get id(){return this._id}get url(){return this.getPreviewMediaCacheURL()}async load(){if(this._isAnimated){if(this.json)return console.error("was cached"),this.json;console.error("was not cached");let t=await this._peerManager._media.loadStickerAndReturn(this._apiObject);return t&&(this.json=t,this.cached=!0),t}{if(this.blobURL)return this.blobURL;let t=await this._peerManager._media.loadStickerAndReturn(this._apiObject);return t&&(this.blobURL=t,this.cached=!0),this.blobURL}}getPreviewMediaCacheURL(){return this._isAnimated?"./tg/sticker_"+this._apiObject.id+".json":"./tg/sticker_"+this._apiObject.id+".png"}}},function(t,e,s){const i=s(28),a=s(4),o=s(5);t.exports=class extends a{constructor(t){super(t),this._components={pinned:[],peers:[]},this._filter=t.filter,this._folder=t.folder,this._folder&&(this._filter=this._folder.getFilterFunc()),this._filter||(this._filter=()=>!0)}updateBadge(t){this._parent.updateBadge&&this._folder&&this._parent.updateBadge(t?null:this._folder)}setActive(t=!0){if(this._data.active=t,!this._wasActivated){this._wasActivated=!0,this._components.DialogsMenu=this.newC(o,{items:[["pin","pin","Pin Dialog"]]}),this._cIds={},this._events=[["click","sidebarDialogs"+this._domId,"onPeerClick"],["mouseover","sidebarDialogs"+this._domId,"onMouseOver"],["touchstart","sidebarDialogs"+this._domId,"onMouseDown"],["touchmove","sidebarDialogs"+this._domId,"onTouchMove"],["mousedown","sidebarDialogs"+this._domId,"onMouseDown"],["scroll","sidebarDialogsScroll"+this._domId,"onScroll"],["contextmenu","sidebarPeers"+this._domId,"onDialogContext"]],this._componentEvents=[["pin","DialogsMenu","onPinDialog"],["archive","DialogsMenu","onArchiveDialog"]],this._folder&&this._peerManager.on("folder",t=>{t.folderId==this._folder._id&&(this.updateFolderPeers(),this.sortPeers())}),this._peerManager.on("peers",()=>{this.peers(),this.updateBadge()}),this._peerManager.on("peer",e=>{t(e)}),this._peerManager.on("subscribed",e=>{this._peerManager._loadingMorePeers||(e.peer.readyToUse()?(this.movePeerToTop(e.peer),t(e),this.setActivePeer(e.peer)):this.removePeer(e.peer))}),this._renderPeerTimeouts={};const t=t=>{if(this._peerManager._loadingMorePeers)return;if(this._ignoreMessageEvents)return!0;let e=this.peerByParams(t);e&&(clearTimeout(this._renderPeerTimeouts[e._id]),this._renderPeerTimeouts[e._id]=setTimeout(()=>{this._filter(e)?(this._cIds[e._id]?(this._cIds[e._id].rerender(),this.sortPeers()):e.readyToUse()&&(this.movePeerToTop(e),this.sortPeers()),this.updateBadge()):this._cIds[e._id]&&this.removePeer(e)},200),t.forceBadge&&this._cIds[e._id]&&this._cIds[e._id].rerender()),t.forceBadge&&this.updateBadge(!0)};this._mostRecentPeerDate=null,this._ignoreMessageEvents=!0,this._peerManager.on("unreadCount",e=>{e.forceBadge=!0,t(e)}),this._peerManager.on("updated",t),this._peerManager.on("online",t),this._peerManager.on("message",e=>{if(this._ignoreMessageEvents)return!0;this.movePeerToTop(e.peer),t(e)}),this.peers(),this.loadUntilFilled()}}updateFolderPeers(){for(let t in this._cIds)this._filter(this._cIds[t]._data.peer)||this.removePeer(this._cIds[t]._data.peer);for(let t of this._peerManager._sortedPeers)this._cIds[t._id]||this.movePeerToTop(t)}async loadUntilFilled(){let t=0;const e=this.$(".loadingMore"),s=this.$(".sidebarScroll");if(!s)return;const i=s.offsetHeight||500;let a=0;do{e.classList.add("active"),a=e.offsetTop,a<i&&(this._ignoreMessageEvents=!0,await this._peerManager.loadPeers(),e.classList.add("active"),await new Promise(t=>{setTimeout(t,500)}))}while(t++<10);this._ignoreMessageEvents=!1}onArchiveDialog(){const t=this._components.DialogsMenu._peer;t&&(t.isArchived()?this._peerManager.toggleDialogArchived(t,!1):this._peerManager.toggleDialogArchived(t,!0))}isPinned(t){return this._folder?this._folder.isPinned(t):t.isPinned()}onPinDialog(){const t=this._components.DialogsMenu._peer;t&&(this._folder?this._folder.toggleDialogPin(t,!this.isPinned(t)):this._peerManager.toggleDialogPin(t,!this.isPinned(t)))}setActivePeer(t){const e=this.$("#sidebarPeers"+this._domId).querySelector(".active");e&&e.classList.remove("active"),this._filter(t)&&this.$(".scblock_"+t._id)&&this.$(".scblock_"+t._id).classList.add("active")}peerByParams(t){let e=t.peer?t.peer:null;return!e&&t.peerUser&&this._peerManager._peers["dialog_"+t.peerUser._id]&&(e=this._peerManager._peers["dialog_"+t.peerUser._id]),e}onScroll(t){const e=this.$("#sidebarDialogsScroll"+this._domId),s=this.$("#sidebarPeers"+this._domId);e.scrollTop+e.clientHeight>.75*s.clientHeight&&this._peerManager._thereReMorePeers&&(this.$(".loadingMore").classList.add("active"),this._ignoreMessageEvents=!0,this._peerManager.loadPeers())}onMouseDown(t){if(!t.button){this._MouseDown=!0;try{const e=this._peerManager.peerById(t.target.closest(".scBlock").dataset.id);e&&(clearTimeout(this._mouseOverTimeout),this._ignoreMessageEvents=!0,app._interface._components.PanelTopBar.avatarToMemory(e._id,t.target.closest(".scBlock").querySelector(".avatarBack")),e._isReady&&!this.isTouchDevice()?(this._app._interface.onPeerSelected({peer:e}),this._ignoreMessageEvents=!1):e.makeReady().then(()=>{this._ignoreMessageEvents=!1}))}catch(t){}t.touches&&(clearTimeout(this._ltt),this._ltt=setTimeout(()=>{const e=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY});t.target.dispatchEvent.call(t.target,e)},1200))}}onTouchMove(){clearTimeout(this._ltt)}onDialogContext(t){t.preventDefault(),clearTimeout(this._ltt);const e=this.$();let s=event.target.closest(".scBlock");if(s&&e.contains(s)){const e=s.dataset.id,i=this._peerManager.peerById(e),a=[];this.isPinned(i)?a.push(["pin","unpin","Unpin Dialog"]):a.push(["pin","pin","Pin Dialog"]),this._folder||(i.isArchived()?a.push(["archive","archived","Unarchive Dialog"]):a.push(["archive","archived","Archive Dialog"])),this._components.DialogsMenu.show(t,a),this._components.DialogsMenu._peer=i}return!1}onMouseOver(t){try{const e=this._peerManager.peerById(t.target.closest(".scBlock").dataset.id);if(e){clearTimeout(this._mouseOverTimeout);const t=()=>{this._ignoreMessageEvents=!0,e.makeReady().then(()=>{this._ignoreMessageEvents=!1})};this._ignoreMessageEvents?this._mouseOverTimeout=setTimeout(t,100):t()}}catch(t){}}onPeerClick(t){this._MouseDown=!1;const e=this.$();let s=t.target.closest(".scBlock");if(s&&e.contains(s)){const t=this._peerManager.peerById(s.dataset.id);t&&this._app._interface.onPeerSelected({peer:t})}clearTimeout(this._ltt)}removePeer(t){if(!this._cIds[t._id])return;const e=this.$(".scblock_"+t._id);if(e&&e.remove(),!this._cIds[t._id])return;let s=this._cIds[t._id],i=(t,e)=>{let s=null;for(let i=0;i<t.length;i++)t[i]._domId==e._domId&&(s=i);null!==s&&t.splice(s,1)};i(this._components.pinned,s),i(this._components.peers,s),delete this._cIds[t._id]}movePeerToTop(t){if(this._data.isLoading||!this._filter(t))return!0;let e="#sidebarPeersNotPinned"+this._domId;this.isPinned(t)&&(e="#sidebarPeersPinned"+this._domId);const s=this.$(e),a=this.$(e).querySelector("div"),o=this.$(".scblock_"+t._id);if(o)s.insertBefore(o,a);else{const e=this.newC(i,{peer:t,folder:this._folder}),a=e.render({withDiv:!0});s.insertAdjacentHTML("afterbegin",a),this.isPinned(t)?this._components.pinned.push(e):this._components.peers.push(e),this._cIds[t._id]=e}}sortPeers(){if(this._MouseDown)return;const t=this.$("#sidebarPeersPinned"+this._domId),e=this.$("#sidebarPeersNotPinned"+this._domId);let s=(t,e,s,i)=>{const a=[];for(let s of t)this.isPinned(s._data.peer)!=e&&a.push(s);if(a.length)for(let e of a){const a=e.$();a&&i.appendChild(a),s.push(e);for(let s=0;s<t.length;s++)if(t[s]._domId==e._domId){t.splice(s,1);break}e.rerender()}};s(this._components.peers,!1,this._components.pinned,t),s(this._components.pinned,!0,this._components.peers,e);let i=(t,e)=>{const s=[];for(let e of t)s.push(e.$());s.sort((t,e)=>t.dataset.date<e.dataset.date?1:t.dataset.date>e.dataset.date?-1:0);for(let t of s)e.appendChild(t)};i(this._components.peers,e),i(this._components.pinned,t)}peers(){if(this._ignoreMessageEvents=!1,this._components.peers.length||this._components.pinned.length){const t=this.$("#sidebarPeersPinned"+this._domId),e=this.$("#sidebarPeersNotPinned"+this._domId);if(e)for(let s of this._peerManager._sortedPeers)if(this._filter(s)&&s&&s.readyToUse()&&!this._cIds[s._id]){this._mostRecentPeerDate<s._mostRecentMessageDate&&(this._mostRecentPeerDate=s._mostRecentMessageDate);const a=this.newC(i,{peer:s,folder:this._folder}),o=a.render({withDiv:!0});this.isPinned(s)?(this._components.pinned.push(a),t.insertAdjacentHTML("beforeend",o)):(this._components.peers.push(a),e.insertAdjacentHTML("beforeend",o)),this._cIds[s._id]=a}this.sortPeers(),this.reinitScrollBar(!0)}else{this._components.peers=[];for(let t of this._peerManager._sortedPeers)if(this._filter(t)&&t.readyToUse()){this._mostRecentPeerDate<t._mostRecentMessageDate&&(this._mostRecentPeerDate=t._mostRecentMessageDate);const e=this.newC(i,{peer:t,folder:this._folder});this.isPinned(t)?this._components.pinned.push(e):this._components.peers.push(e),this._cIds[t._id]=e}this._data.isLoading=!1,this.render()}this.$(".loadingMore")&&this.$(".loadingMore").classList.remove("active")}template(){return'\n\t\t\t<div class="sidebarDialogs" id="sidebarDialogs{{domId}}">\n\t\t\t\t<div class="sidebarScroll" id="sidebarDialogsScroll{{domId}}">\n\t\t\t\t\t<div id="sidebarPeers{{domId}}">\n\t\t\t\t\t\t<div id="sidebarPeersPinned{{domId}}" class="sidebarPeersPinned">{{each(options.components.pinned)}}{{component(@this)}}{{/component}}{{/each}}</div>\n\t\t\t\t\t\t<div id="sidebarPeersNotPinned{{domId}}">\n\t\t\t\t\t\t\t{{each(options.components.peers)}}\n\t\t\t\t\t\t\t\t{{component(@this)}}{{/component}}\n\t\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="loadingMore">\n\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{{component(options.components.DialogsMenu)}}{{/component}}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(57);t.exports=class extends i{constructor(){super(),this.listeners={}}on(t,e){return this.addEventListener(t,e)}addEventListener(t,e){t in this.listeners||(this.listeners[t]=[]);let s=!1;for(let i of this.listeners[t])if(i==e){s=!0;break}s||this.listeners[t].push(e)}removeEventListener(t,e){if(t in this.listeners)for(var s=this.listeners[t],i=0,a=s.length;i<a;i++)if(s[i]===e)return void s.splice(i,1)}clearEventListeners(){this.listeners={}}emit(t){const e=Array.prototype.slice.call(arguments,1);if(!(t in this.listeners))return!0;for(var s=this.listeners[t].slice(),i=0,a=s.length;i<a;i++)try{s[i].apply(this,e||[])}catch(t){console.error(t)}return!0}}},function(t,e){const s=window.classes.UI;t.exports=class extends s{constructor(t){if(super(t),this._from=t.from||null,this._media=t.media||null,this._data.from={x:0,y:0,height:0,width:0},this._data.fromDefined=!1,this._data.calc={x:0,y:0,height:0,width:0},this._from){let t=this._from.getBoundingClientRect();this._data.from.x=t.left,this._data.from.x=t.left,this._data.from.y=t.top,this._data.from.width=t.width,this._data.from.height=t.height,this._data.fromDefined=!0,setTimeout(()=>{this.animateGo()},50)}this.calc(),this._data.imageURL=null,this._media.cached?this._data.imageURL=this._media.blobURL:this._data.imageURL=this._media.getPreviewBase64()}onResize(){this.calc(),this.animateGo()}calc(){let t=this._parent.$(".mbBrowser").getBoundingClientRect();this._data.calc.height=t.height;let e=t.width,s=this._media.getInfo("aspectRatio"),i=Math.floor(t.height*s);i>e-200&&(i=e-200),i<500&&(i=e-10);let a=i/s;a>t.height+150&&(a=t.height+150,i=Math.floor(a*s)),this._data.calc.x=(e-i)/2,this._data.calc.width=i,this._data.calc.bcrWidth=e,this._data.calc.bcrHeight=t.height,this._data.calc.height=a,this._data.calc.y=t.top+Math.floor((t.height-a)/2)}stopMedia(){}setToThePrev(){let t=this.$(".mbbPhoto");t.style.top=this._data.calc.y+"px",t.style.height=this._data.calc.height+"px",t.style.width=this._data.calc.width+"px",t.style.left="-"+this._data.calc.width+"px",t.style.right=this._data.calc.bcrWidth+"px"}setToTheNext(){let t=this.$(".mbbPhoto");t.style.top=this._data.calc.y+"px",t.style.height=this._data.calc.height+"px",t.style.width=this._data.calc.width+"px",t.style.right="-"+this._data.calc.width+"px",t.style.left=this._data.calc.bcrWidth+"px"}animateGo(){let t=this.$(".mbbPhoto");t.style.top=this._data.calc.y+"px",t.style.left=this._data.calc.x+"px",t.style.height=this._data.calc.height+"px",t.style.width=this._data.calc.width+"px",t.style.right=this._data.calc.bcrWidth-this._data.calc.width+"px",this.loadFull()}}},function(t,e,s){const i=s(6),a=s(19),o=s(14),n=s(20),r=s(77),d=s(21),l=s(3);class h{constructor(t={}){this._message=t.message||"",this._peer=t.peer||null,this._peerManager=t.peerManager,this._apiObject=t.apiObject,this._id=this._apiObject.id,this._message=this._apiObject.message,this._date=this._apiObject.date,this._media=null,this._doc=null,this._sticker=null,this._webpage=null,this._poll=null,this._audio=null,this._album=null,this._groupMessages=[],this._groupMessagesIds={},this._isMainInGroup=!0,this._mainMessageInGroup=null,this.checkForObjects(),this._mediaPreviewLoaded=!1,this._peerUser=null,this._authorPeer=this._peer,this._apiObject.from_id&&this._peerManager._peerUsers[this._apiObject.from_id]?(this._authorPeer=this._peerManager._peerUsers[this._apiObject.from_id],this._peerUser=this._authorPeer):this._apiObject.pFlags&&this._apiObject.pFlags.out&&(this._authorPeer=this._peerManager._mePeerUser)}heatServersUp(){let t=this._doc||this._audio||this._media;t&&t.heatServersUp()}async doButton(t){let e=this.getButtons();if(e[t]){let s=null;if(s=this._apiObject.via_bot_id?this._apiObject.via_bot_id:this._apiObject.from_id,e[t].data)return await this._peerManager._user.invoke("messages.getBotCallbackAnswer",{flags:!0,peer:this._peer.getInputPeerObject(),msg_id:this._id,data:e[t].data}),!0;if(e[t].url){let i=e[t].url.split("t.me/")[1].split("?"),a=(i[0],i[1].split("=")[0]),o=i[1].split("=")[1];if(this._peerManager._peerUsers[s]){const t=(""+Math.random()).split("0.").join("");let e={_:"inputPeerUser",user_id:s,access_hash:this._peerManager._peerUsers[s]._apiObject.access_hash},i={_:"inputUser",user_id:s,access_hash:this._peerManager._peerUsers[s]._apiObject.access_hash};if("startgroup"==a)return{_:"startgroup",iu:i,start_param:o};await this._peerManager._user.invoke("messages.startBot",{random_id:t,bot:i,peer:e,start_param:o})}}else if(e[t].query){let i={_:"inputUser",user_id:s,access_hash:this._peerManager._peerUsers[s]._apiObject.access_hash};return(await this._peerManager._user.invoke("messages.getInlineBotResults",{bot:i,peer:this._peer.getInputPeerObject(),query:e[t].query})).data}}}getButtons(){let t=[];try{for(let e of this._apiObject.reply_markup.rows)"keyboardButtonRow"==e._&&(e.title=e.buttons[0].text,e.data=e.buttons[0].data,e.url=e.buttons[0].url,e.query=e.buttons[0].query,t.push(e))}catch(t){}return t}authorPeer(){!this._authorPeer&&this._apiObject.pFlags&&this._apiObject.pFlags.out&&(this._authorPeer=this._peerManager._mePeerUser)}isService(){return"messageService"==this._apiObject._}async getAuthorDialog(){return this._peerManager._peers["dialog_"+this._apiObject.from_id]||this._authorPeer&&this._peerManager._peerUsers[this._apiObject.from_id]&&this._peerManager.peerByAPIResult({peer:{user_id:this._apiObject.from_id}}),this._peerManager._peers["dialog_"+this._apiObject.from_id]}async getFWDPeer(){const t=this._apiObject.fwd_from;if(!t)return null;let e=null;return t.channel_id?e="channel_"+t.channel_id:t.from_id&&(e="dialog_"+t.from_id),this._peerManager._peers[e]?this._peerManager._peers[e]:null}addMessageToGroup(t){return this._groupMessagesIds[t._id]?this._groupMessagesIds[t._id]:(this._groupMessagesIds[t._id]=t,this._groupMessages.push(t),t._message?(t._isMainInGroup=!0,this._isMainInGroup=!1,this._mainMessageInGroup=t):t._isMainInGroup=!1,t)}isMainInGroup(){return this._isMainInGroup}getGroupMessages(){const t=[];for(let e of this._peer._messageGroups[this.getGroupId()]._groupMessages)t.push(e);return t.push(this._peer._messageGroups[this.getGroupId()]),t}getGroupMedias(){return this.getGroupMessages().map(t=>({media:t._media,message:t}))}getGroupId(){return this._apiObject.grouped_id||!1}updateApiObject(t){this._apiObject=t,this._message!=t.message&&(this._message=t.message),this.checkForObjects()}serialize(){return this._apiObject}copyToClipboard(){navigator.clipboard.writeText(this._apiObject.message)}hasAvatar(){return this.authorPeer(),this._authorPeer.hasAvatar()}getAvatarCacheURL(){return this.authorPeer(),this._authorPeer.getAvatarCacheURL()}getAvatarBlobURLSync(){return this.authorPeer(),this._authorPeer.getAvatarBlobURLSync()}getAvatarInitials(){return this.authorPeer(),this._authorPeer.getAvatarInitials()}getAvatarColor(){return this.authorPeer(),this._authorPeer.getAvatarColor()}async getAvatarBlobURL(){return this.authorPeer(),await this._authorPeer.getAvatarBlobURL()}checkForObjects(){let t=(t,e,s)=>{let l=this._peer._mediaIds,h=this._peer._media,c=i;if("doc"==t?(c=a,l=this._peer._docsIds,h=this._peer._docs):"sticker"==t?(c=o,l=this._peer._stickersIds,h=this._peer._stickers):"webpage"==t?(c=n,l=this._peer._webpagesIds,h=this._peer._webpages):"poll"==t?(c=r,l=this._peer._pollsIds,h=this._peer._polls):"audio"==t&&(c=d,l=this._peer._audiosIds,h=this._peer._audios),!l[e.id]){const t=new c({apiObject:e,peerManager:this._peerManager,messageApiObject:s,peer:this._peer,peerMessage:this});h.push(t),l[e.id]=t}this["_"+t]=l[e.id]};if(this._apiObject.media&&(this._apiObject.media.webpage&&t("webpage",this._apiObject.media.webpage,this._apiObject),this._apiObject.media.poll&&t("poll",this._apiObject.media.poll,this._apiObject),this._apiObject.media.photo&&t("media",this._apiObject.media.photo,this._apiObject),this._apiObject.media.document)){let e=this._apiObject.media.document,s=null;if(e.attributes)for(let t of e.attributes)"documentAttributeVideo"==t._&&(s="video"),"documentAttributeSticker"==t._&&(s="sticker"),"documentAttributeAudio"==t._&&(s="audio");"application/x-tgsticker"==e.mime_type&&(s="sticker"),t("video"==s?"media":"sticker"==s?"sticker":"audio"==s?"audio":"doc",e,this._apiObject)}}seenByPeer(){return!(this._peer._read_outbox_max_id&&this._id>this._peer._read_outbox_max_id)}isFromMe(){return this.authorPeer(),!!(this._authorPeer&&this._authorPeer.isMe&&this._authorPeer.isMe())||!(!this._apiObject.from_id||!this._peerManager._peerUsers[this._apiObject.from_id])&&this._peerManager._peerUsers[this._apiObject.from_id].isMe()}getReplyMessage(){return this._apiObject&&this._apiObject.reply_to_msg_id?this._peer&&this._peer._messageIds&&this._peer._messageIds[this._apiObject.reply_to_msg_id]?this._peer._messageIds[this._apiObject.reply_to_msg_id]:void 0:null}getForwardedInfo(){return this._apiObject&&this._apiObject.fwd_from?this._apiObject.fwd_from.channel_id&&this._peerManager._peers["channel_"+this._apiObject.fwd_from.channel_id]?{name:this._peerManager._peers["channel_"+this._apiObject.fwd_from.channel_id].getDisplayName(),peer:this._peerManager._peers["channel_"+this._apiObject.fwd_from.channel_id]}:this._apiObject.fwd_from.from_id&&this._peerManager._peerUsers[this._apiObject.fwd_from.from_id]?{name:this._peerManager._peerUsers[this._apiObject.fwd_from.from_id].getFirstName(),peerUser:this._peerManager._peerUsers[this._apiObject.fwd_from.from_id]}:void 0:null}getAuthorId(){return this._apiObject.from_id?this._apiObject.from_id:this._authorPeer&&this._authorPeer._id?this._authorPeer._id:this._peer.id}getAuthorFirstName(){return this.authorPeer(),this._authorPeer&&this._authorPeer.getFirstName?this._authorPeer.getFirstName():this._peer.getDisplayName()}getDisplayTime(){const t=new Date(1e3*this._apiObject.date);return("0"+t.getHours()).substr(-2)+":"+("0"+t.getMinutes()).substr(-2)}getDownloadableInfo(){const t={size:0,sizeHuman:"",filename:"",ext:"",color:1};if(this._apiObject.media&&this._apiObject.media.document&&this._apiObject.media.document.attributes){for(let e of this._apiObject.media.document.attributes)"documentAttributeFilename"==e._&&(t.filename=""+e.file_name,t.ext=t.filename.substr(t.filename.lastIndexOf(".")+1),t.color=(t.ext+" ").charCodeAt(0)%8+1,2==t.color&&(t.color=5));t.size=this._apiObject.media.document.size;const e=Math.floor(Math.log(t.size)/Math.log(1024));t.sizeHuman=1*(t.size/Math.pow(1024,e)).toFixed(2)+["B","kB","MB","GB","TB"][e]}return t}getPreviewMediaCacheURL(){let t=null;return this._apiObject.media&&(this._apiObject.media.photo?t="./tg/message_photo_"+this._apiObject.media.photo.id+".jpg":this._apiObject.media.webpage&&this._apiObject.media.webpage.photo&&(t="./tg/message_webpage_"+this._apiObject.media.webpage.photo+".jpg")),t}isDownloadable(){return!(!this._apiObject.media||!this._apiObject.media.document||this.hasVideo()||this.hasSticker())}hasMedia(){return!(!this._apiObject.media||!this._apiObject.media.photo)}hasVideo(){if(this._apiObject.media&&this._apiObject.media.document&&this._apiObject.media.document.attributes)for(let t of this._apiObject.media.document.attributes)if("documentAttributeVideo"==t._)return!0;return!1}hasSticker(){if(this._apiObject.media&&this._apiObject.media.document&&this._apiObject.media.document.attributes)for(let t of this._apiObject.media.document.attributes)if("documentAttributeSticker"==t._)return!0;return!1}hasAnimatedSticker(){return!(!this.hasSticker()||"application/x-tgsticker"!=this._apiObject.media.document.mime_type)}isMediaOnly(){return!(this._apiObject.message||!this.hasMedia())}static formatMessageBodyForObject(t){let e=t.message;if(!e)return"";if(e=""+e,e=e.replace(/[<>]/g,t=>"<"==t?"«":"»"),t.entities){const s=[];for(let i of t.entities){if("messageEntityUrl"==i._){let t=null;t=e.substr(i.offset,i.length),t&&i.length&&s.push([i.offset,"<a href='"+t+"' target='_blank'>",i.length,"</a>"])}if("messageEntityTextUrl"==i._){let t=i.url;t&&i.length&&s.push([i.offset,"<a href='"+t+"' target='_blank'>",i.length,"</a>"])}}if(s){let t=[];for(let i of s){t.push(),e=e.substr(0,i[0])+i[1]+e.substr(i[0],i[2])+i[3]+e.substr(i[0]+i[2]);for(let t of s)t[0]+=i[1].length+i[3].length}}}return e=e.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br/>$2"),e=e.replace(/[«»]/g,t=>"»"==t?"&gt;":"&lt;"),e}formatMessageBody(){return h.formatMessageBodyForObject(this._apiObject)}getDisplayAuthor(){return this.authorPeer(),this._authorPeer&&this._authorPeer.getFirstName&&!this._authorPeer.isMe()?this._authorPeer.getFirstName():""}getDisplayMessage(t,e){if(!this._apiObject)return"";if("messageService"==this._apiObject._){try{if(this._apiObject.action){if("date"==this._apiObject.action)return l.dateToHuman(this._date,!0);let t=this._apiObject.action._;if("messageActionChatAddUser"==t&&this._apiObject.action.users){let t=this._peerManager.peerUser(this._apiObject.action.users[0]);return(t?t._apiObject.first_name:"User")+" joined"}if("messageActionChatJoinedByLink"==t&&this._apiObject.from_id){return this._peerManager.peerUser(this._apiObject.from_id)._apiObject.first_name+" joined"}if("messageActionChatCreate"==t||"messageActionChannelCreate"==t)return"Chat Created";if("messageActionChatEditTitle"==t)return"Title changed";if("messageActionChatEditPhoto"==t||"messageActionChatDeletePhoto"==t)return"Photo changed";if("messageActionPinMessage"==t)return"Message Pinned"}}catch(t){console.error(t)}return""}let s=this._apiObject.message;s||(s="",this._apiObject.media&&this._apiObject.media.caption&&(s=this._apiObject.media.caption));let i=s.replace(/([.?!])\s*(?=[A-Z])/g,"$1|").split("|"),a=null;if(e){let t=e.toLowerCase();a=l.guessWord(s,t);for(let t of i){let e=t.toLowerCase().indexOf(a);if(-1!=e){if(s=t,e>=45-a.length){let t=0;do{s=s.substring(s.indexOf(" ")+1),e=s.toLowerCase().indexOf(a)}while(e>=45-a.length&&t++<100)}break}}}else i.length&&(s=i[0]);if(s.length>45&&(s=s.substr(0,45),s=s.substr(0,Math.min(s.length,s.lastIndexOf(" ")))+"..."),this._media){let t="";t=this._media.isVideo()?s?"📹":"Video":s?"🖼️":"Photo",s=t+" "+s}else this._sticker?s=this._sticker.alt():this._poll&&(s="Poll");if(a){let t=s.toLowerCase().indexOf(a);s=s.substring(0,t)+"<span class='search'>"+s.substring(t,t+a.length)+"</span>"+s.substring(t+a.length)}else if(t){let t=this.getDisplayAuthor();t&&(s="<span>"+t+"</span>"+(""+s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"))}return s}}t.exports=h},function(t,e,s){const i=s(3),a=s(12);t.exports=class extends a{constructor(t={}){super(t),this._preparedInfo={},this._infoPrepared=!1}cancelDownload(){if(this._isDownloaded)return!0;this._isDownloading=!1}getInfo(t){return this.prepareInfo(),this._preparedInfo[t]}prepareInfo(){if(this._infoPrepared)return!0;if(this._preparedInfo={size:0,sizeHuman:"",mime:"",filename:"",ext:"",color:1,dateHuman:""},this._apiObject.attributes)for(let t of this._apiObject.attributes)"documentAttributeFilename"==t._&&(this._preparedInfo.filename=""+t.file_name,this._preparedInfo.ext=this._preparedInfo.filename.substr(this._preparedInfo.filename.lastIndexOf(".")+1),this._preparedInfo.color=(this._preparedInfo.ext+" ").charCodeAt(0)%8+1,2==this._preparedInfo.color&&(this._preparedInfo.color=5));this._preparedInfo.size=this._apiObject.size,this._preparedInfo.sizeHuman=this.sizeToHuman(this._preparedInfo.size),this._preparedInfo.dateHuman=i.dateToHuman(this._apiObject.date),this._preparedInfo.mime=this._apiObject.mime_type,this._infoPrepared=!0}get id(){return this._id}}},function(t,e){t.exports=class{constructor(t={}){this._peerManager=t.peerManager,this._apiObject=t.apiObject,this._previewBase64=null,this._peerMessage=t.peerMessage,this._id=this._apiObject.id,this.blobURL=null}get url(){return this.getPreviewMediaCacheURL()}getPreviewMediaCacheURL(){return this.getInfo("hasPhoto")?"./tg/message_photo_"+this._apiObject.photo.id+"_x.jpg":null}async loadPhoto(){if(!this.getInfo("hasPhoto"))return null;if(this.blobURL)return this.blobURL;let t=await this._peerManager._media.loadPreviewAndReturnBlobURL(this._apiObject.photo,"x",this._peerMessage);return t&&(this.blobURL=t,this.cached=!0),this.blobURL}getInfo(t){return this.prepareInfo(),this._preparedInfo[t]}prepareInfo(){if(this._infoPrepared)return!0;if(this._preparedInfo={url:"",displayUrl:"",siteName:"",title:"",description:"",hasPhoto:!1,photoIsSquare:!0,previewBase64:null,photoWidth:320,photoHeight:240},this._preparedInfo.url=this._apiObject.url,this._preparedInfo.displayUrl=this._apiObject.display_url,this._preparedInfo.siteName=this._apiObject.site_name||"",this._preparedInfo.title=this._apiObject.title||"",this._preparedInfo.description=this._apiObject.description||"",this._preparedInfo.hasPhoto=!!this._apiObject.photo,this._preparedInfo.hasPhoto){if(this._apiObject.photo.sizes)for(let t of this._apiObject.photo.sizes)(t&&t.w!=t.h||t.w>200)&&(this._preparedInfo.photoIsSquare=!1),t&&"m"==t.type&&(this._preparedInfo.photoWidth=t.w,this._preparedInfo.photoHeight=t.h);let t=this.getPreviewBase64();t&&(this._preparedInfo.previewBase64=t)}this._infoPrepared=!0}getPreviewBase64(){if(null!==this._previewBase64)return this._previewBase64;let t=null;if(this._apiObject.sizes&&this._apiObject.sizes[0]&&this._apiObject.sizes[0].bytes?t=this._apiObject.sizes[0].bytes:this._apiObject.thumbs&&this._apiObject.thumbs[0]&&this._apiObject.thumbs[0].bytes?t=this._apiObject.thumbs[0].bytes:this._apiObject.photo&&this._apiObject.photo.sizes[0]&&this._apiObject.photo.sizes[0].bytes&&(t=this._apiObject.photo.sizes[0].bytes),null==t)return!1;t=this._peerManager._media.decodeStrippedPhoto(t);let e="";for(var s=0;s<t.byteLength;s++)e+=String.fromCharCode(t[s]);return this._previewBase64="data:image/jpeg;base64,"+btoa(e),this._previewBase64}}},function(t,e,s){s(3);const i=s(12);t.exports=class extends i{constructor(t={}){super(t)}get isVoice(){return this.getInfo("isVoice")}getInfo(t){return this.prepareInfo(),this._preparedInfo[t]}normalizeWaveform(){const t=this._preparedInfo.waveform;if(t&&"Uint8Array"!=t.name&&void 0!==t[0]){let e=[],s=0;for(;t[s]||0===t[s];)e.push(t[s]),s++;this._preparedInfo.waveform=new Uint8Array(e)}for(let t=0;t<this._preparedInfo.waveform.length;t++)this._preparedInfo.waveform[t]=Math.ceil(this._preparedInfo.waveform[t]/255*21)+3}prepareInfo(){if(this._infoPrepared)return!0;if(this._preparedInfo={waveform:[],mime:"",filename:"",title:"",performer:"",duration:0,durationHuman:"",isVoice:!1},this._apiObject.mime_type&&(this._preparedInfo.mime=this._apiObject.mime_type),this._apiObject.attributes)for(let t of this._apiObject.attributes){if("documentAttributeAudio"==t._){let e=t.duration||0;this._preparedInfo.duration=e,this._preparedInfo.durationHuman=Math.floor(e/60)+":"+("0"+e%60).slice(-2),t.waveform&&(this._preparedInfo.waveform=t.waveform,this.normalizeWaveform()),this._preparedInfo.title=t.title,this._preparedInfo.performer=t.performer,t.pFlags&&t.pFlags.voice&&(this._preparedInfo.isVoice=!0,this._messageApiObject&&this._peerManager._peerUsers[this._messageApiObject.from_id]&&(this._preparedInfo.performer=this._peerManager._peerUsers[this._messageApiObject.from_id].getFirstName()))}"documentAttributeFilename"==t._&&(this._preparedInfo.filename=""+t.file_name)}this._preparedInfo.title||(this._preparedInfo.title=this._preparedInfo.filename),this._preparedInfo.performer||(this._preparedInfo.performer=""),this._infoPrepared=!0}get id(){return this._id}}},function(t,e,s){const i=s(23),a=s(90);window.app=new class{constructor(t){this._user=auth._user,this._config=auth._config,this._initialized=!1,this._user.on("state",t=>{"online"!=t||this._initialized||this.init()}),"online"==this._user._state&&this.init(),this._router=new a,this._router.on("peerId",t=>{"online"==this._user._state&&this._interface.goTo({peerId:t})})}get config(){return this._config}init(){this._initialized=!0,this._interface=new i({user:this._user,app:this}),this._interface.init()}}},function(t,e,s){const i=window.classes.UI,a=s(24),o=s(33),n=s(50),r=s(58),d=s(68),l=s(72),h=s(75),c=s(88),p=s(0);t.exports=class extends i{constructor(t){super(t),this._events=[["mousedown","appInterface","onMouseDown"]],this._user=t.user}onMouseDown(t){const e=this.$();let s=t.target.closest(".rpb");s&&e.contains(s)&&this.rippleOn(s,t)}async avatarUpdated(t){await t.flushAvatar();let e=await t.getAvatarBlobURL();e&&document.querySelectorAll(".avatar").forEach(s=>{if(s.dataset.id==t._id){let t=s.querySelector(".avatarBack");if(t){t.style.backgroundImage="url('"+e+"')",t.dataset.loaded=1;let i=s.querySelector(".avatarInitials");i&&i.remove()}}})}async init(){await p.load(this._user),this._app._peerManager=new h({user:this._user,app:this._app}),this._app._mediaPlayer=new c({user:this._user,app:this._app}),this._domId="app",this._data={user:this._user},this._components={MediaBrowser:this.newC(l),LeftSidebar:this.newC(a),RightSidebar:this.newC(r),Panel:this.newC(o),PanelTopBar:this.newC(n),EmojiDialog:this.newC(d)},this._componentEvents=[["sticker","EmojiDialog","onSticker"],["emoji","EmojiDialog","onEmoji"],["peer","LeftSidebar","onPeerSelected"],["toDialogs","PanelTopBar","showDialogs"],["startSearch","PanelTopBar","startSearch"],["goto","Panel","goTo"]],this._onUserState=t=>{this.userStateChanged(t)},this._user.on("state",this._onUserState),this.swipeHandlers(),this.render(),this._app._peerManager.on("avatar",t=>{this.avatarUpdated(t.peer?t.peer:t.user)})}onSwipe(t){if(!this._components.MediaBrowser.onSwipe(t))for(let e in this._components)if(this._components[e].onSwipe&&this._components[e].onSwipe(t))return}swipeHandlers(){this._xDown=null,this._yDown=null,this.__handleTouchStart=t=>{t.touches[0].target.closest(".noswipe")||(this._xDown=t.touches[0].clientX,this._yDown=t.touches[0].clientY)},this.__handleTouchMove=t=>{if(!this._xDown||!this._yDown)return;let e=t.touches[0].clientX,s=t.touches[0].clientY,i=this._xDown-e,a=this._yDown-s;if(Math.abs(i)+Math.abs(a)>150){let e=!1;this.$$(".popup").forEach(s=>{s.contains(t.target)&&(e=!0)}),e||(Math.abs(i)>Math.abs(a)?i>0?this.onSwipe("left"):this.onSwipe("right"):a>0?this.onSwipe("up"):this.onSwipe("down")),this._xDown=null,this._yDown=null}},document.addEventListener("touchstart",this.__handleTouchStart,!1),document.addEventListener("touchmove",this.__handleTouchMove,!1)}async goTo(t){let e=null;e="author"==t.what?await t.message.getAuthorDialog():t.peerId&&this._app._peerManager._peers[t.peerId]?this._app._peerManager._peers[t.peerId]:await t.message.getFWDPeer(),e&&(this._components.Panel.setPeer(e),this._components.PanelTopBar.setPeer(e),this._components.RightSidebar.setPeer(e))}onSticker(t){this._components.Panel.onSticker(t)}onEmoji(t){this._components.Panel.onEmoji(t)}startSearch(t){this._components.LeftSidebar.startSearch(t),this.showDialogs()}showDialogs(){this._components.LeftSidebar.$().classList.remove("invisible"),this._components.Panel.$().classList.add("invisible"),this._components.PanelTopBar.$().classList.add("invisible")}showPanel(){this._components.LeftSidebar.$().classList.add("invisible"),this._components.Panel.$().classList.remove("invisible"),this._components.PanelTopBar.$().classList.remove("invisible")}onPeerSelected(t){this._components.Panel.setPeer(t.peer,t.messageId),this._components.PanelTopBar.setPeer(t.peer),this._components.RightSidebar.setPeer(t.peer),this._components.LeftSidebar.setPeer(t.peer),this.nextTick(()=>{this.showPanel()})}userStateChanged(t){console.error("user state",t),this._components,this._user.signedIn()?(this._app._peerManager=new h({user:this._user,app:this._app}),this._components.LeftSidebar=this.newC(a),this._components.Panel=this.newC(o),this._components.RightSidebar=this.newC(r),this._components.PanelTopBar=this.newC(o),this._components.EmojiDialog=this.newC(d)):(this._components.LeftSidebar=void 0,this._components.Panel=void 0,this._components.PanelTopBar=void 0,this._components.EmojiDialog=void 0,this._app._peerManager._media.clearEventListeners(),this._app._peerManager._stickers.clearEventListeners(),this._app._peerManager.clearEventListeners(),this._app._peerManager=void 0),this.render()}afterRender(){this._components.Panel&&this._components.Panel.$()&&this._components.Panel.$().classList.add("invisible")}template(){return'\n\t\t\t<div id="appInterface">\n\t\t\t{{if(options.user.signedIn())}}\n\t\t\t\t{{component(options.components.LeftSidebar)}}{{/component}}\n\t\t\t\t{{component(options.components.PanelTopBar)}}{{/component}}\n\t\t\t\t{{component(options.components.Panel)}}{{/component}}\n\t\t\t\t{{component(options.components.RightSidebar)}}{{/component}}\n\t\t\t\t{{component(options.components.EmojiDialog)}}{{/component}}\n\t\t\t\t{{component(options.components.MediaBrowser)}}{{/component}}\n\t\t\t{{#else}}\n\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=window.classes.UI,a=s(0),o=window.classes.Icon,n=s(7),r=s(25),d=s(27),l=s(29),h=s(30),c=s(31),p=s(32),_=s(5);t.exports=class extends i{constructor(t){super(t),this._data.isLoading=!0,this._components={BurgerIcon:this.newC(a,{icon:"menu"}),OkIcon:this.newC(o,{icon:"check"}),BackIcon:this.newC(a,{icon:"back"}),SearchBox:this.newC(n),SidebarMain:this.newC(d,{}),SidebarArchived:this.newC(l),SidebarSearch:this.newC(r),SidebarFolders:this.newC(h),SidebarManageFolder:this.newC(c),SidebarFolderPeers:this.newC(p),peers:[]},this._componentEvents=[["peer","SidebarSearch","onPeerSelected"],["search","SearchBox","onSearch"],["archive","Menu","onArchive"],["folders","Menu","onFolders"],["logout","Menu","onLogOut"],["action","Menu","onMenuAction"]],this._events=[["click","burger","onBurger"],["click","rburger","onRBurger"],["click","stOk","onOk"]],this._components.Menu=this.newC(_,{items:[]}),this._burgerIsBack=!1,this._app._peerManager.on("peers",()=>{this._currentBlock||this.showBlock("Main")})}onLogOut(){this._app._peerManager._user.logOut()}onMenuAction(t){this._rmenu&&this._components["Sidebar"+this._currentBlock].onMenu(t)}onOk(){this._components["Sidebar"+this._currentBlock].onOk()}onArchive(){this.showBlock("Archived")}onFolders(){this.showBlock("Folders")}onSwipe(t){if("left"==t&&this._parent._components.Panel._data.peer&&!this.$().classList.contains("invisible"))return this._parent.showPanel(),!0}async onBurger(t){if(this._burgerIsBack)this._components.SearchBox.setActive(!1),this.showBlock(this._back||"Main");else{let e=await this._components.SidebarArchived.getBadgeCount();this._components.Menu.show(t,[["archive","archived","Archived",e],["folders","document","Manage Folders"],["logout","contacts","Logout"]])}}onRBurger(t){this._rmenu&&this._components.Menu.show(t,this._rmenu,"rburger")}onSearch(t){t?(this.showBlock("Search"),this._components.SidebarSearch.doSearch(t),this._components.SearchBox.setActive(!0)):(this._components.SearchBox.setActive(!1),this.showBlock("Main"))}setPeer(t){this._components.SidebarMain.setActivePeer(t),this._components.SidebarArchived.setActivePeer(t)}onPeerSelected(t){this.emit("peer",t),this._components.SidebarMain.setActivePeer(t.peer),this._components.SidebarArchived.setActivePeer(t.peer)}burgerToBack(t){t?(this.$("#burgerBurger").classList.remove("active"),this.$("#burgerBack").classList.add("active"),this._burgerIsBack=!0):(this.$("#burgerBurger").classList.add("active"),this.$("#burgerBack").classList.remove("active"),this._burgerIsBack=!1)}setTitle(t,e,s){this.$(".stSearch").style.display=t?"none":"block",this.$(".stTitle").style.display=t?"block":"none",t&&(this.$(".stTitle").innerHTML=t),s&&s.length?(this._rmenu=s,this.$("#rburger").classList.add("visible"),this.$(".stOk").style.display="none"):(this._rmenu=null,this.$(".stOk").style.display=e?"block":"none",this.$("#rburger").classList.remove("visible"))}showBlock(t,e){this._data.isLoading&&(this._data.isLoading=!1,this.render()),this._currentBlock=t;for(let t in this._components)0===t.indexOf("Sidebar")&&this._components[t].setActive(!1);"Search"==t||this._components["Sidebar"+t]._title?(this.burgerToBack(!0),this._back=this._components["Sidebar"+t]._back):this.burgerToBack(!1),this.setTitle(this._components["Sidebar"+t]._title,this._components["Sidebar"+t]._hasOk),this._components["Sidebar"+t].setActive(!0,e)}template(){return'\n\t\t\t<div class="leftSidebar">\n\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t<div class="appLoading">\n\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t</div>\n\t\t\t\t{{#else}}\n\t\t\t\t<div class="sidebarTop" id="cTop">\n\t\t\t\t\t{{component(options.components.Menu)}}{{/component}}\n\t\t\t\t\t<div class="burger" id="burger">\n\t\t\t\t\t\t<div class="burgerItem active" id="burgerBurger">{{component(options.components.BurgerIcon)}}{{/component}}</div>\n\t\t\t\t\t\t<div class="burgerItem" id="burgerBack">{{component(options.components.BackIcon)}}{{/component}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="stSearch">\n\t\t\t\t\t\t{{component(options.components.SearchBox)}}{{/component}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="stOk" id="stOk">\n\t\t\t\t\t\t{{component(options.components.OkIcon)}}{{/component}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="rburger" id="rburger">\n\t\t\t\t\t\t<div class="burgerItem active" id="burgerBurger">{{component(options.components.BurgerIcon)}}{{/component}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="stTitle">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="sidebarContent" id="sidebarContent">\n\t\t\t\t\t{{component(options.components.SidebarMain)}}{{/component}}\n\t\t\t\t\t{{component(options.components.SidebarArchived)}}{{/component}}\n\t\t\t\t\t{{component(options.components.SidebarSearch)}}{{/component}}\n\t\t\t\t\t{{component(options.components.SidebarFolders)}}{{/component}}\n\t\t\t\t\t{{component(options.components.SidebarManageFolder)}}{{/component}}\n\t\t\t\t\t{{component(options.components.SidebarFolderPeers)}}{{/component}}\n\t\t\t\t</div>\n\t\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(4),a=s(26);t.exports=class extends i{constructor(t){super(t),this._components={messages:[],local:[],global:[]},this._events=[["click","sidebarSearch","onPeerClick"],["click","inPeerRemove","onPeerRemove"]],this._lastDataWithResults=null,this._lastSearch=null,this._avatarsMemory={},this._avatarsMemoryC={}}onPeerClick(t){const e=this.$(),s=t.target.closest(".scBlock");if(s&&e.contains(s)){const t=s.dataset.id,e=s.dataset.messageId,i=this._peerManager.peerById(t);this.emit("peer",{peer:i,messageId:e})}}avatarsToMemory(){const t=document.querySelector("#avmemory");this.$$(".scBlock").forEach(e=>{let s=e.dataset.id;this._avatarsMemory[s]||(this._avatarsMemory[s]=[],this._avatarsMemoryC[s]=0);let i=e.querySelector(".avatarBack");console.error(i.dataset.loaded),(e.dataset.loaded||i.dataset.loaded)&&(this._avatarsMemory[s].push(i),this._avatarsMemoryC[s]=this._avatarsMemory[s].length,t.appendChild(i))})}async doSearch(t){this._lastSearch=t;let e=await this._peerManager.search(t,this._data.inPeer);if(t!=this._lastSearch)return;this._components.messages=[],this._components.local=[],this._components.global=[];let s=!1;console.error(e);try{e&&(e.messages.length||e.local.length||e.global.length)||(e=this._lastDataWithResults)}catch(t){}if(e){if(e.messages)for(let i of e.messages)this._components.messages.push(this.newC(a,{peer:i.peer,peerMessage:i.peerMessage,search:t})),s=!0;if(e.local&&!this._data.inPeer)for(let i of e.local)i.hasMessages()&&(this._components.local.push(this.newC(a,{peer:i,search:t})),s=!0);for(let s of e.global)this._components.global.push(this.newC(a,{peer:s,search:t}))}s&&(this._lastDataWithResults=e),this.avatarsToMemory(),this.render(),this.$$(".wantmemory").forEach(t=>{let e=t.dataset.id;if(this._avatarsMemory&&this._avatarsMemory[e]&&this._avatarsMemory[e].length){let s=this._avatarsMemory[e].shift();s.dataset.loaded=1,console.error("appended cloned",s),t.appendChild(s)}})}template(){return'\n\t\t\t<div class="sidebarSearch sidebarBlock {{if (options.active)}} active{{/if}}" id="sidebarSearch">\n\t\t\t\t<div class="sidebarScroll">\n\t\t\t\t\t{{if (options.components.local.length)}}\n\t\t\t\t\t<div class="sidebarSearchBlock">\n\t\t\t\t\t\t<h3>Chats</h3>\n\n\t\t\t\t\t\t{{each(options.components.local)}}\n\t\t\t\t\t\t\t{{component(@this)}}{{/component}}\n\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t\t{{if (options.components.global.length)}}\n\t\t\t\t\t<div class="sidebarSearchBlock">\n\t\t\t\t\t\t<h3>Global Search</h3>\n\n\t\t\t\t\t\t{{each(options.components.global)}}\n\t\t\t\t\t\t\t{{component(@this)}}{{/component}}\n\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t\t{{if (options.components.messages.length)}}\n\t\t\t\t\t<div class="sidebarSearchBlock">\n\t\t\t\t\t\t<h3>Messages</h3>\n\n\t\t\t\t\t\t{{each(options.components.messages)}}\n\t\t\t\t\t\t\t{{component(@this)}}{{/component}}\n\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=window.classes.UI,a=s(3);class o extends i{constructor(t){if(super(t),this._components={},this._data.peer=t.peer,this._data.peerMessage=t.peerMessage,this._data.search=t.search,this._data.title=this.escapeHTML(t.peer.getDisplayName()),t.search&&!t.peerMessage){let e=a.guessWord(this._data.title,t.search);if(e){let t=this._data.title.toLowerCase().indexOf(e);this._data.title=this._data.title.substring(0,t)+"<span class='search'>"+this._data.title.substring(t,t+e.length)+"</span>"+this._data.title.substring(t+e.length)}if(this._data.info=t.peer.getInfoType(),!e){let s=t.peer._apiObject.username;s&&(e=a.guessWord(s,t.search),e&&(this._data.info="<span class='search'>@"+s+"</span>"))}}this._noDiv=!0}}o.template='\n\t\t\t<div class="scBlock" id="{{domId}}" title="{{peer._id}}" data-id="{{peer._id}}" {{if (options.peerMessage)}} data-message-id="{{peerMessage._id}}" {{/if}}>\n\n\t\t\t\t{{self.avHTML(options.peer)|safe}}\n\n\t\t\t\t<div class="scBlockMeta">\n\t\t\t\t\t{{if (options.peerMessage)}}\n\t\t\t\t\t<div class="scBlockTime" id="scblock_time_{{peer._id}}">{{peer.getDisplayTime(options.peerMessage._date)}}</div>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\n\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t<div class="scBlockTitle">{{title|safe}}</div>\n\t\t\t\t\t{{if (options.peerMessage)}}\n\t\t\t\t\t<div class="scBlockBody">{{peerMessage.getDisplayMessage(false, options.search)|safe}}</div>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t<div class="scBlockBody">{{info|safe}}</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t',t.exports=o},function(t,e,s){const i=s(4),a=s(15);t.exports=class extends i{constructor(t){super(t),this._components={SidebarDialogs:this.newC(a,{active:!0,filter:t=>t&&!t.isArchived()}),folders:{}},this._events=[["click","smFolders","onFolder"]],this._peerManager.on("folders",()=>{setTimeout(()=>{this.folders()},20)}),this._renderedFolders={},this._peerManager.on("folder",t=>{this._peerManager._folders[t.folderId]._isRemoved?this.removeFolder(t.folderId):this._renderedFolders[t.folderId]||this.folders()}),this._peerManager.on("initialPeer",t=>{this.isTouchDevice()||(this.setActivePeer(t.peer),this._app._interface.onPeerSelected({peer:t.peer}))}),this._components.SidebarDialogs.setActive(!0),this._updateBadgeTO={}}async updateBadge(t){if(!t){const t=[];for(let e in this._renderedFolders)t.push(this.updateBadge(this._peerManager._folders[e]));return await Promise.all(t)}let e=200;this._updateBadgeTO[t._id]&&(clearTimeout(this._updateBadgeTO[t._id]),e=1e3),this._updateBadgeTO[t._id]=setTimeout(async()=>{let e=await t.getBadgeCount();e?(this.$("#scFolderBadge_"+t._id).innerHTML=e,this.$("#scFolderBadge_"+t._id).classList.add("scBlockBadgeVisible")):this.$("#scFolderBadge_"+t._id).classList.remove("scBlockBadgeVisible")},e)}setActivePeer(t){for(let e in this._components.folders)this._components.folders[e].setActivePeer(t);this._components.SidebarDialogs.setActivePeer(t)}removeFolder(t){this._components.folders[t].$().remove(),delete this._renderedFolders[t],delete this._components.folders[t],this.$$(".smfItem").forEach(e=>{e.dataset.id==t&&e.remove()})}folders(){const t=this.$(".smfScroll"),e=this.$(".smDialogsFolders");for(let s in this._peerManager._folders){const i=this._peerManager._folders[s];this._renderedFolders[s]||1==s||(t.innerHTML+=`<div class="smfItem" data-id="${i._id}">${this.escapeHTML(i.title)}<div class="scBlockBadge" id="scFolderBadge_${i._id}">43</div></div>`,this._renderedFolders[s]=!0,this._components.folders[s]=this.newC(a,{active:!1,folder:i}),e.insertAdjacentHTML("beforeend",'<div class="smf" id="smf_'+s+'" data-id="'+s+'">'+this._components.folders[s].render({withDiv:!0})+"</div>"),this.updateBadge(i))}for(let t in this._renderedFolders)this._peerManager._folders[t]||this.removeFolder(t)}onFolder(t){const e=this.$("#smFolders");let s=event.target.closest(".smfItem");if(s&&e.contains(s)){this.selectFolder(s.dataset.id);let t=!1;this.$$(".smf").forEach(e=>{e.dataset.id==s.dataset.id?(t=!0,e.classList.add("active")):e.classList.remove("active")}),this._components.folders[s.dataset.id].setActive(!0)}}selectFolder(t){let e=null,s=null;this.$$(".smfItem").forEach(i=>{i.classList[i.dataset.id==t?"add":"remove"]("active"),e&&!s&&(s=i),i.dataset.id==t&&(e=i)});const i=this.$(".smFolders").scrollLeft,a=this.$("#smFolders").getBoundingClientRect();let o=0,n=(s||e).getBoundingClientRect();n.x+i+n.width+20>i+a.width&&(o=i+n.x-a.width+n.width+15),this.$(".smFolders").scrollLeft=o}afterRender(){}template(){return'\n\t\t\t<div class="SidebarMain sidebarBlock active">\n\t\t\t\t<div class="smFolders" id="smFolders">\n\t\t\t\t\t<div class="smfScroll">\n\t\t\t\t\t\t<div class="smfItem active" data-id="0">All</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="smDialogs smf active" data-id="0">\n\t\t\t\t\t{{component(options.components.SidebarDialogs)}}{{/component}}\n\t\t\t\t</div>\n\t\t\t\t<div class="smDialogsFolders">\n\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e){const s=window.classes.UI;class i extends s{constructor(t){super(t),this._components={},this._data.folder=t.folder,this._data.c="scblock_"+t.peer._id,this._data.peer=t.peer,this._noDiv=!0}rerender(){this._clearTypingTimeout&&clearTimeout(this._clearTypingTimeout),this.$(".scBlockBody").innerHTML=this._data.peer.getDisplayMessage(!0);const t=this._data.peer.hasReadBadge();let e="";!0===t?e='<div class="scBlockRead"><div class="i2checks"></div></div>':!1===t&&(e='<div class="scBlockRead"><div class="i1check"></div></div>'),this.$(".scBlockTime").innerHTML=e+this._data.peer.getDisplayTime();const s=this.$(".scBlockBadge");if(s){const t=this._data.peer._unreadCount;if(t)s.innerHTML=t,s.classList.add("scBlockBadgeVisible"),s.classList.remove("scBlockPinned"),this._data.peer.isMuted()?s.classList.add("scBlockMuted"):s.classList.remove("scBlockMuted");else{s.innerHTML="";this._data.folder&&this._data.folder.isPinned(this._data.peer)||!this._data.folder&&this._data.peer.isPinned()?(s.classList.add("scBlockPinned"),s.classList.add("scBlockBadgeVisible")):s.classList.remove("scBlockBadgeVisible")}}if(this._data.peer._peerUser){const t=this.$(".onlineBadge");t&&(this._data.peer._peerUser._isOnline?t.classList.add("online"):t.classList.remove("online")),this._data.peer._peerUser.isTyping()&&(this.$(".scBlockBody").innerHTML="typing...",this._clearTypingTimeout=setTimeout(()=>{this.$(".scBlockBody").innerHTML=this._data.peer.getDisplayMessage(!0)},1e4))}this.$(".scBlockTitle").innerHTML=this._data.peer.getDisplayNameWB(),this.$().dataset.date=this._data.peer._mostRecentMessageDate}}i.template='<div class="scBlock {{c}}" id="{{domId}}" title="{{peer._id}}" data-id="{{peer._id}}" data-date="{{peer._mostRecentMessageDate}}">\n\n\t\t\t\t{{self.avHTML(options.peer)|safe}}\n\n\t\t\t\t<div class="scBlockMeta">\n\t\t\t\t\t<div class="scBlockTime"><div class="scBlockRead">{{if (options.peer.hasReadBadge() === true)}}<div class="i2checks"></div>{{#else}}{{if (options.peer.hasReadBadge() === false)}}<div class="i1check"></div>{{/if}}{{/if}}</div>{{peer.getDisplayTime()}}</div>\n\t\t\t\t\t<div class="scBlockBadge {{if (options.peer.isMuted())}}scBlockMuted{{/if}} {{if ((options.folder && options.folder.isPinned(options.peer)) || (!options.folder && options.peer.isPinned()))  }} {{if (!options.peer.getUnreadCount())}}scBlockPinned{{/if}} scBlockBadgeVisible {{#else}} {{if (options.peer.getUnreadCount())}}scBlockBadgeVisible{{/if}} {{/if}}">{{if (options.peer.getUnreadCount())}}{{peer.getUnreadCount()}}{{/if}}</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t<div class="scBlockTitle">{{peer.getDisplayNameWB()|safe}}</div>\n\t\t\t\t\t<div class="scBlockBody">{{peer.getDisplayMessage(true)|safe}}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t',t.exports=i},function(t,e,s){const i=s(4),a=s(15);t.exports=class extends i{constructor(t){super(t),this._components={SidebarDialogs:this.newC(a,{active:!0,filter:t=>t&&t.isArchived()})},this._title="Archived",this._components.SidebarDialogs.setActive(!0)}setActivePeer(t){this._components.SidebarDialogs.setActivePeer(t)}afterRender(){}async getBadgeCount(){return await this._peerManager._folders[1].getBadgeCount()}template(){return'\n\t\t\t<div class="sidebarArchived sidebarBlock {{if (options.active)}} active{{/if}}">\n\t\t\t\t{{component(options.components.SidebarDialogs)}}{{/component}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(4);t.exports=class extends i{constructor(t){super(t),this._title="Chat Folders",this._events=[["click","sfpFolders","onFolder"],["click","sfpCreate","onNew"]],this._suggested=[]}onNew(){this._parent.showBlock("ManageFolder",{folder:this._peerManager.getEmptyFolder()})}onFolder(t){let e=t.target.closest(".sfpFolder").dataset.id;if(-1!=e.indexOf("rec_")){e=e.split("rec_").join(""),console.error(this._suggested);for(let t=0;t<this._suggested.length;t++)if(this._suggested[t].filter.id==e){const e=this._suggested[t].filter;this._suggested.splice(t,1),e.id=0,this._peerManager.createSuggestedFolder(e);break}t.target.closest(".sfpFolder").remove()}else this._parent.showBlock("ManageFolder",{folder:this._peerManager._folders[e]})}async init(){await this.sureSingle("init")||(this._suggested=await this._peerManager.getSuggestedFolders(),this._data.active=!0,this.render(),this.loadTGS("Folders_1"),this._peerManager.on("folders",()=>{this.updateFolders()}),this.updateFolders(),this.fulfilSingle("init",!0))}getFolderHTML(t){return'<div class="sfpFolder scBlock" id="sfpFolder_'+t._id+'" data-id="'+t._id+'"><span>'+this.escapeHTML(t.title)+'</span><div class="sfpDesc">'+t.info+"</div></div>"}updateFolders(){let t=this.$(".sfpFoldersList");const e=[];for(let s in this._peerManager._folders)if(1!=s){const i=this._peerManager._folders[s],a=this.$("#sfpFolder_"+s);a?(a.querySelector("span").innerHTML=this.escapeHTML(i.title),a.querySelector(".sfpDesc").innerHTML=i.info):t.insertAdjacentHTML("beforeend",this.getFolderHTML(i)),e.push(s)}console.error("showing",e),this.$$(".sfpFolder").forEach(t=>{console.error("showing",t),-1==t.id.indexOf("rec_")&&-1==e.indexOf(t.dataset.id)&&t.remove()}),t=this.$(".sfpRecommendedList");for(let e of this._suggested)this.$("#sfpFolder_rec_"+e.filter.id)||t.insertAdjacentHTML("beforeend",this.getFolderHTML({_id:"rec_"+e.filter.id,title:e.filter.title,info:e.description}))}afterActive(){this.nextTick(()=>{this.init()})}template(){return'\n\t\t\t<div class="sidebarFolders sidebarBlock {{if (options.active)}} active{{/if}}" id="sidebarFolders">\n\t\t\t{{if (!options.active)}}\n\t\t\t\t<div class="appLoading">\n\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t</div>\n\t\t\t{{#else}}\n\t\t\t\t<div class="sidebarScroll">\n\t\t\t\t\t<div class="sfpIcon tgs"></div>\n\t\t\t\t\t<div class="sfpInfo">Create folders for different groups of chats<br>and quickly switch between them.</div>\n\t\t\t\t\t<div class="sfpCreate" id="sfpCreate">\n\t\t\t\t\t\t<div class="sfpCreateIcon">{{self.AppUI.getIconHTML(\'plus\')|safe}}</div>\n\t\t\t\t\t\tCreate Folder\n\t\t\t\t\t</div>\n\t\t\t\t\t<div id="sfpFolders">\n\t\t\t\t\t<div class="sfpFolders">\n\t\t\t\t\t\t<h4>Folders</h4>\n\t\t\t\t\t\t<div class="sfpFoldersList">\n\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sfpRecommended">\n\t\t\t\t\t\t<h4>Recommended folders</h4>\n\n\t\t\t\t\t\t<div class="sfpRecommendedList">\n\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(4),a=window.classes.UIInput,o=s(8),n=window.classes.Icon;t.exports=class extends i{constructor(t){super(t),this._back="Folders",this._title="Folders",this._components.Title=this.newC(a,{label:"Folder Name"}),this._components.IconDown=this.newC(n,{flip:!0}),this._events=[["click","scBlockAdd"+this._domId,"onInclude"],["click","scBlockMore_include"+this._domId,"onInclude"],["click","scBlockRemove"+this._domId,"onExclude"],["click","scBlockMore_exclude"+this._domId,"onExclude"]]}async onMenu(t){"delete"==t&&(await this._folder.remove(),this._parent.onBurger())}afterUnActive(t){this.persist()}onOk(){this._parent.onBurger()}onExclude(){this._parent.showBlock("FolderPeers",{folder:this._folder,exclude:!0})}onInclude(){this._parent.showBlock("FolderPeers",{folder:this._folder})}persist(){this._folder&&(this._folder._apiObject.title=this._components.Title.val(),this._folder.persist())}async init(t={}){t.folder?this._folder=t.folder:this.persist(),this._data.active=!0,this._cs={include:{},exclude:{}},this.render(),this.loadTGS("Folders_2",!0),this._components.Title.val(this._folder.title),this._parent.setTitle((this._folder._id?"Edit":"New")+" Folder",!0,!!this._folder._id&&[["delete","delete","Delete Folder"]])}async rerender(){await this._folder.getPeers();let t=["bots","contacts","non_contacts","groups","broadcasts"],e=0;const s=(t,e)=>{e.style.display=t.length?"block":"none",e.querySelector(".scBlockTitle").innerHTML="Show "+t.length+" more chat"+(t.length>1?"s":"")},i=(e,s)=>{let i=0;for(let a of t)if(!e[a]&&this._folder._apiObject.pFlags[a]){const t=this.newC(o,{type:a.split("exclude_").join("")});e[a]=t,i++,s.insertAdjacentHTML("beforeend",t.render({withdiv:!0,noDOM:!0}))}else e[a]&&(this._folder._apiObject.pFlags[a]?i++:(this.$("#"+e[a]._domId).remove(),delete e[a]));return i};e=i(this._cs.include,this.$(".sfpFoldersList_include")),s(this._folder._apiObject.include_peers,this.$(".scBlockMore_include")),t=["exclude_muted","exclude_read","exclude_archived"],i(this._cs.exclude,this.$(".sfpFoldersList_exclude")),s(this._folder._apiObject.exclude_peers,this.$(".scBlockMore_exclude")),this.reinitScrollBar(!0)}afterRender(){this._data.active&&(this.rerender(),setTimeout(()=>{this.rerender()},2e3))}afterActive(t){this.nextTick(()=>{this.init(t)})}template(){return'\n\t\t\t<div class="manageFolder sidebarBlock {{if (options.active)}} active{{/if}}" id="manageFolder_{{domId}}">\n\t\t\t{{if (!options.active)}}\n\t\t\t\t<div class="appLoading">\n\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t</div>\n\t\t\t{{#else}}\n\t\t\t\t<div class="sidebarScroll">\n\t\t\t\t\t<div class="sfpIcon tgs"></div>\n\t\t\t\t\t<div class="sfpInfo">Choose chats and types of chats that will<br> appear and never appear in this folder.</div>\n\t\t\t\t\t<div class="sfpTitle">{{component(options.components.Title)}}{{/component}}</div>\n\n\t\t\t\t\t<div class="sfpFolders sfpFoldersManage">\n\t\t\t\t\t\t<h4>Included chats</h4>\n\n\t\t\t\t\t\t<div class="scBlock scBlockAdd scBlockType"  id="scBlockAdd{{domId}}">\n\t\t\t\t\t\t\t<div class="scBlockIcon">{{self.AppUI.getIconHTML(\'plus\')|safe}}</div>\n\t\t\t\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t\t\t\t<div class="scBlockTitle">Add Chats</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="sfpFoldersList">\n\t\t\t\t\t\t\t<div class="sfpFoldersList_include">\n\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="scBlock scBlockMore scBlockMore_include scBlockType"  id="scBlockMore_include{{domId}}">\n\t\t\t\t\t\t\t<div class="scBlockIcon">{{component(options.components.IconDown)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t\t\t\t<div class="scBlockTitle"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="sfpFolders sfpFoldersManage">\n\t\t\t\t\t\t<h4>Excluded chats</h4>\n\n\t\t\t\t\t\t<div class="scBlock scBlockRemove scBlockType" id="scBlockRemove{{domId}}">\n\t\t\t\t\t\t\t<div class="scBlockIcon">{{self.AppUI.getIconHTML(\'delete\')|safe}}</div>\n\t\t\t\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t\t\t\t<div class="scBlockTitle">Remove Chats</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="sfpFoldersList">\n\t\t\t\t\t\t\t<div class="sfpFoldersList_exclude">\n\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="scBlock scBlockMore scBlockMore_exclude scBlockType"  id="scBlockMore_exclude{{domId}}">\n\t\t\t\t\t\t\t<div class="scBlockIcon">{{component(options.components.IconDown)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t\t\t\t<div class="scBlockTitle">Show 18 more chats</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\n\t\t\t\t</div>\n\n\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(4),a=s(8),o=s(0);t.exports=class extends i{constructor(t){super(t),this._title="Peers",this._back="ManageFolder",this._hasOk=!0,this._components={CloseIcon:this.newC(o,{icon:"close"}),peerBlocks:[]},this._events=[["keydown","forwardFilter"+this._domId,"onFilter"],["click","sidebarForwardSelectedItem_1"+this._domId,"removePeer1"],["click","sidebarForwardSelectedItem_2"+this._domId,"removePeer2"],["click","sidebarForwardPeers"+this._domId,"onPeerClick"],["click","sidebarForwardTypes"+this._domId,"onTypeClick"]],this._selectedPeers=[],this._initializedPeersIds=[],this._filterQ="",this._hasMePeer=!1,this._apiPath="include_peers"}async init(t){this._folder=t?t.folder:null,this._data.active=!0,this._cs={include:{},exclude:{}},this._posa=["bots","contacts","non_contacts","groups","broadcasts"],this._apiPath="include_peers",t.exclude&&(this._posa=["exclude_muted","exclude_read","exclude_archived"],this._apiPath="exclude_peers"),this._selectedPeers=[],await this.initPeers(),this.render(),this.appendPeers(),this.peersChanged()}afterActive(t){this._params=t,this.nextTick(()=>{this.init(t)}),this._parent.setTitle((t.exclude?"Ex":"In")+"cluded Chats",!0)}isPeerSelected(t){for(let e of this._selectedPeers){if(e._id&&t._id&&e._id==t._id)return!0;if(!e._id&&!t._id&&e==t)return!0}}togglePeer(t,e){if(t._id)e?this.isPeerSelected(t)||(this._selectedPeers.push(t),this._folder.appPeerAPI(t,this._apiPath)):(this._selectedPeers=this._selectedPeers.filter((function(e){return!e._id||e._id!=t._id})),this._folder.removePeerAPI(t,this._apiPath));else{let s=this._params.exclude?"exclude_"+t:t;this._folder._apiObject[s]=e,this._folder._apiObject.pFlags[s]=e,e?this.isPeerSelected(t)||this._selectedPeers.push(s):this._selectedPeers=this._selectedPeers.filter((function(e){return e._id||e!=t}))}}onTypeClick(t){const e=t.target.closest(".scBlock").dataset.id;for(let t in this._cs.include){const s=this._cs.include[t];if(s._data.type==e){let t=s.toggle();this.togglePeer(e,t),this.peersChanged()}}}onPeerClick(t){const e=t.target.closest(".scBlock").dataset.id,s=this._peerManager.peerById(e);for(let t of this._components.peerBlocks)if(t._data.peer._id==e){let e=t.toggle();this.togglePeer(s,e),this.peersChanged()}}onOk(){this._parent.onBurger()}setPeerViewItem(t,e){console.error(t);let s="";if(t.getDisplayName){let e=t.getDisplayName();s=this.escapeHTML(e.split(" ")[0])}else s=t.split("exclude_").join(""),s=s.charAt(0).toUpperCase()+s.slice(1).split("_").join("&nbsp;");e.querySelector("span").innerHTML=s,t.isMine&&t.isMine()?(e.querySelector(".avatarBack").style.backgroundImage="",e.querySelector(".avatarBack").classList.add("avatarMine")):(e.querySelector(".avatarBack").classList.remove("avatarMine"),t.hasAvatar?(t.hasAvatar()?e.querySelector(".avatarBack").style.backgroundImage="url('"+t.getAvatarBlobURLSync()+"')":(e.querySelector(".avatarBack").style.backgroundImage="none",e.querySelector(".avatarInitials").innerHTML=this.escapeHTML(t.getAvatarInitials()),e.querySelector(".avatarInitials").classList="avatarInitials avatarC"+t.getAvatarColor()),e.querySelector(".avatarInitials").classList.remove("avatarType")):(e.querySelector(".avatarInitials").classList.add("avatarType"),e.querySelector(".avatarBack").style.backgroundImage="none",e.querySelector(".avatarInitials").innerHTML=this.AppUI.getIconHTML(t.split("exclude_").join(""))))}peersChanged(){if(console.error(this._selectedPeers),this._selectedPeers.length)if(this.setPeerViewItem(this._selectedPeers[0],this.$(".sidebarForwardSelectedItem_1")),this.$(".sidebarForwardSelectedItem_1").style.display="block",2==this._selectedPeers.length)this.$(".sidebarForwardSelectedItem_more").style.display="none",this.$(".sidebarForwardSelectedItem_2").style.display="block",this.setPeerViewItem(this._selectedPeers[1],this.$(".sidebarForwardSelectedItem_2"));else if(1==this._selectedPeers.length)this.$(".sidebarForwardSelectedItem_2").style.display="none",this.$(".sidebarForwardSelectedItem_more").style.display="none";else{this.setPeerViewItem(this._selectedPeers[1],this.$(".sidebarForwardSelectedItem_2")),this.$(".sidebarForwardSelectedItem_2").style.display="block",this.$(".sidebarForwardSelectedItem_more").style.display="block";let t=this._selectedPeers.length-2;this.$(".sidebarForwardSelectedItem_more").querySelector(".avatarInitials").innerHTML="+"+t}else this.$(".sidebarForwardSelectedItem_1").style.display="none",this.$(".sidebarForwardSelectedItem_2").style.display="none",this.$(".sidebarForwardSelectedItem_more").style.display="none"}removePeer(t){if(this._selectedPeers.length>t){let e=this._selectedPeers.splice(t,1);if(e.length){this.togglePeer(e[0],!1);for(let t of this._components.peerBlocks)t._data.peer._id==e[0]._id&&t.off();for(let t in this._cs.include)t==e[0]&&this._cs.include[t].off()}}this.peersChanged()}removePeer1(){this.removePeer(0)}removePeer2(){this.removePeer(1)}filterDOM(){let t=this.$$(".scBlock");for(let e of t)this._filterQ&&(!e.dataset||e.dataset.search&&-1==e.dataset.search.indexOf(this._filterQ))?e.style.display="none":e.style.display="block"}onFilter(){this.nextTick(()=>{this._filterQ=(""+this.$(".forwardFilter").value).trim().toLowerCase(),this.loadMorePeers(),this.filterDOM()})}initPeers(){this._components.peerBlocks=[],this._initializedPeersIds=[];for(let t of this._app._peerManager._sortedPeers)t._peerUser&&t._peerUser.isMe()?(this._hasMePeer=!0,this._components.peerBlocks.unshift(this.newC(a,{peer:t,info:t.getInfoType()}))):t.readyToUse()&&this._components.peerBlocks.push(this.newC(a,{peer:t,info:t.getInfoType()})),this._initializedPeersIds.push(t._id);return this._components.peerBlocks}async fullfillPeers(){let t=0;const e=this.$(".sidebarScroll"),s=this.$(".sidebarForwardPeers");try{if(!this._hasMePeer){await this._peerManager.getMePeer()&&(this._hasMePeer=!0)}}catch(t){console.error(t)}this.appendPeers();do{t++,e.clientHeight>s.clientHeight&&this._peerManager._thereReMorePeers&&(await new Promise(t=>{setTimeout(t,500)}),await this.loadMorePeers())}while(t<3)}appendPeers(){const t=this.$(".sidebarForwardPeers");for(let e of this._app._peerManager._sortedPeers)if(-1===this._initializedPeersIds.indexOf(e._id)){if(console.error(e._id),e.canSendMessageTo()){let s=this.newC(a,{peer:e}),i=s.render();this._folder.isPeerIn(e,this._apiPath)?t.insertAdjacentHTML("afterbegin",i):t.insertAdjacentHTML("beforeend",i),this._components.peerBlocks.push(s)}else console.error(e);this._initializedPeersIds.push(e._id)}this.rePeers()}rePeers(){for(let t of this._components.peerBlocks)this._folder.isPeerIn(t._data.peer,this._apiPath)?(t.on(),this._selectedPeers.push(t._data.peer)):t.off();this.peersChanged()}async loadMorePeers(){let t=this._filterQ;if(this.$(".loadingMore").classList.add("active"),t){await this._peerManager.search(t)}else await this._peerManager.loadPeers();this.appendPeers(),this.filterDOM(),this.$(".loadingMore").classList.remove("active")}async rerender(){let t=0;t=((e,s)=>{for(let t of this._posa){if(!e[t]){const i=this.newC(a,{type:t.split("exclude_").join("")});e[t]=i,s.insertAdjacentHTML("beforeend",i.render({withdiv:!0,noDOM:!0}))}this._folder._apiObject.pFlags[t]?(e[t].on(),this._selectedPeers.push(t)):e[t].off()}return this.peersChanged(),t})(this._cs.include,this.$(".sfpFoldersList_include")),this.reinitScrollBar(!0)}afterRender(){this._data.active&&this.rerender()}template(){return'\n\t\t\t<div class="manageFolder sidebarBlock {{if (options.active)}} active{{/if}}" id="manageFolder_{{domId}}">\n\t\t\t{{if (!options.active)}}\n\t\t\t\t<div class="appLoading">\n\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t</div>\n\t\t\t{{#else}}\n\t\t\t\t<div class="sidebarScroll">\n\n\t\t\t\t<div class="sidebarForwardSelector">\n\t\t\t\t\t<div class="sidebarForwardSelectedItem sfsiRemovable sidebarForwardSelectedItem_1" id="sidebarForwardSelectedItem_1{{domId}}">\n\n\t\t\t\t\t\t<div class="avatar avatarSmall visible">\n\t\t\t\t\t\t\t<div class="avatarBack"></div>\n\t\t\t\t\t\t\t<div class="avatarInitials avatarC3">K</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="peerClose">{{component(options.components.CloseIcon)}}{{/component}}</div>\n\n\t\t\t\t\t\t<span>n</span>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sidebarForwardSelectedItem sfsiRemovable sidebarForwardSelectedItem_2" id="sidebarForwardSelectedItem_2{{domId}}">\n\n\t\t\t\t\t\t<div class="avatar avatarSmall visible">\n\t\t\t\t\t\t\t<div class="avatarBack"></div>\n\t\t\t\t\t\t\t<div class="avatarInitials avatarC2">J</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="peerClose">{{component(options.components.CloseIcon)}}{{/component}}</div>\n\n\t\t\t\t\t\t<span>n</span>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sidebarForwardSelectedItem sidebarForwardSelectedItem_more">\n\n\t\t\t\t\t\t<div class="avatar avatarSmall visible">\n\t\t\t\t\t\t\t<div class="avatarBack"></div>\n\t\t\t\t\t\t\t<div class="avatarInitials avatarC4">+3</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<span>more</span>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sidebarForwardSelectorInput"><input type="text" placeholder="Select chat" class="forwardFilter" id="forwardFilter{{domId}}"></div>\n\t\t\t\t</div>\n\n\n\t\t\t\t\t<div class="sfpFolders sfpFoldersManage sfpFoldersEdit" id="sidebarForwardTypes{{domId}}">\n\t\t\t\t\t\t<h4>Chat types</h4>\n\n\t\t\t\t\t\t<div class="sfpFoldersList">\n\t\t\t\t\t\t\t<div class="sfpFoldersList_include">\n\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="sfpFolders sfpFoldersManage sfpFoldersEdit">\n\t\t\t\t\t\t<h4>Chats</h4>\n\n\t\t\t\t\t\t<div class="sfpFoldersList">\n\t\t\t\t\t\t\t<div class="sfpFoldersList_exclude sidebarForwardPeers" id="sidebarForwardPeers{{domId}}">\n\t\t\t\t\t\t\t\t{{each(options.components.peerBlocks)}}\n\t\t\t\t\t\t\t\t\t{{component(@this)}}{{/component}}\n\t\t\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="loadingMore">\n\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\n\t\t\t\t</div>\n\n\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(34),a=s(35),o=s(47),n=(s(6),s(49)),r=s(5);t.exports=class extends i{constructor(t){super(t),this._peerManager=this._app._peerManager,this._events=[["scroll","panelMessages","onScroll"],["click","panelPush","onMessageClick"],["mousemove","panelPush","onMessageMove"],["touchstart","panelPush","onTouchStart"],["touchmove","panelPush","onTouchMove"],["contextmenu","panelPush","onMessageContext"]],this._components.NewMessage=this.newC(o),this._components.StickersPopup=this.newC(n),this._components.MessageMenu=this.newC(r,{items:[["reply","reply","Reply"],["copy","copy","Copy"],["forward","forward","Forward"]]}),this._componentEvents=[["submitMessage","NewMessage","onSubmitMessage"],["sendVoice","NewMessage","onSendVoice"],["sendFiles","NewMessage","onSendFiles"],["mode","NewMessage","onNewMessageHeight"],["reply","MessageMenu","onSetReply"],["forward","MessageMenu","onSetForward"],["copy","MessageMenu","onCopy"]],this._components.messages=[],this._components.searchmessages=[],this._cIds={},this._theOldestMessageDate=null,this._data.peer=t.peer||null,this._data.isLoading=!0,this._data.sidebarIsClosed=!0;let e=t=>{this.docStatus(t)};this._peerManager._download.on("downloaded",e),this._peerManager._download.on("progress",e),this._peerManager.on("readybypeer",t=>{if(t.peer._id==this._data.peer._id)for(let t of this._data.peer._messagesVisible)t.seenByPeer()&&t.isFromMe()&&this._cIds[t._id]&&this._cIds[t._id].markAsRead()})}onCopy(t){this._components.MessageMenu._peerMessage.copyToClipboard()}onSetForwardMedia(t){this._parent._components.RightSidebar.showBlock("Forward",{messageMedia:t.messageMedia}),this._parent._components.RightSidebar.show(),this._parent._components.RightSidebar.moveToTop()}onSetForward(){this._components.MessageMenu&&this._components.MessageMenu._peerMessage&&(this._parent._components.RightSidebar.showBlock("Forward",{peerMessage:this._components.MessageMenu._peerMessage}),this._parent._components.RightSidebar.show())}onForward(t){if(t&&t.peers)for(let e of t.peers)t.peerMessage?e.forwardMessage(t.peerMessage):t.messageMedia?e.forwardMessageMedia(t.messageMedia):t.botResults&&e.forwardBotResult(t.botResults)}onButtonBotResults(t){this._parent._components.RightSidebar.showBlock("Forward",{botResults:t}),this._parent._components.RightSidebar.show()}onSetReply(){this._components.MessageMenu&&this._components.MessageMenu._peerMessage&&this._components.NewMessage&&this._components.NewMessage.setReplyToMessage(this._components.MessageMenu._peerMessage)}onSendVoice(){this._data.peer.sendRecordedVoice()}onNewMessageHeight(t){const e=this.$("#panelMessages");"small"==t?(e.classList.remove("panelMessagesLarge"),e.classList.remove("panelMessagesHuge")):"large"==t?(e.classList.add("panelMessagesLarge"),e.classList.remove("panelMessagesHuge")):"huge"==t&&(e.classList.remove("panelMessagesLarge"),e.classList.add("panelMessagesHuge"))}docStatus(t){let e=this.$$(".rsDoc_"+t.id);for(let s of e){let e=s.querySelector(".progress");if(s)if(t._isDownloaded)e.className="progress",e.classList.add("progress100"),s.querySelector(".rsDocMeta").innerHTML=""+t.getInfo("sizeHuman"),s.querySelector(".rsDocIcon").classList.remove("loading"),s.querySelector(".rsDocIcon").classList.add("ready");else if(t._isDownloading){s.querySelector(".rsDocMeta").innerHTML=t._downloadingPercentage+"% &bull; "+t._downloadingSizeHuman+" of "+t.getInfo("sizeHuman");let i=10*Math.floor(t._downloadingPercentage/10);e.className="progress",e.classList.add("active"),e.classList.add("progress"+i),s.querySelector(".rsDocIcon").classList.add("loading")}else s.querySelector(".rsDocIcon").classList.remove("loading"),s.querySelector(".rsDocIcon").classList.remove("ready"),s.querySelector(".rsDocMeta").innerHTML=""+t.getInfo("sizeHuman"),e.classList.remove("active")}}afterRender(){this.reinitScrollBar(!0)}reinitScrollBar(t){let e=this.$(".panelMessages");this.initScrollBarOn(e,t)}onSendFiles(t){this._data.peer.sendFiles(t.files,t.caption)&&this.messagesLoaded()}async loadThumbs(){if(this._data.peer){console.time("loading previews from cache");let t=this._data.peer;if(await this._data.peer.loadPreviewsFromCache(),this._data.peer._id==t._id){for(let t of this._data.peer._messagesVisible)t._previewProcessed=!1;this._hasMoreThumbsToPreview=!0}console.timeEnd("loading previews from cache")}}async loadNextThumb(){if(!this._hasMoreThumbsToPreview)return!1;let t=this._data.peer._id,e=!1,s=async(t,e)=>{if(t._media){if(!t._media.cached){let s=await t._media.loadPreview(e);return s&&this.sendDataToMessage(t,"photoLoaded",s),!0}this.sendDataToMessage(t,"photoLoaded",t._media.blobURL)}if(t._sticker){if(!t._sticker.cached)return await t._sticker.load(e),this.sendDataToMessage(t,"stickerLoaded",t._sticker),!0;this.sendDataToMessage(t,"stickerLoaded",t._sticker),await new Promise(t=>{setTimeout(t,10)})}if(t._webpage)if(t._webpage.cached)this.sendDataToMessage(t,"webpagePhotoLoaded",t._webpage);else if(console.error("webpage photo was not cached"),t._webpage.getInfo("hasPhoto"))return await t._webpage.loadPhoto(e),this.sendDataToMessage(t,"webpagePhotoLoaded",t._webpage),!0};e=await(async t=>{const e=t.length-1,i=e;let a=[],o=1;for(let n=0;n+i<=e||i-n>=0;n++){if(t[i-n]&&!t[i-n]._previewProcessed){const e=t[i-n];a.push(s(e,o++)),e._previewProcessed=!0}if(t[i+n]&&!t[i+n]._previewProcessed){const e=t[i+n];a.push(s(e,o++)),e._previewProcessed=!0}if(o>=3){if(-1!=(await Promise.all(a)).indexOf(!0))return!0;a=[]}}if(a.length){if(-1!=(await Promise.all(a)).indexOf(!0))return!0}return!1})(this._data.peer._messagesVisible),e?this._moreThumbsTimeout=setTimeout(()=>{this.loadNextThumb()},100):this._data.peer._id==t&&(this._hasMoreThumbsToPreview=!1)}onMessageToJump(t){this.jumpToMessage(t.messageId)}onTouchStart(t){t.touches&&(clearTimeout(this._ltt),this._ltt=setTimeout(()=>{const e=new MouseEvent("contextmenu",{bubbles:!0,cancelable:!0,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY});t.target.dispatchEvent.call(t.target,e)},1200))}onTouchMove(){clearTimeout(this._ltt)}onMessageContext(t){t.preventDefault(),clearTimeout(this._ltt);const e=this.$();let s=event.target.closest(".panelMessage");if(s||(s=event.target.closest(".panelMessageSticker")),s&&e.contains(s)){const e=s.dataset.id;let i=null;this._data.peer._messageIds[e]?i=this._data.peer._messageIds[e]:this._cIds[e]&&(i=this._cIds[e]._data.message),this._components.MessageMenu.show(t),this._components.MessageMenu._peerMessage=i}return!1}onMessageMove(t){let e=t.target.closest(".messageMove");if(e&&e.dataset.moveaction){const t=e.dataset.id;let s=null;this._data.peer._messageIds[t]?s=this._data.peer._messageIds[t]:this._cIds[t]&&(s=this._cIds[t]._data.message),s&&"heat"==e.dataset.moveaction&&s.heatServersUp()}}onMessageClick(t){clearTimeout(this._ltt);const e=this.$();let s=t.target.closest(".messageAction");if(s&&e.contains(s)){const t=s.dataset.id;let e=null;this._data.peer._messageIds[t]?e=this._data.peer._messageIds[t]:this._cIds[t]&&(e=this._cIds[t]._data.message);const i=s.dataset.action||null;"gotouser"==i&&this.emit("goto",{message:e,what:"author"}),"gotoforw"==i?this.emit("goto",{message:e}):"button"==i?e.doButton(s.dataset.n).then(t=>{t&&t._&&this.onButtonBotResults(t)}):"jump"==i?this.jumpToMessage(t):e&&(e._media?e._media.isRoundVideo()||e._media.isGIF()?this._cIds[e._id]&&this._cIds[e._id].clickHandler():this._app._interface._components.MediaBrowser.show({from:this.$("#messageMedia_"+t)||this.$("#messageAlbumItem_"+t)||this.$("#message_"+t),media:e._media,mediaItems:this._data.peer._media,peer:this._data.peer}):e._doc?e._doc._isDownloaded?e._doc.save():e._doc._isDownloading?(this._peerManager._download.cancel(e._doc),this.docStatus(e._doc)):(this._peerManager._download.schedule(e._doc),this.docStatus(e._doc)):e._sticker&&this._components.StickersPopup.show({peerManager:this._peerManager,sticker:e._sticker}))}}onSticker(t){this._data.peer.sendSticker(t)}onGIF(t){this._data.peer.sendGif(t)}onEmoji(t){this._components.NewMessage.onEmoji(t)}onSubmitMessage(t){this._data.peer.sendMessage(t)}sendDataToMessage(t,e,s){this._cIds[t._id]&&this._cIds[t._id][e]&&this._cIds[t._id][e](s)}scrollToMessage(t){let e=this.$("#message_"+t);const s=this.$(".panelMessages");if(e&&s){let t=e.offsetTop;s.scrollTop=t-200,this._browsingSearchMessagesStartTime=new Date,this._browsingSearchMessagesScrollTop=s.scrollTop}}setPeer(t,e){if(this._data.peer&&this._data.peer._id==t._id)return e&&this.jumpToMessage(e),!0;if(!t)return!1;this._overflows={bottom:0,top:0,topIds:{},bottomIds:{}},this._searchMessageId=e||null;for(let t of this._components.messages)t.cleanUp();this._cIds={},this._components.messages=[],this._data.peer=t,this._data.isLoading=!0,this._data.peer._messages.length?this._data.peer.setBaseMessage(this._data.peer._messages[this._data.peer._messages.length-1]):this._data.peer.setBaseMessage(null),this._theOldestMessageDate=null,t.on("messages",()=>{this.messagesLoaded()}),t.on("update",()=>{this.messagesLoaded()}),t.on("updateMessage",t=>{this._cIds[t.id]&&this._cIds[t.id].updateContent()}),t.on("groupUpdated",t=>{t.groupMessages.forEach(t=>{this._cIds[t._id]&&this._cIds[t._id].rerender()})}),t.on("delete",t=>{if(this._cIds[t.id]){const e=this._cIds[t.id].destroy();this.$("#panelMessages").scrollTop-=e,this._cIds[t.prevMessageId]&&this._cIds[t.prevMessageId].setSameAsNext(!1)}}),this._app._config.getSetting("rightSidebarVisible")?this._data.sidebarIsClosed=!1:this._data.sidebarIsClosed=!0,this._data.messagesLoaded=!1,t._fullInfoLoaded&&(this._data.messagesLoaded=!0),this.render(),t._messagesWereLoaded?(t.trimMessagesToRecent(),this.messagesLoaded()):t._messagesWereRestored?(this.messagesLoaded(),t.makeReady()):t.makeReady(),this._peerManager.setActivePeer(t),this.nextTick(()=>{this._app._router.hashPeer(t)})}async jumpToMessage(t,e){console.error("jumping to message: "+t),this._searchMessageId=t,this._searchMessageHigh=e,await this._data.peer.searchMessage(t)}appendMessagesHTML(t,e){t||(t=this._data.peer._messagesVisible);let s=!1,i=null;const o=this.$("#messageOverflowTop"),n=this.$("#messageOverflowBottom");let r=null;if(o&&n){i=this.$("#panelMessages").scrollHeight-this.$("#panelMessages").scrollTop;let d=null,l="",h="";const c=[],p=[];this._data.peer.calcDates();for(let i=0,o=t.length;i<o;i++){let n=t[i];if(!this._cIds[n._id]){let t=!0;if((null===d||d>n._apiObject.date)&&(d=n._apiObject.date),n._id<this._data.peer.getBaseMessage()._id&&(t=!1),t){let t=i>0?this._data.peer._messagesVisible[i-1]:null;if(t&&t.getAuthorId()==n.getAuthorId()){let e=(""+t._id).split(".").join("_");this.$("#message_"+e)&&this.$("#message_"+e).classList.add("sameAsNext")}}let _=i<o-1?this._data.peer._messagesVisible[i+1]:null,m=i>0?this._data.peer._messagesVisible[i-1]:null;const u=this.newC(a.factory(n),{message:n,nextMessage:_,prevMessage:m});c.push(u),e&&(u.isSearchedMessage=!0),this._cIds[n._id]=u,p.push(n._id);const g=u.render({withDiv:!0});t?(h+=g,r=u):l+=g,e?this._components.searchmessages.push(u):this._components.messages.push(u),s=!0}}if(h&&n.insertAdjacentHTML("beforebegin",h),l&&o.insertAdjacentHTML("afterend",l),p.length){if(this.reduceOverflows(p)&&l&&i){const t=this.$("#panelMessages");t.scrollTop=t.scrollHeight-i}}for(let t of c)t.assignDomEvents();e||(null!==d&&(d<this._theOldestMessageDate||null==this._theOldestMessageDate)&&(this._theOldestMessageDate=d),r&&r.wasRecent&&r.wasRecent());let _=[];for(let t in this._cIds)-1==this._data.peer._messagesVisibleIds.indexOf(Number(t))&&_.push(t);_.length&&this.removeKeepingScroll(_)}return s}async messagesLoaded(){const t=this.$(".loadingMore");t&&t.classList.remove("active"),this._data.peer.recalcVisible();let e=!1;if(this._data.isLoading?(this._data.isLoading=!1,e=this.appendMessagesHTML(),this.$("#panel").classList.add("panelLoaded"),this.scrollToTheBottom()):e=this.appendMessagesHTML(),this._searchMessageId){let t=this.$("#message_"+this._searchMessageId);const e=this.$(".panelMessages");if(t&&e){let s=t.offsetTop;e.scrollTop=s-200,this._cIds[this._searchMessageId]&&this._cIds[this._searchMessageId].highText(this._searchMessageHigh),this._searchMessageId=null}else this.jumpToMessage(this._searchMessageId)}else this.nextTick(async()=>{const t=this.$("#panelMessages");t&&t.scrollHeight&&t.offsetHeight&&t.scrollTop+t.offsetHeight>t.scrollHeight-500&&this.scrollToTheBottom(),setTimeout(()=>{this._data.peer.markAsRead(!0)},500)});e&&(this._hasMoreThumbsToPreview=!0,await this.loadThumbs(),this.nextTick(()=>{this.loadNextThumb()}))}showNotice(t,e){console.error(t),this.__noticeTimeout&&clearTimeout(this.__noticeTimeout),this.$(".panelNotice").classList.add("active"),this.$("#panelNoticeIcon").innerHTML=this.AppUI.getIconHTML(e),this.$("#panelNoticeContent").innerHTML=t,this.__noticeTimeout=setTimeout(()=>{this.$(".panelNotice").classList.remove("active")},3e3)}scrollToTheBottom(){const t=this.$(".panelMessages");t&&(t.scrollTop=t.scrollHeight)}template(){return'\n\t\t\t<div class="panel panelPos {{if (!options.peer)}}panelNothing{{/if}} {{if (options.sidebarIsClosed)}}panelNoSidebar{{/if}} {{if (options.messagesLoaded)}}panelLoaded{{/if}}" id="panel">\n\t\t\t\t{{if (!options.peer)}}\n\t\t\t\t{{#else}}\n\t\t\t\t\t<div class="panelLoading">\n\t\t\t\t\t\t<div class="appLoading">\n\t\t\t\t\t\t\t<div class="cssload-zenith onDark"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="panelContent">\n\t\t\t\t\t\t\t<div class="panelNotice">\n\t\t\t\t\t\t\t\t<div><span id="panelNoticeIcon"></span><span id="panelNoticeContent"></span></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="panelMessages {{if (!options.peer.canSendMessageTo())}}panelMessagesFull{{/if}}" id="panelMessages">\n\n\n\t\t\t\t\t\t\t<div class="loadingMore">\n\t\t\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t<div class="panelMessagesContainer {{if (options.peer._type == \'channel\' && !options.peer.canSendMessageTo())}}panelChannel{{/if}}" id="panelMessagesContainer">\n\t\t\t\t\t\t\t\t\t<div class="panelPush" id="panelPush">\n\n\t\t\t\t\t\t\t\t\t<svg height="0" width="0">\n\t\t\t\t\t\t\t\t\t\t<defs>\n\t\t\t\t\t\t\t\t\t\t\t<clipPath id="leftBubble">\n\t\t\t\t\t\t\t\t\t\t\t\t<path d="M 14,0 A 14,14 0 0 1 0,14 H 14 V 0 Z"></path>\n\t\t\t\t\t\t\t\t\t\t\t</clipPath>\n\t\t\t\t\t\t\t\t\t\t\t<clipPath id="rightBubble">\n\t\t\t\t\t\t\t\t\t\t\t    <path d="M 0,0 A 14,14 0 0 0 14,14 H 0 V 0 Z"></path>\n\t\t\t\t\t\t\t\t\t\t\t</clipPath>\n\t\t\t\t\t\t\t\t\t\t</defs>\n\t\t\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t\t\t\t{{component(options.components.MessageMenu)}}{{/component}}\n\n\t\t\t\t\t\t\t\t\t<div id="messageOverflowTop" class="messageOverflow"></div>\n\n\t\t\t\t\t\t\t\t\t<div id="messageOverflowBottom" class="messageOverflow"></div>\n\t\t\t\t\t\t\t\t\t<div id="theBottom"></div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t{{if (options.peer.canSendMessageTo())}}\n\t\t\t\t\t\t<div class="panelNewMessage">\n\t\t\t\t\t\t\t{{component(options.components.NewMessage)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{{/if}}\n\n\t\t\t\t\t</div>\n\n\n\t\t\t\t{{/if}}\n\n\n\t\t\t\t{{component(options.components.StickersPopup)}}{{/component}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(1);t.exports=class extends i{constructor(t){super(t),this.AppUI=i,this._overflows={bottom:0,top:0,topIds:{},bottomIds:{}}}reduceOverflows(t){let e=!1;for(let s of t)this._overflows.topIds[s]?(this._overflows.top-=this._overflows.topIds[s],delete this._overflows.topIds[s]):e=!0,this._overflows.bottomIds[s]&&(this._overflows.bottom-=this._overflows.bottomIds[s],delete this._overflows.bottomIds[s]);return this.$("#messageOverflowTop").style.height=this._overflows.top+"px",this.$("#messageOverflowBottom").style.height=this._overflows.bottom+"px",e}removeKeepingScroll(t){for(let e of t)try{const t=this._cIds[e].$();if(e<this._data.peer.getBaseMessage()._id){const s=t.offsetHeight;this._overflows.top+=s,this._overflows.topIds[e]=s}else{const s=t.offsetHeight;this._overflows.bottom+=s,this._overflows.bottomIds[e]=s}this._cIds[e].cleanUp(),t.remove(),delete this._cIds[e]}catch(t){}this.$("#messageOverflowTop").style.height=this._overflows.top+"px",this.$("#messageOverflowBottom").style.height=this._overflows.bottom+"px"}onScroll(){const t=this.$("#panelMessages"),e=t.scrollTop,s=t.scrollHeight,i=t.offsetHeight;t&&(e<this._overflows.top+1e3&&this._data.peer.hasOlder()&&(e<this._overflows.top&&(t.scrollTop=this._overflows.top),console.error("loading asked older"),this._data.peer.loadOlder()),e>s-this._overflows.bottom-i-1e3&&this._data.peer.hasNewer()&&(e>s-this._overflows.bottom-i&&(t.scrollTop=s-this._overflows.bottom-i),console.error("loading asked newer"),this._data.peer.loadNewer()))}}},function(t,e,s){const i={Text:s(36),Sticker:s(37),Album:s(38),GIF:s(39),SingleVideo:s(40),VideoWithText:s(41),RoundVideo:s(42),Downloadable:s(43),Poll:s(44),AudioPlayer:s(45),Service:s(46)};t.exports=class{static factory(t){let e="Text";return t.isService()?e="Service":t.getGroupId()?e="Album":t._sticker?e="Sticker":t._doc?e="Downloadable":t._poll?e="Poll":t._audio?e="AudioPlayer":t._media&&(t._media.isPhoto()?e=(t._message,"Album"):t._media.isVideo()&&(e=t._media.isGIF()?"GIF":t._media.isRoundVideo()?"RoundVideo":t._message?"VideoWithText":"SingleVideo")),i[e]}}},function(t,e,s){const i=s(2);class a extends i{constructor(t){super(t),this._data.buttons=this._data.message.getButtons()}photoLoaded(t){const e=this.$("#message_"+this._data.message._id);if(e){const s="url('"+t+"')";if(e.classList.contains("withPhotoOnly"))e.style.backgroundImage=s,e.style.setProperty("--brImage",s);else{const t=this.$("#messageMedia_"+this._data.message._id);t&&(t.style.backgroundImage=s)}}}webpagePhotoLoaded(t){const e=this.$(".webpagePhoto");if(e){const s='<img src="'+t.blobURL+'" style="max-height: '+this._data.message._webpage.getInfo("photoHeight")+'px; width: auto;">';e.innerHTML=s}}}a.template='\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}"\n\t\t\t\tclass="\n\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}}\n\t\t\t\t\t{{if (options.sameAsNext)}} sameAsNext{{/if}}\n\t\t\t\t\t{{if (options.buttons.length)}}withButtons{{buttons.length}}{{/if}}\n\t\t\t\t"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\tstyle="\n\t\t\t\t"\n\t\t\t\t>\n\n\t\t\t\t<div class="messageAuthor messageAction" data-action="gotouser" data-id="{{message._id}}">{{authorName}}</div>\n\t\t\t\t{{if (options.reply)}}\n\t\t\t\t\t<div class="messageReply messageAction" data-action="jump" data-id="{{reply.id}}">\n\t\t\t\t\t\t<div class="author">{{reply.author}}</div>\n\t\t\t\t\t\t<div class="replyBody">{{reply.message}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div style="clear: both"></div>\n\t\t\t\t{{/if}}\n\n\n\t\t\t\t{{if (options.forwardedInfo)}}<div class="fowardedHeader">Forwarded message</div>{{/if}}\n\t\t\t\t<div class="messageContent {{if (options.forwardedInfo)}}messageForwarded{{/if}}"\n\t\t\t\t\tstyle=""\n\t\t\t\t\t>\n\t\t\t\t\t{{if (options.forwardedInfo)}}\n\t\t\t\t\t\t<div class="author messageAction high" data-action="gotoforw" data-id="{{message._id}}">{{forwardedInfo.name}}</div>\n\t\t\t\t\t{{/if}}\n\n\t\t\t\t\t<span class="messageBody">{{message.formatMessageBody()|safe}}</span>\n\n\t\t\t\t\t{{if (options.message._webpage)}}\n\t\t\t\t\t\t<a href="{{message._webpage.getInfo(\'url\')|safe}}" class="messageWebpage" target="_blank">\n\t\t\t\t\t\t\t{{if (options.message._webpage.getInfo(\'hasPhoto\'))}}\n\t\t\t\t\t\t\t<div class="webpagePhoto {{if (options.message._webpage.getInfo(\'photoIsSquare\'))}}webpagePhotoSquare{{/if}}" id="messageWebpagePhoto_{{message._id}}"\n\t\t\t\t\t\t\t\tstyle="\n\t\t\t\t\t\t\t\t\t{{if (options.message._webpage.getInfo(\'previewBase64\'))}}\n\t\t\t\t\t\t\t\t\t\tbackground-image: url(\'{{message._webpage.getInfo(\'previewBase64\')}}\');\n\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t\t{{if (!options.message._webpage.getInfo(\'photoIsSquare\'))}}\n\t\t\t\t\t\t\t\t\theight: {{message._webpage.getInfo(\'photoHeight\')}}px;\n\t\t\t\t\t\t\t\t\tmax-width: {{message._webpage.getInfo(\'photoWidth\')}}px;\n\t\t\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t\t"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\t<div class="webpageSitename high">{{message._webpage.getInfo(\'siteName\')}}</div>\n\t\t\t\t\t\t\t<div class="webpageTitle high">{{message._webpage.getInfo(\'title\')}}</div>\n\t\t\t\t\t\t\t{{if (options.message._webpage.getInfo(\'description\'))}}\n\t\t\t\t\t\t\t<div class="webpageDescription high">{{message._webpage.getInfo(\'description\')}}</div>\n\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t{{/if}}\n\n\t\t\t\t\t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n\t\t\t\t</div>\n\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t\t{{if (options.buttons.length)}}\n\t\t\t\t<div class="messageButtons"><div class="messageButtonsCont">\n\t\t\t\t\t{{each(options.buttons)}}\n\t\t\t\t\t\t<div class="messageButton messageAction" data-action="button" data-id="{{message._id}}" data-n={{@index}}>{{@this.title}}</div>\n\t\t\t\t\t{{/each}}\n\t\t\t\t</div></div>\n\t\t\t\t{{/if}}\n\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=a},function(t,e,s){const i=s(2),a=window.classes.TGS;class o extends i{constructor(t){super(t),this._events=[["mouseenter","sticker_"+this._data.message._id,"onMouseEnter"]],this._wasRecent=!1}wasRecent(){this._wasRecent=!0}async onMouseEnter(){if(this._tgs){if(await this.sureSingle("play"))return;await this._tgs.playOnce(),this.fulfilSingle("play",!0,!0)}}stickerLoaded(t){if(!this._data.message._sticker||this._stickerAttached)return!1;if(this._stickerAttached=!0,t._isAnimated)this._tgs=new a(this.$(".messageSticker")),this._tgs.setJSON(t.json,!0,!0,t,this._wasRecent);else{const e='<img src="'+t.blobURL+'">',s=this.$(".messageSticker");s&&(s.innerHTML=e)}}}o.template='\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}"\n\t\t\t\tclass="panelMessageSticker\n\t\t\t\t\t{{if (options.message._sticker.isAnimated())}}panelMessageAnimatedSticker{{/if}}\n\t\t\t\t\tpanelMessageSticker{{viewType}}\n\t\t\t\t\t{{if (options.sameAsNext)}}sameAsNext{{/if}}\n\t\t\t\t\t{{if (options.fromMe)}} stickerFromMe{{#else}} stickerFromThem{{/if}}\n\t\t\t\t\tmessageAction\n\t\t\t\t">\n\t\t\t\t<div id="sticker_{{message._id}}" class="messageSticker"></div>\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=o},function(t,e,s){const i=s(2),a=s(11);class o extends i{constructor(t){super(t),this.calcData()}photoLoaded(t){const e=document.querySelector("#messageAlbumItem_"+this._data.message._id);if(e&&!e.dataset.loaded){const s="url('"+t+"')";e.style.backgroundImage=s+","+e.style.backgroundImage,e.dataset.loaded=1}}rerender(){this.calcData(),this.render()}calcData(){if(this._data.isMain=!this._data.message.getGroupId()||this._data.message.isMainInGroup(),this._data.isMain){let t=[];try{t=this._data.message.getGroupMedias()}catch(e){t=[{media:this._data.message._media,message:this._data.message}]}const e=[];for(let s of t){let t=null,i=!1;s.media.blobURL?(i=!0,t="url('"+s.media.blobURL+"'),url('"+s.media.getPreviewBase64()+"')"):t="url('"+s.media.getPreviewBase64()+"')",e.push({loaded:i,width:s.media.getInfo("width"),height:s.media.getInfo("height"),id:s.message._id,media:s.media,background:t})}e.sort((t,e)=>t.id>e.id?1:-1),this._layouter=new a(e),this._data.items=this._layouter.layout(),this._data.albumWidth=this._layouter._width,this._data.albumHeight=this._layouter._height,this._data.messageBody=this._data.message.formatMessageBody(),this._data.fromMe?this._data.cornerBackground=this._layouter._bottomRightItem.media.getPreviewBase64():this._data.cornerBackground=this._layouter._bottomLeftItem.media.getPreviewBase64()}}}o.template='\n\t{{if (!options.isMain)}}\n\n\t{{#else}}\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}"\n\t\t\t\tclass="\n\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}} panelMessageAlbum\n\n\t\t\t\t\t{{if (options.sameAsNext)}} sameAsNext{{/if}}\n\t\t\t\t"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\tstyle="\n\t\t\t\t{{if (!options.messageBody)}}--brImage: url(\'{{cornerBackground}}\');{{/if}}\n\t\t\t\twidth: {{js(options.albumTopWidth = options.albumWidth - 28)/}}{{albumTopWidth}}px"\n\t\t\t\t>\n\n\t\t\t\t<div id="messageAlbum_{{message._id}}" class="messageAlbum {{if (!options.messageBody)}}messageAlbumOnly{{/if}}" style="width: {{albumWidth}}px; height: {{albumHeight}}px;">\n\t\t\t\t\t{{each(options.items)}}\n\t\t\t\t\t\t<div title="message {{@this.id}}" data-id="{{@this.id}}" {{if (@this.loaded)}}data-loaded="1"{{/if}}  id="messageAlbumItem_{{@this.id}}" class="messageAlbumItem messageAction" style="background-image: {{@this.background|safe}}; width: {{@this.pos.width}}px; height: {{@this.pos.height}}px; left: {{@this.pos.left}}px; top: {{@this.pos.top}}px;"></div>\n\t\t\t\t\t{{/each}}\n\n\t\t\t\t\t{{if (!options.messageBody)}}\n\t\t\t\t\t<div class="messageMeta onMediaMeta">{{self.getMetaHTML() | safe}}</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\n\t\t\t\t{{if (options.messageBody)}}\n\t\t\t\t<div class="messageContent"\n\t\t\t\t\tstyle=""\n\t\t\t\t\t>\n\n\t\t\t\t\t<span class="messageBody">{{messageBody|safe}}</span>\n\n\t\t\t\t\t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n\t\t\t\t</div>\n\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\t\t\t\t{{/if}}\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t{{/if}}\n',t.exports=o},function(t,e,s){const i=s(2),a=s(11);class o extends i{constructor(t){super(t);const e=[];e.push({width:t.message._media.getInfo("width"),height:t.message._media.getInfo("height"),id:t.message._media._id,media:t.message._media}),this._layouter=new a(e);const s=this._layouter.layout();if(this._data.mediaSize={width:s[0].width,height:s[0].height},this._data.mediaSize.width>256){let t=this._data.mediaSize.height/this._data.mediaSize.width;this._data.mediaSize.width=256,this._data.mediaSize.height=256*t}this._data.mediaSize.hheight=this._data.mediaSize.height/2-17,this._gifPlaying=!1,this._gifPaused=!1,this._data.previewBase64=t.message._media.getPreviewBase64(),this._wasRecent=!1}wasRecent(){this._wasRecent=!0}clickHandler(){this._wasRecent=!0,this.play()}doPlay(){let t=this.$("#message_"+this._data.message._id),e=this.$("#messageVideo_"+this._data.message._id);e.muted=!0,this._gifPlaying=!0,t.classList.add("loaded"),this._wasRecent?this._gifPaused=!1:this.pause(),this._gifPaused?(e.loop=!1,this._gifPlaying=!1):(this.pauseOthers(),e.loop=!0,e.play())}play(){if(this._data.message._media&&this._data.message._media.isGIF()){let t=this.$("#messageVideo_"+this._data.message._id);t&&(this._videoPlayingSrcSet?this.doPlay():(t.onloadeddata=()=>{this.doPlay()},t.src=this._data.message._media.getStreamURL(),this._videoPlayingSrcSet=!0)),this.tick()}}async tick(){for(await this._data.message._media.checkCache();!this._data.message._media._isDownloaded;)await this._data.message._media.downloadNextPart()}photoLoaded(t){const e=this.$("#message_"+this._data.message._id);if(e){const s="url('"+t+"')";this._data.previewBase64?e.style.backgroundImage=s+","+e.style.backgroundImage:(e.style.backgroundImage=s,e.style.setProperty("--brImage",s)),this.nextTick(()=>{this.play()})}}pauseOthers(){for(let t of this._parent._components.messages)t._data.message._id==this._data.message._id||!1!==t._gifPaused&&!1!==t._gifPlaying||t.pause()}pause(){this._gifPaused=!0;try{this.$("#messageVideo_"+this._data.message._id).pause()}catch(t){}}}o.template='\n\t\t\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}"\n\t\t\t\t\t\tclass="\n\t\t\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}}\n\t\t\t\t\t\t\twithVideo\n\t\t\t\t\t\t\twithVideoOnly\n\t\t\t\t\t\t\tpanelGIF\n\t\t\t\t\t\t\t{{if (options.sameAsNext)}} sameAsNext{{/if}}\n\t\t\t\t\t\t\tmessageAction\n\t\t\t\t\t\t"\n\t\t\t\t\t\ttitle="{{message._id}}"\n\t\t\t\t\t\tstyle="\n\t\t\t\t\t\t\t{{if (options.previewBase64)}}\n\t\t\t\t\t\t\t--brImage: url(\'{{previewBase64}}\'); background-image: url(\'{{previewBase64}}\');\n\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\twidth: {{mediaSize.width}}px;\n\t\t\t\t\t\t\theight: {{mediaSize.height}}px;\n\t\t\t\t\t\t"\n\t\t\t\t\t\t>\n\n\t\t\t\t\t\t<div class="messageContent messageMediaOnly"\n\t\t\t\t\t\t\tstyle="width: {{mediaSize.width}}px; height: {{mediaSize.height}}px;"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div id="messageMedia_{{message._id}}" class="messageMedia" style="width: {{mediaSize.width}}px; height: {{mediaSize.height}}px;"><div class="cssload-zenith onDark videoLoading" style="margin-top: {{mediaSize.hheight}}px;"></div><video muted id="messageVideo_{{message._id}}" autoplay loop></video></div>\n\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\n\t\t\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=o},function(t,e,s){const i=s(2);class a extends i{constructor(t){super(t),this._data.mediaSize=this.getSizeForTheMedia(),this._data.previewBase64=t.message._media.getPreviewBase64()}photoLoaded(t){const e=this.$("#message_"+this._data.message._id);if(e){const s="url('"+t+"')";this._data.previewBase64?e.style.backgroundImage=s+","+e.style.backgroundImage:(e.style.backgroundImage=s,e.style.setProperty("--brImage",s))}}}a.template='\n\t\t\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}" data-moveaction="heat"\n\t\t\t\t\t\tclass="\n\t\t\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}}\n\t\t\t\t\t\t\twithVideo\n\t\t\t\t\t\t\twithVideoOnly\n\t\t\t\t\t\t\t{{if (options.sameAsNext)}} sameAsNext{{/if}}\n\t\t\t\t\t\t\tmessageAction messageMove\n\t\t\t\t\t\t"\n\t\t\t\t\t\ttitle="{{message._id}}"\n\t\t\t\t\t\tstyle="\n\t\t\t\t\t\t\t{{if (options.previewBase64)}}\n\t\t\t\t\t\t\t--brImage: url(\'{{previewBase64}}\'); background-image: url(\'{{previewBase64}}\');\n\t\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t\tmin-width: {{mediaSize.width}}px;\n\t\t\t\t\t\t"\n\t\t\t\t\t\t>\n\n\t\t\t\t\t\t<div class="messageContent messageMediaOnly"\n\t\t\t\t\t\t\tstyle="max-width: {{mediaSize.width}}px;"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t<div id="messageMedia_{{message._id}}" class="messageMedia" style=""><div class="duration">{{message._media.getInfo(\'videoDurationHuman\')}}</div><div class=playIcon></div></div>\n\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\n\t\t\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=a},function(t,e,s){const i=s(2);class a extends i{constructor(t){super(t),this._data.mediaSize=this.getSizeForTheMedia()}photoLoaded(t){const e=this.$("#messageMedia_"+this._data.message._id);if(e){const s="url('"+t+"')";e.style.backgroundImage=s+","+e.style.backgroundImage}}}a.template='\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}" data-moveaction="heat"\n\t\t\t\tclass="\n\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}}\n\t\t\t\t\twithVideo\n\t\t\t\t\t{{if (options.sameAsNext)}} sameAsNext{{/if}} messageMove\n\t\t\t\t"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\tstyle="\n\t\t\t\t\tmin-width: {{mediaSize.width}}px;\n\t\t\t\t"\n\t\t\t\t>\n\n\t\t\t\t<div id="messageMedia_{{message._id}}" data-id="{{message._id}}"  class="messageMedia messageAction" style="background-image: url(\'{{message._media.getPreviewBase64()}}\');\n\t\t\t\t\tmin-width: {{mediaSize.width}}px;">\n\t\t\t\t\t<div class="duration">{{message._media.getInfo(\'videoDurationHuman\')}}</div><div class=playIcon></div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="messageContent"\n\t\t\t\t\tstyle="max-width: {{mediaSize.width}}px;"\n\t\t\t\t\t>\n\t\t\t\t\t{{if (options.message.formatMessageBody())}}\n\t\t\t\t\t\t<div class="messageText"><span class="messageBody">{{message.formatMessageBody()|safe}}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>\n\t\t\t\t\t{{/if}}\n\n\t\t\t\t</div>\n\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=a},function(t,e,s){const i=s(2),a=s(0);class o extends i{constructor(t){super(t),this._data.mediaSize=this.getSizeForTheMedia(),this._components.NoSound=this.newC(a,{icon:"nosound"}),this._videoPlayingBlobURL=null,this._videoPlayingSrcSet=!1,this._videoPlayingState="undefined",this._roundVideoDate=this._data.message._date,this.playRoundVideo()}clickHandler(){"undefined"==this._videoPlayingState||"pause"==this._videoPlayingState?this.playRoundVideo():"muted"==this._videoPlayingState?this.muteRoundVideo(!1):"play"==this._videoPlayingState&&this.pauseRoundVideo()}pauseRoundVideo(){if(this._data.message._media&&this._data.message._media.isRoundVideo()){let t=this.$("#messageVideo_"+this._data.message._id);t&&(t.pause(),t.muted=!0,this._videoPlayingState="pause",this.$(".nosound").style.display="block")}}muteRoundVideo(t){let e=this.$("#messageVideo_"+this._data.message._id);e&&(t?(e.muted=!0,this.$(".nosound").style.display="block",this._videoPlayingState="muted"):(e.muted=!1,this.$(".nosound").style.display="none",this._videoPlayingState="play",this.pauseOthers()))}pauseOthers(){for(let t of this._parent._components.messages)t!=this&&t._roundVideoDate&&t.pauseRoundVideo()}roundLoopEnded(){if("play"==this._videoPlayingState){let t=null,e=1/0;for(let s of this._parent._components.messages)s!=this&&s._roundVideoDate&&s._roundVideoDate>this._roundVideoDate&&s._roundVideoDate-this._roundVideoDate<e&&(e=s._roundVideoDate-this._roundVideoDate,t=s);if(t)t.playRoundVideo(!0);else{this.muteRoundVideo(!0);let t=this.$("#messageVideo_"+this._data.message._id);t&&t.play()}}else this._videoPlayingState="pause"}playRoundVideo(t){if(this._data.message._media&&this._data.message._media.isRoundVideo()){let e=()=>{let e=this.$("#messageVideo_"+this._data.message._id);if(e)if(this._videoPlayingSrcSet){if(t){try{e.currentTime=0}catch(t){}e.muted=!1,this.$(".nosound").style.display="none",this._videoPlayingState="play"}else e.muted=!0,this.$(".nosound").style.display="block",this._videoPlayingState="muted";e.play(),this.$("#messageMediaPlaying_"+this._data.message._id).style.display="block",this.$("#messageMedia_"+this._data.message._id).style.display="none",this.pauseOthers()}else e.onloadeddata=()=>{t?(e.muted=!1,this.$(".nosound").style.display="none",this._videoPlayingState="play"):(e.muted=!0,this.$(".nosound").style.display="block",this._videoPlayingState="muted"),this.$("#messageMediaPlaying_"+this._data.message._id).style.display="block",this.$("#messageMedia_"+this._data.message._id).style.display="none"},e.onended=()=>{this.roundLoopEnded()},e.src=this._videoPlayingBlobURL,this._videoPlayingSrcSet=!0,this.pauseOthers()};this._videoPlayingBlobURL?e():this._data.message._media.getPlayableBlobURL().then(t=>{this._videoPlayingBlobURL=t,e()})}}photoLoaded(t){const e=this.$("#message_"+this._data.message._id);if(e){const s="url('"+t+"')";if(e.classList.contains("withPhotoOnly"))e.style.backgroundImage=s,e.style.setProperty("--brImage",s);else{const t=this.$("#messageMedia_"+this._data.message._id);t&&(t.style.backgroundImage=s)}}}}o.template='\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}"\n\t\t\t\tclass="\n\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}}\n\t\t\t\t\twithVideo withVideoOnly\n\t\t\t\t\tpanelRoundVideo\n\t\t\t\t\tmessageAction\n\t\t\t\t"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\tstyle="\n\t\t\t\t\t{{if (options.message._media)}}\n\t\t\t\t\t\tmin-width: {{mediaSize.width}}px;\n\t\t\t\t\t{{/if}}\n\t\t\t\t"\n\t\t\t\t>\n\n\t\t\t\t<div class="duration">{{message._media.getInfo(\'videoDurationHuman\')}} <div class="nosound">{{component(options.components.NoSound)}}{{/component}}</div></div>\n\n\t\t\t\t<div id="messageMedia_{{message._id}}" class="messageMedia" style="background-image: url(\'{{message._media.getPreviewBase64()}}\');\n\t\t\t\t\tmin-width: {{mediaSize.width}}px;">\n\t\t\t\t\t<div class=playIcon></div>\n\t\t\t\t</div>\n\t\t\t\t<div id="messageMediaPlaying_{{message._id}}" class="messageMedia messageMediaPlaying" style="display: none;">\n\t\t\t\t\t<video muted id="messageVideo_{{message._id}}" autoplay></video>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=o},function(t,e,s){const i=s(2);class a extends i{constructor(t){super(t)}}a.template='\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}" data-moveaction="heat"\n\t\t\t\tclass="panelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}} {{if (options.sameAsNext)}} sameAsNext{{/if}} messageAction messageMove"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\t>\n\n\t\t\t\t<div class="rsDoc panelRsDoc rsDoc_{{message._doc.id}}" data-id="{{message._doc.id}}">\n\t\t\t\t\t<div class="rsDocIcon avatarC{{message._doc.getInfo(\'color\')}}"><div class="progress"><div></div></div>{{message._doc.getInfo(\'ext\')}}</div>\n\t\t\t\t\t<div class="rsDocName">{{message._doc.getInfo(\'filename\')}}</div>\n\t\t\t\t\t<div class="rsDocMeta">{{message._doc.getInfo(\'sizeHuman\')}}</div>\n\t\t\t\t</div>\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=a},function(t,e,s){const i=s(2);class a extends i{constructor(t){super(t),this._events=[["click","pa_"+this.domId,"onAnswerClick"],["click","pols_"+this.domId,"onSolutionClick"],["click","polv_"+this.domId,"onVotersClick"],["click","pbt_"+this.domId,"onButtonClick"]],this._data.poll=this._data.message._poll,this._data.answers=this._data.message._poll._answers,this._setVoters=[],this._picked={},this._animated={}}afterRender(){this.nextTick(()=>{this.assignDomEvents(),this.updateDOM()})}onVotersClick(){(this._data.poll.isVoted||this._data.poll.isClosed)&&this._data.poll.isPublic&&(app._interface._components.RightSidebar.showBlock("Poll",{poll:this._data.poll}),app._interface._components.RightSidebar.show())}updateContent(){this.updateDOM()}async updateVoters(){if(this.$(".pollMeta").classList[this._data.poll._solution?"remove":"add"]("nosolution"),this._setVoters.length>=3)return;let t=this._data.poll.getRecentVoters();const e=this.$(".pollVoters");let s="";for(let e of t)-1==this._setVoters.indexOf(e._id)&&(s+=this.avHTML(e,"avatarSmall"),this._setVoters.push(e._id));s&&e.insertAdjacentHTML("beforeend",s)}async updateClosing(){const t=this.$(".pollMetaTime"),e=this.$(".progress"),s=this.$(".pollMeta");let i=!1;for(;this._data.poll.isClosing;){i=!0,s.classList.add("closing");let a=this._data.poll.closingIn;a.time&&(t.innerHTML=a.time),a.percents&&(e.className="progress progress"+(100-10*(Math.floor(a.percents/10)+1)),a.percents<30&&s.classList.add("closingred")),this._data.poll.isClosing&&await new Promise(t=>setTimeout(t,1e3))}s.className="pollMeta",i&&this._data.poll.fetch().then(()=>{this._data.poll._solution&&this._parent.showNotice(this._data.poll._solution,"lamp"),this.updateVoters()})}onSolutionClick(){this._data.poll._solution&&this._parent.showNotice(this._data.poll._solution,"lamp")}updateDOM(t){if(this._data.poll.isVoted||this._data.poll.isClosed){this.$(".pollAnswers").classList.add("voted");const e=async(e,s,i)=>{let a=t?0:s;do{a<s&&a++,e.innerHTML=a+"%",await new Promise(t=>{setTimeout(t,3)})}while(a<s)},s=this._data.poll.isQuiz;for(let a of this._data.answers){let o="#pa_"+this.domId+"_"+a.uniq;const n=this.$(o);if(n){n.querySelector(".pabFlow2").style.marginLeft=a.percents+"%";const r=n.querySelector(".pollAnswerSelected");(a.chosen||a.correct)&&(setTimeout(()=>{r.classList.add("chosen")},t?200:1),r.innerHTML=i.AppUI.getIconHTML("check")),s&&a.chosen&&!a.correct&&(n.classList.add("pollAnswerWrong"),r.innerHTML=i.AppUI.getIconHTML("close")),this._animated[o]||(this._animated[o]=!0,e(n.querySelector(".pollAnswerResult"),a.percents,t))}}const a=this._data.poll._totalVoters;this._data.poll.isPublic?(this.$(".pollVoteButton").classList.remove("inactive"),this.$(".pollVoteButton").innerHTML="View Results"):(this.$(".pollVoteButton").innerHTML=a+" voter"+(1!=a?"s":""),this.$(".pollVoteButton").classList.add("inactive"))}else this._data.poll.isMultiple?(this.$(".pollVoteButton").classList.remove("inactive"),this.$(".pollVoteButton").innerHTML="Vote"):this.$(".pollVoteButton").classList.add("inactive");this.updateClosing(),this.updateVoters()}doVote(){if(this._data.poll.isVoted||this._data.poll.isClosed)return;let t=[];for(let e in this._picked)t.push(this._picked[e]);t.length&&(this.$$(".pollAnswer").forEach(t=>{t.classList.remove("pickedAnswer"),this._picked[t.dataset.uniq]&&t.classList.add("selectedAnswer")}),this._data.poll.vote(t).then(()=>{this.updateDOM(!0)}))}onButtonClick(){this._data.poll.isPublic&&(this._data.poll.isVoted||this._data.poll.isClosed)?this.onVotersClick():this.doVote()}onAnswerClick(t){const e=event.target.closest(".pollAnswer");let s=e.dataset.uniq,i=null;for(let t of this._data.answers)t.uniq==s&&(i=t);i&&(this._data.poll.isMultiple?this._picked[i.uniq]?(e.classList.remove("pickedAnswer"),delete this._picked[i.uniq]):(e.classList.add("pickedAnswer"),this._picked[i.uniq]=i):(this._picked[i.uniq]=i,this.doVote(),e.classList.add("selectedAnswer"),this.updateDOM()))}}a.template='\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}"\n\t\t\t\tclass="\n\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}}\n\t\t\t\t\t{{if (options.sameAsNext)}} sameAsNext{{/if}} panelMessagePoll\n\t\t\t\t"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\tstyle="\n\t\t\t\t"\n\t\t\t\t>\n\n\t\t\t\t<div class="messageAuthor">{{authorName}}</div>\n\t\t\t\t{{if (options.reply)}}\n\t\t\t\t\t<div class="messageReply">\n\t\t\t\t\t\t<div class="author">{{reply.author}}</div>\n\t\t\t\t\t\t<div class="replyBody">{{reply.message}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t{{/if}}\n\n\n\n\t\t\t\t{{if (options.forwardedInfo)}}<div class="fowardedHeader">Forwarded message</div>{{/if}}\n\t\t\t\t<div class="messageContent"\n\t\t\t\t\tstyle=""\n\t\t\t\t\t>\n\t\t\t\t\t{{if (options.forwardedInfo)}}\n\t\t\t\t\t\t<div class="author">{{forwardedInfo.name}}</div>\n\t\t\t\t\t{{/if}}\n\n\t\t\t\t\t<div class="messagePoll">\n\t\t\t\t\t\t<div class="pollTitle">{{poll.question}}</div>\n\t\t\t\t\t\t<div class="pollMeta">\n\t\t\t\t\t\t\t<div class="pollMetaSolution" id="pols_{{domId}}" >{{self.AppUI.getIconHTML(\'lamp\')|safe}}</div>\n\t\t\t\t\t\t\t<div class="pollMetaTimer">\n\t\t\t\t\t\t\t\t<span class="pollMetaTime">0:05</span>\n\t\t\t\t\t\t\t\t<div class="pollMetaProgress"><div class="progress active progress50"></div></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="pollNote">{{if (!options.poll.isPublic)}}Anonymous {{/if}}{{if (options.poll.isQuiz)}}Quiz{{#else}}Poll{{/if}}\n\t\t\t\t\t\t\t<div class="pollVoters" id="polv_{{domId}}"></div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="pollAnswers {{if (options.poll.isVoted)}}voted votedBefore{{/if}}" id="pa_{{domId}}">\n\t\t\t\t\t\t\t{{each(options.answers)}}\n\t\t\t\t\t\t\t<div class="pollAnswer" id="pa_{{domId}}_{{@this.uniq}}" data-uniq="{{@this.uniq}}">\n\t\t\t\t\t\t\t\t<div class="pollAnswerLeft">\n\t\t\t\t\t\t\t\t\t<div class="pollAnswerButton rpb"><div class="pabCircle">{{self.AppUI.getIconHTML(\'check\')|safe}}</div></div>\n\t\t\t\t\t\t\t\t\t<div class="pollAnswerResult">{{@this.percents}}%</div>\n\t\t\t\t\t\t\t\t\t<div class="pollAnswerSelected"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="pollAnswerText">{{@this.text}}</div>\n\t\t\t\t\t\t\t\t<div class="pollAnswerBarCont"><div class="pabFlow1"></div><div class="pabFlow2" {{if (options.poll.isVoted)}}style="margin-left: {{@this.percents}}%"{{/if}}></div><div class="pollAnswerBar"></div></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="pollVoteButton" id="pbt_{{domId}}">No answers</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n\t\t\t\t</div>\n\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=a},function(t,e,s){const i=s(2);class a extends i{constructor(t){super(t),this._events=[["mouseup","at_"+this.domId,"onMouseUp"],["mousedown","at_"+this.domId,"onMouseDown"],["mousemove","at_"+this.domId,"onMouseMove"],["click","ab_"+this.domId,"onPlay"]],this._seekWidth=250,this._playPercents=11,this._mouseIsDown=!1,this._seekEls=[],this._currentTime=0,this._duration=this._data.message._audio.getInfo("duration"),this._isPlaying=!1,this._app._mediaPlayer.on("play",t=>{t.messageAudio._id==this._data.message._audio._id&&this.play()}),this._app._mediaPlayer.on("pause",t=>{t.messageAudio._id==this._data.message._audio._id&&this.pause()}),this._app._mediaPlayer.on("timeupdate",t=>{t.messageAudio._id==this._data.message._audio._id&&this.timeUpdated(t)})}onPlay(){this._isPlaying?(this.pause(),this._app._mediaPlayer.pauseAudio(this._data.message._audio,this._data.message._peer)):(this.play(),this._app._mediaPlayer.playAudio(this._data.message._audio,this._data.message._peer))}async play(){this._isPlaying=!0,this.$("#ab_"+this.domId+"_play").classList.remove("active"),this.$("#ab_"+this.domId+"_pause").classList.add("active"),this._data.message._audio.isVoice||(this.$("#at_"+this.domId+"_artist").classList.remove("active"),this.$("#at_"+this.domId).classList.add("active"))}async pause(){this.$(".audioTime").innerHTML=""+this._data.message._audio.getInfo("durationHuman"),this._isPlaying=!1,this.$("#ab_"+this.domId+"_play").classList.add("active"),this.$("#ab_"+this.domId+"_pause").classList.remove("active"),this._data.message._audio.isVoice||(this.$("#at_"+this.domId+"_artist").classList.add("active"),this.$("#at_"+this.domId).classList.remove("active"))}async seekTo(t){await this.play(),await this._app._mediaPlayer.seekTo(this._data.message._audio,t)}timeUpdated(t){if(t.messageAudio._id!=this._data.message._audio._id)return;if(!this._isPlaying&&t.currentTime&&this.play(),this._currentTime=t.currentTime,this._data.message._audio.isVoice||this._isPlaying&&(this.$(".audioTime").innerHTML=Math.floor(this._currentTime/60)+":"+("0"+Math.floor(this._currentTime)%60).slice(-2)+" / "+this._data.message._audio.getInfo("durationHuman")),this._mouseIsDown)return;let e=this._currentTime/this._duration*100;this.moveSeekTo(e)}onMouseDown(t){const e=t.offsetX;this._mouseIsDown=!0,this.$(".audioTrack").classList.add("seeking"),this.moveSeekTo(e/this._seekWidth*100)}onMouseMove(t){if(!this._mouseIsDown)return!1;const e=t.offsetX;this.moveSeekTo(e/this._seekWidth*100)}onMouseUp(t){const e=t.offsetX;this._mouseIsDown=!1;const s=e/this._seekWidth*100;this.moveSeekTo(s),this.$(".audioTrack").classList.remove("seeking"),this.seekTo(s)}moveSeekTo(t){if(this._data.message._audio.isVoice){if(this._seekEls.length){let e=this._seekEls.length*(t/100);for(let t=0;t<this._seekEls.length;t++)t<e?this._seekEls[t].classList.add("seeked"):this._seekEls[t].classList.remove("seeked")}}else this.$(".audioSeek").style.width=t+"%"}afterRender(){this.nextTick(()=>{this._seekEls=this.$$(".awi"),this.assignDomEvents()})}}a.template='\n\t\t\t<div id="message_{{message._id}}" data-id="{{message._id}}" data-moveaction="heat"\n\t\t\t\tclass="\n\t\t\t\t\tpanelMessage{{if (options.fromMe)}} fromMe{{#else}} fromThem{{/if}} panelMessage{{viewType}}\n\t\t\t\t\t{{if (options.sameAsNext)}} sameAsNext{{/if}} messageMove\n\t\t\t\t"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\tstyle="\n\t\t\t\t"\n\t\t\t\t>\n\n\t\t\t\t<div class="messageAuthor">{{authorName}}</div>\n\t\t\t\t{{if (options.reply)}}\n\t\t\t\t\t<div class="messageReply">\n\t\t\t\t\t\t<div class="author">{{reply.author}}</div>\n\t\t\t\t\t\t<div class="replyBody">{{reply.message}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t{{/if}}\n\n\n\t\t\t\t{{if (options.forwardedInfo)}}<div class="fowardedHeader">Forwarded message</div>{{/if}}\n\t\t\t\t<div class="messageContent {{if (options.forwardedInfo)}}messageReply{{/if}}"\n\t\t\t\t\tstyle=""\n\t\t\t\t\t>\n\t\t\t\t\t{{if (options.forwardedInfo)}}\n\t\t\t\t\t\t<div class="author">{{forwardedInfo.name}}</div>\n\t\t\t\t\t{{/if}}\n\n\t\t\t\t\t<div class="audio audio_{{message._audio.id}}" data-id="{{message._audio.id}}">\n\t\t\t\t\t\t<div class="audioButton rpb" id="ab_{{domId}}"><div id="ab_{{domId}}_play" class="active">{{self.AppUI.getIconHTML(\'play\')|safe}}</div><div id="ab_{{domId}}_pause">{{self.AppUI.getIconHTML(\'pause\')|safe}}</div></div>\n\t\t\t\t\t\t{{if (options.message._audio.isVoice)}}\n\t\t\t\t\t\t\t<div class="audioWaveform">\n\t\t\t\t\t\t\t\t<div class="awOver" id="at_{{domId}}"></div>\n\t\t\t\t\t\t\t\t{{each(options.message._audio.getInfo(\'waveform\'))}}<span class="awi" style="height: {{@this}}px;"></span>{{/each}}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t{{#else}}\n\t\t\t\t\t\t\t<div class="audioTitle">{{message._audio.getInfo(\'title\')}}</div>\n\t\t\t\t\t\t\t<div class="audioArtist active" id="at_{{domId}}_artist">{{message._audio.getInfo(\'performer\')}}</div>\n\t\t\t\t\t\t\t<div class="audioTrack" id="at_{{domId}}" ><div class="audioSeek"></div><div class="audioLine"></div></div>\n\t\t\t\t\t\t{{/if}}\n\t\t\t\t\t\t<div class="audioTime">{{message._audio.getInfo(\'durationHuman\')}}</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t</div>\n\t\t\t\t<div class="messageMeta">{{self.getMetaHTML() | safe}}</div>\n\n\t\t\t\t{{self.avHTML(options.message, \'avatarSmall\')|safe}}\n\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=a},function(t,e,s){const i=s(2);class a extends i{constructor(t){super(t),this._data.did=(""+this._data.message._id).split(".").join("_")}}a.template='\n\t\t\t<div id="message_{{did}}" data-id="{{message._id}}"\n\t\t\t\tclass="\n\t\t\t\t\tpanelMessage panelMessageService\n\t\t\t\t"\n\t\t\t\ttitle="{{message._id}}"\n\t\t\t\tstyle="\n\t\t\t\t"\n\t\t\t\t>\n\t\t\t\t{{message.getDisplayMessage()}}\n\t\t\t</div>\n\n\t\t\t<div style="clear: both"></div>\n\t\t',t.exports=a},function(t,e,s){const i=s(0),a=s(1),o=s(5),n=s(48);class r extends a{constructor(t){super(t),this._data.icon=t.icon||"up",this._components.IconSend=this.newC(i,{icon:"send"}),this._components.IconClose=this.newC(i,{icon:"close"}),this._components.IconSmile=this.newC(i,{icon:"smile"}),this._components.IconAttach=this.newC(i,{icon:"attach"}),this._components.IconDelete=this.newC(i,{icon:"delete"}),this._components.IconMic=this.newC(i,{icon:"microphone"}),this._components.AttachMenu=this.newC(o,{items:[["photo","photo","Photo or Video"],["doc","document","Document"]]}),this._components.Upload=this.newC(n),this._events=[["keydown","body","onChange"],["change","body","onChange"],["click","send","onSubmit"],["mousedown","send","onDownSubmit"],["touchstart","send","onDownSubmit"],["touchend","send","onUpSubmit"],["mouseup","send","onUpSubmit"],["click","delete","onDeleteVoice"],["click","removeAttach","removeAttach"],["click","emojiButton","showEmoji"],["contextmenu","send","onContext"],["click","attachButton","showAttach"]],this._componentEvents=[["sendFiles","Upload","onSendFiles"],["photo","AttachMenu","onUploadPhoto"],["doc","AttachMenu","onUploadFile"]],this._textHeightStyle="small",this._setToLargeAt=0,this._setToHugeAt=0,this._lastELength=0,this._replyToMessage=null,this._webpage=null,this._entities=null,this._messageType="voice",this._hasVoice=!1,this._isRecording=!1,this._isSubmitDown=!1,this.setGlobalCatch()}onContext(t){t.preventDefault()}setGlobalCatch(){r.__globalKeydownCatch||(r.__globalKeydownCatch=t=>{try{if(t.keyCode<=46)return;if(document.activeElement&&("textarea"==document.activeElement.tagName.toLowerCase()||"input"==document.activeElement.tagName.toLowerCase()))return;const e=document.querySelector("#body");e.focus(),e.dispatchEvent(t)}catch(t){}}),document.removeEventListener("keydown",r.__globalKeydownCatch),document.addEventListener("keydown",r.__globalKeydownCatch)}onDeleteVoice(){this._hasVoice=!1,this.$(".newMessageContainer").classList.remove("withVoice"),this.$(".newMessageContainer").classList.remove("withVoiceRecorded"),this.$(".nmvDuration").classList.remove("active"),this.$(".nmvDuration").innerText=""}async recordedDurationLoop(){do{let t=this._app._mediaPlayer.getRecordedDuration(),e=Math.floor(t/60)+":"+("0"+Math.floor(t)%60).slice(-2)+","+("0"+Math.floor(100*t)%100).slice(-2);this.$(".nmvDuration").innerText=t?e:"",await new Promise(t=>{setTimeout(t,61)}),this.$(".nmvInitializing").classList[t?"remove":"add"]("active"),this.$(".nmvRecording").classList[t?"add":"remove"]("active"),this.$(".nmvDuration").classList[t?"add":"remove"]("active")}while(this._app._mediaPlayer._isRecording)}async errorRecordIcon(){const t=new i({icon:"nosound"}).render({noDOM:!0});this.$(".mmvStatusIcon").innerHTML=t}async onDownSubmit(){if(this._isSubmitDown=!0,"voice"==this._messageType&&!this._lastELength&&!this._hasVoice){this.$(".newMessageContainer").classList.add("withVoice"),this.$(".nmvDuration").innerText="",this.recordedDurationLoop(),this._isRecording=!0,await this._app._mediaPlayer.initRecorder()?this.$(".mmvStatusIcon").innerHTML="":this.errorRecordIcon(),this.recordedDurationLoop()}this.mouseupUpG(()=>{this.onUpSubmit()})}async onUpSubmit(){if(this._isSubmitDown)if(this._isSubmitDown=!1,"voice"==this._messageType&&this._isRecording){this._isRecording=!1,this.$(".nmvRecording").classList.remove("active"),await this._app._mediaPlayer.stopRecorder(),this._app._mediaPlayer.getRecordedDuration()<.3?(this._hasVoice=!1,this.$(".newMessageContainer").classList.remove("withVoiceRecorded"),this.$(".newMessageContainer").classList.remove("withVoice")):(this._hasVoice=!0,this.$(".newMessageContainer").classList.add("withVoiceRecorded"))}else this._hasVoice&&(this.emit("sendVoice"),this.$(".newMessageContainer").classList.remove("withVoiceRecorded"),this.$(".newMessageContainer").classList.remove("withVoice"),this.$(".nmvDuration").classList.remove("active"),this.$(".nmvDuration").innerText="",this._hasVoice=!1)}onSubmit(){const t=this.$("#body");if(!t||!t.value)return!1;const e={message:t.value};this._replyToMessage&&(e.replyTo=this._replyToMessage),this._webpage&&(e.webpage=this._webpage);let s=this.calculateEntities(e.message);s&&s.length&&(e.entities=s),t.value="",this._lastELength=0,this._setToLargeAt=null,this._setToHugeAt=null,this.setTextHeightStyle("small"),this.emit("submitMessage",e),this.removeAttach(),this._mostRecentURLFetched=null,this.$(".newMessageContainer").classList.remove("withText")}onSendFiles(t){this.emit("sendFiles",t)}onUploadPhoto(){this._components.Upload.selectFiles(!0)}onUploadFile(){this._components.Upload.selectFiles(!1)}showAttach(){this._components.AttachMenu.show()}showEmoji(){let t=this.$(".emojiAt").getBoundingClientRect();this._app._interface._components.EmojiDialog.show(t.left,t.top)}calculateEntities(t){let e=[],s=(""+t).match(/\bhttps?:\/\/\S+/gi),i=function(t,e,s){let i=t.length;if(0==i)return[];let a,o=0,n=[];for(s||(e=e.toLowerCase(),t=t.toLowerCase());(a=e.indexOf(t,o))>-1;)n.push(a),o=a+i;return n};if(s&&s.length)for(let a of s){let s=i(a,t,!1),o=(""+a).length;for(let t of s)e.push({_:"messageEntityUrl",offset:t,length:o})}return e}onEmoji(t){const e=this.$("#body");if(e.selectionStart||0===e.selectionStart&&e.selectionEnd){let s=e.selectionStart,i=e.selectionEnd;e.value=e.value.substring(0,s)+t+e.value.substring(i,e.value.length),e.selectionStart=e.value.length,e.selectionEnd=e.value.length}else e.value+=t;this.onChange()}removeAttach(){this._replyToMessage=null,this._webpage=null,this.$(".newMessageAttached").classList.remove("hasSomething")}setReplyToMessage(t){if(!this.$())return!1;this._webpage=null,this._replyToMessage=t,this.$(".author").innerHTML=this.escapeHTML(t.getAuthorFirstName()),this.$(".replyBody").innerHTML=this.escapeHTML(t.getDisplayMessage()),this.$(".newMessageAttached").classList.add("hasSomething"),this.$(".messageReply").classList.add("active"),this.$(".messageWebpage").classList.remove("active")}updateWebpagePreview(t){t&&t.site_name?(this._replyToMessage=null,this._webpage=t,this.$(".webpageSitename").innerHTML=this.escapeHTML(t.site_name),this.$(".webpageTitle").innerHTML=this.escapeHTML(t.title?t.title:"")+"&nbsp;",this.$(".newMessageAttached").classList.add("hasSomething"),this.$(".messageReply").classList.remove("active"),this.$(".messageWebpage").classList.add("active")):this.$(".newMessageAttached").classList.remove("hasSomething")}async detectURLs(t){let e=(""+t).match(/\bhttps?:\/\/\S+/gi);if(e&&e[0]){let t=""+e[0];if(t==this._mostRecentURLFetched)return!1;let s=await this._app._user.invoke("messages.getWebPage",{url:t});s&&s&&s.data&&"webPage"==s.data._&&this.updateWebpagePreview(s.data),this._mostRecentURLFetched=t}}setTextHeightStyle(t){const e=this.$("#body");this._textHeightStyle=t,"small"==t?(e.classList.remove("newMessageLarge"),e.classList.remove("newMessageHuge")):"large"==t?(e.classList.remove("newMessageHuge"),e.classList.add("newMessageLarge")):"huge"==t&&(e.classList.add("newMessageHuge"),e.classList.remove("newMessageLarge")),this.emit("mode",t)}onChange(t){if(t&&t.keyCode&&13==t.keyCode&&"small"==this._textHeightStyle){let e;return e=window.event?!!window.event.shiftKey:!!ev.shiftKey,e||(this.onSubmit(),t.preventDefault()),!0}this.nextTick(()=>{const t=this.$("#body"),e=t.offsetHeight,s=t.scrollHeight,i=t.value.length;this.detectURLs(t.value),this._setToLargeAt&&this._setToLargeAt>i+2&&(this._setToLargeAt=null,this._setToHugeAt=null,this.setTextHeightStyle("small")),this._setToHugeAt&&this._setToHugeAt>i+2&&(this._setToHugeAt=null,this.setTextHeightStyle("large")),s>e+2&&("small"==this._textHeightStyle?(this.setTextHeightStyle("large"),this._setToLargeAt=this._lastELength):"large"==this._textHeightStyle&&i>this._setToLargeAt+10&&(this.setTextHeightStyle("huge"),this._setToHugeAt=this._lastELength)),this._lastELength=i,this._lastELength?this.$(".newMessageContainer").classList.add("withText"):this.$(".newMessageContainer").classList.remove("withText")})}}r.template='\n\t\t\t<div class="newMessageContainer">\n\t\t\t\t<div class="newMessageButton" id="send">\n\t\t\t\t\t<div id="sendMessage" class="nmbType">{{component(options.components.IconSend)}}{{/component}}</div>\n\t\t\t\t\t<div id="sendVoice" class="nmbType">{{component(options.components.IconMic)}}{{/component}}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="deleteVoiceButton" id="delete">\n\t\t\t\t\t<div id="deleteVoice" class="nmbType">{{component(options.components.IconDelete)}}{{/component}}</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="newMessageComposer">\n\t\t\t\t\t<div class="newMessageAttached">\n\t\t\t\t\t\t<div class="removeAttach" id="removeAttach">{{component(options.components.IconClose)}}{{/component}}</div>\n\t\t\t\t\t\t<div class="messageReply newMessageAttachedCont">\n\t\t\t\t\t\t\t<div class="author"></div>\n\t\t\t\t\t\t\t<div class="replyBody"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="messageWebpage newMessageAttachedCont">\n\t\t\t\t\t\t\t<div class="webpageSitename"></div>\n\t\t\t\t\t\t\t<div class="webpageTitle"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="emojiContr">\n\t\t\t\t\t\t<div class="emojiAt"></div>\n\t\t\t\t\t\t<div class="emojiButton" id="emojiButton">{{component(options.components.IconSmile)}}{{/component}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="newMessageAttachment">\n\t\t\t\t\t\t{{component(options.components.AttachMenu)}}{{/component}}\n\t\t\t\t\t\t<div class="attachButton" id="attachButton">{{component(options.components.IconAttach)}}{{/component}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="newMessageVoice">\n\t\t\t\t\t\t<div class="nmvDuration"></div>\n\t\t\t\t\t\t<div class="mmvStatus">\n\t\t\t\t\t\t\t<div class="mmvStatusIcon"></div>\n\t\t\t\t\t\t\t<div class="nmvRecording"></div>\n\t\t\t\t\t\t\t<div class="nmvInitializing active"><div class="cssload-zenith dark"></div></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="newMessageText"><textarea placeholder="Message" id="body"></textarea></div>\n\t\t\t\t</div>\n\n\t\t\t\t{{component(options.components.Upload)}}{{/component}}\n\n\t\t\t</div>\n\t\t',t.exports=r},function(t,e,s){const i=window.classes.UI,a=s(0),o=window.classes.Button,n=window.classes.UIInput,r=s(11);t.exports=class extends i{constructor(t){super(t),this._components.CloseIcon=this.newC(a,{icon:"close"}),this._components.Button=this.newC(o,{title:"Send",loadingTitle:"Sending..."}),this._components.CaptionInput=this.newC(n,{label:"Caption"}),this._events=[["click","uploadClose","onClose"],["click","uploadPreviewAlbum","onAlbumClick"]],this._componentEvents=[["click","Button","sendFiles"]],this._files=[],this._uploadingMedia=!1}buttonLoading(t){t?(this.$(".uploadButton").style.display="none",this.$(".uploadLoading").style.display="block"):(this.$(".uploadButton").style.display="block",this.$(".uploadLoading").style.display="none")}sendFiles(){this.emit("sendFiles",{files:this._files,caption:this._components.CaptionInput.val()}),this.buttonLoading(!0),setTimeout(()=>{this.hide()},2e3)}onClose(){this.hide()}show(){this.$("#uploadTop").style.display="block",this.$(".popupOverlay").classList.add("active"),this.loaded(),this.initScrollBarOn(this.$(".uploadPreview"))}hide(){this.$(".popupOverlay").classList.remove("active"),this.$(".popupOverlay").classList.add("fading"),setTimeout(()=>{this.$(".popupOverlay").classList.remove("fading"),this.$("#uploadTop").style.display="none",this.buttonLoading(!1)},500)}async readFile(t){let e=t=>new Promise((e,s)=>{const i=new Image;i.onload=function(){e([this.width,this.height])},i.onerror=function(){e([100,100])},i.src=t.dataURL});try{let a=await(s=t,i="readAsArrayBuffer",new Promise((t,e)=>{let a=new FileReader;a.onload=e=>{t(e.target.result)},a.onerror=t=>{e(t)},a.onabort=()=>{e()},a[i](s)})),o=""+t.name||"undefined",n=-1!=o.lastIndexOf(".")?o.substr(o.lastIndexOf(".")+1).toLowerCase():"",r={ab:a,name:t.name,size:t.size,filename:o,ext:n,type:"doc",aspectRatio:1};const d=Math.floor(Math.log(r.size)/Math.log(1024));r.sizeHuman=1*(r.size/Math.pow(1024,d)).toFixed(2)+" "+["B","kB","MB","GB","TB"][d],r.color=(n+" ").charCodeAt(0)%8+1,r.random=(""+Math.random()).split(".").join("");let l=["mp4","mpeg","avi","mov"];return-1!=["png","jpg","jpeg"].indexOf(n)&&this._uploadingMedia?r.type="photo":-1!=l.indexOf(n)&&this._uploadingMedia&&(r.type="video"),"photo"==r.type?(r.dataURL=URL.createObjectURL(t),[r.width,r.height]=await e(r)):"video"==r.type&&(r.width=100,r.height=100),this._files.push(r),r}catch(t){return!1}var s,i}loaded(){this.updateTitle(),this.generateUploadPreview()}updateTitle(){let t="Send "+(this._files.length>1?this._files.length:"")+" "+{doc:"File",video:"Video",photo:"Photo"}[this._files[0].type]+(this._files.length>1?"s":"");this.$(".uploadTitle").innerHTML=t}onAlbumClick(t){const e=this.$();let s=event.target.closest(".upiRemove");if(s&&e.contains(s)){const t=s.parentElement;if(t){const e=t.id.split("uploadPreviewItem_").join("");let s=null;for(let t=0;t<this._files.length;t++)this._files[t].random==e&&(s=t);null!==s&&(this._files.splice(s,1),t.remove(),this._files.length?(this.doCalcs(),this.updateTitle()):this.hide())}}}doCalcs(){this._layouter=new r(this._files,{maxWidth:384}),this._files=this._layouter.layout();for(let t of this._files){const e=this.$("#uploadPreviewItem_"+t.random);e&&(e.style.left=t.pos.left+"px",e.style.top=t.pos.top+"px",e.style.width=t.pos.width+"px",e.style.height=t.pos.height+"px")}this.$("#uploadPreviewAlbum").style.height=this._layouter._height+"px",this.initScrollBarOn(this.$(".uploadPreview"))}swapItems(t,e){if(t==e)return;t=t.split("uploadPreviewItem_").join(""),e=e.split("uploadPreviewItem_").join("");let s=null,i=null,a=null,o=null;for(let n=0;n<this._files.length;n++)this._files[n].random==t&&(s=this._files[n],i=n),this._files[n].random==e&&(a=this._files[n],o=n);this._files[i]=a,this._files[o]=s,this.doCalcs()}async generateVideoPreview(t,e){let s=t.ab;e&&(s=t.ab.slice(0,e));let i=new Response(s,{status:206,statusText:"Partial Content",headers:[["Content-Type","video/mp4"],["Content-Length",t.ab.byteLength],["Content-Range","0-"+(s.byteLength-1)+"/"+t.ab.byteLength]]}),a=await i.blob(),o=URL.createObjectURL(a),n=new Promise((e,s)=>{let i=document.createElement("video");i.addEventListener("error",(function(t){s()}),!0),i.onloadeddata=a=>{let o=i.videoWidth,n=i.videoHeight,r=document.createElement("canvas");r.width=o,r.height=n,t.aspectRatio=n?o/n:1,t.width=o,t.height=n,this.doCalcs();let d=r.getContext("2d");d.imageSmoothingEnabled=!0,d.drawImage(i,0,0,o,n);let l=document.createElement("canvas");l.width=o,l.height=n,r.toDataURL()==l.toDataURL()&&s(),r.toBlob(t=>{let s=URL.createObjectURL(t);e(s)})},i.preload="metadata",i.src=o,i.muted=!0,i.playsInline=!0,i.play()});return await n}generateUploadPreviewForFile(t){const e=this._components.CloseIcon.render({noDOM:!0});return"photo"==t.type?'<div class="uploadPreviewItem" draggable="true" id="uploadPreviewItem_'+t.random+'"  style="background-image: url(\''+t.dataURL+"'); "+t.style+'"><div class="upiRemove">'+e+"</div></div>":"video"==t.type?'<div class="uploadPreviewItem" draggable="true" id="uploadPreviewItem_'+t.random+'" style="border: 1px solid #eee;"><div class="upiRemove">'+e+"</div></div>":"doc"==t.type?`<div class="uploadDocItem">\n\t\t\t\t<div class="rsDoc">\n\t\t\t \t\t<div class="rsDocIcon avatarC${t.color}">${t.ext}</div>\n\t\t\t \t\t<div class="rsDocName">${t.filename}</div>\n\t\t\t \t\t<div class="rsDocMeta">${t.sizeHuman}</div>\n\t\t\t \t</div>\n\t\t\t</div>`:void 0}async generateUploadPreview(){this.doCalcs();let t="";for(let e of this._files)t+=this.generateUploadPreviewForFile(e);this.$(".uploadPreviewAlbum").innerHTML=t;for(let t of this._files){const e=this.$("#uploadPreviewItem_"+t.random);if(e&&(e.addEventListener("dragstart",t=>{t.dataTransfer.dropEffect="move",t.dataTransfer.setData("text/plain",t.target.id)}),e.addEventListener("touchend",t=>{if(t.target&&t.target.classList.contains("uploadPreviewItem")&&t.changedTouches&&t.changedTouches[0]){let e=t.changedTouches[0].clientX,s=t.changedTouches[0].clientY;for(let i of this._files){const a=this.$("#uploadPreviewItem_"+i.random),o=a.getBoundingClientRect();if(e>o.left&&e<o.left+o.width&&s>o.top&&s<o.top+o.height)return this.swapItems(a.id,t.target.id)}}}),e.addEventListener("dragover",t=>{t.preventDefault(),t.dataTransfer.dropEffect="move"}),e.addEventListener("drop",t=>{t.preventDefault();let e=t.target.id,s=t.dataTransfer.getData("text/plain");this.swapItems(e,s)})),e&&"video"==t.type&&!t.previewGenerated){let s=null;try{s=await this.generateVideoPreview(t,262144)}catch(e){try{s=await this.generateVideoPreview(t,5242880)}catch(e){try{s=await this.generateVideoPreview(t,10485760)}catch(t){}}}s?e.style.backgroundImage="url('"+s+"')":e.style.backgroundColor="black",e.innerHTML+="<div class=playIcon></div>",t.previewGenerated=!0}}}selectFiles(t){this._uploadingMedia=t;let e=this.$("#"+this.domId+"_fileInput_files");t&&(e=this.$("#"+this.domId+"_fileInput_media")),this._files=[],e.onchange=()=>{if(e.files){let t=[];for(let s of e.files)t.push(this.readFile(s));Promise.all(t).then(()=>{this.show(),e.value=""})}},e.click()}template(){return'\n\t\t\t<div id="uploadTop">\n\t\t\t\t<div class="popupOverlay">\n\t\t\t\t\t<div class="popup">\n\t\t\t\t\t\t<input type="file" id="{{domId}}_fileInput_media" class="hidden"  multiple="multiple" accept="image/*,video/*,.jpg,.png,.mp4">\n\t\t\t\t\t\t<input type="file" id="{{domId}}_fileInput_files" class="hidden"  multiple="multiple">\n\t\t\t\t\t\t<div class="uploadPanel">\n\t\t\t\t\t\t\t<div class="uploadClose" id="uploadClose">{{component(options.components.CloseIcon)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="uploadButton">{{component(options.components.Button)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="uploadLoading">\n\t\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="uploadTitle">Send 3 photos</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="uploadPreview">\n\t\t\t\t\t\t\t<div class="uploadPreviewAlbum" id="uploadPreviewAlbum"></div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="uploadCaption">\n\t\t\t\t\t\t\t{{component(options.components.CaptionInput)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=window.classes.UI,a=s(0),o=window.classes.Button,n=(window.classes.UIInput,window.classes.TGS);t.exports=class extends i{constructor(t){super(t),this._components.CloseIcon=this.newC(a,{icon:"close"}),this._components.Button=this.newC(o,{title:"Add",loadingTitle:"Adding..."}),this._events=[["click","stickersPopupClose","onClose"],["click","emojiPopupTop","onClickOut"],["mouseover","stickersPreviewItems","onMouseOver"]],this._componentEvents=[["click","Button","onButtonClick"]],this._files=[],this._tgss={},this._uploadingMedia=!1,this._isStickerSetInstalled=!1,this._playStickerTimeout=null,this._lastStickerId=null}onMouseOver(t){const e=this.$("#stickersPreviewItems"),s=t.target.closest(".previewStickerItem");s&&e.contains(s)&&s.dataset&&s.dataset.id&&this._lastStickerId!=s.dataset.id&&this._tgss[s.dataset.id]&&(this._lastStickerId=s.dataset.id,this._playStickerTimeout&&clearTimeout(this._playStickerTimeout),this._playStickerTimeout=setTimeout(()=>{this._tgss[s.dataset.id].playOnce()},200))}onClickOut(t){let e=[".popup"];for(let s of e)if(t.target.closest(s))return!1;this.hide()}onButtonClick(){this._stickerSet&&(this._isStickerSetInstalled?(this._peerManager._stickers.uninstallStickerSet(this._stickerSet),this.hide()):(this._peerManager._stickers.installStickerSet(this._stickerSet),this.hide()))}reinitScrollBar(t){let e=this.$(".stickersPreview");this.initScrollBarOn(e,t)}afterRender(){this.reinitScrollBar(!0)}buttonLoading(t){}onClose(){this.hide()}async initializeNextAnimation(){this._initializedAnimationOn||(this._initializedAnimationOn={});for(let t of this._stickerSet._stickers)if(t.tgs&&!this._initializedAnimationOn[""+t._id]){if(t.json&&this.$("#animated_"+t.id)){const e=new n(this.$("#animated_"+t.id));e.setJSON(t.json,!0),this._tgss[t.id]=e}this._initializedAnimationOn[""+t._id]=!0,await new Promise(t=>{setTimeout(t,50)})}}updatePreview(){if(this._stickerSet&&this._stickerSet._imagesLoaded){let t=80*Math.ceil(this._stickerSet.count/5);this.$(".stickerSetDiv").style.height=t+"px",this.$(".stickerSetDiv").style.display="block",this.$(".stickersLoading").style.display="none";let e="",s=0,i=0;for(let t of this._stickerSet._stickers)t.tgs?e+='<div class="animated '+(4==i?"animatedNoPadd":"")+' previewStickerItem" id="animated_'+t.id+'" data-set="'+this._stickerSet.id+'" data-id="'+t.id+'"></div>':e+='<span class="'+(4==i?"animatedNoPadd":"")+' previewStickerItem" style="background-image: url('+t.blobURL+')" data-set="'+this._stickerSet.id+'" data-id="'+t.id+'"></span>',i++,5==i&&(i=0,s++);this.$(".stickerSetDiv").innerHTML=e,this.nextTick(()=>{this.initializeNextAnimation()})}else this.$(".stickerSetDiv").style.display="none",this.$(".stickersLoading").style.display="block";this._stickerSet?(this.$(".uploadTitle").innerHTML=this.escapeHTML(this._stickerSet.name),this._isStickerSetInstalled?this._components.Button._data.title="Remove stickers":this._components.Button._data.title="Add "+this._stickerSet.count+" stickers",this.$(".buttonTitle").innerHTML=this.escapeHTML(this._components.Button._data.title),this.$(".button").style.display="block"):this.$(".uploadTitle").innerHTML="&nbsp;",this.reinitScrollBar(!0)}async loadStickerSet(){await this._stickerSet.load(),this._isStickerSetInstalled=await this._peerManager._stickers.isStickerSetInstalled(this._stickerSet),this.updatePreview()}async loadSticker(){this._stickerSet=await this._peerManager._stickers.getStickerSetBySticker(this._sticker),await this.loadStickerSet()}show(t){this._peerManager=t.peerManager,t.stickerSet?this._stickerSet=t.stickerSet:this._stickerSet=null,t.sticker?this._sticker=t.sticker:this._sticker=null,this.$("#emojiPopupTop").style.display="block",this.$(".popupOverlay").classList.add("active"),this.$(".button").style.display="none",this.updatePreview(),this._initializedAnimationOn={},t.stickerSet?this.loadStickerSet():t.sticker&&this.loadSticker()}hide(){this.$(".popupOverlay").classList.remove("active"),this.$(".popupOverlay").classList.add("fading"),setTimeout(()=>{this.$(".stickersPreview").scrollTop=0,this.$(".popupOverlay").classList.remove("fading"),this.$("#emojiPopupTop").style.display="none",this.buttonLoading(!1);for(let t in this._tgss)this._tgss[t].destroy();this._tgss={},this.$(".stickerSetDiv").innerHTML=""},500)}updateTitle(){}template(){return'\n\t\t\t<div id="emojiPopupTop">\n\t\t\t\t<div class="popupOverlay">\n\t\t\t\t\t<div class="popup">\n\t\t\t\t\t\t<div class="uploadPanel">\n\t\t\t\t\t\t\t<div class="uploadClose" id="stickersPopupClose">{{component(options.components.CloseIcon)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="uploadTitle"></div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="stickersPreview">\n\t\t\t\t\t\t\t<div class="stickersLoading"><div class="cssload-zenith dark" style="margin-top: 80px;"></div></div>\n\t\t\t\t\t\t\t<div class="stickerSetDiv" id="stickersPreviewItems"></div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="stickersButton">\n\t\t\t\t\t\t\t{{component(options.components.Button)}}{{/component}}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(0),a=window.classes.Button,o=s(1),n=s(7),r=s(5),d=window.classes.Icon,l=s(51);t.exports=class extends o{constructor(t){super(t),this._peerManager=this._app._peerManager,this._events=[["click","panelBack","backToDialogs"],["click","panelSearch","onStartSearch"],["click","panelMute","onMute"],["click","panelUnMute","onMute"],["click","panelAvatar","onShowMore"],["click","panelMeta","onShowMore"],["click","ptpPause","onPause"],["click","ptpMeta","onAudioMessage"],["click","ptpClose","onAudioClose"],["click","panelMore","onBurger"],["click","sccCal","onCal"],["click","sccPrev","prevSearch"],["click","sccNext","nextSearch"]],this._components.SearchCalendar=this.newC(l),this._components.SubsButton=this.newC(a,{title:"Subscribe",loadingTitle:"Subscribing..."}),this._components.BackIcon=this.newC(i,{icon:"back"}),this._components.SearchIcon=this.newC(i,{icon:"search"}),this._components.MuteIcon=this.newC(i,{icon:"muted"}),this._components.UnMuteIcon=this.newC(i,{icon:"unmute"}),this._components.MoreIcon=this.newC(i,{icon:"more"}),this._components.SearchBox=this.newC(n),this._components.IconDown=this.newC(d,{flip:!0}),this._components.IconUp=this.newC(d),this._components.IconCal=this.newC(i,{icon:"calendar"}),this._components.Menu=this.newC(r,{items:[["search","search","Search"],["mute","muted","Mute"]]}),this._componentEvents=[["click","SubsButton","onSubs"],["search","Menu","onStartSearch"],["search","SearchBox","onSearch"],["messageId","SearchCalendar","onCalendarMessage"]],this._data.peer=t.peer||null,this._data.isLoading=!0,this._data.sidebarIsClosed=!0,this._peerManager.on("subscribed",t=>{if(t.peer._id==this._data.peer._id){const t=this.$(".panelSubs");this._data.peer.isSubscribed()?t.classList.remove("visible"):t.classList.add("visible")}}),this._peerManager.on("updated",t=>{if(t.peer&&t.peer._id==this._data.peer._id){const e=t.peer.isMuted();this.$("#panelMute").classList[e?"remove":"add"]("visible"),this.$("#panelUnMute").classList[e?"add":"remove"]("visible"),this.$(".panelTitle").innerHTML=this.escapeHTML(this._data.peer.getDisplayName())}}),this._app._mediaPlayer.on("pause",t=>{this.itemPlaying(t.messageAudio,!1)}),this._app._mediaPlayer.on("play",t=>{this.itemPlaying(t.messageAudio,!0)}),this._searchCount=0,this._searched=[],this._searchCache={},this._avatarsMemory={}}onCalendarMessage(t){this._parent._components.Panel.jumpToMessage(t)}avatarToMemory(t,e){if(console.error(e),!e.dataset.loaded)return;const s=document.querySelector("#avmemory"),i=e.cloneNode();this._avatarsMemory[t]||(this._avatarsMemory[t]=i,s.appendChild(i))}onCal(){this._components.SearchCalendar.show({peerManager:this._peerManager})}onBurger(t){this._components.Menu.show(t)}onSwipe(t){if(-1!=["left","right"].indexOf(t)&&!this.$().classList.contains("invisible"))return!!this._app._interface._components.EmojiDialog.isVisible||("right"==t?(this._parent.showDialogs(),!0):"left"==t?(this.onShowMore(),!0):void 0)}onAudioClose(){this.$(".panelTopPlayer").classList.remove("visible")}onPause(){this._app._mediaPlayer.pausePlaying()}onAudioMessage(){try{let t=this._app._mediaPlayer._playingAudio._messageApiObject.id;this._parent._components.Panel.jumpToMessage(t)}catch(t){}}itemPlaying(t,e){e?(this.$(".panelTopPlayer").classList.add("visible"),t.isVoice?this.$(".ptpTrack").innerHTML="Voice Message":this.$(".ptpTrack").innerHTML=t.getInfo("title"),this.$(".ptpArtist").innerHTML=t.getInfo("performer")):this.$(".panelTopPlayer").classList.remove("visible")}onMute(){this._data.peer.toggleDialogMuted(!this._data.peer.isMuted())}onSubs(){let t=!0;this._data.peer.isSubscribed()&&(t=!1),this._data.peer.subscribe(t)}onShowMore(){this._parent._components.RightSidebar.showBlock("Info"),this._parent._components.RightSidebar.show()}hideSearch(){try{this._searchCount=0,this.$(".panelTopBar").classList.remove("inSearch"),this.$(".searchControl").classList.remove("active"),this._components.SearchBox.setActive(!1)}catch(t){}}backToDialogs(){this.$(".panelTopBar").classList.contains("inSearch")?this.hideSearch():this.emit("toDialogs")}onStartSearch(){this.$(".panelTopBar").classList.add("inSearch"),this.$(".searchControl").classList.add("active"),this.$(".sccInfo").classList.remove("active"),this._components.SearchBox.setActive(!0),this._components.SearchBox.focus(),this._searchCount=0}prevSearch(){this._lastSearchN!=this._searchCount-1&&this.jumpToSearch(this._lastSearchN+1)}nextSearch(){this._lastSearchN&&this.jumpToSearch(this._lastSearchN-1)}uc(){this.$("#sccNext").classList[0!=this._lastSearchN&&this._searchCount?"remove":"add"]("inactive"),this.$("#sccPrev").classList[!this._searchCount||this._lastSearchN>=this._searchCount-1?"add":"remove"]("inactive")}jumpToSearch(t){this._lastSearchN=t,this.$(".sccInfo").classList[this._searchCount?"add":"remove"]("visible"),this.$(".sccInfo").innerHTML=t+1+" of "+this._searchCount,this.uc(),console.error(this._searched[t]),this._parent._components.Panel.jumpToMessage(this._searched[t].peerMessage._id,this._lastSearch)}doSearch(t){this.__searchTimeout&&clearTimeout(this.__searchTimeout),setTimeout(async()=>{let e=null;this._searchCache[t]?e=this._searchCache[t]:(e=await this._peerManager.search(t,this._data.peer),this._searchCache[t]=e),this._lastSearch=t,this._searchCount=e.totalMessages,this._searched=e.messages,this.jumpToSearch(0)},100)}onSearch(t){t?(this._components.SearchBox.setActive(!0),this.doSearch(t)):this.hideSearch()}updateInfo(){this.$(".panelInfo").innerHTML=this._data.peer.getInfoString()}setPeer(t){if(!t||this._data.peer&&this._data.peer._id==t._id)return!0;if(!t)return!1;if(this.hideSearch(),this._searchCache={},this._data.peer){this.$(".panelTitle").innerHTML=t.getDisplayNameWB();let e=t.getInfoString();if(this.$(".panelInfo").innerHTML=this.escapeHTML(e),this.$(".panelInfo").classList["online"==e?"add":"remove"]("panelInfoOnline"),this._avatarsMemory[t._id]){this.$(".panelAvatar").innerHTML=`<div class="panelTopAvatar avatarMedium wantmemory avatar" id="avatar_${this._domId}_${t._id}" data-id="${t._id}"></div>`;let e=this._avatarsMemory[t._id];this.$(".wantmemory").appendChild(e),this._avatarsMemory[t._id]=null}else this.$(".panelAvatar").innerHTML=this.avHTML(t,"panelTopAvatar avatarMedium");const s=t.isMuted();this.$("#panelMute").classList[s?"remove":"add"]("visible"),this.$("#panelUnMute").classList[s?"add":"remove"]("visible"),this.$(".panelSubs").classList[t.isSubscribed()?"remove":"add"]("visible"),this._data.peer=t}else this._app._config.getSetting("rightSidebarVisible")?this._data.sidebarIsClosed=!1:this._data.sidebarIsClosed=!0,this._data.peer=t,this.render();t.getFullInfo().then(()=>{this.updateInfo(),this.$(".panelTitle").innerHTML=t.getDisplayNameWB()})}template(){return`\n\t\t\t{{if (!options.peer)}}\n\t\t\t{{#else}}\n\t\t\t\t<div class="panelTopBar panelPos {{if (options.sidebarIsClosed)}}panelNoSidebar{{/if}}">\n\t\t\t\t\t<div class="panelIcon panelBack" id="panelBack">\n\t\t\t\t\t\t{{component(options.components.BackIcon)}}{{/component}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="panelAvatar" id="panelAvatar">\n\t\t\t\t\t\t{{self.avHTML(options.peer, 'panelTopAvatar avatarMedium')|safe}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="panelMeta" id="panelMeta">\n\t\t\t\t\t\t<div class="panelTitle">{{peer.getDisplayNameWB()|safe}}</div>\n\t\t\t\t\t\t{{js(options.infoString = options.peer.getInfoString())/}}\n\t\t\t\t\t\t<div class="panelInfo {{if (options.infoString == 'online')}}panelInfoOnline{{/if}}">{{infoString}}</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="panelActions">\n\t\t\t\t\t\t<div class="panelIcon panelMuted {{if (!options.peer.isMuted())}}visible{{/if}}" id="panelMute">\n\t\t\t\t\t\t\t{{component(options.components.MuteIcon)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="panelIcon panelMuted {{if (options.peer.isMuted())}}visible{{/if}}" id="panelUnMute">\n\t\t\t\t\t\t\t{{component(options.components.UnMuteIcon)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="panelIcon panelSearch" id="panelSearch">\n\t\t\t\t\t\t\t{{component(options.components.SearchIcon)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="panelIcon panelMore" id="panelMore">\n\t\t\t\t\t\t\t{{component(options.components.MoreIcon)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="panelMenu"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div id="panelSearchBox">\n\t\t\t\t\t\t{{component(options.components.SearchBox)}}{{/component}}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="panelSubs {{if (!options.peer.isSubscribed())}}visible{{/if}}">{{component(options.components.SubsButton)}}{{/component}}</div>\n\n\t\t\t\t\t<div class="panelTopPlayer">\n\t\t\t\t\t\t<div class="panelIcon ptpPause" id="ptpPause">${o.getIconHTML("pause")}</div>\n\t\t\t\t\t\t<div class="panelIcon ptpClose" id="ptpClose">${o.getIconHTML("close")}</div>\n\t\t\t\t\t\t<div class="ptpMeta" id="ptpMeta">\n\t\t\t\t\t\t\t<div class="ptpArtist"></div>\n\t\t\t\t\t\t\t<div class="ptpTrack"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t{{component(options.components.Menu)}}{{/component}}\n\n\t\t\t\t</div>\n\t\t\t\t<div class="searchControl">\n\t\t\t\t<div class="panelPos searchControlCont {{if (options.sidebarIsClosed)}}panelNoSidebar{{/if}}">\n\t\t\t\t\t<div class="panelActions panelActionsLeft">\n\t\t\t\t\t\t<div class="panelIcon inactive" id="sccCal">{{component(options.components.IconCal)}}{{/component}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sccInfo">\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="panelActions">\n\t\t\t\t\t\t<div class="panelIcon inactive" id="sccPrev">{{component(options.components.IconUp)}}{{/component}}</div>\n\t\t\t\t\t\t<div class="panelIcon inactive" id="sccNext">{{component(options.components.IconDown)}}{{/component}}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t{{component(options.components.SearchCalendar)}}{{/component}}\n\t\t\t{{/if}}\n\t\t`}}},function(t,e,s){const i=s(1),a=s(3),o=s(52);t.exports=class extends i{constructor(t){super(t),this._year=2020,this._month=7,this._events=[["click","calendarPrev","onPrev"],["click","calendarNext","onNext"],["click","calendarItems","onClick"],["click","calendarPopupTop","onClickOut"]],this._components.NavIcon=this.newC(o,{icon:"up"})}onClickOut(t){let e=[".popup"];for(let s of e)if(t.target.closest(s))return!1;this.hide()}onClick(t){let e=t.target.closest("span");e.dataset.day&&e.dataset.message&&(this.emit("messageId",e.dataset.message),this.hide())}onNext(){this.$("#calendarItemsNext").classList.add("gocur"),this.$("#calendarItemsCurrent").classList.add("goprev"),setTimeout(()=>{this._month++,this._month>11&&(this._month=0,this._year++),this.update()},500)}onPrev(){this.$("#calendarItemsPrev").classList.add("gocur"),this.$("#calendarItemsCurrent").classList.add("gonext"),setTimeout(()=>{this._month--,this._month<0&&(this._month=11,this._year--),this.update()},500)}update(){this.$("#calendarItems").innerHTML='<div id="calendarItemsPrev"></div><div id="calendarItemsCurrent"></div><div id="calendarItemsNext"></div>',this.$("#calendarItemsCurrent").innerHTML=this.getHTML(0),this.$("#calendarItemsNext").innerHTML=this.getHTML(1),this.$("#calendarItemsPrev").innerHTML=this.getHTML(-1),this.$("#calendarCur").innerText=a.monthsNames[this._month]+" "+this._year,this._peerManager._activePeer.getDaysMessages(this._month,this._year,t=>{this.daysData(t)})}daysData(t){this.$("#calendarItemsCurrent").querySelectorAll("span").forEach(e=>{try{t[e.dataset.day-1].el=e}catch(t){console.error(t)}}),console.error(t);for(let e=1;e<=t.length;e++)console.error(t[e-1].has),t[e-1].el.classList[t[e-1].has?"add":"remove"]("has"),t[e-1].el.dataset.message=t[e-1].id}getHTML(t){const e=t=>'<span data-day="'+t+'"><i>'+t+"</i></span>";let s="",i=new Date(this._year,this._month+t).getDay()-1,a=32-new Date(this._year,this._month+t,32).getDate(),o=1;for(let t=0;t<6;t++)for(let n=0;n<7;n++)if(0===t&&n<i)s+=e("&nbsp;");else{if(o>a)break;s+=e(o++)}return s}show(t){this._peerManager=t.peerManager,this.$("#calendarPopupTop").style.display="block",this.$(".popupOverlay").classList.add("active"),this.update()}hide(){this.$(".popupOverlay").classList.remove("active"),this.$(".popupOverlay").classList.add("fading"),setTimeout(()=>{this.$(".popupOverlay").classList.remove("fading"),this.$("#calendarPopupTop").style.display="none"},500)}template(){return'\n\t\t\t<div id="calendarPopupTop" style="display: none;">\n\t\t\t\t<div class="popupOverlay">\n\t\t\t\t\t<div class="popup">\n\n\t\t\t\t\t\t<div id="calendarTitle">Wed, May 27</div>\n\t\t\t\t\t\t<div id="calendarNav">\n\t\t\t\t\t\t\t<div id="calendarPrev">{{component(options.components.NavIcon)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div id="calendarCur">May 2020</div>\n\t\t\t\t\t\t\t<div id="calendarNext">{{component(options.components.NavIcon)}}{{/component}}</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div id="calendarDays">\n\t\t\t\t\t\t\t<span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div id="calendarItems">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(53);t.exports=class extends i{constructor(t){super(t),this._flip=t.flip||!1,this._data.icon=t.icon||"up",this._data.flip=this._flip}template(){return'\n\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" {{if(options.flip)}}class="flip"{{/if}}>\n\t\t\t\t<g fill="none" fill-rule="evenodd">\n\t\t\t\t\t{{if (options.icon==\'check\')}}\n\t\t\t\t    <polygon points="0 0 19 0 19 14 0 14"/>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t<polygon points="0 0 24 0 24 24 0 24"/>\n\t\t\t\t\t{{/if}}\n\t\t\t\t\t{{if (options.icon==\'up\')}}\n\t\t\t\t\t<path fill="#000" fill-rule="nonzero" d="M12,9.41421356 L18.2928932,15.7071068 C18.6834175,16.0976311 19.3165825,16.0976311 19.7071068,15.7071068 C20.0976311,15.3165825 20.0976311,14.6834175 19.7071068,14.2928932 L12.7071068,7.29289322 C12.3165825,6.90236893 11.6834175,6.90236893 11.2928932,7.29289322 L4.29289322,14.2928932 C3.90236893,14.6834175 3.90236893,15.3165825 4.29289322,15.7071068 C4.68341751,16.0976311 5.31658249,16.0976311 5.70710678,15.7071068 L12,9.41421356 Z"/>\n\t\t\t\t    {{/if}}\n\t\t\t\t\t{{if (options.icon==\'edit\')}}\n\t\t\t\t    <path fill="#000" fill-rule="nonzero" d="M7.70710678,20.7071068 C7.5195704,20.8946432 7.26521649,21 7,21 L4,21 C3.44771525,21 3,20.5522847 3,20 L3,17 C3,16.7347835 3.10535684,16.4804296 3.29289322,16.2928932 L16.5857864,3 C17.3257272,2.26005924 18.5012114,2.22111499 19.2869988,2.88316725 L19.4142136,3 L21,4.58578644 C21.7399408,5.3257272 21.778885,6.50121136 21.1168328,7.28699879 L21,7.41421356 L7.70710678,20.7071068 Z M5,17.4142136 L5,19 L6.58578644,19 L16.5857864,9 L15,7.41421356 L5,17.4142136 Z M18,4.41421356 L16.414,5.99921356 L18,7.58521356 L19.5857864,6 L18,4.41421356 Z"/>\n\t\t\t\t    {{/if}}\n\t\t\t\t\t{{if (options.icon==\'eye\')}}\n\t\t\t\t    <path fill="#000" fill-rule="nonzero" d="M12.0037244,5.5 C17.8510242,5.5 22,10.459316 22,12 C22,13.540684 17.8733706,18.5 12.0037244,18.5 C6.17877095,18.5 2,13.540684 2,12 C2,10.459316 6.20856611,5.5 12.0037244,5.5 Z M12,8 C9.790861,8 8,9.790861 8,12 C8,14.209139 9.790861,16 12,16 C14.209139,16 16,14.209139 16,12 C16,9.790861 14.209139,8 12,8 Z M12,10.5 C12.8284271,10.5 13.5,11.1715729 13.5,12 C13.5,12.8284271 12.8284271,13.5 12,13.5 C11.1715729,13.5 10.5,12.8284271 10.5,12 C10.5,11.1715729 11.1715729,10.5 12,10.5 Z"/>\n\t\t\t\t    {{/if}}\n\t\t\t\t\t{{if (options.icon==\'eye2\')}}\n\t\t\t\t    <path fill="#000" fill-rule="nonzero" d="M3.24742331,4.34149539 C3.58312982,3.95783081 4.14726,3.89243104 4.5589723,4.17068553 L4.65850461,4.24742331 L20.6585046,18.2474233 C21.0741412,18.6111054 21.1162587,19.242868 20.7525767,19.6585046 C20.4168702,20.0421692 19.85274,20.107569 19.4410277,19.8293145 L19.3414954,19.7525767 L16.678014,17.4222694 C15.3119739,18.0692771 13.7335408,18.5 12.0037244,18.5 C6.17877095,18.5 2,13.540684 2,12 C2,11.1350242 3.32652339,9.19250915 5.51558991,7.65500291 L3.34149539,5.75257669 C2.92585876,5.38889464 2.88374125,4.75713202 3.24742331,4.34149539 Z M8,12 C8,14.209139 9.790861,16 12,16 C12.836931,16 13.6138279,15.7429633 14.2560564,15.3035242 L12.1815054,13.4891302 C12.1220062,13.4963068 12.0614344,13.5 12,13.5 C11.1773258,13.5 10.509335,12.8377221 10.500097,12.017236 L8.42584708,10.2021204 C8.15342141,10.7426353 8,11.3534009 8,12 Z M12.0037244,5.5 C17.8510242,5.5 22,10.459316 22,12 C22,12.6358131 21.2972072,13.8538424 20.059148,15.0652638 L15.9670652,11.4843103 C15.7225066,9.58427469 14.1447921,8.10174686 12.2022178,8.00502282 L11.984,8 L9.48427708,5.81332663 C10.2814494,5.61420081 11.1243193,5.5 12.0037244,5.5 Z"/>\n\t\t\t\t    {{/if}}\n\t\t\t\t\t{{if (options.icon==\'photo\')}}\n    \t\t\t\t<path fill="#000" fill-rule="nonzero" d="M19.8833789,16.0067277 L20,16 C20.5128358,16 20.9355072,16.3860402 20.9932723,16.8833789 L21,17 L21,19 L23,19 C23.5128358,19 23.9355072,19.3860402 23.9932723,19.8833789 L24,20 C24,20.5128358 23.6139598,20.9355072 23.1166211,20.9932723 L23,21 L21,21 L21,23 C21,23.5128358 20.6139598,23.9355072 20.1166211,23.9932723 L20,24 C19.4871642,24 19.0644928,23.6139598 19.0067277,23.1166211 L19,23 L19,21 L17,21 C16.4871642,21 16.0644928,20.6139598 16.0067277,20.1166211 L16,20 C16,19.4871642 16.3860402,19.0644928 16.8833789,19.0067277 L17,19 L19,19 L19,17 C19,16.4871642 19.3860402,16.0644928 19.8833789,16.0067277 L20,16 L19.8833789,16.0067277 Z M8.41421356,2 L13.5857864,2 C14.0572824,2 14.5116128,2.16648982 14.8701798,2.46691315 L15,2.58578644 L16.4142136,4 L18,4 C19.5976809,4 20.9036609,5.24891996 20.9949073,6.82372721 L21,7 L21,12 C21,12.5522847 20.5522847,13 20,13 C19.4871642,13 19.0644928,12.6139598 19.0067277,12.1166211 L19,12 L19,7 C19,6.48716416 18.6139598,6.06449284 18.1166211,6.00672773 L18,6 L16.4142136,6 C15.9427176,6 15.4883872,5.83351018 15.1298202,5.53308685 L15,5.41421356 L13.5857864,4 L8.41421356,4 L7,5.41421356 C6.66660199,5.74761157 6.22761579,5.95114561 5.76163928,5.99225938 L5.58578644,6 L4,6 C3.48716416,6 3.06449284,6.38604019 3.00672773,6.88337887 L3,7 L3,18 C3,18.5128358 3.38604019,18.9355072 3.88337887,18.9932723 L4,19 L13,19 C13.5522847,19 14,19.4477153 14,20 C14,20.5128358 13.6139598,20.9355072 13.1166211,20.9932723 L13,21 L4,21 C2.40231912,21 1.09633912,19.75108 1.00509269,18.1762728 L1,18 L1,7 C1,5.40231912 2.24891996,4.09633912 3.82372721,4.00509269 L4,4 L5.58578644,4 L7,2.58578644 C7.33339801,2.25238843 7.77238421,2.04885439 8.23836072,2.00774062 L8.41421356,2 L13.5857864,2 L8.41421356,2 Z M11,7 C13.7614237,7 16,9.23857625 16,12 C16,14.7614237 13.7614237,17 11,17 C8.23857625,17 6,14.7614237 6,12 C6,9.23857625 8.23857625,7 11,7 Z M11,9 C9.34314575,9 8,10.3431458 8,12 C8,13.6568542 9.34314575,15 11,15 C12.6568542,15 14,13.6568542 14,12 C14,10.3431458 12.6568542,9 11,9 Z"/>\n    \t\t\t\t{{/if}}\n\t\t\t\t    {{if (options.icon==\'close\')}}\n\t\t\t\t    <path fill="#000" fill-rule="nonzero" d="M5.20970461,5.38710056 L5.29289322,5.29289322 C5.65337718,4.93240926 6.22060824,4.90467972 6.61289944,5.20970461 L6.70710678,5.29289322 L12,10.585 L17.2928932,5.29289322 C17.6834175,4.90236893 18.3165825,4.90236893 18.7071068,5.29289322 C19.0976311,5.68341751 19.0976311,6.31658249 18.7071068,6.70710678 L13.415,12 L18.7071068,17.2928932 C19.0675907,17.6533772 19.0953203,18.2206082 18.7902954,18.6128994 L18.7071068,18.7071068 C18.3466228,19.0675907 17.7793918,19.0953203 17.3871006,18.7902954 L17.2928932,18.7071068 L12,13.415 L6.70710678,18.7071068 C6.31658249,19.0976311 5.68341751,19.0976311 5.29289322,18.7071068 C4.90236893,18.3165825 4.90236893,17.6834175 5.29289322,17.2928932 L10.585,12 L5.29289322,6.70710678 C4.93240926,6.34662282 4.90467972,5.77939176 5.20970461,5.38710056 L5.29289322,5.29289322 L5.20970461,5.38710056 Z"/>\n\t\t\t\t    {{/if}}\n\t\t\t\t    {{if (options.icon==\'check\')}}\n\t\t\t\t\t<path fill="#000" fill-rule="nonzero" d="M7.96833846,10.0490996 L14.5108251,2.571972 C14.7472185,2.30180819 15.1578642,2.27443181 15.428028,2.51082515 C15.6711754,2.72357915 15.717665,3.07747757 15.5522007,3.34307913 L15.4891749,3.428028 L8.48917485,11.428028 C8.2663359,11.6827011 7.89144111,11.7199091 7.62486888,11.5309823 L7.54038059,11.4596194 L4.54038059,8.45961941 C4.2865398,8.20577862 4.2865398,7.79422138 4.54038059,7.54038059 C4.7688373,7.31192388 5.12504434,7.28907821 5.37905111,7.47184358 L5.45961941,7.54038059 L7.96833846,10.0490996 L14.5108251,2.571972 L7.96833846,10.0490996 Z"/>\n\t\t\t\t    {{/if}}\n\t\t\t\t</g>\n\t\t\t</svg>\n\t\t'}}},function(t,e,s){const i=s(54),a=s(16);t.exports=class extends a{constructor(t){super(),this._user=t.user,this._app=t.app,this._parent=t.parent,this._data={},this._components={},this._domId=("el"+Math.random()).split(".").join(""),this._events=[],this._componentEvents=[],this._eventsAssigned=!1,this.constructor.template&&(this._compiledTemplate=i.Compile(this.constructor.template)),this._noDiv=!1}avHTML(t,e){const s="#avatar_"+this._domId+"_"+t._id;let i=!1,a="";if(this._parent._avatarsMemory&&this._parent._avatarsMemory[t._id]&&this._parent._avatarsMemoryC[t._id])this._parent._avatarsMemoryC[t._id]--,e+=" wantmemory";else if(t.isMine&&t.isMine())a='<div class="avatarBack avatarMine"></div>',i=!0;else{if(t.hasAvatar()?(a=`<div class="avatarBack" data-loaded="1" style="background-image: url('${t.getAvatarBlobURLSync()}');"></div>`,i=!0):a=`<div class="avatarBack panelTopAvatarBack"></div><div class="avatarInitials avatarC${t.getAvatarColor()}">${t.getAvatarInitials()}</div>`,t._peerUser){let e="";t._peerUser._isOnline&&(e="online"),a+=`<div class="onlineBadge ${e}"><div class="dot"></div></div>`}null===t.hasAvatar()?setTimeout(()=>{if(t.getAvatarBlobURLSync()){let e=t.getAvatarBlobURLSync();const a=this.$(s);if(a){if(e){const t=a.querySelector(".avatarBack");t.style.backgroundImage="url('"+e+"')",t.dataset.loaded=1}i||a.classList.add("visible")}}else setTimeout(()=>{t.getAvatarBlobURL().then(t=>{const e=this.$(s);if(e){if(t){const s=e.querySelector(".avatarBack");s.style.backgroundImage="url('"+t+"')",s.dataset.loaded=1}i||e.classList.add("visible")}})},20)},200):i||this.nextTick(()=>{this.$(s)&&this.$(s).classList.add("visible")})}i&&(e+=" visible");let o="";return t._authorPeer&&(o='data-action="gotouser" data-id="'+t._id+'"',e+=" messageAction"),`\n\t\t<div class="${e} avatar" id="avatar_${this._domId}_${t._id}" data-id="${t._id}" ${o}>\n\t\t\t${a}\n\t\t</div>\n\t\t`}rippleOn(t,e){console.error("ripple on",e);e.offsetX,e.offsetY;const s=t.offsetWidth,i=document.createElement("span");i.className="ripple",i.style.setProperty("--scale",s),t.prepend(i),setTimeout(()=>{i.parentNode.removeChild(i)},500)}escapeHTML(t){return(""+t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}nl2br(t){return(""+t).replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1 <br /> $2")}initScrollBarOn(t,e){return t?this._ps&&!e?(this._ps.update(),!0):(this._ps&&this._ps.destroy(),void(this._ps=new window.classes.PerfectScrollbar(t,{wheelSpeed:1,wheelPropagation:!1,minScrollbarLength:40,suppressScrollX:!0}))):(this._ps&&(this._ps.destroy(),this._ps=null),!1)}async loadJSON(t,e){let s="./tg/"+t;if(this._user._protocol){let t=await this._user._protocol.getCachedResources([{url:s}]);if(t&&t.length&&t[0].json)return JSON.parse(t[0].json)}let i=await new Promise((e,s)=>{var i=new XMLHttpRequest;i.open("GET",t),i.onload=function(t){e(i.responseText)},i.send()});return this._user._protocol.putToCacheAndForget({url:s,binary:i}),JSON.parse(i)}get domId(){return this._domId}nextTick(t){setTimeout(t,1)}debounce(t){let e;return function(){let s=()=>{e=null,t.apply(this,arguments)},i=!e;clearTimeout(e),e=setTimeout(s,100),i&&t.apply(this,arguments)}}$(t){const e=document.getElementById(this.domId);return t?e?e.querySelector(t):null:e}$$(t){const e=this.$();return e?e.querySelectorAll(t):[]}newC(t,e={}){return e.user=this._user,e.app=this._app,e.parent=this,new t(e)}assignDomEvents(){for(let t of this._events){let e=document.getElementById(t[1]),s=this[t[2]];t[3]||("scroll"==t[0]?t[3]=this.debounce(t=>{s.call(this,t)}):("nodebouncescroll"==t[0]&&(t[0]="scroll"),t[3]=t=>{s.call(this,t)})),e&&s&&e.addEventListener(t[0],t[3])}if(this._components)for(let t in this._components)this._components[t]&&this._components[t].assignDomEvents&&this._components[t].assignDomEvents();for(let t of this._componentEvents){let e=this._components[t[1]],s=this[t[2]];t[3]||(t[3]=t=>{s.call(this,t)}),e&&s&&e.addEventListener(t[0],t[3])}}preFocus(t){this.isTouchDevice()||this.nextTick(()=>{const e=this.$(t);e&&e.focus()})}isTouchDevice(){var t=" -webkit- -moz- -o- -ms- ".split(" ");return!!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)||function(t){return window.matchMedia(t).matches}(["(",t.join("touch-enabled),("),"heartz",")"].join(""))}render(t){t=t||{},this._data.components=this._components,this._data.domId=this._domId,this._data.self=this;let e="";if(e=this._compiledTemplate?this._compiledTemplate(this._data,i):i.Render(this.template(),this._data),!t.noDOM){const t=document.getElementById(this._domId);t&&(-1!=e.indexOf('id="'+this._domId+'"')?t.outerHTML=e:t.innerHTML=e,this.assignDomEvents()),this.afterRender&&this.afterRender()}return t.withDiv?-1!=e.indexOf('id="'+this._domId+'"')?e:"<div id="+this._domId+">"+e+"</div>":e}}},function(t,e,s){const i=s(55);i.defineHelper("component",(function(t,e,s){let i=null;return t[0]&&t[0].domId&&(i=t[0]),i?i.render({withDiv:!0}):""})),i.defineFilter("nl2br",(function(t){return(""+t).replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1 <br /> $2")})),t.exports=i},function(t,e,s){"use strict";s.r(e),s.d(e,"Compile",(function(){return S})),s.d(e,"F",(function(){return v})),s.d(e,"H",(function(){return i})),s.d(e,"P",(function(){return a})),s.d(e,"Render",(function(){return C})),s.d(e,"__express",(function(){return j})),s.d(e,"autoEscaping",(function(){return I})),s.d(e,"defaultTags",(function(){return h})),s.d(e,"defineFilter",(function(){return P})),s.d(e,"defineHelper",(function(){return T})),s.d(e,"defineNativeHelper",(function(){return L})),s.d(e,"definePartial",(function(){return O})),s.d(e,"load",(function(){return A})),s.d(e,"renderFile",(function(){return x})),s.d(e,"setDefaultFilters",(function(){return M}));var i={},a={},o=/{{ *?(?:(?:([\w$]+) *?\((.*?)\) *?([\w$]*))|(?:([\w$]+) *?\((.*?)\) *?\/)|(?:([\w$@].*?) *?((?:\| *?[\w$]+ *)*))|(?:\/ *?([\w$]+))|(?:# *?([\w$]+))|(?:!\-\-[^]+?\-\-)) *?}}\n?/g,n={s:"{{",e:"}}"},r=/@(?:((?:\.\.\/)+)|([\w$]+):)?/g,d=o,l=n;function h(t){c(t[0],t[1]),o=d,n=l}function c(t,e){var s=t+d.source.slice(l.s.length,0-(l.e.length+3))+e+"\\n?",i=d.lastIndex;l={s:t,e:e},(d=RegExp(s,"g")).lastIndex=i}function p(t,e,s){return t.replace(r,(function(t,i,a){return"hvals"+(i&&i.length?e[s-i.length/3-1].id:a||"")+"."}))}var _={if:{helperStart:function(t){return"if("+t+"){"},helperEnd:function(){return"}"},blocks:{else:function(){return"}else{"}}},each:{helperStart:function(t,e){return"for(var i=0;i<"+t+".length; i++){tR+=(function(hvals){var tR='';var hvals"+e+"=hvals;"},helperEnd:function(t){return"return tR})({this:"+t+"[i],index:i})};"}},foreach:{helperStart:function(t,e){return"for(var key in "+t+"){if(!"+t+".hasOwnProperty(key)) continue;tR+=(function(hvals){var tR='';var hvals"+e+"=hvals;"},helperEnd:function(t){return"return tR})({this:"+t+"[key], key: key})};"}},log:{selfClosing:function(t){return"console.log("+t+");"}},tags:{selfClosing:function(t){return c(t.slice(0,t.indexOf(",")).trim(),t.slice(t.indexOf(",")+1).trim()),""}},js:{selfClosing:function(t){return t+";"}}},m={"&":"&amp;","<":"&lt;",'"':"&quot;","'":"&#39;"};function u(t){return m[t]}var g=/[&<"']/g,f=/[&<"']/,v={e:function(t){var e=String(t);return f.test(e)?e.replace(g,u):e}},b={},w={start:"",end:""};function M(t){if("clear"===t)b={};else for(var e in t)t.hasOwnProperty(e)&&(b[e]=t[e]);!function(){for(var t in w={start:"",end:""},b)b.hasOwnProperty(t)&&b[t]&&(w.start+="Sqrl.F."+t+"(",w.end+=")")}()}var y=!0;function I(t){return y=t}function k(t,e){var s,i=!1,a="",o="";if(e&&""!==e){s=e.split("|");for(var n=0;n<s.length;n++)s[n]=s[n].trim(),""!==s[n]&&("safe"!==s[n]?(a="Sqrl.F."+s[n]+"("+a,o+=")"):i=!0)}return a+=w.start,o+=w.end,!i&&y&&(a+="Sqrl.F.e(",o+=")"),a+t+o}function S(t){var e,s=0,i="var tR='';",r=[],h=-1,c=0,m={};function u(e){s!==e&&(i+="tR+='"+t.slice(s,e).replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"';")}function g(t,e){var s=p(t,r,h);return"@"===t[0]?k(s,e):k("options."+s,e)}for(l=n,(d=o).lastIndex=0;null!==(e=d.exec(t));)if(u(e.index),s=e[0].length+e.index,e[1]){var f=e[3];""!==f&&null!==f||(f=c,c++);var v=_.hasOwnProperty(e[1]);h+=1;var b=e[2]||"";b=p(b,r,h),v||(b="["+b+"]");var w={name:e[1],id:f,params:b,native:v};r[h]=w,v?(i+=_[e[1]].helperStart(b,f),s=d.lastIndex):i+="tR+=Sqrl.H."+e[1]+"("+b+",function(hvals){var hvals"+f+"=hvals;var tR='';"}else if(e[4]){var M=e[5]||"";if(M=p(M,r,h),"include"===e[4]){var y=t.slice(0,e.index),I=t.slice(e.index+e[0].length),S=M.replace(/'|"/g,""),P=a[S];t=y+P+I,s=d.lastIndex=e.index}else _.hasOwnProperty(e[4])&&_[e[4]].hasOwnProperty("selfClosing")?(i+=_[e[4]].selfClosing(M),s=d.lastIndex):i+="tR+=Sqrl.H."+e[4]+"("+M+");"}else if(e[6])i+="tR+="+g(e[6],e[7])+";";else if(e[8]){var T=r[h];T&&T.name===e[8]?(h-=1,!0===T.native?i+=_[T.name].helperEnd(T.params,T.id):m[T.id]?i+="return tR}});":i+="return tR});"):console.error("Helper beginning & end don't match.")}else if(e[9]){var L=r[h];if(L.native){var C=_[L.name];C.blocks&&C.blocks[e[9]]?(i+=C.blocks[e[9]](L.id),s=d.lastIndex):console.warn("Native helper '%s' doesn't accept that block.",L.name)}else m[L.id]?i+="return tR},"+e[9]+":function(hvals){var hvals"+L.id+"=hvals;var tR='';":(i+="return tR},{"+e[9]+":function(hvals){var hvals"+L.id+"=hvals;var tR='';",m[L.id]=!0)}return u(t.length),i+="return tR",new Function("options","Sqrl",i.replace(/\n/g,"\\n").replace(/\r/g,"\\r"))}function P(t,e){v[t]=e}function T(t,e){i[t]=e}function L(t,e){_[t]=e}function C(t,e){return"function"==typeof t?t(e,{H:i,F:v,P:a}):"string"==typeof t?A(e,t)(e,{H:i,F:v,P:a}):void 0}function O(t,e){a[t]=e}var B={};function A(t,e){var i=t.$file,a=t.$name,o=t.$cache;if(i){var n=s(56);return!1!==o?(B.hasOwnProperty(i)||(B[i]=S(n.readFileSync(i,"utf8"))),B[i]):S(n.readFileSync(i,"utf8"))}return"string"==typeof e?a&&!1!==o?(B.hasOwnProperty(a)||(B[a]=S(e)),B[a]):!0===o?(B.hasOwnProperty(e)||(B[e]=S(e)),B[e]):S(e):a&&!1!==o&&B.hasOwnProperty(a)?B[a]:"No template"}function x(t,e){return e.$file=t,A(e)(e,{H:i,F:v,P:a})}function j(t,e,s){return s(null,x(t,e))}},function(t,e){},function(t,e){t.exports=class{constructor(){this._singlePromises={},this._singlePromisesResolvers={}}async sureSingle(t){return this._singlePromises[t]?await this._singlePromises[t]:(this._singlePromises[t]=new Promise(e=>{this._singlePromisesResolvers[t]=e}),null)}fulfilSingle(t,e,s){this._singlePromises[t]&&(this._singlePromisesResolvers[t](e),s&&delete this._singlePromises[t])}}},function(t,e,s){const i=window.classes.UI,a=(s(0),s(59)),o=s(60),n=s(65),r=s(66),d=s(67);t.exports=class extends i{constructor(t){super(t),this._components.RightSidebarTop=this.newC(a),this._components.RightSidebarInfo=this.newC(o),this._components.RightSidebarForward=this.newC(n),this._components.RightSidebarStickers=this.newC(r),this._components.RightSidebarPoll=this.newC(d),this._data.isLoading=!0,this._componentEvents=[["close","RightSidebarTop","onClose"],["search","RightSidebarTop","onSearch"]],this._data.defaultClosed=!0}onSwipe(t){if("right"==t&&!this.$("#rightSidebar").classList.contains("rightSidebarClosed"))return this.onClose(),!0}onSearch(t){this._components["RightSidebar"+this._currentBlock].doSearch(t)}setPeer(t){this._data.peer&&this._data.peer._id==t._id||(this._data.peer=t,this._components.RightSidebarInfo.setPeer(t),this._data.isLoading=!0,this._app._config.getSetting("rightSidebarVisible")?(this._data.defaultClosed=!1,setTimeout(()=>{t.getFullInfo().then(()=>{this._data.isLoading=!1,this.render(),this.showBlock("Info")})},100),this._needsRender=!1):(this._data.defaultClosed=!0,this._needsRender=!0))}showBlock(t,e){if(this._needsRender&&(this._data.isLoading=!1,this.render(),this._data.defaultClosed=!1,this._needsRender=!1),this._components["RightSidebar"+t].setParams&&this._components["RightSidebar"+t].setParams(e),t!=this._currentBlock){this._currentBlock=t;for(let t in this._components)0===t.indexOf("RightSidebar")&&"RightSidebarTop"!=t&&this._components[t].setActive(!1);this._components["RightSidebar"+t].setActive(),this._components.RightSidebarTop.showForBlock(t)}}show(){setTimeout(()=>{this.$("#rightSidebar").classList.remove("rightSidebarMobileClosed"),this.$("#rightSidebar").classList.remove("rightSidebarClosed")},10),document.querySelectorAll(".panelPos").forEach(t=>t.classList.remove("panelNoSidebar")),this._app._config.setSetting("rightSidebarVisible",!0),this._components["RightSidebar"+this._currentBlock]&&this._components["RightSidebar"+this._currentBlock].afterShow&&this._components["RightSidebar"+this._currentBlock].afterShow()}moveToTop(){this.$("#rightSidebar").style.zIndex=3333333}moveFromTop(){this.$("#rightSidebar").style.zIndex=5e4}onClose(){this.$("#rightSidebar").classList.add("rightSidebarMobileClosed"),this.$("#rightSidebar").classList.add("rightSidebarClosed"),document.querySelectorAll(".panelPos").forEach(t=>t.classList.add("panelNoSidebar")),setTimeout(()=>{this.moveFromTop()},500),this._app._config.setSetting("rightSidebarVisible",!1)}template(){return'\n\t\t\t<div class="rightSidebar rightSidebarMobileClosed {{if (options.defaultClosed)}}rightSidebarClosed{{/if}}" id="rightSidebar">\n\t\t\t\t{{component(options.components.RightSidebarTop)}}{{/component}}\n\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t<div class="appLoading">\n\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t</div>\n\t\t\t\t{{#else}}\n\t\t\t\t<div class="rightSidebarContent" id="rightSidebarContent">\n\t\t\t\t\t{{component(options.components.RightSidebarInfo)}}{{/component}}\n\t\t\t\t\t{{component(options.components.RightSidebarForward)}}{{/component}}\n\t\t\t\t\t{{component(options.components.RightSidebarStickers)}}{{/component}}\n\t\t\t\t\t{{component(options.components.RightSidebarPoll)}}{{/component}}\n\t\t\t\t</div>\n\t\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=window.classes.UI,a=s(0),o=s(7);t.exports=class extends i{constructor(t){super(t),this._components.BackIcon=this.newC(a,{icon:"back"}),this._components.CloseIcon=this.newC(a,{icon:"close"}),this._components.SearchBox=this.newC(o),this._events=[["click","rsTopIcon","onClickIcon"]],this._componentEvents=[["search","SearchBox","onSearch"]],this._data.isBackable=!1,this._data.acitveTopBlock="Header"}showForBlock(t){this._blockName=t,"Search"==t||"Stickers"==t?(this.$("#rsSearch").classList.add("active"),this.$("#rsHeader").classList.remove("active"),this._data.acitveTopBlock="Search",this._components.SearchBox.setPlaceholder("Stickers"==t?"Search Strickers":"Search")):"Info"==t||"Poll"==t?(this.$("#rsHeader").classList.add("active"),this.$("#rsSearch").classList.remove("active"),this._data.acitveTopBlock="Header"):"Forward"==t&&(this.$("#rsHeader").classList.add("active"),this.$("#rsSearch").classList.remove("active"),this._data.acitveTopBlock="Forward"),this.render()}onSearch(t){t||"Stickers"==this._blockName?(this.emit("search",t),this._components.SearchBox.setActive(!0)):this._components.SearchBox.setActive(!1)}onClickIcon(){this._data.isBackable?this.emit("back"):this.emit("close")}closeToBack(t){t?(this.$("#rsTopIconClose").classList.remove("active"),this.$("#rsTopIconBack").classList.add("active"),this._data.isBackable=!0):(this.$("#rsTopIconClose").classList.add("active"),this.$("#rsTopIconBack").classList.remove("active"),this._data.isBackable=!1)}template(){return'\n\t\t\t<div class="rightSidebarTop">\n\t\t\t\t<div class="rsTopIcon" id="rsTopIcon">\n\t\t\t\t\t<div class="rsTopIconItem active" id="rsTopIconClose">{{component(options.components.CloseIcon)}}{{/component}}</div>\n\t\t\t\t\t<div class="rsTopIconItem " id="rsTopIconBack">{{component(options.components.BackIcon)}}{{/component}}</div>\n\t\t\t\t</div>\n\t\t\t\t<div id="rsSearch" class="rsTopBlock {{if (options.acitveTopBlock == \'Search\')}}active{{/if}}">\n\t\t\t\t\t{{component(options.components.SearchBox)}}{{/component}}\n\t\t\t\t</div>\n\t\t\t\t<div id="rsHeader" class="rsTopBlock {{if (options.acitveTopBlock == \'Header\')}}active{{/if}}">\n\t\t\t\t\t<h5>Info</h5>\n\t\t\t\t</div>\n\t\t\t\t<div id="rsHeader" class="rsTopBlock {{if (options.acitveTopBlock == \'Forward\')}}active{{/if}}">\n\t\t\t\t\t<h5>Forward</h5>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(9),a=s(0),o=s(61),n=s(62),r=s(63),d=s(64);t.exports=class extends i{constructor(t){super(t),this._components={InfoIcon:this.newC(a,{icon:"info"}),UsernameIcon:this.newC(a,{icon:"username"}),RightSidebarMedia:this.newC(o),RightSidebarDocs:this.newC(n),RightSidebarAudio:this.newC(r),RightSidebarWebpages:this.newC(d)},this._componentEvents=[],this._data={},this._events=[["click","rsInfoBlocksNavs","onNavClick"]],this._targets=["Media","Docs","Audio","Webpages"],this._data.defaultTarget=this._app._config.getSetting("rightSidebarInfoDefTarget","Media"),window.addEventListener("resize",()=>{this.afterRender()})}onNavClick(t){const e=this.$("#rsInfoBlocksNavs"),s=t.target.closest(".rsInfoBlocksNav");if(s&&e.contains(s)){let t=s.dataset.target;this.switchInfoBlock(t)}}switchInfoBlock(t){t||(t=this._app._config.getSetting("rightSidebarInfoDefTarget"));for(let e of this._targets)e==t?(this.$("#rs"+e).classList.add("active"),this._components["RightSidebar"+e].setVisible(),this._app._config.setSetting("rightSidebarInfoDefTarget",e),this._data.defaultTarget=e):this.$("#rs"+e).classList.remove("active");let e=this.$$(".rsInfoBlocksNav");for(let s of e)s.dataset&&s.dataset.target==t?s.classList.add("active"):s.classList.remove("active")}afterRender(){this.nextTick(()=>{this._data.peer&&this._data.peer.getFullInfo().then(t=>{this.updateWithFullInfo(t);let e=this.$("#rsInfoBlocks"),s=this.$("#rightSidebarInfo");if(e&&s){e.style.height=s.offsetHeight-e.offsetTop+"px";for(let t of this._targets)this._components["RightSidebar"+t].reinitScrollBar()}this.switchInfoBlock()})})}setPeer(t){if(this._data.peer&&this._data.peer._id==t._id)return!1;for(let e of this._targets)this._components["RightSidebar"+e].setPeer(t);this._data.peer=t}updateWithFullInfo(t){let e=["about","username"];for(let s of e)t[s]?(this.$(".rsInfoItem_"+s).querySelector(".rsiValue").innerHTML=this.nl2br(this.escapeHTML(t[s])),this.$(".rsInfoItem_"+s).style.display="block"):this.$(".rsInfoItem_"+s).style.display="none"}template(){return'\n\t\t\t<div class="rightSidebarInfo rightSidebarBlock {{if (options.active)}} active{{/if}}" id="rightSidebarInfo">\n\t\t\t\t<div class="rsInfoProfile">\n\t\t\t\t\t<div class="rsInfoAvatar">\n\n\t\t\t\t\t\t{{self.avHTML(options.peer, \'panelTopAvatar avatarHuge\')|safe}}\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="rsInfoName">{{peer.getDisplayName()}}</div>\n\t\t\t\t\t{{js(options.infoString = options.peer.getInfoString())/}}\n\t\t\t\t\t<div class="rsInfoStatus {{if (options.infoString == \'online\')}}rsInfoStatusOnline{{/if}}">{{infoString}}</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="rsInfoItems">\n\t\t\t\t\t<div class="rsInfoItem rsInfoItem_about" {{if (!options.peer._fullInfo || ! options.peer._fullInfo.about)}}style="display: none;"{{/if}}>\n\t\t\t\t\t\t<div class="rsiIcon">{{component(options.components.InfoIcon)}}{{/component}}</div>\n\t\t\t\t\t\t<div class="rsiValue">{{if (options.peer._fullInfo && options.peer._fullInfo.about)}}{{peer._fullInfo.about|nl2br}}{{/if}}&nbsp;</div>\n\t\t\t\t\t\t<div class="rsiField">Bio</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="rsInfoItem rsInfoItem_username" {{if (!options.peer._fullInfo || ! options.peer._fullInfo.username)}} style="display: none; background: red;" {{/if}}>\n\t\t\t\t\t\t<div class="rsiIcon">{{component(options.components.UsernameIcon)}}{{/component}}</div>\n\t\t\t\t\t\t<div class="rsiValue">{{if (options.peer._fullInfo && options.peer._fullInfo.username)}}{{peer._fullInfo.username}}{{/if}}&nbsp;</div>\n\t\t\t\t\t\t<div class="rsiField">Username</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="rsInfoBlocksNavs" id="rsInfoBlocksNavs">\n\t\t\t\t\t<div class="rsInfoBlocksNav" data-target="Media">Media</div>\n\t\t\t\t\t<div class="rsInfoBlocksNav" data-target="Docs">Docs</div>\n\t\t\t\t\t<div class="rsInfoBlocksNav" data-target="Audio">Audio</div>\n\t\t\t\t\t<div class="rsInfoBlocksNav active" data-target="Webpages">Links</div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="rsInfoBlocks" id="rsInfoBlocks">\n\t\t\t\t\t<div class="rsInfoBlock" id="rsMedia">{{component(options.components.RightSidebarMedia)}}{{/component}}</div>\n\t\t\t\t\t<div class="rsInfoBlock" id="rsDocs">{{component(options.components.RightSidebarDocs)}}{{/component}}</div>\n\t\t\t\t\t<div class="rsInfoBlock" id="rsAudio">{{component(options.components.RightSidebarAudio)}}{{/component}}</div>\n\t\t\t\t\t<div class="rsInfoBlock active" id="rsWebpages">{{component(options.components.RightSidebarWebpages)}}{{/component}}</div>\n\t\t\t\t</div>\n\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(6),a=s(10);t.exports=class extends a{constructor(t){super(t),this._itemsName="Media",this._events=[["scroll","rsMediaItems","onScroll"],["click","rsMediaItems","onClick"],["mousemove","rsMediaItems","onMove"]],this._hasMoreThumbsToPreview=!1}onMove(t){const e=t.target.closest(".rsMedia");if(e&&e.dataset.id)for(let t of this._data.items)t.id==e.dataset.id&&t.heatServersUp()}onClick(t){const e=this.$("#rsMediaItems"),s=t.target.closest(".rsMedia");if(s&&e.contains(s)){let t=s.dataset.id;for(let e of this._data.items)e.id==t&&this._app._interface._components.MediaBrowser.show({from:this.$("#rsMedia_"+t),media:e,mediaItems:this._data.peer._media,peer:this._data.peer})}}async loadNextThumb(){if(clearTimeout(this._moreThumbsTimeout),!this._hasMoreThumbsToPreview)return!1;let t=!1,e=100,s=1;for(let i of this._data.items)if(!this._processedPreviews[i.id]){i.cached&&(e=10),this._processedPreviews[i.id]=!0;let a=await i.loadPreview(s++),o=this.$("#rsMediaPreview_"+i.id);a&&o&&(o.style.backgroundImage="url('"+a+"')"),t=!0;break}t?this._moreThumbsTimeout=setTimeout(()=>{this.loadNextThumb()},e):this._hasMoreThumbsToPreview=!1}async itemsAddedCallback(t){await i.loadPreviewsFromCache(t.filter(t=>!t.blobURL)),this._hasMoreThumbsToPreview=!0,this.loadNextThumb()}getItemHTML(t){if(t.isRoundVideo()||t.isGIF())return"";let e="";return t.isVideo()&&(e="<div class='duration'>"+t.getVideoLengthString()+"</div>"),t.blobURL?'<div class="rsMedia" data-id="'+t.id+'" id="rsMedia_'+t.id+'" style="background-image: url(\''+t.blobURL+"');\">"+e+"</div>":'<div class="rsMedia" data-id="'+t.id+'" id="rsMedia_'+t.id+'" style="background-image: url(\''+t.getPreviewBase64()+'\');"><div class="rsMediaPreview" id="rsMediaPreview_'+t.id+'">'+e+"</div></div>"}template(){return'<div id="{{domId}}">\n\t\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t\t<div class="appLoading">\n\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t\t<div class="rsDocsItems" id="rsMediaItems">\n\n\t\t\t\t\t\t\t<div class="rsDocsMore">\n\t\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\t\t\t\t'}}},function(t,e,s){const i=s(10);t.exports=class extends i{constructor(t){super(t),this._itemsName="Docs",this._events=[["scroll","rs"+this._itemsName+"Items","onScroll"],["click","rsDocsItems","onClick"],["mousemove","rsDocsItems","onMove"]];let e=t=>{this.docStatus(t)};this._peerManager._download.on("downloaded",e),this._peerManager._download.on("progress",e)}docStatus(t){let e=this.$$(".rsDoc_"+t.id);for(let s of e){let e=s.querySelector(".progress");if(s)if(t._isDownloaded)e.className="progress",e.classList.add("progress100"),s.querySelector(".rsDocMeta").innerHTML=t.getInfo("sizeHuman")+" &bull; "+t.getInfo("dateHuman"),s.querySelector(".rsDocIcon").classList.remove("loading"),s.querySelector(".rsDocIcon").classList.add("ready");else if(t._isDownloading){s.querySelector(".rsDocMeta").innerHTML=t._downloadingPercentage+"% &bull; "+t._downloadingSizeHuman+" of "+t.getInfo("sizeHuman");let i=10*Math.floor(t._downloadingPercentage/10);e.className="progress",e.classList.add("active"),e.classList.add("progress"+i),s.querySelector(".rsDocIcon").classList.add("loading")}else s.querySelector(".rsDocIcon").classList.remove("loading"),s.querySelector(".rsDocIcon").classList.remove("ready"),s.querySelector(".rsDocMeta").innerHTML=t.getInfo("sizeHuman")+" &bull; "+t.getInfo("dateHuman"),e.classList.remove("active")}}onMove(t){const e=t.target.closest(".rsDoc");if(e&&e.dataset.id)for(let t of this._data.items)t.id==e.dataset.id&&t.heatServersUp()}onClick(t){const e=this.$("#rsDocsItems"),s=t.target.closest(".rsDoc");if(s&&e.contains(s)){let t=s.dataset.id;for(let e of this._data.items)e.id==t&&(e._isDownloaded?e.save():e._isDownloading?(this._peerManager._download.cancel(e),this.docStatus(e)):(this._peerManager._download.schedule(e),this.docStatus(e)))}}getItemHTML(t){return`<div class="rsDoc rsDoc_${t.id}" data-id="${t.id}">\n\t\t\t\t<div class="rsDocIcon avatarC${t.getInfo("color")}"><div class="progress"><div></div></div>${t.getInfo("ext")}</div>\n\t\t\t\t<div class="rsDocName">${t.getInfo("filename")}</div>\n\t\t\t\t<div class="rsDocMeta">${t.getInfo("sizeHuman")} &bull; ${t.getInfo("dateHuman")}</div>\n\t\t\t</div>\n\t\t\t`}template(){return'<div id="{{domId}}">\n\t\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t\t<div class="appLoading">\n\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t\t<div class="rsDocsItems" id="rsDocsItems">\n\t\t\t\t\t\t\t<div class="rsDocsMore">\n\t\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\t\t\t\t'}}},function(t,e,s){const i=s(10);t.exports=class extends i{constructor(t){super(t),this._seekWidth=250,this._itemsName="Audios",this._events=[["scroll","rsAudiosItems","onScroll"],["click","rsAudiosItems","onClick"],["mouseup","rsAudiosItems","onMouseUp"],["mousedown","rsAudiosItems","onMouseDown"],["mousemove","rsAudiosItems","onMouseMove"]],this._app._mediaPlayer.on("timeupdate",t=>{this._mouseIsDown||!t.messageAudio.isVoice&&this.moveSeekTo(t)}),this._app._mediaPlayer.on("pause",t=>{!t.messageAudio.isVoice&&this.itemPlaying(t.messageAudio,!1)}),this._app._mediaPlayer.on("play",t=>{!t.messageAudio.isVoice&&this.itemPlaying(t.messageAudio,!0)})}byId(t){for(let e of this._data.items)if(e.id==t)return e}onClick(t){const e=this.$("#rsAudiosItems"),s=t.target.closest(".audioButton");if(s&&e.contains(s)){let t=this.byId(s.dataset.id);t&&this._app._mediaPlayer.toggleAudio(t,this._data.peer)}}onMouseMove(t){const e=this.$("#rsAudiosItems");let s=t.target.closest(".audioButton");if(s&&e.contains(s)){let t=this.byId(s.dataset.id);t&&this._app._mediaPlayer.preloadAudio(t)}if(!this._mouseIsDown)return;const i=t.offsetX;this.moveSeekTo({messageAudio:this._seekingItem,percents:i/this._seekWidth*100})}onMouseDown(t){const e=this.$("#rsAudiosItems");let s=t.target.closest(".audioTrack");if(s&&e.contains(s)){let t=s.dataset.id;for(let e of this._data.items)if(e.id==t)return this._seekingItem=e,s.classList.add("seeking"),this._mouseIsDown=!0,void(this._seekWidth=s.offsetWidth)}}onMouseUp(t){if(!this._mouseIsDown)return;const e=t.offsetX;this._mouseIsDown=!1;const s=e/this._seekWidth*100;this._app._mediaPlayer.seekTo(this._seekingItem,s),this._seekingItem=null,this._mouseIsDown=!1,console.error(this._seekingItem);this.$(".seeking").classList.remove("seeking")}moveSeekTo(t){this.$("#at_rs_"+t.messageAudio._id).querySelector(".audioSeek").style.width=t.percents+"%",t.currentTime&&(this.$("#at_rs_"+t.messageAudio._id+"_time").innerHTML=Math.floor(t.currentTime/60)+":"+("0"+Math.floor(t.currentTime)%60).slice(-2)+" / "+t.messageAudio.getInfo("durationHuman"))}itemPlaying(t,e,s){this.$("#ab_rs_"+t._id+(e?"_play":"_pause")).classList.remove("active"),this.$("#ab_rs_"+t._id+(e?"_pause":"_play")).classList.add("active");const i=this.$("#at_rs_"+t._id),a=this.$("#at_rs_"+t._id+"_artist");e?(i.classList.add("active"),s&&this.moveSeekTo({messageAudio:t,percents:s}),a.classList.remove("active")):(a.classList.add("active"),i.classList.remove("active"),this.$("#at_rs_"+t._id+"_time").innerHTML=t.getInfo("durationHuman"))}timeupdate(t){}getItemHTML(t){if(t.isVoice)return"";return`<div class="audio rsAudio_${t.id}" data-id="${t.id}">\n\t\t\t\t<div class="audioButton rpb" id="ab_rs_${t.id}" data-id="${t.id}"><div id="ab_rs_${t.id}_play" class="active">${i.AppUI.getIconHTML("play")}</div><div id="ab_rs_${t.id}_pause">${i.AppUI.getIconHTML("pause")}</div></div>\n\t\t\t\t<div class="audioTitle">${t.getInfo("title")}</div>\n\t\t\t\t<div class="audioArtist active" id="at_rs_${t.id}_artist">${t.getInfo("performer")}</div>\n\t\t\t\t<div class="audioTrack" id="at_rs_${t.id}"  data-id="${t.id}"><div class="audioSeek"></div><div class="audioLine"></div></div>\n\t\t\t\t<div class="audioTime" id="at_rs_${t.id}_time">${t.getInfo("durationHuman")}</div>\n\t\t\t</div>\n\t\t\t`}template(){return'<div id="{{domId}}">\n\t\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t\t<div class="appLoading">\n\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t\t<div class="rsDocsItems" id="rsAudiosItems">\n\t\t\t\t\t\t\t<div class="rsDocsMore">\n\t\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\t\t\t\t'}}},function(t,e,s){const i=s(10);t.exports=class extends i{constructor(t){super(t),this._itemsName="Webpages",this._events=[["scroll","rs"+this._itemsName+"Items","onScroll"]]}getItemHTML(t){if(!t.getInfo("url"))return"";let e="";if(t.getInfo("previewBase64"))e=`<span class="rswPreview" style="background-image: url('${t.getInfo("previewBase64")}');"></span>`;else{let s=t.getInfo("siteName").substr(0,1);e=`<div  class="rswPreview avatarC${(""+s).substr(-1).charCodeAt(0)%8+1}">${s}</div>`}return`<a href="${t.getInfo("url")}" target="_blank" class="rsWebpage rsWebpage_${t._id}" data-id="${t._id}">\n\t\t\t\t\t\t${e}\n\t\t\t\t\t\t<span class="rswTitle">${this.escapeHTML(t.getInfo("title"))}</span>\n\t\t\t\t\t\t<span class="rswDesc">${this.escapeHTML(t.getInfo("description"))}</span>\n\t\t\t\t\t\t<span class="rswUrl">${this.escapeHTML(t.getInfo("displayUrl"))}</span>\n\t\t\t</a>\n\t\t\t`}template(){return'<div id="{{domId}}">\n\t\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t\t<div class="appLoading">\n\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t{{#else}}\n\t\t\t\t\t\t<div class="rsDocsItems" id="rsWebpagesItems">\n\t\t\t\t\t\t\t<div class="rsDocsMore">\n\t\t\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t{{/if}}\n\t\t\t\t</div>\n\t\t\t\t'}}},function(t,e,s){const i=s(9),a=s(0),o=s(8);t.exports=class extends i{constructor(t){super(t),this._components={IconSend:this.newC(a,{icon:"send"}),CloseIcon:this.newC(a,{icon:"close"}),peerBlocks:[]},this._data={},this._events=[["keydown","forwardFilter","onFilter"],["click","rightSidebarForward","onPeerClick"],["click","sidebarForwardSelectedItem_1","removePeer1"],["click","sidebarForwardSelectedItem_2","removePeer2"],["scroll","sidebarForwardScroll","onScroll"],["click","sidebarForwardSend","onForward"]],this._selectedPeers=[],this._initializedPeersIds=[],this._filterQ="",this._hasMePeer=!1,this._peerMessage=null}setParams(t){console.error(t),this._peerMessage=t.peerMessage,this._messageMedia=t.messageMedia,this._botResults=t.botResults}onForward(){app._interface._components.Panel.onForward({peers:this._selectedPeers,peerMessage:this._peerMessage,messageMedia:this._messageMedia,botResults:this._botResults}),this._parent.onClose()}removePeer(t){if(this._selectedPeers.length>t){let e=this._selectedPeers.splice(t,1);if(e.length)for(let t of this._components.peerBlocks)t._data.peer._id==e[0]._id&&t.off()}this.peersChanged()}removePeer1(){this.removePeer(0)}removePeer2(){this.removePeer(1)}filterDOM(){let t=this.$$(".scBlock");for(let e of t)!this._filterQ||e.dataset&&-1!=e.dataset.search.indexOf(this._filterQ)?e.style.display="block":e.style.display="none"}onFilter(){this.nextTick(()=>{this._filterQ=(""+this.$("#forwardFilter").value).trim().toLowerCase(),this.loadMorePeers(),this.filterDOM()})}onScroll(t){const e=this.$("#sidebarForwardScroll"),s=this.$("#sidebarForwardPeers");e.scrollTop+e.clientHeight>.95*s.clientHeight&&this.loadMorePeers()}setPeerViewItem(t,e){let s=t.getDisplayName().split(" ")[0];e.querySelector("span").innerHTML=this.escapeHTML(s),t.isMine()?(e.querySelector(".avatarBack").style.backgroundImage="",e.querySelector(".avatarBack").classList.add("avatarMine")):(e.querySelector(".avatarBack").classList.remove("avatarMine"),t.hasAvatar()?e.querySelector(".avatarBack").style.backgroundImage="url('"+t.getAvatarBlobURLSync()+"')":(e.querySelector(".avatarBack").style.backgroundImage="none",e.querySelector(".avatarInitials").innerHTML=this.escapeHTML(t.getAvatarInitials()),e.querySelector(".avatarInitials").classList="avatarInitials avatarC"+t.getAvatarColor()))}peersChanged(){if(this._selectedPeers.length)if(this.$(".sidebarForwardSend").classList.add("active"),this.setPeerViewItem(this._selectedPeers[0],this.$("#sidebarForwardSelectedItem_1")),this.$("#sidebarForwardSelectedItem_1").style.display="block",2==this._selectedPeers.length)this.$("#sidebarForwardSelectedItem_more").style.display="none",this.$("#sidebarForwardSelectedItem_2").style.display="block",this.setPeerViewItem(this._selectedPeers[1],this.$("#sidebarForwardSelectedItem_2"));else if(1==this._selectedPeers.length)this.$("#sidebarForwardSelectedItem_2").style.display="none",this.$("#sidebarForwardSelectedItem_more").style.display="none";else{this.$("#sidebarForwardSelectedItem_2").style.display="block",this.$("#sidebarForwardSelectedItem_more").style.display="block";let t=this._selectedPeers.length-2;this.$("#sidebarForwardSelectedItem_more").querySelector(".avatarInitials").innerHTML="+"+t}else this.$("#sidebarForwardSelectedItem_1").style.display="none",this.$("#sidebarForwardSelectedItem_2").style.display="none",this.$("#sidebarForwardSelectedItem_more").style.display="none",this.$(".sidebarForwardSend").classList.remove("active")}onPeerClick(t){const e=this.$(),s=t.target.closest(".scBlock");if(s&&e.contains(s)){const t=s.dataset.id,e=this._peerManager.peerById(t);for(let s of this._components.peerBlocks)if(s._data.peer._id==t){s.toggle()?this._selectedPeers.push(e):this._selectedPeers=this._selectedPeers.filter((function(e){return e._id!=t})),this.peersChanged()}}}initPeers(){this._components.peerBlocks=[],this._initializedPeersIds=[];for(let t of this._app._peerManager._sortedPeers)t._peerUser&&t._peerUser.isMe()?(this._hasMePeer=!0,this._components.peerBlocks.unshift(this.newC(o,{peer:t}))):t.canSendMessageTo()&&this._components.peerBlocks.push(this.newC(o,{peer:t})),this._initializedPeersIds.push(t._id);return this._components.peerBlocks}async fullfillPeers(){let t=0;const e=this.$("#sidebarForwardScroll"),s=this.$("#sidebarForwardPeers");try{if(!this._hasMePeer){await this._peerManager.getMePeer()&&(this._hasMePeer=!0)}}catch(t){console.error(t)}this.appendPeers();do{t++,e.clientHeight>s.clientHeight&&this._peerManager._thereReMorePeers&&(await new Promise(t=>{setTimeout(t,500)}),await this.loadMorePeers())}while(t<3)}appendPeers(){const t=this.$("#sidebarForwardPeers");for(let e of this._app._peerManager._sortedPeers)if(-1===this._initializedPeersIds.indexOf(e._id)){if(console.error(e._id),e.canSendMessageTo()){let s=this.newC(o,{peer:e}),i=s.render();e.isMine()?t.insertAdjacentHTML("afterbegin",i):t.insertAdjacentHTML("beforeend",i),this._components.peerBlocks.push(s)}else console.error(e);this._initializedPeersIds.push(e._id)}}async loadMorePeers(){let t=this._filterQ;if(this.$(".loadingMore").classList.add("active"),t){await this._peerManager.search(t)}else await this._peerManager.loadPeers();this.appendPeers(),this.filterDOM(),this.$(".loadingMore").classList.remove("active")}reinitScrollBar(t){let e=this.$(".sidebarForwardScroll"),s=this.$("#rightSidebarForward");e&&s&&(e.style.height=s.offsetHeight-e.offsetTop+"px",this.initScrollBarOn(e,t))}afterShow(){this._selectedPeers=[],this.nextTick(()=>{this.reinitScrollBar(!0),this.fullfillPeers()})}afterRender(){}template(){return'\n\t\t\t<div class="rightSidebarForward rightSidebarBlock {{if (options.active)}} active{{/if}}" id="rightSidebarForward">\n\n\t\t\t\t{{js(options.self.initPeers())/}}\n\n\t\t\t\t<div class="sidebarForwardSelector">\n\t\t\t\t\t<div class="sidebarForwardSelectedItem sfsiRemovable" id="sidebarForwardSelectedItem_1">\n\n\t\t\t\t\t\t<div class="avatar avatarSmall visible">\n\t\t\t\t\t\t\t<div class="avatarBack"></div>\n\t\t\t\t\t\t\t<div class="avatarInitials avatarC3">K</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="peerClose">{{component(options.components.CloseIcon)}}{{/component}}</div>\n\n\t\t\t\t\t\t<span>n</span>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sidebarForwardSelectedItem sfsiRemovable" id="sidebarForwardSelectedItem_2">\n\n\t\t\t\t\t\t<div class="avatar avatarSmall visible">\n\t\t\t\t\t\t\t<div class="avatarBack"></div>\n\t\t\t\t\t\t\t<div class="avatarInitials avatarC2">J</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="peerClose">{{component(options.components.CloseIcon)}}{{/component}}</div>\n\n\t\t\t\t\t\t<span>n</span>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sidebarForwardSelectedItem" id="sidebarForwardSelectedItem_more">\n\n\t\t\t\t\t\t<div class="avatar avatarSmall visible">\n\t\t\t\t\t\t\t<div class="avatarBack"></div>\n\t\t\t\t\t\t\t<div class="avatarInitials avatarC4">+3</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<span>more</span>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="sidebarForwardSelectorInput"><input type="text" placeholder="Select chat" id="forwardFilter"></div>\n\t\t\t\t</div>\n\n\t\t\t\t<div class="sidebarForwardScroll" id="sidebarForwardScroll">\n\n\t\t\t\t\t<div id="sidebarForwardPeers">\n\t\t\t\t\t\t{{each(options.components.peerBlocks)}}\n\t\t\t\t\t\t\t{{component(@this)}}{{/component}}\n\t\t\t\t\t\t{{/each}}\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="loadingMore">\n\t\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t\t</div>\n\n\t\t\t\t</div>\n\n\t\t\t\t<div class="sidebarForwardSend" id="sidebarForwardSend">\n\t\t\t\t\t{{component(options.components.IconSend)}}{{/component}}\n\t\t\t\t</div>\n\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(9),a=window.classes.TGS;t.exports=class extends i{constructor(t){super(t),this._lastDataWithResults=null,this._lastSearch=null,this._inDOMids={},this._initsids={},this._slept={},this._tgss={},this._cachedSearched={},this._keepInDOM=50,this._events=[["mouseover","rssStickersList","onStickersOver"],["click","rssStickersList","onClick"]],this._data.isLoading=!0}onClick(t){const e=this.$("#rssStickersList"),s=t.target.closest(".rsssButton");if(s&&e.contains(s)){let t=this._peerManager._stickers.installToggle(s.dataset.id);s.classList[t?"add":"remove"]("added")}}onStickersOver(t){const e=this.$("#rssStickersList"),s=t.target.closest(".animated");s&&e.contains(s)&&s.dataset&&s.dataset.id&&this._lastStickerToAnimate!=s.dataset.id&&this._tgss[s.dataset.id]&&(this._lastStickerToAnimate=s.dataset.id,this._playStickerTimeout&&clearTimeout(this._playStickerTimeout),this._playStickerTimeout=setTimeout(()=>{this._tgss[s.dataset.id].playOnce()},200))}async setActive(t=!0){if(this._data.active=t,this.$(".rightSidebarBlock").classList[t?"add":"remove"]("active"),t){let t=await this._peerManager._stickers.getFeatured();t&&t.sets&&await this._peerManager._stickers.loadRespData(t,26,t=>{this._featured=t,this._data.isLoading&&(this._data.isLoading=!1,this.render()),this._lastSearch||(this._data.sets=t,this.updateDom())},5),this.reinitScrollBar(!0)}}updateDom(){const t=this.$(".rssStickersList");let e="",s=[],i=!1;for(let t of this._data.sets)s.length<26&&(this._inDOMids[t._id]?!this._slept[t._id]&&this._initsids[t._id]||(this.$("#rssSet_"+t._id).style.display="block",delete this._slept[t._id],s.length<5&&this._tgss[t._stickers[0]._id]&&this._tgss[t._stickers[0]._id].playOnce(),this._initsids[t._id]||(i=!0)):(e+=this.getSetHTML(t),this._inDOMids[t._id]=!0,i=!0),s.push(t._id));e&&t.insertAdjacentHTML("beforeend",e);let a=s.length,o=0,n=Object.keys(this._inDOMids).reverse();for(let t of n)if(-1==s.indexOf(t)){const e=this.$("#rssSet_"+t);a+o<this._keepInDOM?(e&&(e.style.display="none"),this._slept[t]=!0,o++):(e&&e.remove(),delete this._inDOMids[t],delete this._initsids[t],delete this._slept[t],i=!0)}i&&this.tick()}getSetHTML(t){let e="";for(let t=0;t<5;t++)e+='<div class="rsssSticker"></div>';let s=this._peerManager._stickers.isStickerSetInstalled(t)?"added":"";return`<div class="rssSet" id="rssSet_${t._id}" data-id="${t._id}">\n\t\t\t<div class="rsssHeader">\n\t\t\t\t<div class="rsssButton ${s}" data-id="${t._id}"></div>\n\t\t\t\t<h3>${this.escapeHTML(t._name)}</h3>\n\t\t\t\t<span>${t._stickers.length} stickers</span>\n\t\t\t</div>\n\t\t\t<div class="rsssStickers">\n\t\t\t\t${e}\n\t\t\t</div>\n\t\t</div>`}async tick(){if(await this.sureSingle("tick"))return;let t=1,e=0;for(let s of this._data.sets){if(this._inDOMids[s._id]&&!this._initsids[s._id]&&!this._slept[s._id]){this._initsids[s._id]=!0;for(let i=0;i<5;i++){try{const t=this.$("#rssSet_"+s._id).querySelector(".rsssSticker:nth-child("+(i+1)+")"),o=await s._stickers[i].load();if(s._stickers[i]._isAnimated){const n=new a(t);this._tgss[s._stickers[i]._id]=n,n.setJSON(o,!0,!0,s._stickers[i],0==i&&e<5),t.classList.add("animated"),t.dataset.id=s._stickers[i]._id}else t.style.backgroundImage="url('"+o+"')";await new Promise(t=>setTimeout(t,e<5?5:100))}catch(t){break}if(this._slept[s._id]){delete this._inDOMids[s._id],delete this._initsids[s._id],delete this._slept[s._id],this.$("#rssSet_"+s._id).remove(),t=0;break}}}e++}this.fulfilSingle("tick",t,1)}reinitScrollBar(t){let e=this.$(".rssStickersList"),s=this.$("#rightSidebarStickers");e&&s&&(e.style.height=s.offsetHeight-e.offsetTop+"px",this.initScrollBarOn(e,t))}afterRender(){this._inDOMids={},this._initsids={},this._slept={}}doSearch(t){clearTimeout(this._typeTimeout),this._typeTimeout=setTimeout(()=>{this.search(t)},100)}async search(t){if(this._lastSearch=t,!t)return this._data.sets=this._featured,this.updateDom(),clearTimeout(this._searchTimeout);if(this._cachedSearched[t])return this._data.sets=this._cachedSearched[t],this.updateDom(),clearTimeout(this._searchTimeout);let e=await this._peerManager._stickers.search(t);try{e.sets.length?this._lastDataWithResults=e:e=this._lastDataWithResults}catch(t){e=this._lastDataWithResults}this._searchTimeout&&clearTimeout(this._searchTimeout),this._searchTimeout=setTimeout(async()=>{e&&await this._peerManager._stickers.loadRespData(e,6,e=>{this._cachedSearched[t]=e,e.length&&t==this._lastSearch&&(this._data.sets=e,this.updateDom())})},500)}template(){return'\n\t\t\t<div class="rightSidebarStickers rightSidebarBlock {{if (options.active)}} active{{/if}}" id="rightSidebarStickers">\n\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t<div class="appLoading">\n\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t</div>\n\t\t\t\t{{#else}}\n\t\t\t\t<div class="rssStickersList" id="rssStickersList">\n\n\t\t\t\t</div>\n\t\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){const i=s(9),a=window.classes.Icon,o=s(8);t.exports=class extends i{constructor(t){super(t),this._data.isLoading=!0,this._components.IconDown=this.newC(a,{flip:!0}),this._events=[["click","sfpPoll"+this.domId,"onMore"]]}onMore(t){let e=t.target.closest(".scBlock").dataset.more;for(let t of this._data.poll._answers)t.uniq==e&&this.loadMore(t)}async setParams(t){if(this._data.poll&&this._data.poll._id==t.poll._id)return;this._data.poll=t.poll,this._data.isLoading=!0,this.render(),this._rendered={},await this._data.poll.fetch();let e=[];for(let t of this._data.poll._answers)e.push(this._data.poll.getPollVotes(t));await Promise.all(e),this._data.isLoading=!1,this.render(),this.updateDOM()}updateDOM(){for(let t of this._data.poll._answers)this._rendered[t.uniq]||(this._rendered[t.uniq]={}),this.updateAnswer(t);this.initScrollBarOn(this.$(".rightSidebarBlock"),!0)}updateAnswer(t){const e=this.$("#rspAnswer_"+t.uniq);e.querySelector(".pc").innerHTML=t.percents+"%";let s="";try{for(let e of this._data.poll._votesList[t.uniq])if(!this._rendered[t.uniq][e._id]){console.error(e);s+=this.newC(o,{peer:e,info:" "}).render({withdiv:!0,noDOM:!0}),this._rendered[t.uniq][e._id]=!0}}catch(t){}s&&e.querySelector(".sfpFoldersList_include").insertAdjacentHTML("beforeend",s);const i=e.querySelector(".scBlockMore_include");let a=t.voters;a-=e.querySelector(".sfpFoldersList_include").querySelectorAll(".scBlock").length;let n="Show "+a+" more voter"+(a>1?"s":"");i.querySelector(".pmore").innerHTML=n,i.classList[a>0?"add":"remove"]("visible")}async setActive(t=!0){this._data.active=t,this.$(".rightSidebarBlock").classList[t?"add":"remove"]("active")}async loadMore(t){await this._data.poll.getPollVotes(t),this.updateAnswer(t)}afterRender(){}template(){return'\n\t\t\t<div class="rightSidebarPoll rightSidebarBlock {{if (options.active)}} active{{/if}}" id="rightSidebarPoll">\n\t\t\t\t{{if (options.isLoading)}}\n\t\t\t\t<div class="appLoading">\n\t\t\t\t\t<div class="cssload-zenith dark"></div>\n\t\t\t\t</div>\n\t\t\t\t{{#else}}\n\t\t\t\t\t<h1>{{poll.question}}</h1>\n\n\t\t\t\t\t<div id="sfpPoll{{domId}}">\n\t\t\t\t\t{{each(options.poll._answers)}}\n\t\t\t\t\t<div class="sfpFolders sfpFoldersManage" id="rspAnswer_{{@this.uniq}}">\n\t\t\t\t\t\t<h4>{{@this.text}}<span class="pc">75%</span></h4>\n\n\t\t\t\t\t\t<div class="sfpFoldersList">\n\t\t\t\t\t\t\t<div class="sfpFoldersList_include">\n\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="scBlock scBlockMore scBlockMore_include scBlockType" id="rspMore_{{@this.uniq}}" data-more="{{@this.uniq}}">\n\t\t\t\t\t\t\t<div class="scBlockIcon">{{component(options.components.IconDown)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="scBlockMessage">\n\t\t\t\t\t\t\t\t<div class="scBlockTitle pmore"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t{{/each}}\n\t\t\t\t\t</div>\n\n\n\t\t\t\t{{/if}}\n\t\t\t</div>\n\t\t'}}},function(t,e,s){window.classes.UI;const i=s(0),a=(window.classes.TGS,s(1)),o=s(69),n=s(70),r=s(71);class d extends a{constructor(t){super(t),this._events=[["click","emojiNavBlocks","onNavClick"],["click","search","onSearch"]],this._components={emoji:this.newC(o),stickers:this.newC(n),gifs:this.newC(r),icons:{smile:this.newC(i,{icon:"smile"}),stickers:this.newC(i,{icon:"stickers"}),gifs:this.newC(i,{icon:"gifs"}),search:this.newC(i,{icon:"search"})}},this._types=["emoji","stickers","gifs"],this._data.what="emoji",this._data.initialized=!1,this.isVisible=!1}async init(){if(await this.sureSingle("init"))return!1;this._data.initialized=!0,this.render(),this.fulfilSingle("init",!0)}async show(t,e){t&&e&&(await this.init(),this.$("#emojiTop").style.display="block",this.$(".emojiBubble").style.left=t+"px",this.$(".emojiBubble").style.top=e+"px"),this.$(".emojiBubble").classList.add("active"),this.isVisible=!0,this.switchType(this._data.what),document.querySelector(".panelNewMessage").classList.add("emojiOn"),this.mouseupUpG(()=>{this.hide()})}hide(){this.$(".emojiBubble").classList.remove("active"),this.isVisible=!1,this._types.forEach(t=>{this._components[t].hidden()}),document.querySelector(".panelNewMessage").classList.remove("emojiOn")}switchType(t){this._data.what=t,this._types.forEach(e=>{this.$("#"+e+"Block").classList[e==t?"add":"remove"]("active"),this.$(".emojiNavItem"+e)&&this.$(".emojiNavItem"+e).classList.add("active"),e!==t&&this._components[e].hidden()}),this.$("#search").classList["emoji"==t?"remove":"add"]("active"),this._components[t].show()}onSearch(){"stickers"==this._data.what?(this._parent._components.RightSidebar.showBlock("Stickers"),this._parent._components.RightSidebar.show(),this.hide()):this.$("#search").classList.contains("in")?this._components.gifs.showSearch(!1):this._components.gifs.showSearch(!0)}onNavClick(t){const e=this.$("#emojiNavBlocks"),s=t.target.closest(".emojiNavItem");if(s&&e.contains(s)){let t=s.dataset.what;this.switchType(t)}}}d.template='\n\t\t\t<div id="emojiTop" style="display: none;">\n\t\t\t\t{{if (options.initialized)}}\n\t\t\t\t<div class="emojiBubble">\n\t\t\t\t\t<div class="emojiBubbleContainer">\n\t\t\t\t\t\t<div class="emojiBlock" id="emojiBlock">\n\t\t\t\t\t\t\t{{component(options.components.emoji)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="emojiBlock" id="stickersBlock">\n\t\t\t\t\t\t\t{{component(options.components.stickers)}}{{/component}}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="emojiBlock" id="gifsBlock">\n\t\t\t\t\t\t\t{{component(options.components.gifs)}}{{/component}}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="emojiNav">\n\t\t\t\t\t\t\t<div class="emojiNavItem emojiNavItemLeft" id="search">{{component(options.components.icons.search)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="emojiNavBlocks" id="emojiNavBlocks">\n\t\t\t\t\t\t\t\t<div class="emojiNavItem" data-what="emoji">{{component(options.components.icons.smile)}}{{/component}}</div>\n\t\t\t\t\t\t\t\t<div class="emojiNavItem" data-what="stickers">{{component(options.components.icons.stickers)}}{{/component}}</div>\n\t\t\t\t\t\t\t\t<div class="emojiNavItem" data-what="gifs">{{component(options.components.icons.gifs)}}{{/component}}</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="emojiOver">\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{{/if}}\n\t\t\t</div>\n\t\t',t.exports=d},function(t,e,s){const i=s(13),a=s(0);class o extends i{constructor(t){super(t)}show(){this.init()}async init(){if(await this.sureSingle("init"))return!1;this._data.mostRecentEmoji=[],this._data.emojiData=await this.loadJSON("assets/data/emoji.json"),this._components.IconSmile=this.newC(a,{icon:"smile"}),this._components.IconRecent=this.newC(a,{icon:"recent"}),this._components.IconAnimal=this.newC(a,{icon:"animal"}),this._components.IconEats=this.newC(a,{icon:"eats"}),this._components.IconCar=this.newC(a,{icon:"car"}),this._components.IconSport=this.newC(a,{icon:"sport"}),this._components.IconLamp=this.newC(a,{icon:"lamp"}),this._components.IconFlag=this.newC(a,{icon:"flag"}),this._events=[["click","emojiNav","onNavClick"],["scroll","emojiList","onScroll"],["click","emojiList","onClick"],["click","emojiCats","onCatClick"]],this._data.initialized=!0,this.render(),this.initScrollbar(),this.fulfilSingle("init",!0)}addToMostRecent(t){-1===this._data.mostRecentEmoji.indexOf(t)&&(this._data.mostRecentEmoji.unshift(t),this._data.mostRecentEmoji=this._data.mostRecentEmoji.slice(0,18));let e="";for(let t of this._data.mostRecentEmoji)e+="<span>"+t+"</span>";this.$("#recentEmoji").innerHTML=e,this.calcScrollOffsets(!0)}onClick(t){const e=this.$("#emojiList"),s=t.target.closest("span");s&&e.contains(s)&&(this._parent._parent._components.Panel.onEmoji(s.innerHTML),this.addToMostRecent(s.innerHTML))}calcScrollOffsets(t){if(this.__emojiDivOffsets&&!t)return this.__emojiDivOffsets;let e=[],s=this.$$(".emojiDiv");for(let t of s){let s={targetName:t.dataset.name,offsetTop:t.offsetTop-0};e.push(s)}let i=this.$$(".emojiCat");for(let t of i)for(let s of e)t.dataset.target==s.targetName&&(s.cat=t);return e.reverse(),this.__emojiDivOffsets=e,e}onScroll(t){if(t&&t.target){let e=t.target.scrollTop,s=this.calcScrollOffsets(),i=!1;for(let t of s)e>=t.offsetTop&&!i?(t.cat.classList.add("active"),i=!0):t.cat.classList.remove("active");i||s[s.length-1].cat.classList.add("active")}}onCatClick(t){const e=this.$("#emojiCats"),s=t.target.closest(".emojiCat");if(s&&e.contains(s)){let t=s.dataset.target,e=this.$(".emojiList"),i=null,a=this.$$(".emojiDiv");for(let e of a)e.dataset&&e.dataset.name==t&&(i=e);if(i&&e){let t=0;e.scrollTop=i.offsetTop-t}}}}o.template='\n\t\t{{if (options.initialized)}}\n\t\t<div class="emojiCats active" id="emojiCats">\n\t\t\t<div data-target="Recent" class="emojiCat">{{component(options.components.IconRecent)}}{{/component}}</div>\n\t\t\t<div data-target="Smileys & Emotion" class="emojiCat">{{component(options.components.IconSmile)}}{{/component}}</div>\n\t\t\t<div data-target="Animals & Nature" class="emojiCat">{{component(options.components.IconAnimal)}}{{/component}}</div>\n\t\t\t<div data-target="Food & Drink" class="emojiCat">{{component(options.components.IconEats)}}{{/component}}</div>\n\t\t\t<div data-target="Travel & Places" class="emojiCat">{{component(options.components.IconCar)}}{{/component}}</div>\n\t\t\t<div data-target="Activities" class="emojiCat">{{component(options.components.IconSport)}}{{/component}}</div>\n\t\t\t<div data-target="Objects" class="emojiCat">{{component(options.components.IconLamp)}}{{/component}}</div>\n\t\t\t<div data-target="Flags" class="emojiCat">{{component(options.components.IconFlag)}}{{/component}}</div>\n\t\t</div>\n\t\t<div class="emojiList active emojiScroll" id="emojiList">\n\t\t\t\t<div data-name="Recent" class="emojiDiv">\n\t\t\t\t\t<h5>Recent</h5>\n\n\t\t\t\t\t<div id="recentEmoji">\n\t\t\t\t\t{{each(options.mostRecentEmoji)}}\n\t\t\t\t\t\t<span>{{@this}}</span>\n\t\t\t\t\t{{/each}}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t{{foreach(options.emojiData)}}\n\t\t\t\t<div data-name="{{@key}}" class="emojiDiv">\n\t\t\t\t\t<h5>{{@key}}</h5>\n\t\t\t\t\t{{each(@this)}}<span>{{@this}}</span>{{/each}}\n\t\t\t\t</div>\n\t\t\t{{/foreach}}\n\t\t</div>\n\t\t{{#else}}\n\t\t<div class="appLoading">\n\t\t\t<div class="cssload-zenith dark"></div>\n\t\t</div>\n\t\t{{/if}}\n\t\t',t.exports=o},function(t,e,s){const i=s(13),a=s(0),o=window.classes.TGS;class n extends i{constructor(t){super(t),this.isVisible=!1}send(t){this._parent._parent._components.Panel.onSticker(t),this.addStickerToRecent(t),this.isTouchDevice()&&this._parent.hide()}onStickerClick(t){const e=this.$("#stickersList");let s=t.target.closest("span");if(s||(s=t.target.closest(".animated")),s&&e.contains(s)){let t=this._app._peerManager._stickers._stickersIds[s.dataset.id];t&&this.send(t)}}show(){this.isVisible=!0,this.init().then(()=>{this.doAdded()})}hidden(){this.isVisible=!1}async init(){if(await this.sureSingle("init"))return!1;this._components.IconRecent=this.newC(a,{icon:"recent"}),this._events=[["nodebouncescroll","stickersList","onStickersScroll"],["click","stickersList","onStickerClick"],["click","stickersCats","onStickerCatClick"],["mouseover","stickersList","onStickersOver"]],this._data.stickers=[],this.__stickersDivReady={},this.__animationsStarted={},this._animatedStickersToInit={},this._animatedStickersIniting={},this._tgss={},this._recentTGSs={},this._recentTGSsAsked={},this._lastStickerToAnimate=null,this.__setAdded={},this._app._peerManager._stickers.on("uninstalled",t=>{this.stickerSetUninstalled(t)}),this._app._peerManager._stickers.on("installed",t=>{this.stickerSetInstalled(t)});await this._app._peerManager._stickers.getRecent();this._data.initialized=!0,this.render(),this.rerenderStickers(),this.isVisible=!0,this.initScrollbar();let t=await this._app._peerManager._stickers.getAll();await this._app._peerManager._stickers.loadRespData(t,null,()=>{this.doAdded()}),this.fulfilSingle("init",!0)}async doAdded(){await this.sureSingle("doAdded");for(let t in this._app._peerManager._stickers._installed)if(!this.__setAdded[t]&&this.isVisible){let e=this._app._peerManager._stickers._installed[t];if(this.__setAdded[e._id]=!0,this.fillStickerSetDOM(e,!!e.installed),await this.setCatHTML(e),!this.isVisible){this.__setAdded[e._id]=!1;break}this.fillSetImages(e),this.calcStickersScrollOffsets(!0),this.onStickersScroll("force")}this.calcStickersScrollOffsets(!0),this.onStickersScroll("force"),this.fulfilSingle("doAdded",!0,!0)}async stickerSetUninstalled(t){let e=this.$$(".stickersDiv");for(let s of e)s.dataset&&s.dataset.id==t._id&&s.parentNode.removeChild(s);let s=this.$$(".stickersCat");for(let e of s)e.dataset&&e.dataset.id==t._id&&e.parentNode.removeChild(e);for(let e of t._stickers)this._tgss[e._id]&&(this._tgss[e._id].destroy(),delete this._tgss[e._id]);this.__stickersDivReady[t._id]=!1,this.__animationsStarted[t._id]=!1,delete this._animatedStickersToInit[t._id],delete this._animatedStickersIniting[t._id],delete this.__setAdded[t._id],this.calcStickersScrollOffsets(!0),this.onStickersScroll("force")}async stickerSetInstalled(t){if(this.isVisible){this.$(".stickersDiv");this.fillStickerSetDOM(t,!0),this.fillSetImages(t),this.setCatHTML(t),this.calcStickersScrollOffsets(!0),this.onStickersScroll("force")}}async fillSetImages(t){const e={};for(let s of t._stickers)s._isAnimated||(e[s._id]=this.$("#notanimated_"+s._id),s.blobURL||await s.load(),e[s._id].style.backgroundImage="url('"+s.blobURL+"')")}fillStickerSetDOM(t,e){let s=this.$("#stickersDiv_"+t.id),i=this.$("#stickerVisible_"+t.id);if(!i){const a=this.getStickerSetHTML(t);if(e){this.$(".stickersDiv").insertAdjacentHTML("afterend",a)}else this.$("#stickersList").insertAdjacentHTML("beforeend",a);s=this.$("#stickersDiv_"+t.id),i=this.$("#stickerVisible_"+t.id)}let a="",o="",n=0,r=80*Math.ceil(t.count/5),d=!1;a+='<div class="stickersHandler" data-set="'+t.id+'" style="height: '+r+'px;">';for(let e of t._stickers)e.tgs?a+='<div class="animated '+(4==n?"animatedNoPadd":"")+'" id="animated_'+e._id+'" data-set="'+t.id+'" data-id="'+e._id+'"></div>':a+='<span class="'+(4==n?"animatedNoPadd":"")+'" id="notanimated_'+e._id+'" data-set="'+t.id+'" data-id="'+e._id+'"></span>',o||(e.tgs?(o='<div class="stickersCat stickersCat_'+t.id+'" data-id="'+t.id+'" data-target="'+this.escapeHTML(t.name)+'" id="animatedCat_'+t.id+'"></div>',d=!0):o='<div class="stickersCat stickersCat_'+t.id+'" data-id="'+t.id+'" data-target="'+this.escapeHTML(t.name)+'"></div>'),n++,5==n&&(n=0);a+="</div>",i.innerHTML=a,this.__stickersDivReady[t.id]=!0;const l=this.$("#stickersCatsScrollContainer"),h=this.$(".stickersCat_"+t.id);if(d&&(this._animatedStickersToInit[t.id]=!0),!h)if(e)l.insertAdjacentHTML("afterbegin",o);else{let t=!1;if(s.previousSibling&&s.previousSibling.dataset&&s.previousSibling.dataset.id){let e=this.$(".stickersCat_"+s.previousSibling.dataset.id);e&&(e.insertAdjacentHTML("afterend",o),t=!0)}t||l.insertAdjacentHTML("beforeend",o)}this.calcStickersScrollOffsets(!0),d&&this.isVisible&&this.startAnimationsOn(t.id)}rerenderStickers(t){let e=this.getRecentStickerSetHTML();this.$("#stickersList").innerHTML=e,this.calcStickersScrollOffsets(!0),this.nextTick(()=>{this.startAnimationsOnRecent()}),this.onStickersScroll()}onStickersOver(t){const e=this.$("#stickersList"),s=t.target.closest(".animated");if(s&&e.contains(s)&&s.dataset&&s.dataset.id&&this._lastStickerToAnimate!=s.dataset.id){let t=this._tgss;"Recent"==s.dataset.set&&(t=this._recentTGSs),t[s.dataset.id]&&(this._lastStickerToAnimate=s.dataset.id,this._playStickerTimeout&&clearTimeout(this._playStickerTimeout),this._playStickerTimeout=setTimeout(()=>{t[s.dataset.id].playOnce()},200))}}async stickersUpdated(t){this._data.stickers=await this._app._peerManager._stickers.getStickers(),this.rerenderStickers(t)}addStickerToRecent(t){let e=this._app._peerManager._stickers._recentStickers;for(let s of e)if(s.id==t.id)return!0;e.push(t);let s="";t.tgs?s='<div class="animated recentSticker" id="recentAnimated_'+t._id+'" data-set="Recent" data-id="'+t._id+'"></div>':(s='<span id="recentSticker_'+t._id+'" class="recentSticker" data-set="Recent" data-id="'+t._id+'"></span>',t.load().then(e=>{if(e){const s=this.$("#recentSticker_"+t.id);s&&(s.style.backgroundImage="url('"+e+"')")}}));const i=this.$("#stickersDiv_Recent");i&&i.querySelector("h5")&&i.querySelector("h5").insertAdjacentHTML("afterend",s);let a=e.length;a>10&&(a=10);let o=80*Math.ceil(a/5);this.$("#stickerInVisible_Recent").style.height=o+"px";let n=this.$$(".recentSticker");if(n.length>10)for(let t=10;t<n.length;t++)n[t].dataset&&n[t].dataset.id&&this._recentTGSs[n[t].dataset.id]&&(delete this._recentTGSs[n[t].dataset.id],delete this._recentTGSsAsked[n[t].dataset.id]),n[t].parentNode.removeChild(n[t]);this.calcStickersScrollOffsets(!0),this.startAnimationsOnRecent()}getRecentStickerSetHTML(){this._recentTGSs||(this._recentTGSs={});let t="";t+='<div data-name="Recent" data-id="Recent" class="stickersDiv" id="stickersDiv_Recent">',t+="<h5>Recent</h5>";let e=this._app._peerManager._stickers._recentStickers,s=80*Math.ceil(e.length/5);t+='<div id="stickerInVisible_Recent" style="height: '+s+'px;" class="stickerInVisible">',t+='<div id="stickerVisible_Recent" class="stickerVisible" style="display: none; height: '+s+'px;">';let i=0;for(let s of e)s.tgs?t+='<div class="animated '+(4==i?"animatedNoPadd":"")+' recentSticker" id="recentAnimated_'+s._id+'" data-set="Recent" data-id="'+s._id+'"></div>':(t+='<span id="recentSticker_'+s._id+'" class="recentSticker '+(4==i?"animatedNoPadd":"")+'" data-set="Recent" data-id="'+s._id+'"></span>',s.load().then(t=>{if(t){const e=this.$("#recentSticker_"+s.id);e&&(e.style.backgroundImage="url('"+t+"')")}})),i++,5==i&&(i=0);return t+="</div>",t+="</div>",t+="</div>",t}getStickerSetHTML(t){let e="";e+='<div data-name="'+this.escapeHTML(t.name)+'" data-id="'+t.id+'" class="stickersDiv" id="stickersDiv_'+t.id+'">',e+="<h5>"+this.escapeHTML(t.name)+"</h5>";let s=80*Math.ceil(t.count/5);return e+='<div id="stickerInVisible_'+t.id+'" style="height: '+s+'px;" class="stickerInVisible">',e+='<div id="stickerVisible_'+t.id+'" class="stickerVisible">',e+='<div class="cssload-zenith dark" style="margin-top: '+Math.floor(s/2)+'px;"></div>',e+="</div>",e+="</div>",e+="</div>",e}async startAnimationsOnRecent(){if(!this.isVisible)return!1;let t=this._app._peerManager._stickers._recentStickers;for(let e of t)if(e.tgs&&!this._recentTGSs[e.id]&&!this._recentTGSsAsked[e.id]){const t=this.$("#recentAnimated_"+e._id);if(t&&this.isVisible){this._recentTGSsAsked[e.id]=!0;const s=await e.load();this._recentTGSs[e.id]=new o(t),this._recentTGSs[e.id].setJSON(s,!0,!0,e)}}}async setCatHTML(t){let e=t._stickers[0],s=await e.load();if(e._isAnimated){new o(this.$("#animatedCat_"+t._id)).setJSON(s,!0,!0)}else this.$(".stickersCat_"+t._id)&&(this.$(".stickersCat_"+t._id).style.backgroundImage="url('"+s+"')")}async startAnimationsOn(t){if(this._animatedStickersIniting[t])return!1;this._animatedStickersIniting[t]=!0;let e=()=>{delete this._animatedStickersIniting[t]};if(!(this._animatedStickersToInit[t]&&this.isVisible&&this.__stickersDivReady&&this.__stickersDivReady[t]))return e(),!1;let s=!1;const i=this.$("#stickerVisible_"+t);if(s=!(!i||"block"!=i.style.display),!s)return e(),!1;let a=this._app._peerManager._stickers.byId(t);if(a)for(let t of a._stickers){if(s=!(!i||"block"!=i.style.display),!s)return e(),!1;const a=await t.load();if(a&&!this._tgss[t._id]&&this.isVisible){try{const e=new o(this.$("#animated_"+t._id));e.setJSON(a,!0,!0,t),this._tgss[t._id]=e}catch(t){console.error(t)}await new Promise(t=>{setTimeout(t,150)})}}if(!(this._animatedStickersToInit[t]&&s&&this.isVisible))return e(),!1;delete this._animatedStickersToInit[t]}onStickersScroll(t){let e=0;if(t&&t.target?e=t.target.scrollTop:("force"==t&&(this._lastStickersScrollTop=null),e=this.$("#stickersList").scrollTop),this._lastStickersScrollTop&&Math.abs(this._lastStickersScrollTop-e)<20)return;this._lastStickersScrollTop=e;let s=this.calcStickersScrollOffsets(),i=!1,a=0,o=1;for(let t of s)e>=t.offsetTop&&!i?(t.cat&&(t.cat.classList.add("active"),a=o),i=!0):t.cat&&t.cat.classList.remove("active"),e+400>=t.offsetTop&&e<=t.offsetTop+t.height?(this.$("#stickerVisible_"+t.id).style.display="block",this.__stickersDivReady[t.id]&&this._animatedStickersToInit[t.id]&&this.startAnimationsOn(t.id)):this.$("#stickerVisible_"+t.id).style.display="none",o++;i||s[s.length-1]&&s[s.length-1].cat&&(s[s.length-1].cat.classList.add("active"),a=s.length);let n=62*(s.length-a);n-=186,n<0&&(n=0),a&&(document.querySelector("#stickersCatsScroll").scrollLeft=n)}calcStickersScrollOffsets(t){if(this.__stickersDivOffsets&&!t)return this.__stickersDivOffsets;let e=[],s=this.$$(".stickersDiv");for(let t of s){let s={targetName:t.dataset.name,id:t.dataset.id,offsetTop:t.offsetTop-0,height:t.offsetHeight};e.push(s)}let i=this.$$(".stickersCat");for(let t of i)for(let s of e)t.dataset.target==s.targetName&&(s.cat=t);return e.reverse(),this.__stickersDivOffsets=e,this.__stickersDivOffsets}onStickerCatClick(t){const e=this.$("#stickersCats"),s=t.target.closest(".stickersCat");if(s&&e.contains(s)){let t=s.dataset.target,e=this.$(".stickersList"),i=null,a=this.$$(".stickersDiv");for(let e of a)e.dataset&&e.dataset.name==t&&(i=e);if(i&&e){let t=0;e.scrollTop=i.offsetTop-t}}}}n.template='\n\t\t{{if (options.initialized)}}\n\t\t<div class="stickersCats active" id="stickersCats">\n\t\t\t<div data-target="Recent" class="stickersCat stickersCatRecent">{{component(options.components.IconRecent)}}{{/component}}</div>\n\t\t\t<div class="stickersCatsScroll" id="stickersCatsScroll">\n\t\t\t\t<div class="stickersCatsScrollContainer" id="stickersCatsScrollContainer">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="stickersList active emojiScroll" id="stickersList"></div>\n\t\t{{#else}}\n\t\t<div class="appLoading">\n\t\t\t<div class="cssload-zenith dark"></div>\n\t\t</div>\n\t\t{{/if}}\n\t\t',t.exports=n},function(t,e,s){const i=s(13),a=s(7);class o extends i{constructor(t){super(t),this._itemHeight=105,this._minWidth=50,this._maxWidth=250,this._lastOffsetY=null,this._overflowFirstItemI=null,this._overflowLastItemI=null,this._containerHeight=373,this._lastScrollTime=new Date,this._lastItemToDisplay=null,this._visibleItems={},this._loadedToPlay={},this._slept={},this._items=[],this._components.SearchBox=this.newC(a),this._componentEvents=[["search","SearchBox","onSearch"]]}searchOver(t){this.$(".gifSearchOver").classList[t?"remove":"add"]("notvis"),clearTimeout(this._soT),t?this.$(".gifSearchOver").classList.remove("hidden"):this._soT=setTimeout(()=>{this.$(".gifSearchOver").classList.add("hidden")},1e3)}onSearch(t){t||(this._components.SearchBox.setActive(!1),this.showSearch(!1)),this.searchOver(!0),clearTimeout(this._sTimeout),this._sTimeout=setTimeout(()=>{t?this.search(t):this.restore()},200)}showSearch(t){this.$(".gifSearch").classList[t?"add":"remove"]("active"),this._components.SearchBox.setActive(!0),t&&!this.isTouchDevice()&&this._components.SearchBox.focus(),this.$().closest(".emojiBubble").querySelector("#search").classList[t?"add":"remove"]("in")}show(){this.init()}onGifClick(t){const e=this.$("#gifsList");let s=t.target.closest(".gif");if(s&&e.contains(s)){const t=this._items;for(let e of t)e._id==s.dataset.id&&(this._parent._parent._components.Panel.onGIF(e),this._parent.hide())}}clean(){this._lastOffsetY=null,this._overflowFirstItemI=null,this._overflowLastItemI=null,this._containerHeight=373,this._lastScrollTime=new Date,this._lastItemToDisplay=null;for(let t=0;t<this._items.length;t++)this.freeze(t);this._visibleItems={},this._loadedToPlay={},this._slept={},this.searchOver(!1)}async restore(){this._items=this._app._peerManager._gifs._gifs;for(let t of this._items)t.tagSet=!1;this.clean(),this.calcItemsPoss(),this.$(".gifsOverflowItems").innerHTML="",this.setItems(),this.$(".gifsOverflowItems").scrollTop=5}async search(t){this._items=await this._app._peerManager._gifs.search(t),this.clean(),this.calcItemsPoss(),this.$(".gifsOverflowItems").innerHTML="",this.setItems(),this.$(".gifsOverflowItems").scrollTop=5}async searchMore(){if(!this._app._peerManager._gifs._hasMore||this._searchingMore)return;this._searchingMore=!0;let t=await this._app._peerManager._gifs.search(null,!0),e="";for(let e of t)this._items.push(e);this.calcItemsPoss();for(let t=0;t<this._items.length;t++){let s=this._items[t];s.pos&&t>this._lastItemToDisplay&&(e+=`<div class="gif" id="gif_${s._id}" data-id="${s._id}" style="width: ${s.pos.width};"><div class="cssload-zenith onDark videoLoading"></div></div>`,this._lastItemToDisplay=t)}this.$("#clearGif").insertAdjacentHTML("beforebegin",e),this._searchingMore=!1}async init(){if(await this.sureSingle("init"))return!1;await this._app._peerManager._gifs.load(!0),this._items=this._app._peerManager._gifs._gifs,this.calcItemsPoss(),this._events=[["nodebouncescroll","gifsList","onScroll"],["mouseover","gifsList","onOver"],["click","gifsList","onGifClick"]],this._data.initialized=!0,this.render(),this.setItems(),this.initScrollbar(),this.searchOver(!1),this.fulfilSingle("init",!0)}onOver(t){const e=this.$("#gifsList"),s=t.target.closest(".gif");s&&e.contains(s)&&s.querySelector("video").play()}async calcItemsPoss(){const t=this._items;let e=0;const s=(e,s,i)=>{t[e].pos={y:s,width:i}};for(let i=0;i<t.length-3;i++){let a=t[i].getInfo("aspectRatio"),o=t[i+1]?t[i+1].getInfo("aspectRatio"):0;a>1&&o>1?(s(i,e,"50%"),s(i+1,e,"50%"),i++):(s(i,e,"33%"),s(i+1,e,"33%"),s(i+2,e,"34%"),i+=2),e+=this._itemHeight}}onScroll(t){this.setItems(t.target.scrollTop)}async setItems(t){const e=this._items,s=this.$(".gifsOverflowItems"),i=e=>{if(e&&e.pos&&e.pos.y+this._itemHeight>=t&&e.pos.y<this._containerHeight+t)return!0};if(void 0===t){t=0;let a="";for(let t=0;t<e.length;t++)e[t].pos&&(a+=`<div class="gif" id="gif_${e[t]._id}" data-id="${e[t]._id}" style="width: ${e[t].pos.width};"><div class="cssload-zenith onDark videoLoading"></div></div>`,i(e[t])?(null==this._overflowFirstItemI&&(this._overflowFirstItemI=t),this._overflowLastItemI=t):this._lastItemToDisplay=t);s.innerHTML=a+"<div id='clearGif' style='clear:both'></div>",this.setItems(200),this.setItems(1)}else if(t!=this._lastOffsetY){this._lastScrollTime=new Date;let s=null,a=null;for(let t=0;t<e.length;t++)i(e[t])&&(null==s&&(s=t),a=t,t==this._lastItemToDisplay&&this.searchMore());if(this._lastOffsetY=t,s!=this._overflowFirstItemI||a!=this._overflowLastItemI){let t=[],e=[];for(let e=this._overflowFirstItemI;e<=this._overflowLastItemI;e++)(e<s||e>a)&&t.push(e);for(let i=s;i<=a;i++)-1==t.indexOf(i)&&e.push(i);this._overflowFirstItemI=s,this._overflowLastItemI=a;for(let e of t){Math.min(Math.abs(s-e),Math.abs(a-e))<=3?this.sleep(e):this.freeze(e)}for(let t in this._slept)(t<s-3||t>a+3)&&this.freeze(t);for(let t of e)this.wakeup(t);clearTimeout(this._tickTimeout),this._tickTimeout=setTimeout(()=>{this.tick()},100)}}}async freeze(t){let e=this._items[t];const s=this.$("#gif_"+e._id);delete this._visibleItems[e._id],delete this._slept[t];const i=s.querySelector("video");e.tagSet=!1,e.sleep=!1,i&&(i.removeEventListener("canplay",e.vTagListener),i.pause(),i.removeAttribute("src"),i.load(),i.remove(),s.classList.remove("loaded"))}async sleep(t){this._slept[t]=!0;let e=this._items[t];delete this._visibleItems[e._id],e.tagSet&&(e.tagSet.pause(),e.sleep=!0)}async wakeup(t){let e=this._items[t];if(delete this._slept[t],!e.tagSet){const t=this.$("#gif_"+e._id);if(e.cBlobUrlSet)t.classList.add("loaded");else{const s=e.getPreviewBase64();s&&(t.style.backgroundImage="url('"+s+"')")}t.innerHTML+=`<video src="${e.getStreamURL()}?r${Math.random()}" muted autoplay title="${e._id}"></video>`;const s=t.querySelector("video");e.vTagListener=()=>{t.classList.add("loaded"),this._loadedToPlay[e._id]=!0;try{let i=document.createElement("canvas");i.height=100,i.width=100*e.getInfo("aspectRatio"),i.getContext("2d").drawImage(s,0,0,i.width,100),i.toBlob(s=>{t.style.backgroundImage="url('"+URL.createObjectURL(s)+"')",e.cBlobUrlSet=!0})}catch(t){}},s.addEventListener("canplay",e.vTagListener),s.load(),e.tagSet=s,e.askedD||(e.scheduleDownload(),e.askedD=!0,await e.checkCache())}e.sleep&&e.tagSet.play(),this._visibleItems[e._id]=e}async tick(){if(await this.sureSingle("tick"))return;let t=[];do{t=[];for(let e in this._visibleItems)if(this._visibleItems[e]._isDownloaded?delete this._visibleItems[e]:this._loadedToPlay[e]||t.push(this._visibleItems[e].downloadNextPart()),t.length>1)break;await Promise.all(t)}while(t.length);this.fulfilSingle("tick",!0,!0)}}o.template='\n\t\t{{if (options.initialized)}}\n\t\t<div class="gifsList active emojiScroll" id="gifsList">\n\t\t\t<div class="gifsOverflowItems">\n\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="gifSearchOver"></div>\n\t\t{{#else}}\n\t\t<div class="appLoading">\n\t\t\t<div class="cssload-zenith dark"></div>\n\t\t</div>\n\t\t{{/if}}\n\t\t<div class="gifSearch">\n\t\t\t<div class="gifSearchCont">\n\t\t\t\t{{component(options.components.SearchBox)}}{{/component}}\n\t\t\t</div>\n\t\t</div>\n\t\t',t.exports=o},function(t,e,s){const i=window.classes.UI,a=s(0),o=s(73),n=s(74),r=s(5);class d extends i{constructor(t){super(t),this._components.IconClose=this.newC(a,{icon:"close"}),this._components.IconDownload=this.newC(a,{icon:"download"}),this._components.IconForward=this.newC(a,{icon:"forward"}),this._components.IconMenu=this.newC(a,{icon:"more"}),this._events=[["click","mbPanel","onIcon"],["click","mbbArrowNext","onNext"],["click","mbbArrowPrev","onPrev"],["click","mediaOverlay","onClickOut"]],this._components.Menu=this.newC(r,{items:[["forward","forward","Forward"],["download","download","Download"]]}),this._componentEvents=[["forward","Menu","doForward"],["download","Menu","doDownload"]],this._mbCs={prev:null,next:null,current:null},this._mediaItems=[],this._currentMedia=null,this._currentCome=!1,this._currentComeFromEl=null,this.isVisible=!1,this._documentKeyPressHandler=t=>{this.onDocumentKeypress(t)},window.addEventListener("resize",()=>{this.onResize()})}onResize(){this._mbCs.prev&&(this._mbCs.prev.onResize(),this._mbCs.prev.setToThePrev()),this._mbCs.next&&(this._mbCs.next.onResize(),this._mbCs.next.setToTheNext()),this._mbCs.current&&(this._mbCs.current.onResize(),this._mbCs.current.animateGo(!0))}onSwipe(t){if(this.isVisible)return"left"==t&&this.next(),"right"==t&&this.prev(),!0}onDocumentKeypress(t){t.keyCode&&(37==t.keyCode&&this.onPrev(),39==t.keyCode&&this.onNext(),32==t.keyCode&&this._mbCs.current.onPlayClick&&this._mbCs.current.onPlayClick())}onClickOut(t){this.$("#mediaOverlay");let e=["#mbPanelIcons",".mbbItem",".mbPanelAbout",".mbpIcon",".menu"];for(let s of e)if(t.target.closest(s))return!1;return!(!this._mbCs.prev||!t.target.closest("#mbbArrowPrev"))||(!(!this._mbCs.next||!t.target.closest("#mbbArrowNext"))||void this.hide())}doForward(){this._currentMedia&&this._app._interface._components.Panel.onSetForwardMedia({messageMedia:this._currentMedia})}async doDownload(){this.$("#downloadOn").classList.add("active"),this.$("#downloadOff").classList.remove("active"),await this._currentMedia.save(),this.$("#downloadOn").classList.remove("active"),this.$("#downloadOff").classList.add("active")}onIcon(t){const e=this.$(".mbPanel"),s=t.target.closest(".mbpIcon");if(s&&e.contains(s)&&s.dataset.action){let e=s.dataset.action;"close"==e&&this.hide(),"download"==e&&this.doDownload(),"forward"==e&&this.doForward(),"menu"==e&&this._components.Menu.show(t)}}show(t){this.$("#mediaBrowserTop").style.display="block",this.$(".mediaBrowserOverlay").classList.add("active"),document.addEventListener("keydown",this._documentKeyPressHandler),this.initMBCs(t),this.isVisible=!0}hide(){this._mbCs.current&&this._mbCs.current.stopMedia&&this._mbCs.current.stopMedia(),this.$(".mediaBrowserOverlay").classList.remove("active"),this.$(".mediaBrowserOverlay").classList.add("fading"),this.isVisible=!1,document.removeEventListener("keydown",this._documentKeyPressHandler),setTimeout(()=>{this.$(".mediaBrowserOverlay").classList.remove("fading"),this.$("#mediaBrowserTop").style.display="none"},500)}onNext(){this.next()}onPrev(){this.prev()}newCByParams(t){let e=null;return e=(t.media||null).isVideo()?this.newC(n,t):this.newC(o,t),e}updateAuthorDOM(){try{if(this._mbCs.current){let t=this._mbCs.current._media;this.$(".mbbCaption").innerHTML=t.getInfo("caption");let e=t.getInfo("sentByPeerUser"),s=e._id,i=this.$(".mbpaAboutCurrent");if(this._lastAuthorPeerUserId===s)i.querySelector(".mbpaDate").innerHTML=t.getInfo("sentByPeerUserAtDateHuman");else{this._lastAuthorPeerUserId=s;let a=this.$(".mbpaAboutPrev");a.querySelector(".mbpaName").innerHTML=t.getInfo("sentByPeerUserName"),a.querySelector(".mbpaDate").innerHTML=t.getInfo("sentByPeerUserAtDateHuman");let o="";e.hasAvatar()?o=`\n\t\t\t\t\t\t\t<div class="avatar visible avatarMedium avatar_${s}">\n\t\t\t\t\t\t\t\t<div class="avatarBack" style="background-image: url('${e.getAvatarBlobURLSync()}');"></div>\n\t\t\t\t\t\t\t</div>`:(o=`\n\t\t\t\t\t\t\t<div class="avatar visible avatarMedium avatar_${s}">\n\t\t\t \t\t\t\t\t<div class="avatarBack"></div>\n\t\t\t \t\t\t\t\t<div class="avatarInitials avatarC${e.getAvatarColor()}">${e.getAvatarInitials()}</div>\n\t\t\t\t\t\t\t</div>`,e.getAvatarBlobURL().then(t=>{if(t){let e=this.$(".avatar_"+s);e&&(e.querySelector(".avatarBack").style.backgroundImage="url('"+t+"')")}})),a.querySelector(".mbpaAvatar").innerHTML=o,a.classList.remove("mbpaAboutPrev"),a.classList.add("mbpaAboutCurrent"),i.classList.remove("mbpaAboutCurrent"),i.classList.add("mbpaAboutPrev")}}}catch(t){}}initPrevAndNext(){if(this._mbCs.prev&&this._mbCs.next)return;let t=null;for(let e=0;e<this._mediaItems.length;e++)if(this._mediaItems[e].id==this._currentMedia.id){t=e;break}if(!this._mbCs.prev)for(let e=t-1;e>=0;e--)if(!this._mediaItems[e].isRoundVideo()&&!this._mediaItems[e].isGIF()){this._mbCs.prev=this.newCByParams({media:this._mediaItems[e]});break}if(!this._mbCs.next){let e=0;for(e=t+1;e<this._mediaItems.length;e++)if(!this._mediaItems[e].isRoundVideo()&&!this._mediaItems[e].isGIF()){this._mbCs.next=this.newCByParams({media:this._mediaItems[e]});break}e>this._mediaItems.length-5&&this._peer&&!this._peer._loadingMoreMedia&&this._peer.loadMedia()}}repositionArrows(){if(this._mbCs.next?this.$("#mbbArrowNext").classList.remove("noMore"):this.$("#mbbArrowNext").classList.add("noMore"),this._mbCs.prev?this.$("#mbbArrowPrev").classList.remove("noMore"):this.$("#mbbArrowPrev").classList.add("noMore"),this._mbCs.current&&this._mbCs.current._media.isVideo()){let t=this._mbCs.current._data.calc,e=Math.floor((t.bcrHeight-t.height)/2)+100;this.$("#mbbArrowPrev").style.bottom=e+"px",this.$("#mbbArrowNext").style.bottom=e+"px"}else this.$("#mbbArrowPrev").style.bottom="0px",this.$("#mbbArrowNext").style.bottom="0px"}initMBCs(t){t.from;let e=t.media;this._mbCs.current=this.newCByParams(t),this._mbCs.prev=null,this._mbCs.next=null,this._currentMedia=e,t.peer?this._peer=t.peer:this._peer=null,t.mediaItems&&(this._mediaItems=t.mediaItems),this.initPrevAndNext(),this.renderMBCs(),this.repositionArrows(),this.updateAuthorDOM()}next(){if(!this._mbCs.next)return;this._mbCs.next.animateGo(),this._mbCs.current.setToThePrev(),this._mbCs.current.stopMedia();let t=this._mbCs.prev?this.$("#"+this._mbCs.prev.domId):null,e=t?t.parentNode:null;e||(e=this.$(".mbbItemEmpty")),this._mbCs.prev=this._mbCs.current,this._mbCs.current=this._mbCs.next,this._mbCs.next=null,this._currentMedia=this._mbCs.current._media,this.initPrevAndNext(),this._mbCs.next?(e.innerHTML=this._mbCs.next.render({withDiv:!0}),e.classList.remove("mbbItemEmpty"),this._mbCs.next.setToTheNext()):(e.classList.add("mbbItemEmpty"),e.innerHTML=""),this.repositionArrows(),this.updateAuthorDOM()}prev(){if(!this._mbCs.prev)return;this._mbCs.prev.animateGo(),this._mbCs.current.setToTheNext(),this._mbCs.current.stopMedia();let t=this._mbCs.next?this.$("#"+this._mbCs.next.domId):null,e=t?t.parentNode:null;e||(e=this.$(".mbbItemEmpty")),this._mbCs.next=this._mbCs.current,this._mbCs.current=this._mbCs.prev,this._mbCs.prev=null,this._currentMedia=this._mbCs.current._media,this.initPrevAndNext(),this._mbCs.prev?(e.innerHTML=this._mbCs.prev.render({withDiv:!0}),e.classList.remove("mbbItemEmpty"),this._mbCs.prev.setToThePrev()):(e.classList.add("mbbItemEmpty"),e.innerHTML=""),this.repositionArrows(),this.updateAuthorDOM()}renderMBCs(){this.$(".mbbPrevItem").innerHTML=this._mbCs.prev?this._mbCs.prev.render({withDiv:!0}):"",this.$(".mbbNextItem").innerHTML=this._mbCs.next?this._mbCs.next.render({withDiv:!0}):"",this.$(".mbbCurrentItem").innerHTML=this._mbCs.current?this._mbCs.current.render({withDiv:!0}):"",this._mbCs.prev?this._mbCs.prev.setToThePrev():this.$(".mbbPrevItem").classList.add("mbbItemEmpty"),this._mbCs.next?this._mbCs.next.setToTheNext():this.$(".mbbNextItem").classList.add("mbbItemEmpty")}}d.template='\n\t\t\t<div id="mediaBrowserTop" style="display: none;">\n\t\t\t\t<div class="mediaBrowserOverlay" id="mediaOverlay">\n\t\t\t\t\t{{component(options.components.Menu)}}{{/component}}\n\t\t\t\t\t<div class="mbPanel" id="mbPanel">\n\t\t\t\t\t\t<div class="mbPanelIcons" id="mbPanelIcons">\n\t\t\t\t\t\t\t<div class="mbpIcon mbpIconClose" data-action="close">{{component(options.components.IconClose)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="mbpIcon" data-action="forward">{{component(options.components.IconForward)}}{{/component}}</div>\n\t\t\t\t\t\t\t<div class="mbpIcon" data-action="download">\n\t\t\t\t\t\t\t\t<div class="mbpIconAn" id="downloadOn"><div class="cssload-zenith"></div></div>\n\t\t\t\t\t\t\t\t<div class="mbpIconAn active" id="downloadOff">{{component(options.components.IconDownload)}}{{/component}}</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="mbPanelAbout">\n\t\t\t\t\t\t\t<div class="mbpaAboutItem mbpaAboutCurrent">\n\t\t\t\t\t\t\t\t<div class="mbpaAvatar">\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="mbpaMeta">\n\t\t\t\t\t\t\t\t\t<div class="mbpaName"></div>\n\t\t\t\t\t\t\t\t\t<div class="mbpaDate"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="mbpaAboutItem mbpaAboutPrev">\n\t\t\t\t\t\t\t\t<div class="mbpaAvatar">\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="mbpaMeta">\n\t\t\t\t\t\t\t\t\t<div class="mbpaName"></div>\n\t\t\t\t\t\t\t\t\t<div class="mbpaDate"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\n\t\t\t\t\t\t<div class="mbpMenu">\n\t\t\t\t\t\t\t<div class="mbpIcon" data-action="menu">{{component(options.components.IconMenu)}}{{/component}}</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="mbBrowser">\n\t\t\t\t\t\t<div class="mbbArrowItem mbbArrowNext" id="mbbArrowNext"><div class="mbbArrow"></div></div>\n\t\t\t\t\t\t<div class="mbbArrowItem mbbArrowPrev" id="mbbArrowPrev"><div class="mbbArrow"></div></div>\n\n\t\t\t\t\t\t<div class="mbbItem mbbPrevItem">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="mbbItem mbbCurrentItem">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="mbbItem mbbNextItem">\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="mbbCaption"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="mbInfo">\n\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t',t.exports=d},function(t,e,s){const i=s(17);t.exports=class extends i{constructor(t){super(t),this._data.originalBlobURL=null}async loadFull(){let t=await this._media.loadFull();if(t){this._data.originalBlobURL=t;let e=this.$(".mbbPhoto");e&&(e.style.backgroundImage="url('"+t+"')")}}template(){return'\n\t\t\t{{if (options.fromDefined)}}\n\t\t\t\t<div class="mbbPhoto" style="background-image: url(\'{{imageURL}}\'); top: {{from.y}}px; left: {{from.x}}px; width: {{from.width}}px; height: {{from.height}}px;"></div>\n\t\t\t{{#else}}\n\t\t\t\t{{if (options.originalBlobURL)}}\n\t\t\t\t\t<div class="mbbPhoto"  style="background-image: url(\'{{originalBlobURL}}\');"></div>\n\t\t\t\t{{#else}}\n\t\t\t\t\t<div class="mbbPhoto"  style="background-image: url(\'{{imageURL}}\');"></div>\n\t\t\t\t{{/if}}\n\t\t\t{{/if}}\n\t\t'}}},function(t,e,s){const i=s(17),a=s(1);t.exports=class extends i{constructor(t){super(t),this._previewHeight=100,this._mediaPlaying=!0,this._mouseIsDown=null}onResize(){this.calc(),this.animateGo(!0),this._trackRect=null}getMediaWidth(){return this._data.calc.width}animateGo(t){let e=this.$(".mbbPhoto");e.style.top=this._data.calc.y+"px",e.style.left=this._data.calc.x+"px",e.style.height=this._data.calc.height+"px",e.style.width=this._data.calc.width+"px",this.$(".videoLoading").style.marginTop=this._data.calc.height/2-12+"px",e.classList.add("playing"),this._mediaPlaying=!0,t||setTimeout(()=>{this.startLoad()},100)}stopMedia(){this._videoTag&&(this._videoTag.muted=!0,this._videoTag.pause(),this._videoTag.removeAttribute("src"),this._videoTag.load()),this.$(".previewVideo").pause(),this.$(".previewVideo").removeAttribute("src"),this.$(".previewVideo").load(),this._srcSet=!1,this._mediaPlaying=!1,this._previewSet=!1,this.$(".mbbPhoto").classList.remove("playing")}onFull(){this._videoTag.requestFullscreen()}async startLoad(){this._media.scheduleDownload(),await this._media.checkCache(),await this.restorePreviewSprites(),this._previewSet=!1;do{if(this.onLoadTime(),await this._media.downloadNextPart(),this._videoTag=this.$(".videoPlayer"),!this._videoTag)return;this._app._mediaPlayer.pausePlaying(),this._videoTag.muted=!1,this._eventsSet||(this.$(".mpCont").addEventListener("click",t=>{this.onClick(t)}),this.$(".mpPlay").addEventListener("click",()=>{this.onPlayClick()}),this.$(".mpFull").addEventListener("click",()=>{this.onFull()}),this.$(".mpTrack").addEventListener("mousedown",t=>{this.onTrackDown(t)}),this.$(".mpTrack").addEventListener("mousemove",t=>{this.onTrackMove(t)}),this.$(".mpTrack").addEventListener("touchmove",t=>{this.onTrackTouch(t)}),this.$(".mpTrack").addEventListener("mouseup",t=>{this.onTrackUp(t)}),this.$(".mpTrack").addEventListener("mouseleave",t=>{this.onTrackLeave(t)}),this._eventsSet=!0),this._srcSet||(this._videoTag.onloadeddata=()=>{this._videoTag.style.display="block",this.$(".videoLoading").style.display="none",this._mediaPlaying&&(this._videoTag.play(),this.playB(!1))},this._videoTag.addEventListener("timeupdate",t=>{this.onTagTime(t)}),this._videoTag.addEventListener("play",t=>{this.videoProgress()}),this._videoTag.addEventListener("ended",t=>{this.videoProgress()}),this._videoTag.addEventListener("progress",()=>{this.videoProgress()}),this._videoTag.src=this._media.getStreamURL(),this._videoTag.load(),this._srcSet=!0)}while(!this._media._isDownloaded&&this._mediaPlaying)}onLoadTime(){this.$(".mpLoaded").innerText=!this._media._isDownloaded&&this._media._isDownloading&&this._media._downloadingPercentage?this._media._downloadingSizeHuman+" / "+this._media.getInfo("sizeHuman"):""}onTagTime(t){const e=this._videoTag.currentTime/this._videoTag.duration*100;let s=Math.floor(this._videoTag.currentTime/60)+":"+("0"+Math.floor(this._videoTag.currentTime%60)).slice(-2);this.$(".mpTime").innerText=s+" / "+this._media.getInfo("videoDurationHuman"),null===this._mouseIsDown&&(this.seekToPercents(e),this._playingPercents=e,this.videoProgress()),this.upPlay()}videoProgress(){try{let t=0,e=this._videoTag.buffered,s=this._videoTag.currentTime;try{for(;!(e.start(t)<=s&&s<=e.end(t))&&t<100;)t+=1}catch(e){t--}let i=e.start(t)/this._videoTag.duration,a=100*(e.end(t)/this._videoTag.duration-i);this._playingPercents&&(a+=this._playingPercents),this.$(".mptLoaded").style.width=a+"%"}catch(t){}}onClick(t){t.target.closest(".mpTrack")||t.target.closest(".mpButs")||this.onPlayClick()}onPlayClick(){this._videoTag.currentTime>0&&!this._videoTag.paused&&!this._videoTag.ended?(this._videoTag.pause(),this.playB(!0)):(this._videoTag.play(),this.playB(!1))}upPlay(){return this._videoTag.currentTime>0&&!this._videoTag.paused&&!this._videoTag.ended?(this.playB(!1),!1):(this.playB(!0),!0)}playB(t){this.$(".mpIconPlay").classList[t?"add":"remove"]("active"),this.$(".mpIconPause").classList[t?"remove":"add"]("active")}onTrackDown(t){this._mouseIsDown=t.pageX,this.$(".mptOver").style.display="block",this.seekToX(t.pageX)}onTrackTouch(t){this.previewOnX(t.touches[0].pageX)}onTrackMove(t){if(this.previewOnX(t.pageX),null===this._mouseIsDown)return!1;this.seekToX(t.pageX)}onTrackUp(t){this._mouseIsDown=null,this.$(".mptOver").style.display="none";let e=this.xToPercents(t.pageX);this._videoTag.currentTime=this.percentsToTime(e),this.isTouchDevice()&&this.onTrackLeave()}onTrackLeave(){this.toHidePreview()}toHidePreview(){clearTimeout(this._hpt),this._hpt=setTimeout(()=>{this.$(".mptHover").classList.remove("active")},200)}xToPercents(t){this._trackRect||(this._trackRect=this.$(".mpTrack").getBoundingClientRect());let e=(t-this._trackRect.x<0?0:t-this._trackRect.x)/this._trackRect.width;return e=100*(e>1?1:e),e}percentsToTime(t){return this._videoTag.duration/100*t}seekToPercents(t){(t-=1)>98&&(t=98),this.$(".mptBlue").style.width=t+"%",this.$(".mptBall").style.left=t+"%"}seekToX(t){let e=this.xToPercents(t);this.seekToPercents(e)}async restorePreviewSprites(){this._previewsCached={};let t=await this._app._peerManager._media.getVideoPreview(this._media);if(t){let e=URL.createObjectURL(t);this._previewsURL=e,this.$(".mptHover").style.backgroundImage="url('"+this._previewsURL+"')",await this.updatePreviewSprites(e)}}async updatePreviewSprites(t){let e=this._previewSeekOffset/5,s=this._media.getInfo("aspectRatio")*this._previewHeight;this._canvasInitialized||(this._previewCanvas=document.createElement("canvas"),this._previewCanvas.width=20*s,this._previewCanvas.height=this._previewHeight,this._canvasInitialized=!0);let i=this._previewCanvas.getContext("2d");if(t){const e=new Image;e.onload=()=>{i.drawImage(e,0,0,e.width,e.height,0,0,this._previewCanvas.width,this._previewCanvas.height);for(let t=0;t<30;t++){let e=i.getImageData(s*t+1,0,1,1).data;e[0]>110&&e[0]>e[1]&&e[0]>e[2]&&(this._previewsCached[t]=!0)}},e.src=t}else i.drawImage(this._previewVideo,0,0,this._media.getInfo("width"),this._media.getInfo("height"),s*e,0,s,this._previewHeight),i.fillStyle="#ff0000",i.fillRect(s*e,0,3,3),this._previewCanvas.toBlob(t=>{let s=URL.createObjectURL(t);this._app._peerManager._media.saveVideoPreview(this._media,t),this._previewsCached[e]=!0,this._previewsURL=s,this.$(".mptHover").style.backgroundImage="url('"+this._previewsURL+"')"},"image/jpeg",.9)}previewSeeking(){this.$(".mptHover").classList.add("seeking")}previewSeeked(){this.$(".mptHover").classList.remove("seeking"),this.updatePreviewSprites()}previewOnX(t){if(!this._previewSet){this._previewVideo=this.$(".previewVideo"),this._previewVideo.src=this._media.getStreamURL()+"?preview",this._previewVideo.addEventListener("seeking",()=>{this.previewSeeking()}),this._previewVideo.addEventListener("seeked",()=>{this.previewSeeked()});let t=this._media.getInfo("aspectRatio")*this._previewHeight;this.$(".mptHover").style.width=t+"px",this.$(".mptHover").style.marginLeft="-"+Math.floor(t/2)+"px",this._trackRect=this.$(".mpTrack").getBoundingClientRect(),this._maxPreviewPOffset=Math.ceil(100*Math.abs(Math.floor(t/2)/this._trackRect.width)),this._previewSet=!0}this.$(".mptHover").classList.add("active");let e=this.xToPercents(t);e<this._maxPreviewPOffset&&(e=this._maxPreviewPOffset),e>100-this._maxPreviewPOffset&&(e=100-this._maxPreviewPOffset),this.$(".mptHover").style.left=e+"%",this._previewSeekOffset=5*Math.floor(e/5);let s=this._previewSeekOffset/5;if(this._previewsCached&&this._previewsCached[s]){if(this._lastPreviewI==s)return;this.$(".mptHover").classList.remove("seeking"),this._previewVideo.style.display="none";let t=this.$("#mptHoverItem"+s);t&&t.remove();let e="-"+this._media.getInfo("aspectRatio")*this._previewHeight*s+"px 0px",i=`<div id="mptHoverItem${s}" class="mptHoverItem" style="background-position: ${e}; background-image: url(${this._previewsURL})"></div>`;this.$(".mptHovers").insertAdjacentHTML("beforeEnd",i),setTimeout(()=>{this.$("#mptHoverItem"+s).classList.add("active"),clearTimeout(this._rppto),this._rppto=setTimeout(()=>{let t=this.$$(".mptHoverItem");for(let e=0;e<t.length-1;e++)t[e].remove();t[t.length-1].classList.add("forcedactive")},800)},10),this._lastPreviewI=s}else this._previewVideo.style.display="block",this._previewVideo.currentTime=Math.floor(this.percentsToTime(this._previewSeekOffset))}template(){return`\n\t\t\t<div class="mbbPhoto mbbVideo" style="background-image: url('{{imageURL}}'); {{if (options.fromDefined)}}top: {{from.y}}px; left: {{from.x}}px; width: {{from.width}}px; height: {{from.height}}px;{{/if}}">\n\t\t\t\t<div class="mpCont">\n\t\t\t\t\t<div class="mpNav">\n\t\t\t\t\t\t<div class="mpNavCont noswipe">\n\t\t\t\t\t\t\t<div class="mpTrack" id="mpTrack{{domId}}">\n\t\t\t\t\t\t\t\t<div class="mptGray"></div>\n\t\t\t\t\t\t\t\t<div class="mptLoaded"></div>\n\t\t\t\t\t\t\t\t<div class="mptBlue"></div>\n\t\t\t\t\t\t\t\t<div class="mptBall"></div>\n\t\t\t\t\t\t\t\t<div class="mptOver"></div>\n\t\t\t\t\t\t\t\t<div class="mptHover"><div class="cssload-zenith dark"></div><div class="mptHovers"></div><video class="previewVideo" muted></video></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="mpButs noswipe">\n\t\t\t\t\t\t\t\t<div class="mpPlay" id="mpPlay{{domId}}">\n\t\t\t\t\t\t\t\t\t<div class="mpIcon mpIconPlay">${a.getIconHTML("play")}</div>\n\t\t\t\t\t\t\t\t\t<div class="mpIcon mpIconPause active">${a.getIconHTML("pause")}</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="mpTime"></div>\n\t\t\t\t\t\t\t\t<div class="mpFull" id="mpFull{{domId}}">\n\t\t\t\t\t\t\t\t\t<div class="mpIcon active">${a.getIconHTML("fullscreen")}</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="mpLoaded">\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<video id="video_{{domId}}" class="videoTag videoPlayer" style="display: none;"></video>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="cssload-zenith onDark videoLoading" style="margin-top: 200px;"></div>\n\t\t\t</div>\n\t\t`}}},function(t,e,s){const i=window.classes.EventTarget,a=window.classes.Storage,o=s(76),n=s(80),r=s(81),d=s(82),l=s(84),h=s(85),c=s(87);t.exports=class extends i{constructor(t={}){super(),this._app=t.app,this._user=t.app._user,this._storage=new a,this._media=new d({app:t.app,user:this._user,storage:this._storage}),this._stickers=new h({app:t.app,user:this._user,media:this._media,storage:this._storage,peerManager:this}),this._download=new l({app:t.app}),this._gifs=new c({user:this._user,peerManager:this}),this._peers={},this._sortedPeers=[],this._peerUsers={},this._mePeerUser=null,this._folders={},this._folders[1]=new n({peerManager:this,apiObject:{id:1}}),this._throttleTimeouts={},this._channels={},this._doNotSendMessageEvents=!1,this.initState(),this._thereReMorePeers=!0,this._loadingMorePeers=!1,this._oldestDialogDate=!1,this._loadedPinned=!1,this._activePeer=null,this._poll=!0,this.on("subscribed",()=>{this.sortPeers(),this.persist()})}async toggleDialogArchived(t,e){await t.toggleDialogArchived(e)&&this.emit("updated",{peer:t})}async toggleDialogPin(t,e){await t.toggleDialogPin(e)&&this.emit("updated",{peer:t})}async initState(){setTimeout(()=>{console.error("initState load"),this.restore(),this.loadPeers()},1);const t=await this._user.invoke("updates.getState");t&&t.data&&(this._state=t.data),this._user._protocol.on("update",t=>{this.processApiUpdates(t)})}async processApiUpdates(t){if(t.data)return await this.processApiUpdates(t.data);if(t){if(t.users)for(let e of t.users){let t=this.peerUserByAPIResult(e);t.checkOnlineChanged()&&this.emit("online",{peerUser:t})}if(t.chats)for(let e of t.chats){this.peerByAPIResult(e)}if(t.update)if(t.update.updates)for(let e of t.update.updates)await this.processApiUpdate(e);else await this.processApiUpdate(t.update);else if(t.updates)for(let e of t.updates)await this.processApiUpdate(e);else t._&&await this.processApiUpdate(t)}this.persist()}shortObjectToId(t){return t.chat_id?"chat_"+t.chat_id:t.channel_id?"channel_"+t.channel_id:t.user_id?"dialog_"+t.user_id:void 0}async updatePinnedData(t,e){let s=[];for(let e of t)s.push(this.shortObjectToId(e.peer));for(let t of this._sortedPeers)if(t.isArchived()==e){let e=null;t.isPinned()&&-1==s.indexOf(t._id)?e=!1:t.isPinned()||-1==s.indexOf(t._id)||(e=!0),null!==e&&(t._apiObject.pFlags.pinned=e,this.emit("peers"))}}async processApiUpdate(t){if(console.error("API Update",t),t.folder_peers){for(let e of t.folder_peers)this.processApiUpdate(e);return}if("updatePinnedDialogs"==t._&&setTimeout(()=>{this.updatePinnedData(t.order,t.folder_id)},500),"updateDialogFilter"==t._&&(t.filter?this.workFoldersData([t.filter]):this._folders[t.id]._isRemoved=!0,this.emit("folder",{folderId:t.id})),"updateMessagePoll"==t._){let e=t.poll_id;for(let s of this._sortedPeers)s._pollsIds[e]&&s._pollsIds[e].fillUpdatesFromAPIResult(t)}let e=null;if(t.user_id&&(e=this.peerUser(t.user_id)),e){e.processApiUpdate(t)&&this.emit("updated",{peerUser:e})}let s=await this.peerByApiShortObject(t);if(s||e||(await this.nextState(),s=await this.peerByApiShortObject(t,!0)),s){let e=s.isPinned(),i=s.getDisplayTime(),a=null,o=!1;"updateNewChannelMessage"==t._||"updateNewMessage"==t._||"updateEditMessage"==t._?(a=this.messageToPeer(s,t.message),o=await s.processApiUpdate(t)):"updateShortChatMessage"==t._||"updateShortMessage"==t._?a=this.messageToPeer(s,t):o=await s.processApiUpdate(t),o&&(this.emit("updated",{peer:s}),!o||e==s.isPinned()&&i==s.getDisplayTime()||this.emit("peers"))}}async peerByApiShortObject(t,e){if(t.peer)return await this.peerByApiShortObject(t.peer);let s=null,i=null,a=null;if(t.chat_id)s="chat_"+t.chat_id,i=t.chat_id,a="chat";else if(t.channel_id)s="channel_"+t.channel_id,i=t.channel_id,a="channel";else if(t.from_id){if(t.to_id&&(t.pFlags&&t.pFlags.out||t.out)){let e=await this.peerByApiShortObject(t.to_id);if(e)return e}s="dialog_"+t.from_id,i=t.from_id,a="dialog"}else t.user_id&&(s="dialog_"+t.user_id,i=t.user_id,a="dialog");if(!s){if(t.message&&t.message._)return await this.peerByApiShortObject(t.message);if(t.to_id)return await this.peerByApiShortObject(t.to_id)}if(!s&&t.messages&&e){console.error("look for peer by message id");for(let e of this._sortedPeers)for(let s of t.messages)if(e.hasMessageId(s))return e}return this._peers[s]?this._peers[s]:null}setActivePeer(t){this._activePeer=t,this.persist()}persist(){const t={peers:[],activePeerId:null};this._activePeer&&(t.activePeerId=this._activePeer._id);let e=0;for(let s of this._sortedPeers)s._id==t.activePeerId?t.peers.push(s.serialize(!0)):e<20&&t.peers.push(s.serialize()),e++;this._storage.set("dialogs",JSON.stringify(t))}async restore(){let t=await this._storage.get("dialogs");try{t=JSON.parse(t)}catch(t){}if(t&&t.peers){for(let e of t.peers)try{if(e.peerUser){this.peerUserByAPIResult(e.peerUser)}if(e.users)for(let t of e.users)this.peerUserByAPIResult(t);this.peerByAPIResult(e.apiObject).deserialize(e)}catch(t){}await this.loadAvatarsFromCache(),this.sortPeers(),this.emit("peers"),t.activePeerId&&(this._activePeer=this.peerById(t.activePeerId),this._activePeer&&this.emit("initialPeer",{peer:this._activePeer}))}}async getMePeer(){if(this._mePeerUser){if(this._mePeerUser._peer)return this._mePeerUser._peer;this.peerByAPIResult({peer:{_:"peerUser",user_id:this._mePeerUser._id}});return this._mePeerUser._peer}}async loadAvatarsFromCache(){let t=[];for(let e of this._sortedPeers){let s={url:e.getAvatarCacheURL()};e._peerUser?(s.object=e._peerUser,null===e._peerUser._hasAvatar&&t.push(s)):(s.object=e,null===e._hasAvatar&&t.push(s))}await this._user._protocol.getCachedResources(t);for(let e of t)e.cached&&(e.object._avatarBlobURL=e.blobURL,e.object._hasAvatar=!0)}async loadPeers(){if(!this._thereReMorePeers||this._loadingMorePeers)return!1;this._loadingMorePeers=!0;let t=null;const e={offset_peer:{_:"inputPeerEmpty"},exclude_pinned:!0};if(this._loadedPinned)!1!==this._oldestDialogDate&&(e.offset_date=this._oldestDialogDate),t=await this._user.invoke("messages.getDialogs",e);else{const s=await Promise.all([this._user.invoke("messages.getDialogs",e),this._user.invoke("messages.getPinnedDialogs",e),this._user.invoke("messages.getDialogFilters"),this._user.invoke("messages.getPinnedDialogs",{offset_peer:{_:"inputPeerEmpty"},folder_id:1})]);t=s[0];const i=e=>{try{for(let s in e)if(t.data[s]&&"_"!=s)for(let i of e[s])if(i.pFlags||(i.pFlags={}),i.pFlags){for(let e of t.data.chats)e.id==i.id&&e.pFlags&&(e.pFlags.loadedPinned=!0,e.pFlags.pinned=!0);for(let e of t.data.dialogs)e.peer&&i.peer&&e.peer.user_id&&i.peer.user_id&&e.peer.user_id==i.peer.user_id&&e.pFlags&&(e.pFlags.loadedPinned=!0,e.pFlags.pinned=!0)}}catch(t){console.error(t)}};s[1]&&s[1].data&&i(s[1].data),s[3]&&s[3].data&&i(s[3].data),s[2]&&await this.workFoldersData(s[2].data)}if(console.error(t.data),t.data){"dialogs"==t.data._&&(this._thereReMorePeers=!1),this._doNotSendMessageEvents=!0;let e=await this.workApiData(t,!0);if(this._doNotSendMessageEvents=!1,(!1===this._oldestDialogDate||e<this._oldestDialogDate)&&(this._oldestDialogDate=e),null==e&&(this._thereReMorePeers=!1),!this._loadedPinned){for(let t of this._sortedPeers)t._apiObject.pFlags&&t._apiObject.pFlags.pinned&&(t._apiObject.pFlags.loadedPinned||(t._apiObject.pFlags.pinned=!1),t._apiObject.pFlags.loadedPinned=!1);this._loadedPinned=!0}await this.loadAvatarsFromCache()}this._loadingMorePeers=!1,this.emit("peers")}peerById(t){return this._peers[t]}messageToPeer(t,e,s){if(!t)return!1;const i=t.messageByAPIResult(e,s);return s||this._doNotSendMessageEvents||this.emit("message",{peer:t}),i}peerUser(t){return t=""+t,this._peerUsers[t]?this._peerUsers[t]:null}peerByAPIResult(t,e,s){let i=null,a=null,n=null;if(t.peer?(t.peer.user_id&&(i="dialog_"+t.peer.user_id,a="dialog"),"peerChannel"==t.peer._&&(i="channel_"+t.peer.channel_id,a="channel"),"peerChat"==t.peer._&&(i="chat_"+t.peer.chat_id,a="chat")):("channel"==t._&&(i="channel_"+t.id,a="channel"),"chat"!=t._&&"chatForbidden"!=t._||(i="chat_"+t.id,a="chat")),t.folder_id&&(n=t.folder_id),!i)return null;if(this._peers[i])return s||this._peers[i].fillUpdatesFromAPIResult(t),this._peers[i];if(e)return null;const r={};r.id=i,r.type=a,r.apiObject=t,r.peerManager=this;const d=new o(r);return"dialog"!=a&&t.id&&(this._channels[t.id]=d),n&&(d.folder_id=n),this._peers[i]=d,this._sortedPeers.push(d),d}apiMessageToPeer(t){if(!t.to_id&&t.chat_id&&this._peers["chat_"+t.chat_id]&&(t.to_id={_:"peerChat",chat_id:t.chat_id}),!t.to_id&&t.user_id&&this._peers["dialog_"+t.user_id]&&(t.to_id={_:"peerUser",user_id:t.user_id},t.pFlags&&t.pFlags.out&&this._mePeerUser?t.from_id=this._mePeerUser._id:t.from_id=t.user_id),!t.to_id)return null;if("peerChat"==t.to_id._)return this._peers["chat_"+t.to_id.chat_id]?this._peers["chat_"+t.to_id.chat_id]:null;if("peerChannel"==t.to_id._)return this._peers["channel_"+t.to_id.channel_id]?this._peers["channel_"+t.to_id.channel_id]:null;if("peerUser"==t.to_id._){let e=null,s=null;if(t.to_id.user_id==t.from_id?(e=this._peers["dialog_"+t.from_id]?this._peers["dialog_"+t.from_id]:null,s=t.from_id):t.pFlags.out?(e=this._peers["dialog_"+t.to_id.user_id]?this._peers["dialog_"+t.to_id.user_id]:null,s=t.to_id.user_id):(e=this._peers["dialog_"+t.from_id]?this._peers["dialog_"+t.from_id]:null,s=t.from_id),e)return e;{const t={};t.id="dialog_"+s,t.type="dialog",t.apiObject={peer:{user_id:s}},t.peerManager=this;const e=new o(t);return this._peers[t.id]=e,this._sortedPeers.push(e),e}}}peerUserByAPIResult(t){let e=null;if(t.id&&(e=""+t.id),!e)return null;if(this._peerUsers[e])return t.status&&(this._peerUsers[e]._apiObject.status=t.status),this._peerUsers[e];const s=new r({id:e,apiObject:t,peerManager:this});return this._peerUsers[e]=s,s.isMe()&&(this._mePeerUser=s),s}getEmptyFolder(){return new n({peerManager:this})}async getSuggestedFolders(){return(await this._user.invoke("messages.getSuggestedDialogFilters")).data}async createSuggestedFolder(t){let e=new n({peerManager:this,apiObject:t});return await e.persist()}async workFoldersData(t){for(let e of t)"dialogFilter"==e._&&(this._folders[e.id]?this._folders[e.id].fillUpdatesFromAPIResult(e):this._folders[e.id]=new n({apiObject:e,peerManager:this}));this.emit("folders")}async updateHashes(){const t=await this._user.invoke("messages.getDialogs",{offset_peer:{_:"inputPeerEmpty"}});for(let e of t.data.chats)if(e.access_hash){let t=this.peerByAPIResult(e);t&&(t._apiObject.access_hash=e.access_hash)}for(let e of t.data.users)if(e.access_hash){let t=this.peerUserByAPIResult(e);t&&(t._apiObject.access_hash=e.access_hash)}return!0}async workApiData(t){let e=null;if(t&&t.success&&t.data){if(t.data.users)for(let e of t.data.users){this.peerUserByAPIResult(e).checkOnlineChanged()}if(t.data.chats)for(let e of t.data.chats){this.peerByAPIResult(e)}if(t.data.dialogs)for(let e of t.data.dialogs)if("dialog"==e._){let t=this.peerByAPIResult(e);if(t){if(e._pts&&(t._pts=e.pts),e.notify_settings&&(t._notify_settings=e.notify_settings),e.pFlags)for(let s in e.pFlags)t._apiObject.pFlags[s]=e.pFlags[s]}else console.error("no peer found for ",e)}else this._folders[e.folder.id]||(this._folders[e.folder.id]=new n({apiObject:e.folder,peerManager:this}));if(t.data.messages)for(let s of t.data.messages){let t=this.apiMessageToPeer(s);this.messageToPeer(t,s),t.isPinned()||(!e||e>s.date)&&(e=s.date)}this.sortPeers()}return e}sortPeers(){this._sortedPeers.sort((t,e)=>t._mostRecentMessageDate<e._mostRecentMessageDate?1:e._mostRecentMessageDate<t._mostRecentMessageDate?-1:0)}async workState(t){if(t&&t.success&&t.data){if(t.data.users)for(let e of t.data.users){let t=this.peerUserByAPIResult(e);t.checkOnlineChanged()&&(console.error("ONLINE ",t),this.emit("online",{peerUser:t}))}if(t.data.chats)for(let e of t.data.chats){this.peerByAPIResult(e)}if(t.data.new_messages)for(let e of t.data.new_messages){let t=this.apiMessageToPeer(e);this.messageToPeer(t,e)}if(t.data.other_updates)for(let e of t.data.other_updates)if("updateNewChannelMessage"==e._){let t=this.apiMessageToPeer(e.message);this.messageToPeer(t,e.message)}else"updateChannelTooLong"==e._?this.nextChannelState(e.channel_id):e.peer&&console.error(e,"update")}}async nextChannelState(t){const e={pts:this._channels[t]._pts,date:this._state.date,channel:{_:"inputChannel",channel_id:t,access_hash:this._channels[t]._apiObject.access_hash},filter:{_:"channelMessagesFilterEmpty"}},s=await this._user.invoke("updates.getChannelDifference",e);console.error("todo this"),console.log(s)}async nextState(){if(!this._user.signedIn())return!1;const t=await this._user.invoke("updates.getDifference",{pts:this._state.pts,date:this._state.date});t&&t.data&&t.data.state&&(await this.workState(t),this._state=t.data.state)}async search(t,e){if(t=(""+t).toLowerCase(),!this._user.signedIn())return!1;const s={global:[],messages:[],local:[],totalMessages:0};for(let e of this._sortedPeers)e.isSearchMatch(t)&&s.local.push(e);let i=null;if(i=e?await this._user.invoke("messages.search",{q:t,limit:50,peer:e.getInputPeerObject(),filter:{_:"inputMessagesFilterEmpty"}}):await this._user.invoke("messages.searchGlobal",{q:t,offset_peer:{_:"inputPeerEmpty"}}),console.error(i),i&&i.success&&i.data){if(i.data.users)for(let t of i.data.users){this.peerUserByAPIResult(t).checkOnlineChanged()}if(i.data.chats)for(let t of i.data.chats){this.peerByAPIResult(t)}if(i.data.messages)for(let t of i.data.messages){let e=this.apiMessageToPeer(t),i=this.messageToPeer(e,t,!0);e&&i?s.messages.push({peer:e,peerMessage:i}):console.error("Cant find peer and peerMessage for",t)}i.data.count?s.totalMessages=i.data.count:s.totalMessages=i.data.messages.length}if(!e&&(i=await this._user.invoke("contacts.search",{q:t}),i.data&&i.data.chats&&i.data.chats.length))for(let t of i.data.chats){console.error(t);let e=this.peerByAPIResult(t);console.error(e),e&&s.global.push(e)}return s}}},function(t,e,s){window.classes.EventTarget,window.classes.Storage;const i=s(18),a=s(6),o=s(19),n=s(21),r=s(20),d=s(3),l=s(78),h=s(79);class c extends h{constructor(t={}){super(t),this._id=t.id,this._peerManager=t.peerManager,this._displayMessage="",this._type=t.type,this._apiObject=t.apiObject,"dialog"==this._type&&(this._peerUser=this._peerManager.peerUser(this._apiObject.peer.user_id),this._peerUser._peer=this),this._messages=[],this._messageIds={},this._mostRecentMessageDate=0,this._mostRecentMessage=null,this._messageGroups={},this._pts=null,this._notify_settings=null,this._unreadCount=0,this._readByPeer=null,this._read_inbox_max_id=null,this._read_outbox_max_id=null,this.fillUpdatesFromAPIResult(this._apiObject),this._oldestMessageId=1/0,this._thereReMoreMessages=!0,this._loadingMoreMessages=!1,this._messagesWereLoaded=!1,this._messagesWereRestored=!1,this._media=[],this._mediaIds={},this._docs=[],this._docsIds={},this._stickers=[],this._stickersIds={},this._webpages=[],this._webpagesIds={},this._polls=[],this._pollsIds={},this._audios=[],this._audiosIds={},this._folder=null,this._folderId=null,this._fullInfoLoaded=!1,this._fullInfoPromiseResolver=null,this._fullInfoPromise=new Promise(t=>{this._fullInfoPromiseResolver=t}),this._fullInfo={},this._makeReadyPromiseResolver=null,this._isReady=!1,this._hasAvatar=null,this._avatarBlobURL=null}async makeReady(){this._makeReadyPromiseResolver?await this._makeReadyPromise:(this._makeReadyPromise=new Promise(t=>{this._makeReadyPromiseResolver=t}),await this.loadInitial(),this._makeReadyPromiseResolver(),this._isReady=!0)}async subscribe(t){const e={channel:{_:"inputChannel",channel_id:this._apiObject.id,access_hash:this._apiObject.access_hash}};let s="channels.joinChannel";t||(s="channels.leaveChannel");await this._peerManager._user.invoke(s,e)}isSubscribed(){try{if("channel"==this._type&&this._apiObject.pFlags.left)return!1}catch(t){}return!0}isArchived(){return 1==this._folderId}async toggleDialogArchived(t){return this._apiObject.pFlags||(this._apiObject.pFlags={}),this._apiObject.pFlags.pinned=!1,this.isArchived()?this._peerManager._folders[1].removePeer(this):this._peerManager._folders[1].addPeer(this),!0}async toggleDialogMuted(t){let e=t?Math.ceil((new Date).getTime()/1e3)+31536e3:0;const s={peer:{_:"inputNotifyPeer",peer:this.getInputPeerObject()},settings:{_:"inputPeerNotifySettings",mute_until:e,flags:4}};await this._peerManager._user.invoke("account.updateNotifySettings",s)&&(this._notify_settings={mute_until:e},this._peerManager.emit("updated",{peer:this}))}async toggleDialogPin(t){const e={pinned:t,flags:t,peer:{_:"inputDialogPeer",peer:this.getInputPeerObject()}},s=await this._peerManager._user.invoke("messages.toggleDialogPin",e);return s&&(this._apiObject.pFlags||(this._apiObject.pFlags={}),this._apiObject.pFlags.pinned=t),s}hasMessageId(t){return t in this._messageIds}async processApiUpdate(t){let e=!1;if("folderPeer"==t._&&(console.error("updaing folder 2"),this._folderId=t.folder_id,e=!0),"updateReadHistoryOutbox"==t._&&(this._read_outbox_max_id=t.max_id,e=!0,this._peerManager.emit("readybypeer",{peer:this})),"updateReadHistoryInbox"!=t._&&"updateReadChannelInbox"!=t._||(this._read_inbox_max_id=t.max_id,t.still_unread_count?this._unreadCount=t.still_unread_count:this._unreadCount=0,e=!0),"updateDeleteMessages"==t._){for(let e of t.messages)await this.deleteMessage(e),this._messages.length||await this.loadInitial(),this._displayMessage=this._messages[this._messages.length-1].getDisplayMessage(!0);e=!0}return"updateEditMessage"==t._&&(this._displayMessage=this._messages[this._messages.length-1].getDisplayMessage(!0),e=!0),"updateDialogPinned"==t._&&(this._apiObject.pFlags.pinned=t.pFlags.pinned,e=!0),"updateNotifySettings"==t._&&(this._notify_settings=t.notify_settings,e=!0),e}serialize(t){const e={apiObject:this._apiObject,id:this._id,type:this._type,messages:[],users:[],peerUser:null};let s=["fullInfo","pts","unreadCount","read_outbox_max_id","read_inbox_max_id","readByPeer","notify_settings","folderId"];for(let t of s)e[t]=this["_"+t];this._peerUser&&(e.peerUser=this._peerUser.serialize()),this.sortMessages();let i=[];for(let s=this._messages.length-1;s>=0&&(!e.messages.length||t)&&e.messages.length<20;s--){let t=this._messages[s];e.messages.push(t.serialize()),t._peerUser&&-1==i.indexOf(t._peerUser._id)&&(e.users.push(t._peerUser.serialize()),i.push(t._peerUser._id))}return e}deserialize(t){let e=["fullInfo","pts","unreadCount","read_outbox_max_id","read_inbox_max_id","readByPeer","notify_settings","folderId"];for(let s of e)this["_"+s]=t[s];if(t.messages){for(let e of t.messages)e.id&&"string"!=typeof e.id&&this.messageByAPIResult(e,!1,!0);this.sortMessages(),this._oldestMessageId=1/0,this._messages.length>1&&(this._messagesWereRestored=!0)}}hasReadBadge(){return this._mostRecentMessage&&this._mostRecentMessage.isFromMe()?this._mostRecentMessage.seenByPeer():null}isMuted(){return this._notify_settings&&this._notify_settings.mute_until&&this._notify_settings.mute_until>c.cTime}isPinned(){return this._apiObject.pFlags&&this._apiObject.pFlags.pinned}isMine(){return!(!this._peerUser||!this._peerUser.isMe())}getInfoType(){return this.getDisplayType()}getInfoString(){let t=this.getDisplayType(),e=this._apiObject.participants_count||this._fullInfo.participants||0;if("channel"==t)return d.numberToString(e)+" subscriber"+(1!=e?"s":"");if("dialog"==t)return this._peerUser.isMe()?"chat with yourself":this._peerUser.lastSeenString();if("chat"==t){let t="chat";if(!e)return t;if(t=d.numberToString(e)+" member"+(1!=e?"s":""),this._fullInfoLoaded){let e=this._fullInfo.participantsOnline;return e&&(t+=", "+d.numberToString(e)+" online"),t}return t}}trimMessagesToRecent(){this._messages=this._messages.slice(-40),this._messageIds={},this._oldestMessageId=1/0;for(let t of this._messages)this._messageIds[t._id]=t,t._id<this._oldestMessageId&&(this._oldestMessageId=t._id)}async flushAvatar(){if(this._peerUser)return this._peerUser.flushAvatar();this._hasAvatar=null,this._avatarBlobURL=null,await this._peerManager._media.flushPeerAvatar(this),await this.getAvatarBlobURL()}hasAvatar(){return this._peerUser?this._peerUser.hasAvatar():this._hasAvatar}getAvatarCacheURL(){return this._peerUser?this._peerUser.getAvatarCacheURL():"./tg/avatar_peer_"+this._id+".png"}getAvatarBlobURLSync(){return this._peerUser?this._peerUser.getAvatarBlobURLSync():this._avatarBlobURL}async getAvatarBlobURL(){if(this._peerUser)return this._peerUser.getAvatarBlobURL();if(this._avatarBlobURL)return this._avatarBlobURL;if(!1===this._hasAvatar)return null;let t=await this._peerManager._media.getPeerAvatarAndReturnBlobURL(this);return null===t?(this._hasAvatar=!1,null):(this._hasAvatar=!0,this._avatarBlobURL=t,this._avatarBlobURL)}getAvatarInitials(){return this._peerUser?this._peerUser.getAvatarInitials():this._apiObject.title?this._apiObject.title.substring(0,1):""}getAvatarColor(){return(""+this._id).substr(-1)%8+1}async loadPreviewsFromCache(){const t=[];for(let e of this._messagesVisible)e.authorPeer(),!e.isService()&&e._authorPeer&&null===e._authorPeer._hasAvatar&&t.push(e._authorPeer._peerUser?e._authorPeer._peerUser:e._authorPeer);if(t.length){let e=[];for(let s of t)e.push({url:"./tg/avatar_peer_dialog_"+s._id+".png",user:s});await this._peerManager._user._protocol.getCachedResources(e);for(let t of e)t.blobURL&&(t.user._avatarBlobURL=t.blobURL,t.user._hasAvatar=!0)}await this._peerManager._user._protocol.getCachedResources(this._media.concat(this._stickers,this._webpages))}async getFullInfo(){if(this._fullInfoLoaded)return await this._fullInfoPromise,this._fullInfo;this._fullInfoLoaded=!0;const t={};let e=null;"dialog"==this._type?(t.id={_:"inputUser",user_id:this._peerUser._apiObject.id,access_hash:this._peerUser._apiObject.access_hash},e="users.getFullUser"):"channel"==this._type?(t.channel={_:"inputChannel",channel_id:this._apiObject.id,access_hash:this._apiObject.access_hash},e="channels.getFullChannel"):"chat"==this._type&&(t.chat_id=this._apiObject.id,e="messages.getFullChat");const s=await this._peerManager._user.invoke(e,t);return s&&s.data?(this._fullInfo=s.data,this._fullInfo.about=this._fullInfo.about||"",this._fullInfo.participants="",this._fullInfo.participantsOnline="",this._fullInfo.username="",this._fullInfo.phone="",s.data.full_chat&&(this._fullInfo.about=s.data.full_chat.about,this._fullInfo.participants=s.data.full_chat.participants_count,this._fullInfo.participantsOnline=s.data.full_chat.online_count),s.data.chats&&s.data.chats[0]&&(this._fullInfo.participants=this._fullInfo.participants||s.data.chats[0].participants_count,this._fullInfo.username=s.data.chats[0].username?"t.me/"+s.data.chats[0].username:""),s.data.user&&(this._fullInfo.username=s.data.user.username,this._fullInfo.phone=s.data.user.phone),this._fullInfoPromiseResolver(),this.emit("info"),this._fullInfo):void 0}canSendMessageTo(){if("channel"==this._type){if(this._apiObject.pFlags)return!(!this._apiObject.pFlags.creator&&!this._apiObject.pFlags.megagroup)}else{if("chat"==this._type)return!(!this._apiObject.title||this._apiObject.migrated_to||"chatForbidden"==this._apiObject._);if("dialog"==this._type&&this._peerUser&&this._peerUser.isRemoved())return!1}return!0}getDisplayType(){return"channel"!=this._type?this._type:this._apiObject.pFlags&&this._apiObject.pFlags.megagroup?"chat":"channel"}async sendRecordedVoice(){let t=this._peerManager._app._mediaPlayer._recorded;await this.sendFiles([{filename:"voice.ogg",bytes:t,type:"voice"}])}async sendGif(t){const e="c"+this._id+"_"+(""+Math.random()).split(".").join(""),s={peer:this.getInputPeerObject(),random_id:e,media:{_:"inputMediaDocument",id:{_:"inputDocument",id:t._id,access_hash:t._apiObject.access_hash,file_reference:t._apiObject.file_reference}},flags:!0};let i=await this._peerManager._user.invoke("messages.sendMedia",s);i&&i.data&&this._peerManager.processApiUpdates(i.data)}async sendFiles(t,e=""){const s=[];let i=!1;for(let e of t){let t=e.bytes;e.ab&&(t=new Uint8Array(e.ab));const a="c"+this._id+"_"+(""+Math.random()).split(".").join(""),o=(this.getInputPeerObject(),await this._peerManager._media.uploadPhoto(t,e.filename));if("photo"==e.type)s.push({_:"inputMediaUploadedPhoto",file:o});else if("video"==e.type){let t=[{_:"documentAttributeVideo",flags:!0,w:200,h:200},{_:"documentAttributeFilename",file_name:e.filename}];s.push({_:"inputMediaUploadedDocument",file:o,mime_type:"video/mp4",attributes:t})}else if("doc"==e.type||"voice"==e.type){let t=[{_:"documentAttributeFilename",file_name:e.filename}];s.push({_:"inputMediaUploadedDocument",file:o,mime_type:l.filenameToMime(e.filename),attributes:t}),i=!0}}const a={peer:this.getInputPeerObject()},o=(""+Math.random()).split("0.").join("");let n=0;if(s.length>1&&!i){const t=[];for(let i of s){a.media=i;let s=await this._peerManager._user.invoke("messages.uploadMedia",a);if(s&&s.data){let i="inputMediaPhoto";const a={_:"inputPhoto"};let r=s.data.photo;s.data.document&&(r=s.data.document,a._="inputDocument",i="inputMediaDocument"),a.id=r.id,a.access_hash=r.access_hash,a.file_reference=r.file_reference;const d={_:"inputSingleMedia",random_id:o+n++,media:{_:i,id:a}};!t.length&&e&&(d.message=e),t.push(d)}}a.multi_media=t;let i=await this._peerManager._user.invoke("messages.sendMultiMedia",a);i&&i.data&&this._peerManager.processApiUpdates(i.data)}else{a.random_id=o;for(let t of s){a.media=t,a.message="",!n&&e&&(a.message=e),a.random_id=o+n++;let s=await this._peerManager._user.invoke("messages.sendMedia",a);s&&s.data&&this._peerManager.processApiUpdates(s.data)}}}sendSticker(t){const e="1"+(""+Math.random()).split(".").join(""),s={peer:this.getInputPeerObject(),random_id:e,flags:!0};s.media={_:"inputMediaDocument",id:{_:"inputDocument",id:t.id,access_hash:t._apiObject.access_hash,file_reference:t._apiObject.file_reference}},this._peerManager._user.invoke("messages.sendMedia",s).then(t=>{t.data&&this._peerManager.processApiUpdates(t.data)})}forwardBotResult(t){const e="1"+(""+Math.random()).split(".").join("");if("messages.botResults"==t._)for(let s of t.results){const i={peer:this.getInputPeerObject(),random_id:e,query_id:t.query_id,id:s.id,flags:!0};this._peerManager._user.invoke("messages.sendInlineBotResult",i).then(t=>{t.data&&this._peerManager.processApiUpdates(t.data)})}else this._peerManager._user.invoke("messages.startBot",{random_id:e,bot:t.iu,peer:this.getInputPeerObject(),start_param:t.start_param}).then(t=>{t.data&&this._peerManager.processApiUpdates(t.data)})}forwardMessage(t){const e="1"+(""+Math.random()).split(".").join(""),s={from_peer:t._peer.getInputPeerObject(),to_peer:this.getInputPeerObject(),id:[t._id],random_id:[e],flags:!0};this._peerManager._user.invoke("messages.forwardMessages",s).then(t=>{t.data&&this._peerManager.processApiUpdates(t.data)})}forwardMessageMedia(t){const e="1"+(""+Math.random()).split(".").join(""),s={from_peer:t._peer.getInputPeerObject(),to_peer:this.getInputPeerObject(),id:[t._messageApiObject.id],random_id:[e],flags:!0};this._peerManager._user.invoke("messages.forwardMessages",s).then(t=>{t.data&&this._peerManager.processApiUpdates(t.data)})}sendMessage(t){const e="1"+(""+Math.random()).split(".").join(""),s={peer:this.getInputPeerObject(),message:t.message,random_id:e,flags:!0};t.replyTo&&(s.reply_to_msg_id=t.replyTo._id),this._peerManager._user.invoke("messages.sendMessage",s).then(t=>{t.data&&this._peerManager.processApiUpdates(t.data)})}sortMessages(){this._messages.sort((t,e)=>t._id>e._id?1:e._id>t._id?-1:0)}async getDaysMessages(t,e,s){let i=32-new Date(e,t,32).getDate(),a=[];new Date;const o=async(t,e,i)=>{let n=a[t].from.getTime()/1e3,r=a[e].to;const d={peer:this.getInputPeerObject(),offset_date:r.getTime()/1e3,limit:15};let l=await this._peerManager._user._protocol.invokeAndCache("messages.getHistory",d,{max:999990}),h=null;if(l.messages)for(let t of l.messages){let e=new Date(1e3*t.date);if(console.log(e),e.getTime()/1e3<n)return void(s&&s(a));let i=e.getDate()-1;a[i].has=!0,a[i].id=t.id,h=i}s&&s(a),h&&h!=t&&l.messages.length==d.limit&&i<30&&await o(t,h-1,i+1)};for(let s=1;s<=i;s++)a.push({from:new Date(e,t,s,0,0),to:new Date(e,t,s+1,0,-1),has:!1,id:null});return await o(0,a.length-1,1),a}async loadElements(t){if(t.initialization&&t.refs&&t.refs.length)return t.refs;const e={peer:this.getInputPeerObject(),limit:12,filter:{_:"inputMessagesFilter"+t.filter}};this["__last"+t.filter+"MessageOffsetId"]&&(e.offset_id=this["__last"+t.filter+"MessageOffsetId"]);const s=(e,s)=>{if(e[t.objProp]&&e[t.objProp][s]&&!t.idsRefs[e[t.objProp][s].id]){const i=new t.classN({apiObject:e[t.objProp][s],peerManager:this._peerManager,messageApiObject:e,peer:this});t.refs.push(i),t.idsRefs[i._id]=i}},i=await this._peerManager._user.invoke("messages.search",e);if(i&&i.data&&i.data.messages){if(i.data.users)for(let t of i.data.users)this._peerManager.peerUserByAPIResult(t);for(let e of i.data.messages){for(let i of t.objSubProp)s(e,i);this["__last"+t.filter+"MessageOffsetId"]=e.id}}return t.refs}async loadWebpages(t){return await this.loadElements({initialization:t,refs:this._webpages,filter:"Url",classN:r,idsRefs:this._webpagesIds,objProp:"media",objSubProp:["webpage"]})}async loadAudios(t){return await this.loadElements({initialization:t,refs:this._audios,filter:"Music",classN:n,idsRefs:this._audiosIds,objProp:"media",objSubProp:["document"]})}async loadDocs(t){return await this.loadElements({initialization:t,refs:this._docs,filter:"Document",classN:o,idsRefs:this._docsIds,objProp:"media",objSubProp:["document"]})}async loadMedia(t){return await this.loadElements({initialization:t,refs:this._media,filter:"PhotoVideo",classN:a,idsRefs:this._mediaIds,objProp:"media",objSubProp:["photo","document"]})}getInputPeerObject(){return"chat"==this._type?{_:"inputPeerChat",chat_id:this._apiObject.id}:"channel"==this._type?{_:"inputPeerChannel",channel_id:this._apiObject.id,access_hash:this._apiObject.access_hash}:"dialog"==this._type?{_:"inputPeerUser",user_id:this._peerUser._apiObject.id,access_hash:this._peerUser._apiObject.access_hash}:void 0}readyToUse(){return!(!this._mostRecentMessageDate||!this.isSubscribed())}hasMessages(){return this._messages.length>0&&(!this._apiObject.pFlags||!this._apiObject.pFlags.deactivated)}fillUpdatesFromAPIResult(t){this._pts=t.pts||this._pts,void 0!==t.unread_count&&(this._unreadCount=t.unread_count,this._peerManager.emit("unreadCount",{peer:this})),this._read_outbox_max_id=t.read_outbox_max_id||this._read_outbox_max_id,this._read_inbox_max_id=t.read_inbox_max_id||this._read_inbox_max_id,t.access_hash&&(this._apiObject.access_hash=t.access_hash),this._apiObject.pFlags||(this._apiObject.pFlags={}),t.pFlags&&(t.pFlags.pinned&&(this._apiObject.pFlags.pinned=!0),t.pFlags.loadedPinned&&(this._apiObject.pFlags.loadedPinned=!0),t.pFlags.left&&!this._apiObject.pFlags.left?(this._apiObject.pFlags.left=!0,this._peerManager.emit("subscribed",{peer:this})):this._apiObject.pFlags.left&&!t.pFlags.left&&(this._apiObject.pFlags.left=!1,this._peerManager.emit("subscribed",{peer:this}))),t.read_outbox_max_id&&t.top_message&&(t.read_outbox_max_id>t.top_message?this._readByPeer=!1:this._readByPeer=!0);try{t.photo.photo_small.local_id!=this._apiObject.photo.photo_small.local_id&&(this._apiObject.photo=t.photo)}catch(t){}t.folder_id?this._folderId=t.folder_id:this._folderId&&"dialog"==t._&&(this._folderId=null),this._peerManager.emit("peer",{peer:this})}async deleteMessage(t){if(!t in this._messageIds)return!1;let e=null;this._messageIds[t]=null;for(let s=0;s<this._messages.length;s++)if(this._messages[s]._id==t){s>0&&(e=this._messages[s-1]._id),this._messages.splice(s,1);break}this.emit("delete",{id:t,prevMessageId:e}),this._mostRecentMessage&&this._mostRecentMessage._id==t&&(this._mostRecentMessage=null,this._mostRecentMessageDate=null,this._displayMessage="",this._messages.length&&(this._mostRecentMessage=this._messages[this._messages.length-1],this._mostRecentMessageDate=this._messages[this._messages.length-1]._date,this._displayMessage=this._messages[this._messages.length-1].getDisplayMessage(!0)),this.emit("update"))}messageByAPIResult(t,e,s){if(t.id in this._messageIds)return this._oldestMessageId>t.id&&(this._oldestMessageId=t.id),this._messageIds[t.id].updateApiObject(t),this.emit("updateMessage",{id:t.id}),this._messageIds[t.id];const a=new i({apiObject:t,peer:this,peerUser:this._peerUser,peerManager:this._peerManager});if(e)return a;if("messageService"==t._&&(t.date>this._mostRecentMessageDate&&(this._mostRecentMessageDate=t.date,this._displayMessage=a.getDisplayMessage(!0)),!s&&t.action))if("messageActionChatEditTitle"==t.action._)this._apiObject.title=t.action.title,this._peerManager.emit("updated",{peer:this});else if("messageActionChatEditPhoto"==t.action._)try{this._apiObject.photo||(this._apiObject.photo={}),this._apiObject.photo.photo_small||(this._apiObject.photo.photo_small={}),this._apiObject.photo.dc_id=t.action.photo.dc_id,this._apiObject.photo.photo_small=t.action.photo.sizes[0].location,this._peerManager.emit("avatar",{peer:this})}catch(t){}let o=a.getGroupId();o&&(this._messageGroups[o]?(this._messageGroups[o].addMessageToGroup(a),this.emit("groupUpdated",{messageGroupId:o,groupMessages:this._messageGroups[o].getGroupMessages()})):this._messageGroups[o]=a),this._messages.push(a),this._messageIds[a._id]=a,this._oldestMessageId>a._id&&(this._oldestMessageId=a._id);let n=this._unreadCount;return a._date>this._mostRecentMessageDate&&(this._mostRecentMessageDate=a._date,this._mostRecentMessage=a,this._displayMessage=a.getDisplayMessage(!0),a._id>this._read_inbox_max_id&&!a.isFromMe()&&this._unreadCount++,a.isFromMe()&&(this._unreadCount=0),this.emit("update")),n!=this._unreadCount&&(clearTimeout(this._unreadTimeout),this._unreadTimeout=setTimeout(()=>{this._peerManager.emit("unreadCount",{peer:this})},100)),a}markAsRead(t){if(this._unreadCount=0,this._peerManager.emit("unreadCount",{peer:this}),t){const t={peer:this.getInputPeerObject()};this._mostRecentMessage&&(t.max_id=this._mostRecentMessage._id),"channel"==this._type?(t.channel=t.peer,t.channel._="inputChannel",this._peerManager._user.invoke("channels.readHistory",t)):this._peerManager._user.invoke("messages.readHistory",t)}}getUnreadCount(){return this._unreadCount}getDisplayTime(t){return new Date-(t=t?new Date(1e3*t):new Date(1e3*this._mostRecentMessageDate))<864e5?("0"+t.getHours()).substr(-2)+":"+("0"+t.getMinutes()).substr(-2):d.monthsNames[t.getMonth()]+" "+t.getDate()}getDisplayNameWB(){let t=this._apiObject.pFlags&&this._apiObject.pFlags.verified;return(""+this.getDisplayName()).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+(t?' <span class="verifiedAcc"></span>':"")}getDisplayName(){return this._peerUser?this._peerUser.isMe()?"Saved Messages":""+this._peerUser._displayName:""+this._apiObject.title||""}isSearchMatch(t){return-1!==this.getDisplayName().toLowerCase().indexOf(t)}getDisplayMessage(){return this._displayMessage}}c.cTime=(new Date).getTime()/1e3,t.exports=c},function(t,e){t.exports=class{constructor(t={}){this._peerManager=t.peerManager,this._apiObject=t.apiObject,this._messageApiObject=t.messageApiObject||{},this._peer=t.peer,this._id=this._apiObject.id,this._answers=[],this._results=[],this._totalVoters=0,this._solution="",this._isVoted=!1,this.fillUpdatesFromAPIResult(this._apiObject),this.fillUpdatesFromAPIResult(this._messageApiObject),this.mergeResults(),this._at=(new Date).getTime()/1e3,this._votesList={},this._votesListIds={},this._votesListOffsets={}}async getPollVotes(t){if(this._votesList[t.uniq]||(this._votesList[t.uniq]=[],this._votesListIds[t.uniq]={}),(this._votesListOffsets[t.uniq]||"")==1/0)return;let e=3+this._votesList[t.uniq].length;const s=await this._peerManager._user.invoke("messages.getPollVotes",{flags:1,limit:e,offset:"",option:t.option,peer:this._peer.getInputPeerObject(),id:this._messageApiObject.id});if(s&&s.data){if(s.data.users)for(let t of s.data.users)this._peerManager.peerUserByAPIResult(t);if(s.data.votes)for(let e of s.data.votes)this._votesListIds[t.uniq][e.user_id]||(this._votesList[t.uniq].push(this._peerManager._peerUsers[e.user_id]),this._votesListIds[t.uniq][e.user_id]=!0);s.data.next_offset?this._votesListOffsets[t.uniq]=s.data.next_offset:this._votesListOffsets[t.uniq]=1/0}}getRecentVoters(){const t=[];if(this._apiObject.recent_voters)for(let e of this._apiObject.recent_voters)this._peerManager._peerUsers[e]&&t.push(this._peerManager._peerUsers[e]);return t}get isVoted(){return this._isVoted}get closingIn(){const t={};if(this.isClosing){let e=(new Date).getTime()/1e3,s=this._apiObject.close_date&&this._apiObject.close_period?this._apiObject.close_date-this._apiObject.close_period:this._at,i=this._apiObject.close_date?this._apiObject.close_date:s+this._apiObject.close_period;t.time=Math.floor((i-e)/60)+":"+("0"+Math.floor(i-e)%60).slice(-2),t.percents=Math.floor((i-e)/(i-s)*100)}return t}get isClosing(){return!this.isClosed&&!this.isVoted&&(this._apiObject.close_date||this._apiObject.close_period)}get isClosed(){if(this._apiObject.pFlags&&this._apiObject.pFlags.closed)return!0;let t=(new Date).getTime()/1e3;return!!(this._apiObject.close_date&&this._apiObject.close_date<=t||this._apiObject.close_period&&this._apiObject.close_period+this._at<=t)}get isPublic(){return this._apiObject.pFlags&&this._apiObject.pFlags.public_voters}get isMultiple(){return this._apiObject.pFlags&&this._apiObject.pFlags.multiple_choice}get isQuiz(){return this._apiObject.pFlags&&this._apiObject.pFlags.quiz}get question(){return this._apiObject.question}async fetch(){const t=await this._peerManager._user.invoke("messages.getPollResults",{peer:this._peer.getInputPeerObject(),msg_id:this._messageApiObject.id});if(t.data&&t.data.updates)for(let e of t.data.updates)this.processApiUpdate(e)}processApiUpdate(t){this.fillUpdatesFromAPIResult(t)}async vote(t){const e={peer:this._peer.getInputPeerObject(),msg_id:this._messageApiObject.id,options:[]};for(let s of t)s.option?e.options.push(s.option):e.options.push(s);const s=await this._peerManager._user.invoke("messages.sendVote",e);if(s.data&&s.data.updates){for(let t of s.data.updates)this.processApiUpdate(t);return!0}return!1}fillUpdatesFromAPIResult(t){if(!t)return!1;if(t.answers){this._answers=t.answers;for(let t of this._answers)t.uniq=t.option.join("")}t.close_date&&(this._apiObject.close_date=t.close_date),t.close_period&&(this._apiObject.close_period=t.close_period),t.results&&(t.results.total_voters&&(this._totalVoters=t.results.total_voters),t.results.results&&(this._results=t.results.results),t.results.solution&&(this._solution=t.results.solution),t.results.recent_voters&&(this._apiObject.recent_voters=t.results.recent_voters)),t.media&&this.fillUpdatesFromAPIResult(t.media),this.mergeResults(),this._peer.emit("updateMessage",{id:this._messageApiObject.id})}mergeResults(){if(this._answers&&this._results&&this._answers.length==this._results.length)for(let t=0;t<this._answers.length;t++)this._answers[t].voters=this._results[t].voters,this._answers[t].percents=Math.floor(this._results[t].voters/this._totalVoters*100),this._results[t].pFlags&&(this._results[t].pFlags.chosen&&(this._isVoted=!0,this._answers[t].chosen=!0),this._results[t].pFlags.correct&&(this._answers[t].correct=!0))}}},function(t,e){class s{constructor(){}static filenameToMime(t){try{let e=t.substr(t.lastIndexOf(".")+1);if(s.d[e])return s.d[e]}catch(t){}return"application/octet-stream"}}s.d={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",json:"application/json",mp4:"video/mp4",mp3:"audio/mp3",oga:"audio/ogg",ogg:"audio/ogg",wav:"audio/wav",weba:"audio/webm"},t.exports=s},function(t,e,s){const i=s(18),a=window.classes.EventTarget;t.exports=class extends a{constructor(t){super(t),this._baseMessage=null,this._messagesVisible=[],this._messagesVisibleIds=[],this._baseMessageN=null}calcDates(){for(let t=1;t<this._messagesVisible.length;t++)if(!this._messagesVisible[t].isDate&&new Date(1e3*this._messagesVisible[t]._date).getDay()!=new Date(1e3*this._messagesVisible[t-1]._date).getDay()){const e=new i({apiObject:{_:"messageService",action:"date",date:this._messagesVisible[t]._date-1,id:this._messagesVisible[t]._id-.5},peerManager:this.peerManager,peer:this});e.isDate=!0,this._messagesVisible.splice(t,0,e),this._messagesVisibleIds.push(Number(e._id)),t++}}recalcVisible(t){let e=!1;this._messagesVisible=[],this._messagesVisibleIds=[];let s=this.getBaseMessage(),i=null;for(let t=this._messages.length-1;t>=0;t--)this._messages[t]._id==s._id&&(i=t);if(i>this._messages.length-5&&(this.setBaseMessage(this._messages[this._messages.length-1]),i=this._messages.length-1),null!==i)for(let s=i-40;s<i+40;s++)this._messages[s]&&(this._messagesVisible.push(this._messages[s]),this._messagesVisibleIds.push(Number(this._messages[s]._id)),(s==i-40&&"desc"==t||s==i+39&&"asc"==t)&&(e=!0));return this._baseMessageN=this._messagesVisible.length-1,e}hasOlder(){return!(this._messagesVisible[0]._id==this._messages[0]._id&&!this._thereReMoreMessages)}hasNewer(){return this._messagesVisible[this._messagesVisible.length-1]._id!=this._messages[this._messages.length-1]._id}async loadInitial(){return this._messages.length>=20?(this.sortMessages(),this.recalcVisible(),void this.emit("messages")):await this.loadMoreMessages()}async loadOlder(){return this.setBaseMessage(this._messagesVisible[0]),await this.loadMoreMessages("desc")}async loadNewer(){return this.setBaseMessage(this._messagesVisible[this._messagesVisible.length-1]),await this.loadMoreMessages("asc")}async searchMessage(t){await this.loadMoreMessages(null,t);for(let e of this._messages)if(e._id==t)return this.setBaseMessage(e),this.sortMessages(),this.recalcVisible(),this.emit("messages"),!0;return!1}async sureInvoke(t,e){let s=await this._peerManager._user.invoke(t,e);return"CHANNEL_INVALID"==s.data.type&&(await this._peerManager.updateHashes(),e.peer.access_hash=this._apiObject.access_hash,s=await this._peerManager._user.invoke(t,e)),s}async loadMoreMessages(t,e){if(this._loadingMoreMessages)return;if(this._loadingMoreMessages=!0,this.recalcVisible(t)&&!e)return this._loadingMoreMessages=!1,void this.emit("messages");const s=this.getBaseMessage(),i={peer:this.getInputPeerObject(),limit:40};e?(i.offset_id=e,i.add_offset=-40):t&&(i.offset_id=s._id,"asc"==t&&(i.add_offset=-40));const a=await this.sureInvoke("messages.getHistory",i);if(a&&a.success){if(a.data.chats)for(let t of a.data.chats)this._peerManager.peerByAPIResult(t,!1,!0);if(a.data.users)for(let t of a.data.users)this._peerManager.peerUserByAPIResult(t);let e=!1;if(a.data.messages)for(let t of a.data.messages)this.messageByAPIResult(t,!1,!0),e=!0;e||"desc"!=t||(this._thereReMoreMessages=!1),this._messagesWereLoaded=!0}return this._loadingMoreMessages=!1,e||(this.sortMessages(),this.recalcVisible(),this.emit("messages")),!0}getBaseMessage(){return this._baseMessage?this._baseMessage:this._messages[this._messages.length-1]}setBaseMessage(t){this._baseMessage=t}}},function(t,e){t.exports=class{constructor(t={}){if(this._peerManager=t.peerManager,this._apiObject=t.apiObject,!this._apiObject){this._apiObject={_:"dialogFilter",include_peers:[],exclude_peers:[],pinned_peers:[],pFlags:{bots:!1,contacts:!0,non_contacts:!1,groups:!1,broadcasts:!1,exclude_muted:!1,exclude_read:!1,exclude_archived:!1},title:"",flags:!0};for(let t in this._apiObject.pFlags)this._apiObject[t]=this._apiObject.pFlags[t]}this._id=this._apiObject.id}async remove(){if(await this._peerManager._user.invoke("messages.updateDialogFilter",{id:this._id}))return this._removed=!0,delete this._peerManager._folders[this._id],this._peerManager.emit("folders"),!0}async persist(){if(!this._removed){if(!this._id){if(!this.title)return;let t=1;for(let e in this._peerManager._folders)e=Number(e),e>t&&(t=e);this._id=t+1,this._apiObject.id=t+1}await this._peerManager._user.invoke("messages.updateDialogFilter",{flags:!0,id:this._id,filter:this._apiObject})&&(this._peerManager._folders[this._id]=this,this._peerManager.emit("folders"))}}async getPeers(){return{include:[],exclude:[]}}toggleDialogPin(t,e){if(e)this._apiObject.pinned_peers.push(t.getInputPeerObject());else for(let e=0;e<this._apiObject.pinned_peers.length;e++){let s=this._apiObject.pinned_peers[e],i="";if(s.chat_id&&(i="chat_"+s.chat_id),s.user_id&&(i="dialog_"+s.user_id),s.channel_id&&(i="channel_"+s.channel_id),i==t._id){this._apiObject.pinned_peers.splice(e,1);break}}this._peerManager._user.invoke("messages.updateDialogFilter",{flags:!0,id:this._id,filter:this._apiObject}),this._peerManager.emit("folder",{folderId:this._id})}appPeerAPI(t,e){this._apiObject[e].push(t.getInputPeerObject())}removePeerAPI(t,e){console.error("remove ",t,"from "+e);for(let s=0;s<this._apiObject[e].length;s++){let i=this._apiObject[e][s],a="";if(i.chat_id&&(a="chat_"+i.chat_id),i.user_id&&(a="dialog_"+i.user_id),i.channel_id&&(a="channel_"+i.channel_id),t._id==a){this._apiObject[e].splice(s,1);break}}}isPeerIn(t,e){try{for(let s of this._apiObject[e]){let e="";if(s.chat_id&&(e="chat_"+s.chat_id),s.user_id&&(e="dialog_"+s.user_id),s.channel_id&&(e="channel_"+s.channel_id),t._id==e)return!0}}catch(t){}return!1}isPinned(t){return 1==this._id?t.isPinned():this.isPeerIn(t,"pinned_peers")}getFilterFunc(){return t=>{let e=!1;return this._apiObject.pFlags.bots&&t._peerUser&&t._peerUser._apiObject.pFlags&&t._peerUser._apiObject.pFlags.bot||this._apiObject.pFlags.contacts&&t._peerUser&&t._peerUser._apiObject.pFlags&&t._peerUser._apiObject.pFlags.contact?e=!0:!this._apiObject.pFlags.non_contacts||!t._peerUser||t._peerUser._apiObject.pFlags&&t._peerUser._apiObject.pFlags.contact?this._apiObject.pFlags.groups&&!t._peerUser&&t.canSendMessageTo()?e=!0:!this._apiObject.pFlags.broadcasts||"channel"!=t._type||t._apiObject.pFlags&&t._apiObject.pFlags.megagroup?(this.isPeerIn(t,"include_peers")||this.isPeerIn(t,"pinned_peers"))&&(e=!0):e=!0:e=!0,!!e&&((this._apiObject.pFlags.exclude_muted&&t.isMuted()||this._apiObject.pFlags.exclude_read&&!t._unreadCount||this._apiObject.pFlags.exclude_archived&&!t.isArchived()||this.isPeerIn(t,"exclude_peers"))&&(e=!1),!!t)}}fillUpdatesFromAPIResult(t){this._apiObject=t}get title(){return this._apiObject.title}get info(){let t=[];this._apiObject.pFlags.bots&&t.push("All Bots"),this._apiObject.pFlags.contacts&&t.push("All Contacts"),this._apiObject.pFlags.non_contacts&&t.push("All Non Contacts"),this._apiObject.pFlags.groups&&t.push("All Groups"),this._apiObject.pFlags.broadcasts&&t.push("All Channels");let e={chat:0,user:0,channel:0};for(let t of this._apiObject.include_peers)t.chat_id&&e.chat++,t.user_id&&e.user++,t.channel_id&&e.channel++;for(let s in e)e[s]&&t.push(e[s]+" "+s+(s>1?"s":""));return t.slice(0,3).join(", ")}async getBadgeCount(){let t=0;if(1==this._id)for(let e of this._peerManager._sortedPeers)e._folderId==this._id&&(t+=e._unreadCount);else{let e=this.getFilterFunc();for(let s of this._peerManager._sortedPeers)e(s)&&(t+=s._unreadCount)}return t}async addPeer(t){let e=[];for(let s of this._peerManager._sortedPeers)s._folderId!=this._id&&t._id!=s._id||e.push({_:"inputFolderPeer",folder_id:this._id,peer:s.getInputPeerObject()});app._peerManager.processApiUpdates(await this._peerManager._user.invoke("folders.editPeerFolders",{folder_peers:e}))}async removePeer(t){let e=[];for(let s of this._peerManager._sortedPeers)t._id==s._id&&e.push({_:"inputFolderPeer",folder_id:0,peer:s.getInputPeerObject()});let s=null;s=e.length?await this._peerManager._user.invoke("folders.editPeerFolders",{folder_peers:e}):await this._peerManager._user.invoke("folders.deleteFolder",{folder_id:this._id}),app._peerManager.processApiUpdates(s)}}},function(t,e){const s=window.classes.EventTarget;window.classes.Storage;t.exports=class extends s{constructor(t={}){super(),this._peerManager=t.peerManager,this._type="user",this._id=t.id,this._apiObject=t.apiObject,this._displayName=null,this._apiObject&&this._apiObject.first_name&&(this._displayName=this._apiObject.first_name+" "+(this._apiObject.last_name?this._apiObject.last_name:"")),this._isOnline=!1,this._hasAvatar=null,this._avatarBlobURL=null,this._lastTypingTime=null,this._lastTypingAction=null,this._peer=null}getDisplayName(){return this._displayName}processApiUpdate(t){let e=!1;return"updateUserStatus"==t._&&(this._apiObject.status=t.status,e=this.checkOnlineChanged()),"updateUserTyping"==t._&&(this._lastTypingTime=(new Date).getTime()/1e3,this._lastTypingAction=t.action,e=!0),"updateUserPhoto"==t._&&(this._apiObject.photo=t.photo,this._peer?this._peerManager.emit("avatar",{peer:this._peer}):this._peerManager.emit("avatar",{user:this}),e=!0),"updateUserName"==t._&&(this._apiObject.first_name=t.first_name,this._apiObject.last_name=t.last_name,e=!0),e}serialize(){return this._apiObject}isTyping(){return!!(this._lastTypingTime&&this._lastTypingTime>(new Date).getTime()/1e3-20)}isRemoved(){return!!(this._apiObject&&this._apiObject.pFlags&&this._apiObject.pFlags.deleted)}async flushAvatar(){this._hasAvatar=null,this._avatarBlobURL=null,await this._peerManager._media.flushPeerAvatar(this),await this.getAvatarBlobURL()}hasAvatar(){return this._hasAvatar}getAvatarColor(){return(""+this._id).substr(-1)%8+1}getAvatarCacheURL(){return"./tg/avatar_peer_dialog_"+this._id+".png"}getAvatarBlobURLSync(){return this._avatarBlobURL}async getAvatarBlobURL(){if(this._avatarBlobURL)return this._avatarBlobURL;if(!1===this._hasAvatar)return null;let t=await this._peerManager._media.getPeerAvatarAndReturnBlobURL(this);return null===t?(this._hasAvatar=!1,null):(this._hasAvatar=!0,this._avatarBlobURL=t,this._avatarBlobURL)}isMe(){return!!(this._apiObject&&this._apiObject.pFlags&&this._apiObject.pFlags.self)}lastSeenString(){if(this._isOnline)return"online";{let t=this._apiObject.status;if(!t)return"";if("userStatusOnline"==t._)return"last seen just now";if("userStatusOffline"==t._){const e=(new Date).getTime()/1e3,s=Math.abs(e-t.was_online);if(s<60)return"last seen just now";if(s<3600){let t=Math.floor(s/60);return"last seen "+t+" minute"+(1==t?"":"s")+" ago"}if(s<86400){let t=Math.floor(s/3600);return"last seen "+t+" hour"+(1==t?"":"s")+" ago"}if(s<172800)return"last seen yesterday";{let t=Math.floor(s/86400);return"last seen "+t+" day"+(1==t?"":"s")+" ago"}}return"userStatusRecently"==t._?"last seen recently":"userStatusLastWeek"==t._?"last seen last week":"userStatusLastMonth"==t._?"last seen last month":""}}checkOnlineChanged(){const t=this._isOnline;return this._isOnline=this.isOnline(),this._isOnline!=t}isOnline(){if(this._apiObject&&this._apiObject.status){const t=(new Date).getTime()/1e3;return"userStatusOnline"==this._apiObject.status._&&this._apiObject.status.expires>t}}getFirstName(){return this._apiObject.first_name?this._apiObject.first_name.trim():""}getAvatarInitials(){return(this._apiObject.first_name?this._apiObject.first_name.charAt(0):"")+(this._apiObject.last_name?this._apiObject.last_name.charAt(0):"")}}},function(t,e,s){const i=window.classes.EventTarget,a=s(83);t.exports=class extends i{constructor(t={}){super(),this._app=t.app,this._user=t.user,this._user._mediaManager=this,this._storage=t.storage,this._header8=Uint8Array.from([255,216,255,224,0,16,74,70,73,70,0,1,1,0,0,1,0,1,0,0,255,219,0,67,0,40,28,30,35,30,25,40,35,33,35,45,43,40,48,60,100,65,60,55,55,60,123,88,93,73,100,145,128,153,150,143,128,140,138,160,180,230,195,160,170,218,173,138,140,200,255,203,218,238,245,255,255,255,155,193,255,255,255,250,255,230,253,255,248,255,219,0,67,1,43,45,45,60,53,60,118,65,65,118,248,165,140,165,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,255,192,0,17,8,0,0,0,0,3,1,34,0,2,17,1,3,17,1,255,196,0,31,0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,255,196,0,181,16,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125,1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250,255,196,0,31,1,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,255,196,0,181,17,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119,0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250,255,218,0,12,3,1,0,2,17,3,17,0,63,0]),this._footer8=Uint8Array.from([255,217]),this._downloadPromises={},this._downloadPromiseResolvers={},this._serversHeated={},this._webp=new a,this._parallelC=this._app._config.get("maxParallelConnections")}async getVideoPreview(t){const e="./tg/"+t._id+"_preview.jpg";return await this._user._protocol.matchGetBlob(e)}async saveVideoPreview(t,e){const s="./tg/"+t._id+"_preview.jpg";this._user._protocol.putToCacheAndForget({url:s,binary:e,lazy:!0})}async uploadPhoto(t,e){console.error("uploading photo",t,e);let s=(""+Math.random()).split(".").join("").split("0").join("1"),i=0,a=await this._user._protocol.md5(t);const o=await this._user._protocol.currentDC(),n=t.length;let r=[];for(let e=0;524288*e<n;e++){const a={file_id:s,file_part:0,bytes:[]};a.file_part=e,a.bytes=t.subarray(524288*e,524288*(e+1));const n=o+1e3*(e%this._parallelC+1);r.push(this._user.invoke("upload.saveFilePart",a,{dcId:n})),r.length>=this._parallelC&&(await Promise.all(r),r=[]),i++}return await Promise.all(r),{_:"inputFile",parts:i,id:s,name:e,md5_checksum:a}}decodeStrippedPhoto(t){if(t&&"Uint8Array"!=t.name&&void 0!==t[0]){let e=[],s=0;for(;t[s]||0===t[s];)e.push(t[s]),s++;t=new Uint8Array(e)}if(!t||t.byteLength<3||1!=t[0])return t;const e=new Uint8Array(t.byteLength+this._header8.byteLength-3+2),s=this._header8.byteLength;return e.set(this._header8),e[164]=t[1],e[166]=t[2],e.set(t,s-3),e[s-3]=this._header8[s-3],e[s-2]=this._header8[s-2],e[s-1]=this._header8[s-1],e[e.byteLength-2]=this._footer8[0],e[e.byteLength-1]=this._footer8[1],e}async heatServersUp(t){let e=t.dc_id;if(this._serversHeated[e])return;this._serversHeated[e]=!0,console.error(e);let s=await this._user._protocol.activeNetworkers(),i=!1;for(let t of s)t==e&&(i=!0);i||await this._user.invoke("help.getSupport",{},{dcId:e});let a=[];for(let t=1;t<=this._parallelC;t++)a.push(this._user.invoke("help.getSupport",{},{dcId:1e3*t+e}));await Promise.all(a)}async loadFilePartAndReturnAB(t,e,s){t.id;let i={precise:0,limit:524288,offset:524288*e};i.location={_:"inputDocumentFileLocation",access_hash:t.access_hash,file_reference:t.file_reference,id:t.id};let a={};a.dcId=t.dc_id+1e3*(e%this._parallelC+1);let o=await this._user.invoke("upload.getFile",i,a);if(!o.success&&o.data.type&&-1!=o.data.type.indexOf("FILE_REFERENCE_")&&s&&(await this.updateFileReferences(s,t),i.location.file_reference=t.file_reference,o=await this._user.invoke("upload.getFile",i,a)),o&&o.data&&o.data.bytes){return o.data.bytes.buffer.slice(o.data.bytes.byteOffset,o.data.bytes.byteLength+o.data.bytes.byteOffset)}return console.error(o),null}async loadStickerAndReturn(t){const e="sticker_"+t.id,s={location:{_:"inputDocumentFileLocation",access_hash:t.access_hash,file_reference:t.file_reference,id:t.id},precise:0,limit:1048576,offset:0};let i={};i.dcId=t.dc_id;let a="./tg/"+e+".json";if("application/x-tgsticker"!=t.mime_type){if(s.location.thumb_size="s",a="./tg/"+e+".png",this._webp._hasSupport){return await this._user._protocol.loadImageAndReturnBlobURL({url:a,params:s,options:i,timeout:5e3})}{let t=await this._user._protocol.loadRaw({url:a,params:s,options:i,timeout:5e3}),e=await this._webp.convert(t);const o=new Response(e.data,{status:200,statusText:"OK",headers:{"Content-Type":"image/png","Content-Length":e.data.length,"Cache-Control":"public, max-age: 86400, immutable"}});this._user._protocol.putToCacheAndForget({url:a,binary:e.data});let n=await o.blob();return URL.createObjectURL(n)}}return await this._user._protocol.loadFileAndInflate({url:a,params:s,options:i,timeout:5e3})}async updateFileReferences(t,e){let s="messages.getMessages";const i={};"channel"==t._peer._type&&(s="channels.getMessages",i.channel={_:"inputChannel",channel_id:t._peer._apiObject.id,access_hash:t._peer._apiObject.access_hash}),i.id=[{_:"inputMessageID",id:t._id}];const a=await this._user.invoke(s,i);try{let t=a.data.messages[0];const s=t=>{if(t&&t.file_reference)return e.file_reference=t.file_reference,!0};s(t.media.photo),s(t.media.document),s(t.media.webpage.photo)}catch(t){return!1}return!1}async loadPreviewAndReturnBlobURL(t,e,s,i){let a="message_photo_"+t.id;e&&(a+="_"+e);let o={precise:0,limit:524288,offset:0},n={};"photo"==t._?o.location={_:"inputPhotoFileLocation",access_hash:t.access_hash,thumb_size:"m",file_reference:t.file_reference,id:t.id}:"document"==t._&&(o.location={_:"inputDocumentFileLocation",access_hash:t.access_hash,thumb_size:"m",file_reference:t.file_reference,id:t.id}),e&&(o.location.thumb_size=e),n.dcId=t.dc_id,i&&(n.dcId+=1e3*(i%this._parallelC+1));let r=await this._user._protocol.loadImageAndReturnBlobURL({url:"./tg/"+a+".jpg",params:o,options:n});return!1===r&&s?(await this.updateFileReferences(s,t),await this.loadPreviewAndReturnBlobURL(t,e)):(r||(o.location.thumb_size="m",r=await this._user._protocol.loadImageAndReturnBlobURL({url:"./tg/"+a+".jpg",params:o,options:n})),r)}async flushPeerAvatar(t){let e="avatar_peer_"+t._id;return"user"==t._type&&(e="avatar_peer_dialog_"+t._id),this._downloadPromises[e]&&delete this._downloadPromises[e],await this._user._protocol.removeCache("./tg/"+e+".png"),!0}async getPeerAvatarAndReturnBlobURL(t){let e="avatar_peer_"+t._id;if("user"==t._type&&(e="avatar_peer_dialog_"+t._id),this._downloadPromises[e])return await this._downloadPromises[e];this._downloadPromises[e]=new Promise(t=>{this._downloadPromiseResolvers[e]=t});const s=await this._user._protocol.getCachedResources([{url:"./tg/"+e+".png"}]);if(s&&s[0]&&s[0].blobURL)return this._downloadPromiseResolvers[e](s[0].blobURL),s[0].blobURL;const i={},a={location:({_:"inputFileLocation",volume_id:0,local_id:0},{_:"inputPeerPhotoFileLocation",big:0,peer:null,volume_id:0,local_id:0}),precise:0,limit:524288,offset:0};if(t._apiObject.photo&&t._apiObject.photo.photo_small?"chat"==t._type?(a.location.volume_id=t._apiObject.photo.photo_small.volume_id,a.location.local_id=t._apiObject.photo.photo_small.local_id,a.location.peer={_:"inputPeerChat",chat_id:t._apiObject.id},i.dcId=t._apiObject.photo.dc_id):"channel"==t._type?(a.location.volume_id=t._apiObject.photo.photo_small.volume_id,a.location.local_id=t._apiObject.photo.photo_small.local_id,a.location.peer={_:"inputPeerChannel",channel_id:t._apiObject.id,access_hash:t._apiObject.access_hash},i.dcId=t._apiObject.photo.dc_id):t._apiObject&&"user"==t._apiObject._&&(a.location.volume_id=t._apiObject.photo.photo_small.volume_id,a.location.local_id=t._apiObject.photo.photo_small.local_id,a.location.peer={_:"inputPeerUser",user_id:t._apiObject.id,access_hash:t._apiObject.access_hash},i.dcId=t._apiObject.photo.dc_id):"dialog"==t._type&&t._peerUser&&t._peerUser._apiObject&&t._peerUser._apiObject.photo&&(a.location.volume_id=t._peerUser._apiObject.photo.photo_small.volume_id,a.location.local_id=t._peerUser._apiObject.photo.photo_small.local_id,a.location.peer={_:"inputPeerUser",user_id:t._peerUser._apiObject.id,access_hash:t._peerUser._apiObject.access_hash},i.dcId=t._peerUser._apiObject.photo.dc_id),!a.location.peer)return this._downloadPromiseResolvers[e](null),null;let o=await this._user._protocol.loadImageAndReturnBlobURL({url:"./tg/"+e+".png",params:a,options:i});return this._downloadPromiseResolvers[e](o),o}}},function(t,e){t.exports=class{constructor(){this._isInitializing=!1,this._initializationPromiseResolver=null,this._initializationPromise=new Promise((t,e)=>{this._initializationPromiseResolver=t}),this._workerPromises={},this._workerPromisesResolvers={},this._hasSupport=this.detectSupport()}detectSupport(){const t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))&&0==t.toDataURL("image/webp").indexOf("data:image/webp")}async convert(t){await this.initializeWorker();const e=(""+Math.random()).split(".").join("");return this._workerPromises[e]=new Promise((t,s)=>{this._workerPromisesResolvers[e]=t}),this._worker.postMessage({id:e,binary:t}),await this._workerPromises[e]}async initializeWorker(){return!!this._initialized||(this._isInitializing?await this._initializationPromise:(this._isInitializing=!0,this._worker=new Worker("webpworker.js"),this._worker.onmessage=t=>{t.data&&t.data.id&&this._workerPromisesResolvers[t.data.id]&&(this._workerPromisesResolvers[t.data.id](t.data),delete this._workerPromisesResolvers[t.data.id],delete this._workerPromises[t.data.id])},void this._initializationPromiseResolver(!0)))}}},function(t,e){const s=window.classes.EventTarget;t.exports=class extends s{constructor(t={}){super(),this._docsToDownload=[],setTimeout(()=>{this.tick()},5e3)}schedule(t){this._docsToDownload.push(t),t.scheduleDownload()}cancel(t){for(let e=0;e<this._docsToDownload.length;e++)if(this._docsToDownload[e].id==t.id){this._docsToDownload.splice(e,1),t.cancelDownload();break}}async tick(){let t=100;if(this._docsToDownload.length){let e=this._docsToDownload[0];try{await e.downloadNextPart(!!e._downloadingSize)}catch(t){console.log(t)}e._isDownloaded?(this.emit("downloaded",e),this._docsToDownload.shift()):this.emit("progress",e),t=10}setTimeout(()=>{this.tick()},t)}}},function(t,e,s){const i=window.classes.EventTarget,a=(window.classes.Storage,s(86)),o=s(14);t.exports=class extends i{constructor(t={}){super(),this._app=t.app,this._storage=t.storage,this._user=t.app._user,this._media=t.media,this._peerManager=t.peerManager,this._stickers=[],this._stickersImageData={},this._stickerSetsIds={},this._featured=[],this._stickersIds={},this._recentStickers=[],this._installed={},this._installedIds={},this._stickersCache={}}byId(t){return this._stickerSetsIds[t]}installToggle(t){const e=this.byId(t);if(e)return this.isStickerSetInstalled(e)?(this.uninstallStickerSet(e),!1):(this.installStickerSet(e),!0)}async installStickerSet(t){if(this.isStickerSetInstalled(t))return!0;this._installed[t._id]=t,this._installedIds[t._id]=t._id,t.installed=!0,await t.loadImagesFromCache(),await t.load(),this.emit("installed",t),this._user.invoke("messages.installStickerSet",{stickerset:{_:"inputStickerSetID",id:t._apiObject.set.id,access_hash:t._apiObject.set.access_hash}})}uninstallStickerSet(t){return delete this._installedIds[t._id],delete this._installed[t._id],this.emit("uninstalled",t),this._user.invoke("messages.uninstallStickerSet",{stickerset:{_:"inputStickerSetID",id:t._apiObject.set.id,access_hash:t._apiObject.set.access_hash}}),!0}isStickerSetInstalled(t){return!!this._installed[t._id]||this._installedIds[t._id]}async getStickerSetBySticker(t){let e=null,s=null;if(t._apiObject&&t._apiObject.attributes)for(let i of t._apiObject.attributes)if("documentAttributeSticker"==i._&&i.stickerset){e=i.stickerset.id,s=i.stickerset.access_hash;break}if(e){const t=this.byId(e);if(t)return t;if(this._stickersCache[e])return this._stickersCache[e]}if(e&&s){const t=await this._user.invoke("messages.getStickerSet",{stickerset:{_:"inputStickerSetID",id:e,access_hash:s}});if(t&&t.data&&t.data.documents){let e=new a({apiObject:t.data,peerManager:this._peerManager});return this._stickersCache[e._id]=e,e}}return null}async loadRespData(t,e,s){const i=[],o={};if(e){for(let s of t.sets)e>i.length&&(s.set&&(s=s.set),this._stickerSetsIds[s.id]&&(i.push(this._stickerSetsIds[s.id]),o[s.id]=!0));i.length&&s&&s(i)}for(let n of t.sets)if(!e||e>i.length){if(n.set&&(n=n.set),o[n.id])continue;try{if(this._stickerSetsIds[n.id])i.push(this._stickerSetsIds[n.id]),o[n.id]=!0;else{const t=await this._user._protocol.invokeAndCache("messages.getStickerSet",{stickerset:{_:"inputStickerSetID",id:n.id,access_hash:n.access_hash}},{max:10});if(t&&t.documents){let s=new a({apiObject:t,peerManager:this._peerManager});for(let t of s._stickers)this._stickersIds[t._id]=t;this._stickerSetsIds[s._id]=s,this._installedIds[s._id]&&(this._installed[s._id]=s),await s.loadImagesFromCache(e),i.push(s),o[s._id]=!0}}s&&s(i)}catch(t){}}return i}async getFeatured(){return await this._user._protocol.invokeAndCache("messages.getFeaturedStickers",{},{max:10})}async search(t){return await this._user._protocol.invokeAndCache("messages.searchStickerSets",{q:t},{max:10})}async getAll(){if(this._allData)return this._allData;let t=await this._user.invoke("messages.getAllStickers",{},{max:10});return t=t.data,t&&t.sets&&t.sets.forEach(t=>{this._installedIds[t.id]=!0}),this._allData=t,t}async getRecent(){if(this._recentStickers.length)return this._recentStickers;const t=await this._user.invoke("messages.getRecentStickers");if(t&&t.data&&t.data.stickers){let e=0;for(let s of t.data.stickers)if(e<10){if(this._stickersIds[s.id])this._recentStickers.push(this._stickersIds[s.id]);else{const t=new o({apiObject:s,peerManager:this._peerManager});this._recentStickers.push(t),this._stickersIds[t._id]=t}e++}}return await this._peerManager._user._protocol.getCachedResources(this._recentStickers),this._recentStickers}free(t){const e=this.byId(t);e&&e.free()}}},function(t,e,s){const i=s(14);t.exports=class{constructor(t={}){this._peerManager=t.peerManager,this._apiObject=t.apiObject,this._id=this._apiObject.set?this._apiObject.set.id:null,this._stickers=[],this._name="",this._hasAnimated=!1,this.processApiData(),this._imagesLoaded=!1}free(){console.error("Free stickers memory",this);for(let t of this._stickers)t.json=null,t.cached=null}get id(){return this._id}get name(){return this._name}get count(){return this._stickers.length}get documents(){return this._stickers}async load(){return await this.loadImages(),this}processApiData(){for(let t of this._apiObject.documents){const e=new i({apiObject:t,peerManager:this._peerManager});this._stickers.push(e),!this._hasAnimated&&e.isAnimated()&&(this._hasAnimated=!0)}this._apiObject.set&&this._apiObject.set.title&&(this._name=""+this._apiObject.set.title)}async loadImagesFromCache(t){await this._peerManager._user._protocol.getCachedResources(t?this._stickers.slice(0,t):this._stickers)}async loadImages(){await this.loadImagesFromCache();for(let t of this._stickers)await t.load();this._imagesLoaded=!0}}},function(t,e,s){const i=window.classes.EventTarget,a=s(6);t.exports=class extends i{constructor(t){super(),this._user=t.user,this._peerManager=t.peerManager,this._gifs=[],this._lastQ=null,this._lastOffset=null,this._hasMore=!1}async search(t,e){if(null===t&&(t=this._lastQ),!this._searchBot){const t=await this._user.invoke("contacts.resolveUsername",{username:"gif"});try{this._searchBot={_:"inputUser",user_id:t.data.users[0].id,access_hash:t.data.users[0].access_hash}}catch(t){}}t!=this._lastQ&&(this._lastOffset=null);const s=await this._user._protocol.invokeAndCache("messages.getInlineBotResults",{bot:this._searchBot,peer:{_:"inputPeerEmpty"},query:t,offset:e&&this._lastOffset?this._lastOffset:void 0},{max:10}),i=[];if(s){try{for(let t of s.results){let e=new a({apiObject:t.document,peerManager:this._peerManager});i.push(e),this._hasMore=!0}this._lastOffset=s.next_offset,this._lastQ=t}catch(t){}i.length||(this._lastOffset=null,this._hasMore=!1)}return i}async load(){const t=await this._user.invoke("messages.getSavedGifs",{});if(t&&t.data&&t.data.gifs)for(let e of t.data.gifs){let t=new a({apiObject:e,peerManager:this._peerManager});this._gifs.push(t)}}}},function(t,e,s){const i=window.classes.EventTarget,a=s(89);t.exports=class extends i{constructor(t){super(t),this._recorder=null,this._recorded=null,this._recordedDuration=null,this._recordedStartAt=null,this._recordedFinishAt=null,this._isRecording=!1,this._askedToLoadAudio=null,this._playingAudio=null,this._playingTime=0,this._audiosTags={},this._audiosCanPlay={},this._pausedAudio=!0,this._audioPeer=null}async seekTo(t,e){!this._playingAudio||(this._playingAudio._id,t._id),this._audiosTags[t._id].currentTime=e/100*this._audiosTags[t._id].duration}async audioLoad(t,e){for(;;){if(!t)return;if(t._isDownloaded)return;if(e&&this._audiosCanPlay[t._id])return;await t.downloadNextPart(!0)}}async preloadAudio(t){if(await this.sureSingle("preload_"+t._id))return!0;this._askedToLoadAudio=t;const e=t.getStreamURL(),s=new Audio(e);this._audiosTags[t._id]=s,await new Promise(e=>{s.addEventListener("canplay",s=>{console.error("canplay"),this._audiosCanPlay[t._id]=!0,e()}),s.addEventListener("loadedmetadata",s=>{console.error("loadedmetadata"),this._audiosCanPlay[t._id]=!0,e()}),s.addEventListener("timeupdate",e=>{this._playingTime=s.currentTime,this._pausedAudio||this.emit("timeupdate",{messageAudio:t,currentTime:s.currentTime,percents:s.currentTime/s.duration*100})}),s.addEventListener("ended",t=>{this.audioEnded()}),t.scheduleDownload(),this.audioLoad(t,!0)}),this.fulfilSingle("preload_"+t._id,!0)}async audioEnded(){if(this.pausePlaying(),this._audioPeer)for(let t=0;t<this._audioPeer._audios.length;t++)this._audioPeer._audios[t]._id==this._playingAudio._id&&this.playAudio(this._audioPeer._audios[t+1],this._audioPeer)}async toggleAudio(t,e){console.error("toggleAudio",t),!this._playingAudio||this._pausedAudio||this._playingAudio._id!=t._id?await this.playAudio(t,e):await this.pauseAudio(t)}async playAudio(t,e){if(this._playingAudio&&this._playingAudio._id==t._id&&!this._pausedAudio)return;this._audioPeer=e;const s=this._playingAudio;this._audiosCanPlay[t._id]||await this.preloadAudio(t),this.pauseAudio(s),this._playingAudio=t,this._audiosTags[t._id].play(),this._pausedAudio=!1,this.emit("play",{messageAudio:t}),this.audioLoad(t),s&&s._id!=t._id&&(this._audiosTags[s._id].currentTime=0)}pausePlaying(){this._playingAudio&&this.pauseAudio(this._playingAudio)}async pauseAudio(t){this._playingAudio&&this._playingAudio._id==t._id&&this._pausedAudio||t&&(this._audiosTags[t._id].pause(),this._pausedAudio=!0,this.emit("pause",{messageAudio:t}))}getRecordedDuration(){if(null===this._recordedStartAt)return 0;let t=this._recordedFinishAt;return null===t&&(t=new Date),(t.getTime()-this._recordedStartAt.getTime())/1e3}async initRecorder(){if(this._isRecording)return!0;this._isRecording=!0,this._recordedStartAt=null,this._recordedFinishAt=null,this._recorder||(await a.includeOnce("assets/js/oggrecorder.js"),this._recorder=new Recorder({encoderPath:"assets/js/oggworker.js",encoderSampleRate:24e3,encoderApplication:2048,reuseWorker:!0}),this._recorder.ondataavailable=t=>{this._recorded=t});try{await this._recorder.start(),console.log("duration","started"),this._recordedStartAt=new Date}catch(t){return console.error(t),this._isRecording=!1,!1}return null!==this._recordedFinishAt&&await this.stopRecorder(),!0}async stopRecorder(){try{this._recordedFinishAt=new Date,await this._recorder.stop(),console.log("duration","stoped")}catch(t){}this._isRecording=!1}}},function(t,e){class s{constructor(){}static async includeOnce(t){if(s._included[t])return await s._included[t];await s.include(t)}static include(t){return s._included[t]=new Promise((e,s)=>{let i=document.createElement("script");i.src=t,i.onload=()=>{e()},i.onerror=()=>{s()},document.getElementsByTagName("body")[0].appendChild(i)}),s._included[t]}}s._included={},t.exports=s},function(t,e,s){const i=s(16);t.exports=class extends i{constructor(){super(),window.addEventListener("hashchange",()=>{this.hashChanged()}),this._peerId=null}hashChanged(){let t=window.location.hash.slice(1)||"";try{t=t.split("/"),this._peerId!=t[0]&&(this._peerId=t[0],this.emit("peerId",t[0]))}catch(t){}}hashPeer(t){document.title=t.getDisplayName()+" | LoveGram",this._peerId=""+t._id,window.location.hash=this._peerId}}}]);